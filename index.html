<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema Círculos</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #e5e7eb; }
        ::-webkit-scrollbar-thumb { background: #9ca3af; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #6b7280; }
        
        .page, .content-section { display: none; }
        .page.active { display: block; }
        #dashboard-page.active { display: flex; flex-direction: column; }
        .content-section.active { display: block; }
        .content-section.flex-active { display: flex; }

        .login-bg {
            background-image: linear-gradient(rgba(0, 0, 0, 0.6), rgba(0, 0, 0, 0.6)), url('https://i.imgur.com/9x4CHMr.png');
            background-size: cover;
            background-position: center;
        }

        .nav-link.active {
             border-bottom-color: #3b82f6; /* Azul */
             color: #3b82f6;
        }
        .dropdown:hover .dropdown-menu { display: block; }
        .dropdown-menu {
            display: none;
            animation: fadeIn 0.2s ease-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .tab-link.active {
            border-color: #22c55e; /* green-500 */
            color: #22c55e;
        }
        .tab-content { display: none; }
        .tab-content.active { display: block; }

        /* Modal specific styles */
        .modal {
            transition: opacity 0.3s ease-in-out, visibility 0.3s ease-in-out;
        }
        .modal.hidden {
            opacity: 0;
            visibility: hidden;
        }
        .modal:not(.hidden) {
            opacity: 1;
            visibility: visible;
        }
        .modal-content {
            transform: translateY(-20px);
            transition: transform 0.3s ease-in-out;
        }
        .modal:not(.hidden) .modal-content {
            transform: translateY(0);
        }
        /* Custom message box for alerts */
        #message-box {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
            display: none;
            padding: 1rem;
            border-radius: 0.5rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .message-box-success {
            background-color: #d1fae5;
            color: #065f46;
        }
        .message-box-error {
            background-color: #fee2e2;
            color: #991b1b;
        }
    </style>
    <!-- Firebase SDKs - ALL IMPORTS CONSOLIDATED HERE -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, addDoc, setDoc, updateDoc, deleteDoc, onSnapshot, collection, query, where, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Global variables for Firebase instances and functions
        window.firebaseApp = null;
        window.db = null;
        window.auth = null;
        window.userId = null;
        window.isAuthReady = false;

        // Make Firestore functions available globally via window object
        window.firebaseFirestore = {
            collection: collection,
            doc: doc,
            getDoc: getDoc,
            addDoc: addDoc,
            setDoc: setDoc,
            updateDoc: updateDoc,
            deleteDoc: deleteDoc,
            onSnapshot: onSnapshot,
            query: query,
            where: where,
            getDocs: getDocs
        };

        document.addEventListener('DOMContentLoaded', async () => {
            const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

            // Initialize Firebase only once
            if (!window.firebaseApp) {
                console.log('Initializing Firebase...');
                window.firebaseApp = initializeApp(firebaseConfig);
                window.db = getFirestore(window.firebaseApp);
                window.auth = getAuth(window.firebaseApp);
                console.log('Firebase initialized. DB:', !!window.db, 'Auth:', !!window.auth);


                // Set up authentication state listener
                onAuthStateChanged(window.auth, async (user) => {
                    if (user) {
                        // User is signed in.
                        window.userId = user.uid;
                        console.log('User signed in (onAuthStateChanged):', window.userId); // Added log
                        const userIdDisplay = document.getElementById('user-id-display');
                        if (userIdDisplay) {
                           userIdDisplay.textContent = `ID do Utilizador: ${window.userId}`;
                           console.log('User ID display updated to:', userIdDisplay.textContent); // Added log
                        }
                    } else {
                        // No user is signed in. Attempt anonymous sign-in.
                        console.log('No user signed in. Attempting anonymous sign-in.');
                        try {
                            const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
                            if (initialAuthToken) {
                                await signInWithCustomToken(window.auth, initialAuthToken);
                            } else {
                                await signInAnonymously(window.auth);
                            }
                            console.log('Anonymous sign-in attempted.'); // Log after attempt
                        } catch (error) {
                            console.error('Error during anonymous sign-in:', error);
                            window.showMessage('Erro ao fazer login anónimo.', 'error');
                        }
                    }
                    window.isAuthReady = true; // Mark auth as ready
                    console.log('Auth state changed. isAuthReady:', window.isAuthReady);
                    // Ensure initializeDashboard is called only once after auth is ready and dashboard is visible.
                    // This is handled by the login form submission now.
                    if (document.getElementById('dashboard-page').classList.contains('active') && !window.dashboardInitialized) {
                        initializeDashboard();
                    }
                });
            }
        });
    </script>
</head>
<body>

    <!-- Message Box for alerts -->
    <div id="message-box" class="message-box-success">
        <span id="message-text"></span>
        <button class="float-right ml-4 text-sm font-semibold" onclick="window.showMessage('', 'hide')">&times;</button>
    </div>

    <!-- PÁGINA DE LOGIN -->
    <div id="login-page" class="page active">
        <div class="min-h-screen flex flex-col items-center justify-center px-4 login-bg">
            <div class="w-full max-w-md">
                <div class="text-center mb-8">
                    <img src="https://i.imgur.com/gM6495x.png" alt="Logo Círculos" class="mx-auto h-28 w-auto">
                    <p class="text-gray-200 mt-4 text-lg">Aceda à sua conta para gerir o seu negócio.</p>
                </div>
                <div class="bg-white rounded-xl shadow-lg p-8">
                    <form id="login-form">
                        <div class="space-y-6">
                            <div>
                                <label for="email" class="block text-sm font-medium text-gray-700">Email</label>
                                <div class="mt-1 relative">
                                    <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none"><i data-lucide="mail" class="w-5 h-5 text-gray-400"></i></div>
                                    <input type="email" id="email" name="email" required class="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-400" placeholder="voce@email.com">
                                </div>
                            </div>
                            <div>
                                <div class="flex justify-between items-center">
                                    <label for="password" class="block text-sm font-medium text-gray-700">Senha</label>
                                    <a href="#" class="text-sm text-blue-500 hover:underline">Esqueceu a senha?</a>
                                </div>
                                <div class="mt-1 relative">
                                    <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none"><i data-lucide="lock" class="w-5 h-5 text-gray-400"></i></div>
                                    <input type="password" id="password" name="password" required class="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-400" placeholder="Sua senha">
                                </div>
                            </div>
                            <div>
                                <button type="submit" class="w-full bg-blue-500 text-white font-semibold py-3 px-4 rounded-md hover:bg-blue-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition-colors">Entrar</button>
                            </div>
                        </div>
                    </form>
                    <div class="mt-6 text-center">
                        <a href="#" class="font-medium text-blue-500 hover:text-blue-600">Crie a sua conta gratuitamente</a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- PAINEL PRINCIPAL DO SISTEMA -->
    <div id="dashboard-page" class="page h-screen">
        <header class="bg-white text-gray-800 shadow-md z-20 border-b">
            <div class="w-full px-6 flex justify-between items-center">
                <div class="h-16 flex items-center">
                    <img src="https://i.imgur.com/0ooTC9z.png" alt="Logo Círculos" class="h-10 w-auto">
                    <span id="user-id-display" class="ml-4 text-xs text-gray-500">ID do Utilizador: A carregar...</span>
                </div>
                <nav class="flex items-center h-full text-sm font-medium text-gray-600">
                    <a href="#" id="nav-dashboard" class="nav-link h-16 flex items-center px-4 hover:bg-gray-100 transition-colors border-b-2 border-transparent">Dashboard</a>
                    <div class="dropdown relative h-16 flex items-center">
                        <button id="nav-catalogo" class="nav-link h-full flex items-center px-4 hover:bg-gray-100 transition-colors gap-2 border-b-2 border-transparent">
                            <span>Registos</span><i data-lucide="chevron-down" class="w-4 h-4"></i>
                        </button>
                        <div class="dropdown-menu absolute left-0 mt-16 w-56 bg-white rounded-b-md shadow-lg py-1 z-30 text-gray-800 border-t">
                            <a href="#" id="link-produtos" class="block px-4 py-2 text-sm hover:bg-gray-100">Produtos</a>
                            <a href="#" id="link-clientes-fornecedores" class="block px-4 py-2 text-sm hover:bg-gray-100">Clientes e Fornecedores</a>
                        </div>
                    </div>
                    <a href="#" id="nav-vendas" class="nav-link h-16 flex items-center px-4 hover:bg-gray-100 transition-colors border-b-2 border-transparent">Vendas</a>
                    <a href="#" id="nav-estoque" class="nav-link h-16 flex items-center px-4 hover:bg-gray-100 transition-colors border-b-2 border-transparent">Inventário</a>
                    <a href="#" id="nav-financeiro" class="nav-link h-16 flex items-center px-4 hover:bg-gray-100 transition-colors border-b-2 border-transparent">Financeiro</a>
                </nav>
            </div>
        </header>
        <main id="page-content" class="flex-1 overflow-y-auto bg-gray-50"></main>
        <div id="modal-container"></div>
    </div>

    <script type="module">
        // Utility function for showing messages - now global
        window.showMessage = function(message, type = 'success') {
            const messageBox = document.getElementById('message-box');
            const messageText = document.getElementById('message-text');
            if (type === 'hide') {
                messageBox.style.display = 'none';
                return;
            }
            messageText.textContent = message;
            messageBox.classList.remove('message-box-success', 'message-box-error');
            messageBox.classList.add(`message-box-${type}`);
            messageBox.style.display = 'block';
            setTimeout(() => {
                messageBox.style.display = 'none';
            }, 5000);
        };

        document.addEventListener('DOMContentLoaded', async () => {
            const loginPage = document.getElementById('login-page');
            const dashboardPage = document.getElementById('dashboard-page');
            const loginForm = document.getElementById('login-form');

            // Flag to prevent multiple initializations
            window.dashboardInitialized = false;

            // Wait for Firebase auth to be ready before proceeding
            const waitForAuth = () => {
                return new Promise(resolve => {
                    const checkAuth = () => {
                        if (window.isAuthReady) {
                            console.log('waitForAuth: Auth is ready.');
                            resolve();
                        } else {
                            console.log('waitForAuth: Auth not ready yet, retrying...');
                            setTimeout(checkAuth, 100);
                        }
                    };
                    checkAuth();
                });
            };

            loginForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                console.log('Login form submitted. Transitioning to dashboard.');
                loginPage.classList.remove('active');
                dashboardPage.classList.add('active');
                await waitForAuth(); // Ensure auth is ready before initializing dashboard
                if (!window.dashboardInitialized) {
                    console.log('Initializing dashboard after login...');
                    initializeDashboard();
                    window.dashboardInitialized = true;
                }
            });

            const initializeDashboard = () => {
                console.log('initializeDashboard started.');
                const pageContent = document.getElementById('page-content');
                const modalContainer = document.getElementById('modal-container');
                const navLinks = document.querySelectorAll('.nav-link');

                // Initial dummy data for clients and suppliers (will be replaced by Firestore later)
                let clientsAndSuppliers = [
                    { id: 1, tipo: 'Cliente', pessoa: 'Física', nome: 'João da Silva', cpf: '123.456.789-00', email: 'joao.silva@email.com', telefone: '(11) 98765-4321' },
                ];

                const setActiveLink = (id) => {
                    navLinks.forEach(link => {
                        link.classList.remove('active', 'text-blue-500', 'border-blue-500');
                        link.classList.add('border-transparent');
                    });
                    const activeLink = document.getElementById(id);
                    if (activeLink) {
                        activeLink.classList.add('active', 'text-blue-500', 'border-blue-500');
                        activeLink.classList.remove('border-transparent');
                    }
                };

                const showPage = (pageHtml, navId, scriptRunner, modalHtml = '') => {
                    pageContent.innerHTML = pageHtml;
                    modalContainer.innerHTML = modalHtml; // Set modal HTML when showing the page
                    setActiveLink(navId);
                    lucide.createIcons(); // Re-render Lucide icons for new content
                    if(scriptRunner) scriptRunner();
                };
                
                // Function to run the Product System specific script
                const runProductSystemScript = () => {
                    console.log('runProductSystemScript started.');
                    const tableBody = document.getElementById('product-table-body');
                    const addProductBtn = document.getElementById('add-product-btn');
                    const productModal = document.getElementById('product-modal');
                    const productForm = document.getElementById('product-form');
                    const closeModalBtn = document.getElementById('product-modal-close');
                    const cancelBtn = document.getElementById('product-modal-cancel');
                    const generateBarcodeBtn = document.getElementById('generate-barcode-btn');
                    const generateGtinEanBtn = document.getElementById('generate-gtinean-btn'); // Get the new button

                    // Ensure Firebase Firestore functions are available
                    const { collection, doc, getDoc, addDoc, updateDoc, deleteDoc, onSnapshot } = window.firebaseFirestore;

                    // Function to render products in the table
                    const renderProductsTable = (productsData) => {
                        tableBody.innerHTML = ''; // Clear existing rows
                        if (productsData.length === 0) {
                            tableBody.innerHTML = '<tr><td colspan="5" class="p-3 text-center text-gray-500">Nenhum produto registado ainda.</td></tr>';
                            return;
                        }
                        productsData.forEach(item => {
                            const tr = document.createElement('tr');
                            tr.innerHTML = `
                                <td class="p-3">${item.descricao || 'N/A'}</td>
                                <td class="p-3">${item.codigo || 'N/A'}</td>
                                <td class="p-3">R$ ${parseFloat(item.preco || 0).toFixed(2)}</td>
                                <td class="p-3">${item.estoque || 0}</td>
                                <td class="text-center p-3">
                                    <button class="p-1 text-gray-500 hover:text-blue-600" data-id="${item.id}" data-action="edit"><i data-lucide="edit" class="w-5 h-5"></i></button>
                                    <button class="p-1 text-gray-500 hover:text-red-600" data-id="${item.id}" data-action="delete"><i data-lucide="trash-2" class="w-5 h-5"></i></button>
                                </td>
                            `;
                            tableBody.appendChild(tr);
                        });
                        lucide.createIcons(); // Re-render Lucide icons for new rows
                    };

                    // Firestore setup and real-time listener for products
                    if (window.db && window.userId) {
                        console.log('Setting up Firestore listener for products. User ID:', window.userId);
                        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
                        const productsColRef = collection(window.db, `artifacts/${appId}/users/${window.userId}/products`);
                        
                        onSnapshot(productsColRef, (snapshot) => {
                            const products = [];
                            snapshot.docs.forEach(doc => {
                                products.push({ id: doc.id, ...doc.data() });
                            });
                            renderProductsTable(products); // Render products whenever data changes
                        }, (error) => {
                            console.error("Error listening to products collection:", error);
                            window.showMessage("Erro ao carregar produtos.", "error");
                        });
                    } else {
                        console.warn("Firestore or User ID not available for product listener yet.");
                        tableBody.innerHTML = '<tr><td colspan="5" class="p-3 text-center text-gray-500">Aguardar autenticação para carregar produtos...</td></tr>';
                    }

                    // Event listeners for modal
                    addProductBtn.addEventListener('click', () => {
                        productForm.reset(); // Clear form on add
                        productForm.dataset.editingId = ''; // Clear editing ID
                        productModal.classList.remove('hidden');
                        productModal.querySelector('.modal-content').classList.remove('translate-y-[-20px]');
                    });
                    
                    const hideProductModal = () => {
                        productModal.querySelector('.modal-content').classList.add('translate-y-[-20px]');
                        // Use a timeout to allow animation to play before hiding
                        setTimeout(() => {
                            productModal.classList.add('hidden');
                        }, 300); // Match this with your CSS transition duration
                    };

                    closeModalBtn.addEventListener('click', hideProductModal);
                    cancelBtn.addEventListener('click', hideProductModal);

                    // Function to generate a unique internal barcode (shorter version)
                    const generateInternalBarcode = () => {
                        // Generate a random alphanumeric string (e.g., 6 characters long)
                        const randomString = Math.random().toString(36).substring(2, 8).toUpperCase(); 
                        // You can combine with a short timestamp for higher uniqueness if needed, but keeping it simple for shorter SKU
                        const barcode = `SKU-${randomString}`; 
                        const skuInput = productForm.querySelector('[name="product-sku"]');
                        if (skuInput) {
                            skuInput.value = barcode;
                            window.showMessage("Código SKU interno gerado!", "success");
                        } else {
                            window.showMessage("Campo de Código (SKU) não encontrado.", "error");
                        }
                    };

                    // Function to generate a unique GTIN/EAN (placeholder)
                    const generateGtinEan = () => {
                        const randomNumeric = Math.floor(100000000000 + Math.random() * 900000000000).toString(); // 12-digit number for EAN-13 like
                        const gtinEan = `GTIN-${randomNumeric}`;
                        const gtinEanInput = productForm.querySelector('[name="product-gtinean"]');
                        if (gtinEanInput) {
                            gtinEanInput.value = gtinEan;
                            window.showMessage("Código GTIN/EAN gerado!", "success");
                        } else {
                            window.showMessage("Campo de GTIN/EAN não encontrado.", "error");
                        }
                    };


                    // Event listener for the new barcode generation button
                    if (generateBarcodeBtn) {
                        generateBarcodeBtn.addEventListener('click', generateInternalBarcode);
                    }
                    // Event listener for the new GTIN/EAN generation button
                    if (generateGtinEanBtn) {
                        generateGtinEanBtn.addEventListener('click', generateGtinEan);
                    }


                    // Handle form submission for adding/editing product
                    productForm.addEventListener('submit', async (e) => {
                        e.preventDefault();
                        if (!window.db || !window.userId) {
                            window.showMessage("Erro: Utilizador não autenticado para guardar produto.", "error");
                            return;
                        }

                        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
                        const productsColRef = collection(window.db, `artifacts/${appId}/users/${window.userId}/products`);

                        const formData = new FormData(productForm);
                        const productData = {
                            descricao: formData.get('product-name') || '',
                            codigo: formData.get('product-sku') || '',
                            formato: formData.get('product-format') || '',
                            tipo: formData.get('product-type') || '',
                            condicao: formData.get('product-condition') || '',
                            ativado: formData.get('product-activated') === 'on',
                            preco: parseFloat(formData.get('product-price')) || 0,
                            estoque: parseInt(formData.get('product-stock'), 10) || 0,
                            unidade: formData.get('product-unit') || '',
                            
                            // New fields from the image
                            marca: formData.get('product-brand') || '',
                            producao: formData.get('product-production') || '',
                            dataValidade: formData.get('product-expiration-date') || '',
                            freteGratis: formData.get('product-free-shipping') || '',
                            pesoLiquido: parseFloat(formData.get('product-liquid-weight')) || 0,
                            pesoBruto: parseFloat(formData.get('product-gross-weight')) || 0,
                            largura: parseFloat(formData.get('product-width')) || 0,
                            altura: parseFloat(formData.get('product-height')) || 0,
                            profundidade: parseFloat(formData.get('product-depth')) || 0,
                            volumes: parseInt(formData.get('product-volumes'), 10) || 0,
                            itensPorCaixa: parseInt(formData.get('product-items-per-box'), 10) || 0,
                            unidadeMedida: formData.get('product-measurement-unit') || '',
                            gtinean: formData.get('product-gtinean') || '',
                            gtineanTributario: formData.get('product-gtinean-tax') || '',
                        };

                        const editingId = productForm.dataset.editingId;

                        try {
                            if (editingId) {
                                // Update existing product
                                await updateDoc(doc(window.db, `artifacts/${appId}/users/${window.userId}/products`, editingId), productData);
                                window.showMessage("Produto atualizado com sucesso!", "success");
                            } else {
                                // Add new product
                                await addDoc(productsColRef, productData);
                                window.showMessage("Produto guardado com sucesso!", "success");
                            }
                            hideProductModal();
                        } catch (error) {
                            console.error("Error saving product:", error);
                            window.showMessage("Erro ao guardar produto.", "error");
                        }
                    });

                    // Event delegation for table actions (edit/delete)
                    tableBody.addEventListener('click', async (e) => {
                        const targetButton = e.target.closest('button');
                        if (targetButton) {
                            const productId = targetButton.dataset.id;
                            const action = targetButton.dataset.action;

                            if (!window.db || !window.userId) {
                                window.showMessage("Erro: Utilizador não autenticado para realizar esta ação.", "error");
                                return;
                            }
                            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

                            if (action === 'delete') {
                                // In a real app, you'd show a confirmation modal
                                if (confirm('Tem a certeza que deseja excluir este produto?')) { // Using browser confirm for simplicity, but a custom modal is better.
                                    try {
                                        await deleteDoc(doc(window.db, `artifacts/${appId}/users/${window.userId}/products`, productId));
                                        window.showMessage("Produto excluído com sucesso!", "success");
                                    } catch (error) {
                                        console.error("Error deleting product:", error);
                                        window.showMessage("Erro ao excluir produto.", "error");
                                    }
                                }
                            } else if (action === 'edit') {
                                // Fetch product data and populate form
                                try {
                                    const productDoc = await getDoc(doc(window.db, `artifacts/${appId}/users/${window.userId}/products`, productId));
                                    if (productDoc.exists()) {
                                        const data = productDoc.data();
                                        productForm.dataset.editingId = productId; // Store ID for editing
                                        productForm.querySelector('[name="product-name"]').value = data.descricao || '';
                                        productForm.querySelector('[name="product-sku"]').value = data.codigo || '';
                                        productForm.querySelector('[name="product-format"]').value = data.formato || 'Simples';
                                        productForm.querySelector('[name="product-type"]').value = data.tipo || 'Produto';
                                        productForm.querySelector('[name="product-condition"]').value = data.condicao || 'Não Especificado';
                                        productForm.querySelector('[name="product-activated"]').checked = data.ativado;
                                        productForm.querySelector('[name="product-price"]').value = data.preco || 0;
                                        productForm.querySelector('[name="product-stock"]').value = data.estoque || 0;
                                        productForm.querySelector('[name="product-unit"]').value = data.unidade || '';

                                        // Populate new fields
                                        productForm.querySelector('[name="product-brand"]').value = data.marca || '';
                                        productForm.querySelector('[name="product-production"]').value = data.producao || '';
                                        productForm.querySelector('[name="product-expiration-date"]').value = data.dataValidade || '';
                                        productForm.querySelector('[name="product-free-shipping"]').value = data.freteGratis || '';
                                        productForm.querySelector('[name="product-liquid-weight"]').value = data.pesoLiquido || 0;
                                        productForm.querySelector('[name="product-gross-weight"]').value = data.pesoBruto || 0;
                                        productForm.querySelector('[name="product-width"]').value = data.largura || 0;
                                        productForm.querySelector('[name="product-height"]').value = data.altura || 0;
                                        productForm.querySelector('[name="product-depth"]').value = data.profundidade || 0;
                                        productForm.querySelector('[name="product-volumes"]').value = data.volumes || 0;
                                        productForm.querySelector('[name="product-items-per-box"]').value = data.itensPorCaixa || 0;
                                        productForm.querySelector('[name="product-measurement-unit"]').value = data.unidadeMedida || 'Centímetros';
                                        productForm.querySelector('[name="product-gtinean"]').value = data.gtinean || '';
                                        productForm.querySelector('[name="product-gtinean-tax"]').value = data.gtineanTributario || '';


                                        productModal.classList.remove('hidden');
                                        productModal.querySelector('.modal-content').classList.remove('translate-y-[-20px]');
                                    } else {
                                        window.showMessage("Produto não encontrado para edição.", "error");
                                    }
                                } catch (error) {
                                    console.error("Error fetching product for edit:", error);
                                    window.showMessage("Erro ao carregar produto para edição.", "error");
                                }
                            }
                        }
                    });

                    // Modal tab navigation logic
                    const modalTabs = document.getElementById('modal-tabs');
                    if (modalTabs) {
                        modalTabs.addEventListener('click', (e) => {
                            e.preventDefault();
                            const tabLink = e.target.closest('.tab-link');
                            if (tabLink) {
                                document.querySelectorAll('.tab-link').forEach(link => link.classList.remove('active', 'border-green-500', 'text-green-500'));
                                document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));

                                tabLink.classList.add('active', 'border-green-500', 'text-green-500');
                                const targetTabId = tabLink.dataset.tab;
                                document.getElementById(targetTabId).classList.add('active');
                            }
                        });
                    }
                };

                const runClientesFornecedoresScript = () => {
                    const tableBody = document.getElementById('cs-table-body');
                    const renderTable = (data) => {
                        tableBody.innerHTML = '';
                        if (data.length === 0) {
                            tableBody.innerHTML = '<tr><td colspan="4" class="p-3 text-center text-gray-500">Nenhum cliente ou fornecedor registado ainda.</td></tr>';
                            return;
                        }
                        data.forEach(item => {
                            const tr = document.createElement('tr');
                            tr.innerHTML = `
                                <td class="p-3">${item.nome}</td>
                                <td class="p-3">${item.cpf || item.cnpj}</td>
                                <td class="p-3">${item.tipo}</td>
                                <td class="text-center p-3">
                                    <button class="p-1 text-gray-500 hover:text-blue-600"><i data-lucide="edit" class="w-5 h-5"></i></button>
                                </td>
                            `;
                            tableBody.appendChild(tr);
                        });
                        lucide.createIcons();
                    };
                    renderTable(clientsAndSuppliers); // Using dummy data for now
                };

                // Templates HTML
                const dashboardHtml = `<div class="p-8"><h1 class="text-3xl font-bold text-gray-800 mb-8">Dashboard</h1><div class="bg-white p-6 rounded-lg shadow"><p>Bem-vindo ao seu sistema!</p><p class="mt-2 text-sm text-gray-600">Este é um ambiente de demonstração com persistência de dados via Firestore.</p></div></div>`;
                const vendasHtml = `<div class="p-8"><h1 class="text-3xl font-bold text-gray-800 mb-8">Gestão de Vendas</h1><div class="bg-white p-6 rounded-lg shadow"><p>Página de Vendas em construção.</p></div></div>`;
                const estoqueHtml = `<div class="p-8"><h1 class="text-3xl font-bold text-gray-800 mb-8">Controle de Inventário</h1><div class="bg-white p-6 rounded-lg shadow"><p>Página de Inventário em construção.</p></div></div>`;
                const financeiroHtml = `<div class="p-8"><h1 class="text-3xl font-bold text-gray-800 mb-8">Gestão Financeira</h1><div class="bg-white p-6 rounded-lg shadow"><p>Página Financeira em construção.</p></div></div>`;
                const productSystemHtml = `<div class="flex h-full overflow-hidden"><aside class="w-72 bg-gray-800 text-white p-4 space-y-4 overflow-y-auto flex-shrink-0"><div class="flex items-center justify-between"><h2 class="text-xl font-bold">Filtros</h2><button id="clear-filters-btn" class="text-sm text-gray-400 hover:text-white">Limpar</button></div><div class="space-y-3"><div><label for="filter-situacao" class="text-sm font-medium">Situação</label><select id="filter-situacao" class="w-full mt-1 bg-gray-700 border-gray-600 rounded-md px-2 py-1.5 text-sm"><option value="">Todos</option><option value="ativo">Ativo</option><option value="inativo">Inativo</option></select></div><div><label for="filter-estoque" class="text-sm font-medium">Inventário</label><select id="filter-estoque" class="w-full mt-1 bg-gray-700 border-gray-600 rounded-md px-2 py-1.5 text-sm"><option value="">Qualquer</option><option value="com_estoque">Com inventário</option><option value="sem_estoque">Sem inventário</option></select></div></div></aside><main class="flex-1 flex flex-col overflow-hidden"><header class="bg-white p-4 px-8 flex items-center justify-between flex-shrink-0 border-b"><div><h1 class="text-2xl font-bold text-gray-800">Produtos</h1></div><div class="flex items-center gap-4"><button id="add-product-btn" class="bg-blue-500 hover:bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg flex items-center gap-2"><i data-lucide="plus" class="w-5 h-5"></i> Adicionar Produto</button></div></header><div class="flex-1 overflow-y-auto p-8"><div class="bg-white rounded-lg shadow overflow-hidden"><table class="w-full"><thead class="bg-gray-50"><tr><th class="p-3 text-left text-xs font-semibold text-gray-600 uppercase">Descrição</th><th class="p-3 text-left text-xs font-semibold text-gray-600 uppercase">Código</th><th class="p-3 text-left text-xs font-semibold text-gray-600 uppercase">Preço</th><th class="p-3 text-left text-xs font-semibold text-gray-600 uppercase">Inventário</th><th class="p-3 text-center text-xs font-semibold text-gray-600 uppercase">Ações</th></tr></thead><tbody id="product-table-body" class="divide-y divide-gray-200"></tbody></table></div></div></main></div>`;
                const clientesFornecedoresHtml = `<main class="flex-1 flex flex-col overflow-hidden"><header class="bg-white p-4 px-8 flex items-center justify-between flex-shrink-0 border-b"><div><h1 class="text-2xl font-bold text-gray-800">Clientes e Fornecedores</h1></div><div class="flex items-center gap-4"><button id="add-cs-btn" class="bg-blue-500 hover:bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg flex items-center gap-2"><i data-lucide="plus" class="w-5 h-5"></i> Adicionar</button></div></header><div class="flex-1 overflow-y-auto p-8"><div class="bg-white rounded-lg shadow overflow-hidden"><table class="w-full"><thead class="bg-gray-50"><tr><th class="p-3 text-left text-xs font-semibold text-gray-600 uppercase">Nome</th><th class="p-3 text-left text-xs font-semibold text-gray-600 uppercase">Documento</th><th class="p-3 text-left text-xs font-semibold text-gray-600 uppercase">Tipo</th><th class="p-3 text-center text-xs font-semibold text-gray-600 uppercase">Ações</th></tr></thead><tbody id="cs-table-body" class="divide-y divide-gray-200"></tbody></table></div></div></main>`;
                const productModalHtml = `<div id="product-modal" class="modal hidden fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-60"><div class="modal-content bg-gray-800 text-white rounded-lg shadow-xl w-full max-w-5xl max-h-[95vh] flex flex-col"><div class="p-4 flex justify-between items-center border-b border-gray-700"><h3 class="text-xl font-semibold">Produtos</h3><div class="flex gap-4"><button id="product-modal-cancel" class="border border-gray-600 hover:bg-gray-700 font-semibold py-2 px-4 rounded-lg">Cancelar</button><button type="submit" form="product-form" class="bg-green-600 hover:bg-green-700 font-semibold py-2 px-4 rounded-lg">Guardar produto</button></div></div><form id="product-form" class="flex-1 overflow-y-auto p-6 space-y-6"><div class="grid grid-cols-12 gap-6"><div class="col-span-8 space-y-4"><label class="block text-sm">Nome*</label><input type="text" name="product-name" required class="w-full bg-gray-700 border border-gray-600 rounded-md p-2"></div><div class="col-span-4 space-y-4"><label class="block text-sm">Código (SKU)</label><div class="flex gap-2 mt-1"><input type="text" name="product-sku" class="w-full bg-gray-700 border border-gray-600 rounded-md p-2"><button type="button" id="generate-barcode-btn" class="bg-blue-500 hover:bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg text-sm flex-shrink-0">Gerar Interno</button></div></div><div class="col-span-3 flex items-center justify-center bg-gray-700 rounded-md border-2 border-dashed border-gray-600 h-40"><i data-lucide="image" class="w-10 h-10 text-gray-500"></i></div><div class="col-span-9 grid grid-cols-3 gap-4"><div><label class="block text-sm">Formato</label><select name="product-format" class="w-full bg-gray-700 border border-gray-600 rounded-md p-2 mt-1"><option>Simples</option></select></div><div><label class="block text-sm">Tipo</label><select name="product-type" class="w-full bg-gray-700 border border-gray-600 rounded-md p-2 mt-1"><option>Produto</option></select></div><div><label class="block text-sm">Condição</label><select name="product-condition" class="w-full bg-gray-700 border border-gray-600 rounded-md p-2 mt-1"><option>Não Especificado</option></select></div><div><label class="block text-sm">Situação</label><div class="flex items-center gap-2 mt-2"><input type="checkbox" name="product-activated" checked class="form-checkbox h-5 w-5 bg-gray-700 border-gray-600 text-green-500 focus:ring-green-500 rounded"><span>Ativado</span></div></div><div><label class="block text-sm">Preço Venda</label><input type="number" step="0.01" name="product-price" class="w-full bg-gray-700 border border-gray-600 rounded-md p-2 mt-1"></div><div><label class="block text-sm">Inventário</label><input type="number" name="product-stock" class="w-full bg-gray-700 border border-gray-600 rounded-md p-2 mt-1"></div><div><label class="block text-sm">Unidade</label><input type="text" name="product-unit" class="w-full bg-gray-700 border border-gray-600 rounded-md p-2 mt-1"></div></div></div><div class="border-b border-gray-700"><nav class="-mb-px flex space-x-6" id="modal-tabs"><a href="#" class="tab-link active whitespace-nowrap py-3 px-1 border-b-2 font-medium text-sm border-green-500 text-green-500" data-tab="caracteristicas">Características</a><a href="#" class="tab-link whitespace-nowrap py-3 px-1 border-b-2 font-medium text-sm border-transparent text-gray-400 hover:border-gray-300" data-tab="imagens">Imagens</a><a href="#" class="tab-link whitespace-nowrap py-3 px-1 border-b-2 font-medium text-sm border-transparent text-gray-400 hover:border-gray-300" data-tab="estoque">Inventário</a><a href="#" class="tab-link whitespace-nowrap py-3 px-1 border-b-2 font-medium text-sm border-transparent text-gray-400 hover:border-gray-300" data-tab="novo">Novo</a><a href="#" class="tab-link whitespace-nowrap py-3 px-1 border-b-2 font-medium text-sm border-transparent text-gray-400 hover:border-gray-300" data-tab="fornecedores">Fornecedores</a><a href="#" class="tab-link whitespace-nowrap py-3 px-1 border-b-2 font-medium text-sm border-transparent text-gray-400 hover:border-gray-300" data-tab="tributacao">Tributação</a></nav></div><div id="tab-content-container" class="pt-6"><div id="caracteristicas" class="tab-content active grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4"><!-- New fields added here --><div class="space-y-4"><label class="block text-sm">Marca</label><input type="text" name="product-brand" class="w-full bg-gray-700 border border-gray-600 rounded-md p-2"></div><div class="space-y-4"><label class="block text-sm">Produção</label><select name="product-production" class="w-full bg-gray-700 border border-gray-600 rounded-md p-2"><option>Própria</option><option>Terceirizada</option></select></div><div class="space-y-4"><label class="block text-sm">Data de Validade</label><input type="date" name="product-expiration-date" class="w-full bg-gray-700 border border-gray-600 rounded-md p-2"></div><div class="space-y-4"><label class="block text-sm">Frete Grátis</label><select name="product-free-shipping" class="w-full bg-gray-700 border border-gray-600 rounded-md p-2"><option>Não</option><option>Sim</option></select></div><div class="space-y-4"><label class="block text-sm">Peso Líquido</label><input type="number" step="0.01" name="product-liquid-weight" class="w-full bg-gray-700 border border-gray-600 rounded-md p-2"></div><div class="space-y-4"><label class="block text-sm">Peso Bruto</label><input type="number" step="0.01" name="product-gross-weight" class="w-full bg-gray-700 border border-gray-600 rounded-md p-2"></div><div class="space-y-4"><label class="block text-sm">Largura</label><input type="number" step="0.01" name="product-width" class="w-full bg-gray-700 border border-gray-600 rounded-md p-2"></div><div class="space-y-4"><label class="block text-sm">Altura</label><input type="number" step="0.01" name="product-height" class="w-full bg-gray-700 border border-gray-600 rounded-md p-2"></div><div class="space-y-4"><label class="block text-sm">Profundidade</label><input type="number" step="0.01" name="product-depth" class="w-full bg-gray-700 border border-gray-600 rounded-md p-2"></div><div class="space-y-4"><label class="block text-sm">Volumes</label><input type="number" name="product-volumes" class="w-full bg-gray-700 border border-gray-600 rounded-md p-2"></div><div class="space-y-4"><label class="block text-sm">Itens p/ caixa</label><input type="number" name="product-items-per-box" class="w-full bg-gray-700 border border-gray-600 rounded-md p-2"></div><div class="space-y-4"><label class="block text-sm">Unidade de medida</label><select name="product-measurement-unit" class="w-full bg-gray-700 border border-gray-600 rounded-md p-2"><option>Centímetros</option><option>Metros</option><option>Polegadas</option></select></div><div class="space-y-4"><label class="block text-sm">GTIN/EAN</label><div class="flex gap-2 mt-1"><input type="text" name="product-gtinean" class="w-full bg-gray-700 border border-gray-600 rounded-md p-2" placeholder="SEM GTIN"><button type="button" id="generate-gtinean-btn" class="bg-blue-500 hover:bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg text-sm flex-shrink-0">Gerar Automático</button></div></div><div class="space-y-4"><label class="block text-sm">GTIN/EAN tributário</label><input type="text" name="product-gtinean-tax" class="w-full bg-gray-700 border border-gray-600 rounded-md p-2" placeholder="SEM GTIN"></div></div><div id="imagens" class="tab-content"></div><div id="estoque" class="tab-content"></div><div id="novo" class="tab-content"></div><div id="fornecedores" class="tab-content"></div><div id="tributacao" class="tab-content"></div></div></form><button id="product-modal-close" class="absolute top-4 right-4 text-gray-400 hover:text-white"><i data-lucide="x" class="w-6 h-6"></i></button></div></div>`;
                
                document.getElementById('nav-dashboard').addEventListener('click', (e) => { e.preventDefault(); showPage(dashboardHtml, 'nav-dashboard'); });
                document.getElementById('nav-vendas').addEventListener('click', (e) => { e.preventDefault(); showPage(vendasHtml, 'nav-vendas'); });
                document.getElementById('nav-estoque').addEventListener('click', (e) => { e.preventDefault(); showPage(estoqueHtml, 'nav-estoque'); });
                document.getElementById('nav-financeiro').addEventListener('click', (e) => { e.preventDefault(); showPage(financeiroHtml, 'nav-financeiro'); });
                
                // When navigating to Products, inject the product modal HTML as well
                document.getElementById('link-produtos').addEventListener('click', (e) => { 
                    e.preventDefault(); 
                    showPage(productSystemHtml, 'nav-catalogo', runProductSystemScript, productModalHtml); 
                });
                document.getElementById('link-clientes-fornecedores').addEventListener('click', (e) => { e.preventDefault(); showPage(clientesFornecedoresHtml, 'nav-catalogo', runClientesFornecedoresScript); });

                // Initial page load for the dashboard
                showPage(dashboardHtml, 'nav-dashboard');
                lucide.createIcons();
            };

            // This ensures initializeDashboard runs only once after the DOM is ready and Firebase auth is set up.
            // If the dashboard is already active (e.g., after login), it will re-initialize after auth is ready.
            if (dashboardPage.classList.contains('active')) {
                await waitForAuth();
                if (!window.dashboardInitialized) {
                    initializeDashboard();
                    window.dashboardInitialized = true;
                }
            }
        });

        lucide.createIcons(); // Initialize icons for the login page
    </script>
</body>
</html>
