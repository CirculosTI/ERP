<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema Círculos</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #e5e7eb; }
        ::-webkit-scrollbar-thumb { background: #9ca3af; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #6b7280; }
        
        .page, .content-section { display: none; }
        .page.active { display: block; }
        #dashboard-page.active { display: flex; flex-direction: column; }
        .content-section.active { display: block; }
        .content-section.flex-active { display: flex; }

        .login-bg {
            background-image: linear-gradient(rgba(0, 0, 0, 0.6), rgba(0, 0, 0, 0.6)), url('https://i.imgur.com/9x4CHMr.png');
            background-size: cover;
            background-position: center;
        }

        .nav-link.active {
             border-bottom-color: #3b82f6; /* Azul */
             color: #3b82f6;
        }
        .dropdown:hover .dropdown-menu { display: block; }
        .dropdown-menu {
            display: none;
            animation: fadeIn 0.2s ease-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .tab-link.active {
            border-color: #22c55e; /* green-500 */
            color: #22c55e;
        }
        /* Important: Ensure these base styles are not overridden by other CSS rules */
        .tab-content { display: none; }
        .tab-content.active { display: block; }

        /* Modal specific styles */
        .modal {
            transition: opacity 0.3s ease-in-out, visibility 0.3s ease-in-out;
        }
        .modal.hidden {
            opacity: 0;
            visibility: hidden;
        }
        .modal:not(.hidden) {
            opacity: 1;
            visibility: visible;
        }
        .modal-content {
            transform: translateY(-20px);
            transition: transform 0.3s ease-in-out;
        }
        .modal:not(.hidden) .modal-content {
            transform: translateY(0);
        }
        /* Custom message box for alerts */
        #message-box {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
            display: none;
            padding: 1rem;
            border-radius: 0.5rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .message-box-success {
            background-color: #d1fae5;
            color: #065f46;
        }
        .message-box-error {
            background-color: #fee2e2;
            color: #991b1b;
        }
        /* Custom styles for product listing to match the image */
        .product-listing-header {
            background-color: #1a1a1a; /* Dark background from image */
            color: #e0e0e0;
        }
        .product-search-input-dark {
            background-color: #333;
            border-color: #555;
            color: #e0e0e0;
        }
        .filter-chip {
            background-color: #444;
            color: #eee;
            border-radius: 0.375rem; /* rounded-md */
            padding: 0.25rem 0.625rem; /* px-2.5 py-1 */
            font-size: 0.875rem; /* text-sm */
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
        }
        .filter-chip-clear {
            background-color: transparent;
            color: #aaa;
        }
        .product-table-dark {
            background-color: #222;
            color: #ccc;
        }
        .product-table-dark th {
            background-color: #333;
            color: #e0e0e0;
        }
        .product-table-dark tr:nth-child(even) {
            background-color: #2a2a2a;
        }
        .product-table-dark tr:hover {
            background-color: #3a3a3a;
        }
        .product-table-dark td {
            border-bottom: 1px solid #444;
        }
        .product-table-dark tr.selected-row {
            background-color: #3b82f630; /* Light blue tint for selected rows */
        }

        /* Calendar Picker Specific Styles */
        .date-picker-modal-content {
            background-color: #1a1a1a;
            color: #e0e0e0;
            border-radius: 0.5rem;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.5);
        }
        .calendar-nav-btn {
            background-color: #333;
            color: #e0e0e0;
            padding: 0.25rem 0.5rem;
            border-radius: 0.25rem;
            transition: background-color 0.2s;
        }
        .calendar-nav-btn:hover {
            background-color: #555;
        }
        .calendar-day {
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 0.25rem;
            cursor: pointer;
            transition: background-color 0.2s, color 0.2s;
            font-size: 0.875rem; /* text-sm */
        }
        .calendar-day.current-month {
            color: #e0e0e0;
        }
        .calendar-day.other-month {
            color: #666;
        }
        .calendar-day.selected {
            background-color: #22c55e; /* green-500 */
            color: white;
            font-weight: 600;
        }
        .calendar-day.range-selected {
            background-color: #1a563a; /* darker green for range */
            color: white;
        }
        .calendar-day.today {
            border: 1px solid #22c55e;
        }
        .quick-select-btn {
            background-color: #333;
            color: #e0e0e0;
            padding: 0.5rem 0.75rem;
            border-radius: 0.375rem;
            text-align: left;
            width: 100%;
            transition: background-color 0.2s;
            font-size: 0.875rem;
        }
        .quick-select-btn:hover {
            background-color: #444;
        }
        .quick-select-btn.active-preset {
            background-color: #22c55e;
            color: white;
            font-weight: 600;
        }
    </style>
    <!-- Supabase SDKs - ALL IMPORTS CONSOLIDATED AND MADE GLOBALLY AVAILABLE HERE -->
    <script type="module">
        import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

        // Global variables for Supabase instances
        window.supabase = null;
        window.userId = null;
        window.isAuthReady = false;
        window.appId = 'default-app-id'; // Global appId, initialized with default

        // Utility function for showing messages - now global
        window.showMessage = function(message, type = 'success') {
            const messageBox = document.getElementById('message-box');
            const messageText = document.getElementById('message-text');
            if (type === 'hide') {
                messageBox.style.display = 'none';
                return;
            }
            messageText.textContent = message;
            messageBox.classList.remove('message-box-success', 'message-box-error');
            messageBox.classList.add(`message-box-${type}`);
            messageBox.style.display = 'block';
            setTimeout(() => {
                messageBox.style.display = 'none';
            }, 5000);
        };

        // Function to initialize Supabase and attempt authentication
        window.initSupabaseAndAuth = async () => {
            console.log("initSupabaseAndAuth: Starting Supabase initialization and authentication.");

            // ==============================================================================================
            // === ATENÇÃO EXTREMA: CONFIGURAÇÃO DO SUPABASE É OBRIGATÓRIA!                                ===
            // ===                                                                                          ===
            // === Por favor, SUBSTITUA OS PLACEHOLDERS ABAIXO com o SEU URL e CHAVE ANON REAIS do Supabase. ===
            // === Encontrará estas credenciais no seu painel Supabase em 'Settings' -> 'API'.               ===
            // ===                                                                                          ===
            // === O URL deve começar com 'https://' (ex: https://abcde12345.supabase.co).                 ===
            // === A Chave Anon é uma string longa que começa com 'eyJ...'.                                  ===
            // ===                                                                                          ===
            // === NÃO DEIXE ESTES VALORES COMO PLACEHOLDERS!                                              ===
            // ==============================================================================================
            let localSupabaseUrl = "https://bmgkulpexiqibbgwwxcx.supabase.co"; // <--- COLOQUE O SEU URL REAL DO SUPABASE AQUI! EX: "https://abcdefghijk.supabase.co"
            let localSupabaseAnonKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJtZ2t1bHBleGlxaWJiZ3d3eGN4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ0MDU0ODUsImV4cCI6MjA2OTk4MTQ4NX0.JClBYIz7CbnHkn04LWYEtVzoz66FMSfR1Mjg-LRUqjI"; // <--- COLOQUE A SUA CHAVE ANON REAL DO SUPABASE AQUI! EX: "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFiY2RlZmdoamlrIiwicm9sZSI6ImFub24iLCJpYXQiOjE2NzgwODk2MDAsImV4cCI6MTk5MzY2NTYwMH0.1234567890abcdefghijklmnopqrstuvwxyz"
            // ==============================================================================================


            // Determine Supabase credentials and appId
            let finalSupabaseUrl = localSupabaseUrl;
            let finalSupabaseAnonKey = localSupabaseAnonKey;

            // Debugging: Log what is being passed from Canvas globals
            console.log("Canvas global __supabase_url:", typeof __supabase_url !== 'undefined' ? __supabase_url : 'undefined');
            console.log("Canvas global __supabase_anon_key:", typeof __supabase_anon_key !== 'undefined' ? (__supabase_anon_key.substring(0, 10) + '...') : 'undefined');


            // Check if Canvas global variables are provided and valid
            if (typeof __supabase_url !== 'undefined' && typeof __supabase_url === 'string' && __supabase_url.trim() !== '') {
                finalSupabaseUrl = __supabase_url;
                console.log("initSupabaseAndAuth: Using Supabase URL from Canvas globals.");
            } else {
                console.log("initSupabaseAndAuth: __supabase_url not found or invalid in Canvas globals. Using local default.");
            }

            if (typeof __supabase_anon_key !== 'undefined' && typeof __supabase_anon_key === 'string' && __supabase_anon_key.trim() !== '') {
                finalSupabaseAnonKey = __supabase_anon_key;
                console.log("initSupabaseAndAuth: Using Supabase Anon Key from Canvas globals.");
            } else {
                console.log("initSupabaseAndAuth: __supabase_anon_key not found or invalid in Canvas globals. Using local default.");
            }

            if (typeof __app_id !== 'undefined' && typeof __app_id === 'string' && __app_id.trim() !== '') {
                window.appId = __app_id;
                console.log("initSupabaseAndAuth: App ID loaded from Canvas globals:", window.appId);
            } else {
                console.log("initSupabaseAndAuth: __app_id not found or invalid. Using default appId:", window.appId);
            }
            
            // Log the final determined keys before checking for placeholders
            console.log(`initSupabaseAndAuth: Final Supabase URL a ser usado: ${finalSupabaseUrl}`);
            console.log(`initSupabaseAndAuth: Final Supabase Anon Key a ser usado: ${finalSupabaseAnonKey.substring(0, 10)}... (truncado por segurança)`);


            // Check if user has replaced placeholders for local development
            const defaultSupabaseUrlPlaceholder = "https://your-project-id.supabase.co"; // This is the placeholder URL
            const defaultSupabaseAnonKeyPlaceholder = "YOUR_SUPABASE_ANON_KEY_HERE_FROM_SUPABASE_DASHBOARD"; // This is the placeholder key

            if (finalSupabaseUrl === defaultSupabaseUrlPlaceholder || finalSupabaseAnonKey === defaultSupabaseAnonKeyPlaceholder) {
                console.error("initSupabaseAndAuth: ERRO CRÍTICO: Supabase URL ou Chave Anon não configurados. Por favor, atualize os placeholders no código ou garanta que as variáveis do Canvas estão definidas.");
                window.showMessage("Erro: Credenciais do Supabase ausentes ou padrão. Por favor, edite o código para inserir o seu URL e Chave Anon reais do Supabase. Verifique os comentários na secção 'CONFIGURAÇÃO DO SUPABASE' no script!", "error");
                window.isAuthReady = true; // Mark as ready to avoid infinite loading, but auth will fail

                // Display a prominent warning on the login page itself
                const loginErrorMessageDiv = document.getElementById('login-error-message');
                if (loginErrorMessageDiv) {
                    loginErrorMessageDiv.textContent = "ERRO: Credenciais do Supabase não configuradas. Por favor, edite o código para inserir o seu URL e Chave Anon reais.";
                    loginErrorMessageDiv.classList.remove('hidden');
                }
                return;
            }

            // Create Supabase client
            window.supabase = createClient(finalSupabaseUrl, finalSupabaseAnonKey);
            console.log("initSupabaseAndAuth: Supabase client created.");


            if (!window.supabase) {
                console.error("initSupabaseAndAuth: Supabase client failed to initialize.");
                window.showMessage("Erro: Falha ao inicializar o Supabase.", "error");
                window.isAuthReady = true;
                return;
            }

            // Listen for auth changes
            window.supabase.auth.onAuthStateChange((event, session) => {
                console.log('Supabase auth state changed:', event, session);
                if (session) {
                    window.userId = session.user.id;
                    console.log('Supabase User ID obtained:', window.userId);
                    const userIdDisplay = document.getElementById('user-id-display');
                    if (userIdDisplay) {
                        userIdDisplay.textContent = `ID do Utilizador: ${window.userId}`;
                        console.log('User ID display updated to:', userIdDisplay.textContent);
                    } else {
                        console.warn('user-id-display element not found yet.');
                    }
                } else {
                    window.userId = null;
                    console.log('No Supabase user session.');
                    const userIdDisplay = document.getElementById('user-id-display');
                    if (userIdDisplay) {
                        userIdDisplay.textContent = `ID do Utilizador: Não autenticado`;
                    }
                }
                window.isAuthReady = true;
                console.log('Auth process finished. isAuthReady:', window.isAuthReady);
                // If dashboard is already active and not initialized, initialize it now
                if (document.getElementById('dashboard-page').classList.contains('active') && !window.dashboardInitialized) {
                    console.log('initSupabaseAndAuth: Calling initializeDashboard from onAuthStateChange.');
                    window.initializeDashboard();
                    window.dashboardInitialized = true;
                }
            });

            // Check current session immediately after setting up listener
            const { data: { session } = { data: { session: null } } } = await window.supabase.auth.getSession();
            if (session) {
                window.userId = session.user.id;
                console.log('initSupabaseAndAuth: Existing session found for User ID:', window.userId);
                const userIdDisplay = document.getElementById('user-id-display');
                if (userIdDisplay) {
                    userIdDisplay.textContent = `ID do Utilizador: ${window.userId}`;
                }
            } else {
                window.userId = null;
                console.log('initSupabaseAndAuth: No existing Supabase session.');
                const userIdDisplay = document.getElementById('user-id-display');
                if (userIdDisplay) {
                    userIdDisplay.textContent = `ID do Utilizador: Não autenticado`;
                }
            }
            window.isAuthReady = true; // Mark as ready after initial session check
            console.log('initSupabaseAndAuth: Initial session check complete. isAuthReady:', window.isAuthReady);
            if (document.getElementById('dashboard-page').classList.contains('active') && !window.dashboardInitialized) {
                console.log('initSupabaseAndAuth: Calling initializeDashboard after initial session check.');
                window.initializeDashboard();
                window.dashboardInitialized = true;
            }
        };

        // Call the new initialization function once the DOM is fully loaded
        document.addEventListener('DOMContentLoaded', () => {
            console.log("DOMContentLoaded fired."); // Debugging line
            window.initSupabaseAndAuth();
        });
    </script>
</head>
<body>

    <!-- Message Box for alerts -->
    <div id="message-box" class="message-box-success">
        <span id="message-text"></span>
        <button class="float-right ml-4 text-sm font-semibold" onclick="window.showMessage('', 'hide')">&times;</button>
    </div>

    <!-- PÁGINA DE LOGIN -->
    <div id="login-page" class="page active">
        <div class="min-h-screen flex flex-col items-center justify-center px-4 login-bg">
            <div class="w-full max-w-md">
                <div class="text-center mb-8">
                    <img src="https://i.imgur.com/gM6495x.png" alt="Logo Círculos" class="mx-auto h-28 w-auto">
                    <p class="text-gray-200 mt-4 text-lg">Aceda à sua conta para gerir o seu negócio.</p>
                </div>
                <div class="bg-white rounded-xl shadow-lg p-8">
                    <div id="login-error-message" class="hidden text-red-500 text-center mb-4 font-bold"></div>
                    <form id="login-form">
                        <div class="space-y-6">
                            <div>
                                <label for="email" class="block text-sm font-medium text-gray-700">Email</label>
                                <div class="mt-1 relative">
                                    <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none"><i data-lucide="mail" class="w-5 h-5 text-gray-400"></i></div>
                                    <input type="email" id="email" name="email" required class="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-400" placeholder="voce@email.com">
                                </div>
                            </div>
                            <div>
                                <div class="flex justify-between items-center">
                                    <label for="password" class="block text-sm font-medium text-gray-700">Senha</label>
                                    <a href="#" class="text-sm text-blue-500 hover:underline">Esqueceu a senha?</a>
                                </div>
                                <div class="mt-1 relative">
                                    <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none"><i data-lucide="lock" class="w-5 h-5 text-gray-400"></i></div>
                                    <input type="password" id="password" name="password" required class="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-400" placeholder="Sua senha">
                                </div>
                            </div>
                            <div>
                                <button type="submit" class="w-full bg-blue-500 text-white font-semibold py-2.5 px-4 rounded-md hover:bg-blue-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition-colors">Entrar</button>
                            </div>
                        </div>
                    </form>
                    <div class="mt-6 text-center">
                        <a href="#" id="signup-link" class="font-medium text-blue-500 hover:text-blue-600">Crie a sua conta gratuitamente</a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- PAINEL PRINCIPAL DO SISTEMA -->
    <div id="dashboard-page" class="page h-screen">
        <header class="bg-white text-gray-800 shadow-md z-20 border-b">
            <div class="w-full px-6 flex justify-between items-center">
                <div class="h-16 flex items-center">
                    <img src="https://i.imgur.com/0ooTC9z.png" alt="Logo Círculos" class="h-10 w-auto">
                    <span id="user-id-display" class="ml-4 text-xs text-gray-500">ID do Utilizador: A carregar...</span>
                </div>
                <nav class="flex items-center h-full text-sm font-medium text-gray-600">
                    <a href="#" id="nav-dashboard" class="nav-link h-16 flex items-center px-4 hover:bg-gray-100 transition-colors border-b-2 border-transparent">Dashboard</a>
                    <div class="dropdown relative h-16 flex items-center">
                        <button id="nav-catalogo" class="nav-link h-full flex items-center px-4 hover:bg-gray-100 transition-colors gap-2 border-b-2 border-transparent">
                            <span>Registos</span><i data-lucide="chevron-down" class="w-4 h-4"></i>
                        </button>
                        <div class="dropdown-menu absolute left-0 mt-16 w-56 bg-white rounded-b-md shadow-lg py-1 z-30 text-gray-800 border-t">
                            <a href="#" id="link-produtos" class="block px-4 py-2 text-sm hover:bg-gray-100">Produtos</a>
                            <a href="#" id="link-clientes-fornecedores" class="block px-4 py-2 text-sm hover:bg-gray-100">Clientes e Fornecedores</a>
                        </div>
                    </div>
                    <a href="#" id="nav-vendas" class="nav-link h-16 flex items-center px-4 hover:bg-gray-100 transition-colors border-b-2 border-transparent">Vendas</a>
                    <a href="#" id="nav-estoque" class="nav-link h-16 flex items-center px-4 hover:bg-gray-100 transition-colors border-b-2 border-transparent">Inventário</a>
                    <a href="#" id="nav-financeiro" class="nav-link h-16 flex items-center px-4 hover:bg-gray-100 transition-colors border-b-2 border-transparent">Financeiro</a>
                </nav>
            </div>
        </header>
        <main id="page-content" class="flex-1 overflow-y-auto bg-gray-50 p-6"></main> <!-- Added p-6 for spacing -->
        <div id="modal-container"></div>
    </div>

    <!-- MODAL DE REGISTO (MOVIDO PARA FORA DO DASHBOARD) -->
    <div id="register-modal" class="modal hidden fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-60">
        <div class="modal-content bg-white rounded-lg shadow-xl w-full max-w-md p-6">
            <div class="flex justify-between items-center border-b pb-3 mb-4">
                <h3 class="text-xl font-semibold text-gray-800">Crie a sua conta</h3>
                <button id="register-modal-close" class="text-gray-400 hover:text-gray-600 p-1.5 rounded-md"><i data-lucide="x" class="w-5 h-5"></i></button>
            </div>
            <form id="register-form" class="space-y-4">
                <div>
                    <label for="register-name" class="block text-sm font-medium text-gray-700">Nome Completo</label>
                    <input type="text" id="register-name" name="name" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 focus:outline-none focus:ring-2 focus:ring-blue-400" placeholder="O seu nome">
                </div>
                <div>
                    <label for="register-email" class="block text-sm font-medium text-gray-700">Email</label>
                    <input type="email" id="register-email" name="email" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 focus:outline-none focus:ring-2 focus:ring-blue-400" placeholder="o-seu@email.com">
                </div>
                <div>
                    <label for="register-phone" class="block text-sm font-medium text-gray-700">Telefone</label>
                    <input type="tel" id="register-phone" name="phone" class="mt-1 block w-full border border-gray-300 rounded-md p-2 shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-400" placeholder="(XX) XXXXX-XXXX">
                </div>
                <div>
                    <label for="register-password" class="block text-sm font-medium text-gray-700">Senha</label>
                    <input type="password" id="register-password" name="password" required class="mt-1 block w-full border border-gray-300 rounded-md p-2 shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-400" placeholder="Crie uma senha segura">
                </div>
                <div>
                    <button type="submit" class="w-full bg-green-500 text-white font-semibold py-2.5 px-4 rounded-md hover:bg-green-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 transition-colors">Registar</button>
                </div>
            </form>
        </div>
    </div>

    <script type="module">
        // This function will be called after Supabase init and auth attempt
        window.initializeDashboard = () => {
            console.log('initializeDashboard started.');
            const pageContent = document.getElementById('page-content');
            const modalContainer = document.getElementById('modal-container');
            const navLinks = document.querySelectorAll('.nav-link');

            // Initial dummy data for clients and suppliers (will be replaced by Supabase later)
            let clientsAndSuppliers = [
                { id: 1, tipo: 'Cliente', pessoa: 'Física', nome: 'João da Silva', cpf: '123.456.789-00', email: 'joao.silva@email.com', telefone: '(11) 98765-4321' },
            ];

            const setActiveLink = (id) => {
                navLinks.forEach(link => {
                    link.classList.remove('active', 'text-blue-500', 'border-blue-500');
                    link.classList.add('border-transparent');
                });
                const activeLink = document.getElementById(id);
                if (activeLink) {
                    activeLink.classList.add('active', 'text-blue-500', 'border-blue-500');
                    activeLink.classList.remove('border-transparent');
                }
            };

            const showPage = (pageHtml, navId, scriptRunner, modalHtml = '') => {
                // Esta função carrega o conteúdo HTML de uma "página" separada na área principal do dashboard.
                // Isso garante que cada secção de navegação (Dashboard, Produtos, Clientes, etc.)
                // tenha a sua própria área de conteúdo distinta.
                console.log(`showPage called for navId: ${navId}`); // Debugging: track page changes
                pageContent.innerHTML = pageHtml;
                // Adiciona o HTML do modal ao modalContainer apenas se não for o modal de registo.
                // O modal de registo é uma parte estática da estrutura do body.
                if (modalHtml && !modalHtml.includes('id="register-modal"')) {
                    modalContainer.innerHTML = modalHtml; 
                } else {
                    modalContainer.innerHTML = ''; // Limpa outros modais, se existirem
                }
                setActiveLink(navId);
                window.lucide.createIcons(); // Re-renderiza os ícones Lucide para novo conteúdo
                if(scriptRunner) scriptRunner();
            };
            
            // Function to run the Product System specific script
            const runProductSystemScript = () => {
                console.log('runProductSystemScript started. Supabase database integration pending.');
                try { // Start try block
                    const tableBody = document.getElementById('product-table-body');
                    if (!tableBody) { console.error('Error: product-table-body not found.'); return; }
                    
                    const addProductBtn = document.getElementById('add-product-btn');
                    if (!addProductBtn) { console.error('Error: add-product-btn not found.'); return; }

                    const productModal = document.getElementById('product-modal');
                    if (!productModal) { console.error('Error: product-modal not found.'); return; }
                    
                    const productForm = document.getElementById('product-form');
                    if (!productForm) { console.error('Error: product-form not found.'); return; }
                    
                    const modalCloseButton = productModal.querySelector('#product-modal-header-close'); 
                    if (!modalCloseButton) { console.error('Error: product-modal-header-close not found.'); return; }

                    const cancelBtn = document.getElementById('product-modal-cancel');
                    if (!cancelBtn) { console.error('Error: product-modal-cancel not found.'); return; }

                    const generateBarcodeBtn = document.getElementById('generate-barcode-btn');
                    if (!generateBarcodeBtn) { console.error('Error: generate-barcode-btn not found.'); return; }

                    const generateGtinEanBtn = document.getElementById('generate-gtinean-btn'); 
                    if (!generateGtinEanBtn) { console.error('Error: generate-gtinean-btn not found.'); return; }
                    
                    const productImageInput = document.getElementById('product-image-input');
                    if (!productImageInput) { console.error('Error: product-image-input not found.'); return; }

                    const productImagePreview = document.getElementById('product-image-preview');
                    if (!productImagePreview) { console.error('Error: product-image-preview not found.'); return; }

                    const imageDropArea = productModal.querySelector('#image-drop-area'); 
                    if (!imageDropArea) { console.error('Error: image-drop-area not found.'); return; }

                    const addImageUrlInput = productModal.querySelector('#image-url-input');
                    if (!addImageUrlInput) { console.error('Error: image-url-input not found.'); return; }

                    const addImageUrlBtn = productModal.querySelector('#add-image-url-btn');
                    if (!addImageUrlBtn) { console.error('Error: add-image-url-btn not found.'); return; }

                    const MAX_IMAGES = 4;
                    let productImages = []; // Array to store image URLs/Base64

                    // Filter elements
                    const filterSituacao = document.getElementById('filter-situacao');
                    const filterTags = document.getElementById('filter-tags');
                    const filterCategoria = document.getElementById('filter-categoria');
                    const filterNCM = document.getElementById('filter-ncm');
                    const filterTipo = document.getElementById('filter-tipo');
                    const filterMarca = document.getElementById('filter-marca');
                    const clearFiltersBtn = document.getElementById('clear-filters-btn');
                    const filterChipsContainer = document.getElementById('filter-chips-container'); // New element


                    // Date Picker elements
                    const dateRangeDisplay = document.getElementById('date-range-display');
                    const datePickerModal = document.getElementById('date-picker-modal');
                    const datePickerCloseBtn = document.getElementById('date-picker-close-btn');
                    const datePickerCancelBtn = document.getElementById('date-picker-cancel-btn');
                    const datePickerFilterBtn = document.getElementById('date-picker-filter-btn');
                    const searchDateStartInput = document.getElementById('search-date-start');
                    const searchDateEndInput = document.getElementById('search-date-end');
                    const monthDisplayLeft = document.getElementById('month-display-left');
                    const calendarGridLeft = document.getElementById('calendar-grid-left');
                    const monthDisplayRight = document.getElementById('month-display-right');
                    const calendarGridRight = document.getElementById('calendar-grid-right');
                    const prevMonthBtnLeft = document.getElementById('prev-month-left');
                    const nextMonthBtnLeft = document.getElementById('next-month-left');
                    const prevMonthBtnRight = document.getElementById('prev-month-right');
                    const nextMonthBtnRight = document.getElementById('next-month-right');

                    // Check if filter elements exist
                    if (!filterSituacao) console.error('Error: filter-situacao not found.');
                    if (!filterTags) console.error('Error: filter-tags not found.');
                    if (!filterCategoria) console.error('Error: filter-categoria not found.');
                    if (!filterNCM) console.error('Error: filter-ncm not found.');
                    if (!filterTipo) console.error('Error: filter-tipo not found.');
                    if (!filterMarca) console.error('Error: filter-marca not found.');
                    if (!clearFiltersBtn) console.error('Error: clear-filters-btn not found.');
                    if (!filterChipsContainer) console.error('Error: filter-chips-container not found.');
                    
                    // Import/Export buttons
                    const importProductsBtn = document.getElementById('import-products-btn');
                    const exportProductsBtn = document.getElementById('export-products-btn');

                    if (!importProductsBtn) console.error('Error: import-products-btn not found.');
                    if (!exportProductsBtn) console.error('Error: export-products-btn not found.');

                    // New search and action buttons in the top bar
                    const productSearchInput = document.getElementById('product-search-input');
                    const toggleFilterSidebarBtn = document.getElementById('toggle-filter-sidebar-btn');
                    const lockBtn = document.getElementById('lock-product-btn');
                    const printerBtn = document.getElementById('printer-product-btn');
                    const trashBtn = document.getElementById('trash-product-btn');
                    const refreshBtn = document.getElementById('refresh-product-btn'); // New refresh button
                    const viewOptionsBtn = document.getElementById('view-options-product-btn'); // New view options button


                    if (!productSearchInput) console.error('Error: product-search-input not found.');
                    if (!toggleFilterSidebarBtn) console.error('Error: toggle-filter-sidebar-btn not found.');
                    if (!lockBtn) console.error('Error: lock-product-btn not found.');
                    if (!printerBtn) { console.error('Error: printer-product-btn not found.'); return; }
                    if (!trashBtn) console.error('Error: trash-product-btn not found.');
                    if (!refreshBtn) console.error('Error: refresh-product-btn not found.');
                    if (!viewOptionsBtn) console.error('Error: view-options-product-btn not found.');

                    // Table selection elements
                    const selectAllCheckbox = document.getElementById('select-all-products');
                    if (!selectAllCheckbox) console.error('Error: select-all-products not found.');


                    // Placeholder for Supabase data loading
                    tableBody.innerHTML = '<tr><td colspan="8" class="p-3 text-center text-gray-400">A carregar produtos do Supabase... (Integração da base de dados pendente)</td></tr>';


                    // --- Date Picker Logic ---
                    const months = ["Janeiro", "Fevereiro", "Março", "Abril", "Maio", "Junho", "Julho", "Agosto", "Setembro", "Outubro", "Novembro", "Dezembro"];
                    const weekdays = ["Dom", "Seg", "Ter", "Qua", "Qui", "Sex", "Sáb"];
                    let currentMonthLeft = new Date();
                    let selectedStartDate = null;
                    let selectedEndDate = null;

                    const formatDate = (date) => {
                        if (!date) return '';
                        const d = new Date(date);
                        return d.toLocaleDateString('pt-BR', { day: '2-digit', month: '2-digit', year: 'numeric' });
                    };

                    const updateDateRangeDisplay = () => {
                        const start = searchDateStartInput.value;
                        const end = searchDateEndInput.value;
                        if (start && end) {
                            dateRangeDisplay.textContent = `${formatDate(start)} - ${formatDate(end)}`;
                        } else if (start) {
                            dateRangeDisplay.textContent = `${formatDate(start)} - Fim`;
                        } else if (end) {
                            dateRangeDisplay.textContent = `Início - ${formatDate(end)}`;
                        } else {
                            dateRangeDisplay.textContent = 'Data do Pedido';
                        }
                    };

                    const renderCalendar = (monthDate, calendarGrid, monthDisplay, isRightCalendar = false) => {
                        calendarGrid.innerHTML = '';
                        monthDisplay.textContent = `${months[monthDate.getMonth()]} ${monthDate.getFullYear()}`;

                        const firstDayOfMonth = new Date(monthDate.getFullYear(), monthDate.getMonth(), 1);
                        const lastDayOfMonth = new Date(monthDate.getFullYear(), monthDate.getMonth() + 1, 0);
                        const today = new Date();
                        today.setHours(0, 0, 0, 0);

                        // Calculate the start day of the calendar grid (Sunday of the first week)
                        const startDay = new Date(firstDayOfMonth);
                        startDay.setDate(firstDayOfMonth.getDate() - firstDayOfMonth.getDay());

                        // Generate days
                        for (let i = 0; i < 42; i++) { // 6 weeks * 7 days
                            const day = new Date(startDay);
                            day.setDate(startDay.getDate() + i);

                            const dayElement = document.createElement('div');
                            dayElement.classList.add('calendar-day');
                            dayElement.textContent = day.getDate();
                            dayElement.dataset.date = day.toISOString().split('T')[0];

                            if (day.getMonth() === monthDate.getMonth()) {
                                dayElement.classList.add('current-month');
                            } else {
                                dayElement.classList.add('other-month');
                            }

                            if (day.getTime() === today.getTime()) {
                                dayElement.classList.add('today');
                            }

                            // Check for selection
                            if (selectedStartDate && selectedEndDate) {
                                if (day.getTime() >= new Date(selectedStartDate).getTime() && day.getTime() <= new Date(selectedEndDate).getTime()) {
                                    dayElement.classList.add('range-selected');
                                }
                            }
                            if (selectedStartDate && day.getTime() === new Date(selectedStartDate).getTime()) {
                                dayElement.classList.add('selected');
                            }
                            if (selectedEndDate && day.getTime() === new Date(selectedEndDate).getTime()) {
                                dayElement.classList.add('selected');
                            }
                            

                            dayElement.addEventListener('click', () => {
                                const clickedDate = day.toISOString().split('T')[0];
                                if (!selectedStartDate || (selectedStartDate && selectedEndDate)) {
                                    selectedStartDate = clickedDate;
                                    selectedEndDate = null; // Reset end date for new selection
                                } else if (new Date(clickedDate).getTime() < new Date(selectedStartDate).getTime()) {
                                    selectedEndDate = selectedStartDate;
                                    selectedStartDate = clickedDate;
                                } else {
                                    selectedEndDate = clickedDate;
                                }
                                renderCalendars(); // Re-render both calendars to show selection
                            });
                            calendarGrid.appendChild(dayElement);
                        }
                    };

                    const renderCalendars = () => {
                        const monthDateRight = new Date(currentMonthLeft);
                        monthDateRight.setMonth(currentMonthLeft.getMonth() + 1);
                        renderCalendar(currentMonthLeft, calendarGridLeft, monthDisplayLeft);
                        renderCalendar(monthDateRight, calendarGridRight, monthDisplayRight, true);
                    };

                    const navigateMonth = (direction, isLeftCalendar) => {
                        if (isLeftCalendar) {
                            currentMonthLeft.setMonth(currentMonthLeft.getMonth() + direction);
                        } else {
                            // Navigating right calendar, impacts both to keep them sequential
                            currentMonthLeft.setMonth(currentMonthLeft.getMonth() + direction);
                        }
                        renderCalendars();
                    };
                    
                    const setPresetDateRange = (preset) => {
                        const today = new Date();
                        today.setHours(0, 0, 0, 0);
                        let start = null;
                        let end = today; // Default end date to today for most presets

                        if (preset === 'today') {
                            start = today;
                        } else if (preset === 'this_week') {
                            start = new Date(today);
                            start.setDate(today.getDate() - today.getDay()); // Sunday
                        } else if (preset === 'last_week') {
                            end = new Date(today);
                            end.setDate(today.getDate() - today.getDay() - 1); // Saturday of last week
                            start = new Date(end);
                            start.setDate(end.getDate() - 6); // Sunday of last week
                        } else if (preset === 'this_month') {
                            start = new Date(today.getFullYear(), today.getMonth(), 1);
                        } else if (preset === 'last_month') {
                            end = new Date(today.getFullYear(), today.getMonth(), 0); // Last day of previous month
                            start = new Date(end.getFullYear(), end.getMonth(), 1); // First day of previous month
                        }

                        if (start) selectedStartDate = start.toISOString().split('T')[0];
                        if (end) selectedEndDate = end.toISOString().split('T')[0];
                        else selectedEndDate = null;

                        // Ensure start is always before or equal to end if both are set
                        if (selectedStartDate && selectedEndDate && new Date(selectedStartDate).getTime() > new Date(selectedEndDate).getTime()) {
                            const temp = selectedStartDate;
                            selectedStartDate = selectedEndDate;
                            selectedEndDate = temp;
                        }
                        
                        // Update currentMonthLeft to show the selected range in the calendar modal
                        if (selectedStartDate) {
                            currentMonthLeft = new Date(selectedStartDate);
                            currentMonthLeft.setDate(1); // Set to first day to avoid issues with month length
                        } else {
                            currentMonthLeft = new Date();
                            currentMonthLeft.setDate(1);
                        }
                        renderCalendars();
                        
                        // Highlight active preset button
                        document.querySelectorAll('.quick-select-btn').forEach(btn => btn.classList.remove('active-preset'));
                        const activeBtn = document.querySelector(`.quick-select-btn[data-preset="${preset}"]`);
                        if (activeBtn) activeBtn.classList.add('active-preset');
                    };

                    // Event listeners for date picker
                    dateRangeDisplay?.addEventListener('click', () => {
                        if (datePickerModal) {
                            // Initialize selected dates from current filter inputs if available
                            if (searchDateStartInput.value) {
                                selectedStartDate = searchDateStartInput.value;
                                currentMonthLeft = new Date(selectedStartDate);
                                currentMonthLeft.setDate(1);
                            } else {
                                selectedStartDate = null;
                                currentMonthLeft = new Date();
                                currentMonthLeft.setDate(1);
                            }
                            if (searchDateEndInput.value) selectedEndDate = searchDateEndInput.value;
                            else selectedEndDate = null;

                            renderCalendars();
                            datePickerModal.classList.remove('hidden');
                        }
                    });
                    datePickerCloseBtn?.addEventListener('click', () => { datePickerModal?.classList.add('hidden'); });
                    datePickerCancelBtn?.addEventListener('click', () => { datePickerModal?.classList.add('hidden'); });
                    datePickerFilterBtn?.addEventListener('click', () => {
                        searchDateStartInput.value = selectedStartDate || '';
                        searchDateEndInput.value = selectedEndDate || '';
                        updateDateRangeDisplay();
                        datePickerModal?.classList.add('hidden');
                        applyFilters(); // Apply filters with new date range
                    });
                    prevMonthBtnLeft?.addEventListener('click', () => navigateMonth(-1, true));
                    nextMonthBtnLeft?.addEventListener('click', () => navigateMonth(1, true));
                    prevMonthBtnRight?.addEventListener('click', () => navigateMonth(-1, false)); // Clicking right prev button
                    nextMonthBtnRight?.addEventListener('click', () => navigateMonth(1, false)); // Clicking right next button

                    // Quick select buttons
                    document.querySelectorAll('.quick-select-btn').forEach(btn => {
                        btn.addEventListener('click', () => {
                            setPresetDateRange(btn.dataset.preset);
                        });
                    });

                    // Initial render on script load
                    updateDateRangeDisplay();
                    renderCalendars();
                    // --- End Date Picker Logic ---


                    // Function to render filter chips
                    const renderFilterChips = (appliedFilters) => {
                        filterChipsContainer.innerHTML = ''; // Clear existing chips

                        if (appliedFilters.situacao) {
                            const chip = document.createElement('span');
                            chip.className = 'filter-chip';
                            chip.innerHTML = `Situação: ${appliedFilters.situacao} <button class="ml-1 text-gray-300 hover:text-white" data-filter="situacao"><i data-lucide="x" class="w-3 h-3"></i></button>`;
                            filterChipsContainer.appendChild(chip);
                        }
                        if (appliedFilters.tags) {
                            const chip = document.createElement('span');
                            chip.className = 'filter-chip';
                            chip.innerHTML = `Tags: ${appliedFilters.tags} <button class="ml-1 text-gray-300 hover:text-white" data-filter="tags"><i data-lucide="x" class="w-3 h-3"></i></button>`;
                            filterChipsContainer.appendChild(chip);
                        }
                        if (appliedFilters.categoria) {
                            const chip = document.createElement('span');
                            chip.className = 'filter-chip';
                            chip.innerHTML = `Categoria: ${appliedFilters.categoria} <button class="ml-1 text-gray-300 hover:text-white" data-filter="categoria"><i data-lucide="x" class="w-3 h-3"></i></button>`;
                            filterChipsContainer.appendChild(chip);
                        }
                        if (appliedFilters.ncm) {
                            const chip = document.createElement('span');
                            chip.className = 'filter-chip';
                            chip.innerHTML = `NCM: ${appliedFilters.ncm} <button class="ml-1 text-gray-300 hover:text-white" data-filter="ncm"><i data-lucide="x" class="w-3 h-3"></i></button>`;
                            filterChipsContainer.appendChild(chip);
                        }
                        if (appliedFilters.tipo) {
                            const chip = document.createElement('span');
                            chip.className = 'filter-chip';
                            chip.innerHTML = `Tipo: ${appliedFilters.tipo} <button class="ml-1 text-gray-300 hover:text-white" data-filter="tipo"><i data-lucide="x" class="w-3 h-3"></i></button>`;
                            filterChipsContainer.appendChild(chip);
                        }
                        if (appliedFilters.marca) {
                            const chip = document.createElement('span');
                            chip.className = 'filter-chip';
                            chip.innerHTML = `Marca: ${appliedFilters.marca} <button class="ml-1 text-gray-300 hover:text-white" data-filter="marca"><i data-lucide="x" class="w-3 h-3"></i></button>`;
                            filterChipsContainer.appendChild(chip);
                        }
                        if (appliedFilters.dataInicio || appliedFilters.dataFim) {
                            const dateRangeText = `${formatDate(appliedFilters.dataInicio || '')} - ${formatDate(appliedFilters.dataFim || '')}`;
                            const chip = document.createElement('span');
                            chip.className = 'filter-chip';
                            chip.innerHTML = `Datas: ${dateRangeText} <button class="ml-1 text-gray-300 hover:text-white" data-filter="datas"><i data-lucide="x" class="w-3 h-3"></i></button>`;
                            filterChipsContainer.appendChild(chip);
                        }
                        if (appliedFilters.termoPesquisa) {
                            const chip = document.createElement('span');
                            chip.className = 'filter-chip';
                            chip.innerHTML = `Pesquisa: "${appliedFilters.termoPesquisa}" <button class="ml-1 text-gray-300 hover:text-white" data-filter="termoPesquisa"><i data-lucide="x" class="w-3 h-3"></i></button>`;
                            filterChipsContainer.appendChild(chip);
                        }

                        // Add "Limpar" chip if any filters are applied
                        if (Object.keys(appliedFilters).length > 0) {
                            const clearChip = document.createElement('button');
                            clearChip.className = 'filter-chip-clear ml-2 text-sm font-semibold hover:text-white';
                            clearChip.innerHTML = `<i data-lucide="x" class="w-4 h-4 mr-1"></i> Limpar`;
                            clearChip.addEventListener('click', clearFilters);
                            filterChipsContainer.appendChild(clearChip);
                        }

                        window.lucide.createIcons(); // Re-render Lucide icons for new chips
                    };


                    // Function to apply filters (placeholder)
                    const applyFilters = () => {
                        console.log('Aplicando filtros...');
                        const appliedFilters = {};
                        if (filterSituacao?.value) appliedFilters.situacao = filterSituacao.value;
                        if (filterTags?.value) appliedFilters.tags = filterTags.value;
                        if (filterCategoria?.value) appliedFilters.categoria = filterCategoria.value;
                        if (filterNCM?.value) appliedFilters.ncm = filterNCM.value;
                        if (filterTipo?.value) appliedFilters.tipo = filterTipo.value;
                        if (filterMarca?.value) appliedFilters.marca = filterMarca.value;
                        if (searchDateStartInput?.value) appliedFilters.dataInicio = searchDateStartInput.value;
                        if (searchDateEndInput?.value) appliedFilters.dataFim = searchDateEndInput.value;
                        if (productSearchInput?.value.trim()) appliedFilters.termoPesquisa = productSearchInput.value.trim();

                        renderFilterChips(appliedFilters); // Update filter chips display

                        if (Object.keys(appliedFilters).length > 0) {
                            window.showMessage(`Filtros aplicados: ${JSON.stringify(appliedFilters)}. Funcionalidade de filtragem no Supabase pendente.`, "info");
                        } else {
                            window.showMessage("Nenhum filtro aplicado. A mostrar todos os produtos. Funcionalidade de filtragem no Supabase pendente.", "info");
                        }
                        // Here you would typically fetch data from Supabase based on these filter values
                    };


                    const clearFilters = () => {
                        console.log('A limpar filtros...');
                        if (filterSituacao) filterSituacao.value = '';
                        if (filterTags) filterTags.value = '';
                        if (filterCategoria) filterCategoria.value = '';
                        if (filterNCM) filterNCM.value = '';
                        if (filterTipo) filterTipo.value = '';
                        if (filterMarca) filterMarca.value = '';
                        if (searchDateStartInput) searchDateStartInput.value = '';
                        if (searchDateEndInput) searchDateEndInput.value = '';
                        if (productSearchInput) productSearchInput.value = '';
                        selectedStartDate = null; // Clear date picker selection
                        selectedEndDate = null; // Clear date picker selection
                        updateDateRangeDisplay(); // Update date range display
                        renderCalendars(); // Re-render calendars without selection
                        applyFilters(); // Re-apply filters to show all products (empty filters)
                        window.showMessage("Filtros limpos.", "info");
                    };

                    // Add event listener for clearing individual filter chips
                    filterChipsContainer.addEventListener('click', (e) => {
                        const target = e.target.closest('button');
                        if (target && target.dataset.filter) {
                            const filterToClear = target.dataset.filter;
                            console.log(`Clearing individual filter: ${filterToClear}`);
                            if (filterToClear === 'situacao' && filterSituacao) filterSituacao.value = '';
                            else if (filterToClear === 'tags' && filterTags) filterTags.value = '';
                            else if (filterToClear === 'categoria' && filterCategoria) filterCategoria.value = '';
                            else if (filterToClear === 'ncm' && filterNCM) filterNCM.value = '';
                            else if (filterToClear === 'tipo' && filterTipo) filterTipo.value = '';
                            else if (filterToClear === 'marca' && filterMarca) filterMarca.value = '';
                            else if (filterToClear === 'datas') {
                                if (searchDateStartInput) searchDateStartInput.value = '';
                                if (searchDateEndInput) searchDateEndInput.value = '';
                                selectedStartDate = null;
                                selectedEndDate = null;
                                updateDateRangeDisplay();
                                renderCalendars();
                            }
                            else if (filterToClear === 'termoPesquisa' && productSearchInput) productSearchInput.value = '';
                            applyFilters(); // Re-apply filters to update chips and data
                        }
                    });

                    clearFiltersBtn?.addEventListener('click', clearFilters);


                    // Event listeners for Import/Export buttons
                    importProductsBtn?.addEventListener('click', () => {
                        console.log('Botão Importar Produtos clicado. Simulação de importação.');
                        window.showMessage("A iniciar processo de importação de produtos... Funcionalidade pendente.", "info");
                    });

                    exportProductsBtn?.addEventListener('click', () => {
                        console.log('Botão Exportar Produtos clicado. Simulação de exportação.');
                        window.showMessage("A preparar exportação de produtos... Funcionalidade pendente.", "info");
                    });

                    // New search and action button event listeners
                    productSearchInput?.addEventListener('keypress', (e) => {
                        if (e.key === 'Enter') {
                            console.log('Pesquisar Produtos acionado com Enter.');
                            applyFilters(); // Call applyFilters to include text search
                        }
                    });

                    toggleFilterSidebarBtn?.addEventListener('click', () => {
                        const filterSidebar = document.querySelector('aside:first-child'); // Select the first aside (filter sidebar)
                        const productSystemContainer = document.querySelector('.product-system-container');
                        if (filterSidebar && productSystemContainer) {
                            filterSidebar.classList.toggle('hidden');
                            if (filterSidebar.classList.contains('hidden')) {
                                console.log('Barra lateral de filtros escondida.');
                                // Adjust main content grid to expand if filter sidebar is hidden
                                productSystemContainer.classList.remove('grid-cols-[288px_1fr_200px]');
                                productSystemContainer.classList.add('grid-cols-[1fr_200px]');
                                window.showMessage("Barra lateral de filtros escondida.", "info");
                            } else {
                                console.log('Barra lateral de filtros visível.');
                                // Adjust main content grid to original 3-column layout
                                productSystemContainer.classList.remove('grid-cols-[1fr_200px]');
                                productSystemContainer.classList.add('grid-cols-[288px_1fr_200px]');
                                window.showMessage("Barra lateral de filtros visível.", "info");
                            }
                        }
                    });

                    lockBtn?.addEventListener('click', () => {
                        const selectedProducts = Array.from(document.querySelectorAll('.product-checkbox:checked')).map(cb => cb.closest('tr').dataset.productId);
                        if (selectedProducts.length > 0) {
                            console.log(`Bloquear produtos selecionados: ${selectedProducts.join(', ')}. Simulação de bloqueio.`);
                            window.showMessage(`A bloquear ${selectedProducts.length} produtos. Funcionalidade pendente.`, "info");
                        } else {
                            window.showMessage("Nenhum produto selecionado para bloquear.", "warning");
                        }
                    });

                    printerBtn?.addEventListener('click', () => {
                        const selectedProducts = Array.from(document.querySelectorAll('.product-checkbox:checked')).map(cb => cb.closest('tr').dataset.productId);
                        if (selectedProducts.length > 0) {
                            console.log(`Imprimir produtos selecionados: ${selectedProducts.join(', ')}. Simulação de impressão.`);
                            window.showMessage(`A preparar a impressão de ${selectedProducts.length} produtos. Funcionalidade pendente.`, "info");
                        } else {
                            window.showMessage("Nenhum produto selecionado para imprimir.", "warning");
                        }
                    });

                    trashBtn?.addEventListener('click', () => {
                        const selectedProducts = Array.from(document.querySelectorAll('.product-checkbox:checked')).map(cb => cb.closest('tr').dataset.productId);
                        if (selectedProducts.length > 0) {
                            console.log(`Excluir produtos selecionados: ${selectedProducts.join(', ')}. Simulação de exclusão.`);
                            window.showMessage(`A mover ${selectedProducts.length} produtos para a lixeira. Funcionalidade pendente.`, "info");
                        } else {
                            window.showMessage("Nenhum produto selecionado para excluir.", "warning");
                        }
                    });

                    refreshBtn?.addEventListener('click', () => { // New refresh button event listener
                        console.log('Botão Atualizar clicado. Simulação de atualização.');
                        window.showMessage("A atualizar a lista de produtos... Funcionalidade pendente.", "info");
                        applyFilters(); // Re-apply filters to simulate refresh
                    });

                    viewOptionsBtn?.addEventListener('click', () => { // New view options button event listener
                        console.log('Botão Opções de Visualização clicado. Simulação de opções de visualização.');
                        window.showMessage("A abrir opções de visualização (e.g., colunas da tabela, modo de exibição)... Funcionalidade pendente.", "info");
                    });

                    // Product selection logic
                    selectAllCheckbox?.addEventListener('change', (e) => {
                        const isChecked = e.target.checked;
                        document.querySelectorAll('.product-checkbox').forEach(checkbox => {
                            checkbox.checked = isChecked;
                            if (isChecked) {
                                checkbox.closest('tr').classList.add('selected-row');
                            } else {
                                checkbox.closest('tr').classList.remove('selected-row');
                            }
                        });
                        if (isChecked) {
                            window.showMessage("Todos os produtos visíveis foram selecionados.", "info");
                        } else {
                            window.showMessage("Seleção de todos os produtos removida.", "info");
                        }
                    });

                    tableBody.addEventListener('change', (e) => {
                        if (e.target.classList.contains('product-checkbox')) {
                            const row = e.target.closest('tr');
                            if (e.target.checked) {
                                row.classList.add('selected-row');
                            } else {
                                row.classList.remove('selected-row');
                            }
                            // Update select all checkbox state
                            const allCheckboxes = document.querySelectorAll('.product-checkbox');
                            const allChecked = Array.from(allCheckboxes).every(cb => cb.checked);
                            if (selectAllCheckbox) {
                                selectAllCheckbox.checked = allChecked;
                            }
                        }
                    });


                    // Function to render/re-render the image preview area
                    const renderImagePreviews = () => {
                        if (!imageDropArea) {
                            console.error("renderImagePreviews: imageDropArea not found, cannot render.");
                            return;
                        }

                        console.log('Rendering image previews. Current images array:', productImages);
                        imageDropArea.innerHTML = ''; // Clear existing previews

                        productImages.forEach((src, index) => {
                            const imageItem = document.createElement('div');
                            imageItem.className = 'relative group aspect-w-1 aspect-h-1 bg-gray-100 border border-gray-200 rounded-md overflow-hidden flex items-center justify-center p-2 image-preview-item';
                            // Add onerror to image tag for fallback
                            imageItem.innerHTML = `
                                <img src="${src}" alt="Pré-visualização da Imagem ${index + 1}" class="object-cover w-full h-full" onerror="this.onerror=null;this.src='https://placehold.co/120x120/ef4444/ffffff?text=Falha';">
                                <button class="absolute top-0.5 right-0.5 bg-red-500 text-white rounded-full p-0.5 opacity-0 group-hover:opacity-100 transition-opacity duration-200 delete-image-btn" data-index="${index}">
                                    <i data-lucide="x" class="w-3 h-3"></i>
                                </button>
                            `;
                            imageDropArea.appendChild(imageItem);
                        });

                        // Update main product image preview
                        if (productImages.length > 0) {
                            if (productImagePreview) {
                                productImagePreview.src = productImages[0];
                                console.log('Main image preview updated to:', productImages[0]);
                            }
                        } else {
                            if (productImagePreview) {
                                productImagePreview.src = 'https://placehold.co/160x160/cbd5e1/475569?text=Sem%20Imagem';
                                console.log('Main image preview set to placeholder.');
                            }
                        }

                        // Add "plus" icon slot if less than MAX_IMAGES
                        if (productImages.length < MAX_IMAGES) {
                            const plusIconDiv = document.createElement('div');
                            plusIconDiv.className = 'aspect-w-1 aspect-h-1 bg-gray-100 border-2 border-dashed border-gray-300 rounded-md flex items-center justify-center text-gray-500 hover:border-blue-500 hover:text-blue-500 cursor-pointer transition-colors duration-200 add-image-slot';
                            plusIconDiv.innerHTML = '<i data-lucide="plus" class="w-8 h-8"></i>';
                            plusIconDiv.addEventListener('click', () => {
                                if (productImages.length < MAX_IMAGES) {
                                    productImageInput.click();
                                    console.log('Add image slot clicked, opening file input.');
                                } else {
                                    window.showMessage(`Limite de ${MAX_IMAGES} imagens atingido.`, "error");
                                    console.warn(`Limit of ${MAX_IMAGES} images reached on click.`);
                                }
                            });
                            imageDropArea.appendChild(plusIconDiv);
                            console.log('Added "plus" icon slot.');
                        } else {
                             window.showMessage(`Limite de ${MAX_IMAGES} imagens atingido.`, "info");
                             console.info(`Limit of ${MAX_IMAGES} images reached, not adding "plus" slot.`);
                        }
                        window.lucide.createIcons(); 
                    };

                    // Event listeners for modal
                    addProductBtn.addEventListener('click', () => {
                        console.log('Add Product button clicked. Showing product modal.'); 
                        productForm.reset(); 
                        productForm.dataset.editingId = ''; 
                        
                        productImages = []; 
                        renderImagePreviews(); 

                        if (addImageUrlInput) addImageUrlInput.value = ''; 

                        productModal.classList.remove('hidden');
                        productModal.querySelector('.modal-content').classList.remove('translate-y-[-20px]');
                        document.querySelectorAll('.tab-content').forEach(content => {
                            content.classList.remove('active');
                            content.style.display = 'none'; 
                        });
                        document.querySelectorAll('#modal-tabs .tab-link').forEach(link => {
                            link.classList.remove('active', 'border-green-500', 'text-green-500');
                            link.classList.add('text-gray-500', 'border-transparent', 'hover:border-gray-300', 'hover:text-gray-700'); 
                        });
                        
                        const defaultTabLink = document.querySelector('#modal-tabs .tab-link[data-tab="caracteristicas"]');
                        const defaultTabContent = document.getElementById('caracteristicas');

                        if (defaultTabLink) {
                            defaultTabLink.classList.add('active', 'border-green-500', 'text-green-500');
                            defaultTabLink.classList.remove('text-gray-500', 'border-transparent', 'hover:border-gray-300', 'hover:text-gray-700');
                        }
                        if (defaultTabContent) {
                            defaultTabContent.classList.add('active');
                            defaultTabContent.style.display = 'block'; 
                        }
                        window.lucide.createIcons();
                    });
                    
                    const hideProductModal = () => {
                        console.log('Hiding product modal.'); 
                        if (productModal) {
                            productModal.querySelector('.modal-content').classList.add('translate-y-[-20px]');
                            setTimeout(() => {
                                productModal.classList.add('hidden');
                            }, 300); 
                        } else {
                            console.error("Erro: product-modal não encontrado ao tentar esconder.");
                        }
                    };

                    if (modalCloseButton) {
                        modalCloseButton.addEventListener('click', hideProductModal);
                    } else {
                        console.error("Erro: Botão de fechar do modal de produto não encontrado.");
                    }
                    cancelBtn.addEventListener('click', hideProductModal);

                    // Image file input functionality
                    if (productImageInput && imageDropArea) {
                        productImageInput.addEventListener('change', (event) => {
                            console.log('Product image file input changed.'); 
                            if (productImages.length >= MAX_IMAGES) {
                                window.showMessage(`Limite de ${MAX_IMAGES} imagens atingido.`, "error");
                                console.warn(`File input: Limit of ${MAX_IMAGES} images reached.`);
                                return;
                            }

                            const file = event.target.files[0];
                            if (file) {
                                console.log('File selected from input:', file.name, file.type); 
                                const reader = new FileReader();
                                reader.onload = (e) => {
                                    console.log('FileReader loaded image (Base64) from file.'); 
                                    productImages.push(e.target.result);
                                    renderImagePreviews();
                                };
                                reader.onerror = (error) => {
                                    console.error('FileReader error during file load:', error);
                                    window.showMessage("Erro ao carregar a imagem do arquivo.", "error");
                                };
                                reader.readAsDataURL(file);
                            } else {
                                console.log('No file selected from input.'); 
                            }
                        });

                        // Handle clicks on the image drop area for adding new images and deleting existing ones
                        imageDropArea.addEventListener('click', (e) => {
                            if (e.target.closest('.add-image-slot')) {
                                if (productImages.length < MAX_IMAGES) {
                                    productImageInput.click();
                                    console.log('Add image slot clicked, opening file input.');
                                } else {
                                    window.showMessage(`Limite de ${MAX_IMAGES} imagens atingido.`, "error");
                                    console.warn(`Limit of ${MAX_IMAGES} images reached on click.`);
                                }
                            }
                            const deleteButton = e.target.closest('.delete-image-btn');
                            if (deleteButton) {
                                const indexToRemove = parseInt(deleteButton.dataset.index, 10);
                                console.log("Delete image button clicked for index:", indexToRemove);
                                productImages.splice(indexToRemove, 1); 
                                renderImagePreviews(); 
                                window.showMessage("Imagem removida.", "info");
                            }
                        });

                        // Drag and drop functionality
                        imageDropArea.addEventListener('dragover', (e) => {
                            e.preventDefault();
                            e.stopPropagation();
                            if (productImages.length < MAX_IMAGES) {
                                imageDropArea.classList.add('border-blue-500', 'bg-blue-50'); 
                            }
                        });

                        imageDropArea.addEventListener('dragleave', (e) => {
                            e.preventDefault();
                            e.stopPropagation();
                            imageDropArea.classList.remove('border-blue-500', 'bg-blue-50');
                        });

                        imageDropArea.addEventListener('drop', (e) => {
                            e.preventDefault();
                            e.stopPropagation();
                            imageDropArea.classList.remove('border-blue-500', 'bg-blue-50');

                            if (productImages.length >= MAX_IMAGES) {
                                window.showMessage(`Limite de ${MAX_IMAGES} imagens atingido.`, "error");
                                console.warn(`Drag/Drop: Limit of ${MAX_IMAGES} images reached.`);
                                return;
                            }

                            const files = e.dataTransfer.files;
                            if (files.length > 0) {
                                console.log('Files dropped:', files);
                                const file = files[0]; 
                                if (file.type.startsWith('image/')) {
                                    const reader = new FileReader();
                                    reader.onload = (event) => {
                                        console.log('FileReader loaded image (Base64) from drop.'); 
                                        productImages.push(event.target.result);
                                        renderImagePreviews();
                                    };
                                    reader.onerror = (error) => {
                                        console.error('FileReader error during drop load:', error);
                                        window.showMessage("Erro ao carregar a imagem arrastada.", "error");
                                    };
                                    reader.readAsDataURL(file);
                                } else {
                                    window.showMessage("Por favor, solte apenas arquivos de imagem.", "error");
                                }
                            }
                        });

                    } else {
                        console.error("Erro: productImageInput ou imageDropArea não encontrado (runProductSystemScript).");
                    }

                    // Add Image by URL functionality
                    if (addImageUrlBtn && addImageUrlInput) {
                        addImageUrlBtn.addEventListener('click', () => {
                            console.log('Add Image by URL button clicked.');
                            if (productImages.length >= MAX_IMAGES) {
                                window.showMessage(`Limite de ${MAX_IMAGES} imagens atingido.`, "error");
                                console.warn(`Add by URL: Limit of ${MAX_IMAGES} images reached.`);
                                return;
                            }

                            const imageUrl = addImageUrlInput.value.trim();
                            if (imageUrl) {
                                console.log('Attempting to add image with URL:', imageUrl);
                                // Simple check for common image extensions
                                const isImageLink = /\.(jpeg|jpg|png|gif|webp|svg)$/i.test(imageUrl);

                                if (!isImageLink) {
                                    window.showMessage("URL de imagem inválida. Por favor, insira um link direto para o ficheiro da imagem (terminando em .jpg, .png, etc.).", "error");
                                    console.error("Invalid image file extension in URL:", imageUrl);
                                    return;
                                }

                                try {
                                    new URL(imageUrl); // Validate URL format
                                    productImages.push(imageUrl);
                                    renderImagePreviews();
                                    addImageUrlInput.value = ''; 
                                    window.showMessage("Imagem adicionada por link!", "success");
                                } catch (e) {
                                    window.showMessage("URL de imagem inválida. Por favor, insira um link válido.", "error");
                                    console.error("Invalid URL format provided:", imageUrl, e);
                                }
                            } else {
                                window.showMessage("Por favor, insira um link de imagem.", "error");
                                console.warn("Add by URL: No URL provided.");
                            }
                        });
                    } else {
                        console.error("Erro: addImageUrlBtn ou addImageUrlInput não encontrado (runProductSystemScript).");
                    }


                    // Function to generate a unique internal barcode (shorter version)
                    const generateInternalBarcode = () => {
                        console.log('Generating internal barcode.'); 
                        const randomString = Math.random().toString(36).substring(2, 8).toUpperCase(); 
                        const barcode = `SKU-${randomString}`; 
                        const skuInput = productForm.querySelector('[name="product-sku"]');
                        if (skuInput) {
                            skuInput.value = barcode;
                            window.showMessage("Código SKU interno gerado!", "success");
                        } else {
                            window.showMessage("Campo de Código (SKU) não encontrado.", "error");
                        }
                    };

                    // Function to generate a unique GTIN/EAN (placeholder)
                    const generateGtinEan = () => {
                        console.log('Generating GTIN/EAN.'); 
                        const randomNumeric = Math.floor(100000000000 + Math.random() * 900000000000).toString(); 
                        const gtinEan = `GTIN-${randomNumeric}`;
                        const gtinEanInput = productForm.querySelector('[name="product-gtinean"]');
                        if (gtinEanInput) {
                            gtinEanInput.value = gtinEan;
                            window.showMessage("Código GTIN/EAN gerado!", "success");
                        } else {
                            window.showMessage("Campo de GTIN/EAN não encontrado.", "error");
                        }
                    };

                    if (generateBarcodeBtn) {
                        generateBarcodeBtn.addEventListener('click', generateInternalBarcode);
                    }
                    if (generateGtinEanBtn) {
                        generateGtinEanBtn.addEventListener('click', generateGtinEan);
                    }

                    productForm.addEventListener('submit', async (e) => {
                        e.preventDefault();
                        console.log('Product form submitted.'); 
                        window.showMessage("Guarda de produto no Supabase pendente.", "info");
                        hideProductModal();
                    });

                    tableBody.addEventListener('click', async (e) => {
                        const targetButton = e.target.closest('button');
                        if (targetButton) {
                            const action = targetButton.dataset.action;
                            const productId = targetButton.closest('tr').dataset.productId; // Get product ID from row
                            if (action === 'delete') {
                                console.log(`Delete product with ID: ${productId} action triggered.`); 
                                window.showMessage(`Eliminação do produto ID: ${productId} no Supabase pendente.`, "info");
                            } else if (action === 'edit') {
                                console.log(`Edição do produto com ID: ${productId} no Supabase pendente.`, "info");
                            } else if (action === 'add-to-cart') {
                                console.log(`Adicionar ao carrinho o produto com ID: ${productId}. Funcionalidade pendente.`);
                                window.showMessage(`Produto ID: ${productId} adicionado ao carrinho.`, "info");
                            } else if (action === 'more-options') {
                                console.log(`Mais opções para o produto com ID: ${productId}. Funcionalidade pendente.`);
                                window.showMessage(`A abrir mais opções para o produto ID: ${productId}.`, "info");
                            }
                        }
                    });

                    const modalTabs = document.getElementById('modal-tabs');
                    if (modalTabs) {
                        modalTabs.addEventListener('click', (e) => {
                            e.preventDefault();
                            const tabLink = e.target.closest('.tab-link');
                            if (tabLink) {
                                console.log(`Tab clicked: ${tabLink.dataset.tab}`); 

                                document.querySelectorAll('.tab-content').forEach(content => {
                                    console.log(`Attempting to hide tab-content: ${content.id}`); 
                                    content.classList.remove('active');
                                    content.style.display = 'none'; 
                                });
                                document.querySelectorAll('.tab-link').forEach(link => {
                                    link.classList.remove('active', 'border-green-500', 'text-green-500');
                                    link.classList.add('text-gray-500', 'border-transparent', 'hover:border-gray-300', 'hover:text-gray-700');
                                });

                                tabLink.classList.add('active', 'border-green-500', 'text-green-500');
                                tabLink.classList.remove('text-gray-500', 'border-transparent', 'hover:border-gray-300', 'hover:text-gray-700');
                                
                                const targetTabId = tabLink.dataset.tab;
                                const targetTabContent = document.getElementById(targetTabId);
                                if (targetTabContent) {
                                    console.log(`Attempting to show tab-content: ${targetTabId}`); 
                                    targetTabContent.classList.add('active');
                                    targetTabContent.style.display = 'block'; 
                                } else {
                                    console.error(`ERROR: Target tab content not found for ID: ${targetTabId}`);
                                }
                                window.lucide.createIcons(); 
                            }
                        });
                    }
                    applyFilters(); // Initial render of filter chips and messages
                } catch (error) { // End try block
                    console.error("An error occurred in runProductSystemScript:", error);
                    window.showMessage("Ocorreu um erro ao carregar o sistema de produtos. Por favor, verifique a consola para mais detalhes.", "error");
                }
            };

            const runClientesFornecedoresScript = () => {
                console.log('runClientesFornecedoresScript started. Supabase database integration pending.');
                const tableBody = document.getElementById('cs-table-body');
                if (!tableBody) { console.error('Error: cs-table-body not found.'); return; }
                
                const renderTable = (data) => {
                    tableBody.innerHTML = '';
                    if (data.length === 0) {
                        tableBody.innerHTML = '<tr><td colspan="4" class="p-3 text-center text-gray-500">Nenhum cliente ou fornecedor registado ainda.</td></tr>';
                        return;
                    }
                    data.forEach(item => {
                        const tr = document.createElement('tr');
                        tr.innerHTML = `
                            <td class="p-3">${item.nome}</td>
                            <td class="p-3">${item.cpf || item.cnpj}</td>
                            <td class="p-3">${item.tipo}</td>
                            <td class="text-center p-3">
                                <button class="p-1.5 text-gray-500 hover:text-blue-600 rounded-md"><i data-lucide="edit" class="w-4 h-4"></i></button>
                            </td>
                        `;
                        tableBody.appendChild(tr);
                    });
                    window.lucide.createIcons();
                };
                renderTable(clientsAndSuppliers); // Using dummy data for now
                tableBody.innerHTML = '<tr><td colspan="4" class="p-3 text-center text-gray-500">A carregar clientes/fornecedores do Supabase... (Integração da base de dados pendente)</td></tr>';
            };

            // Templates HTML
            const dashboardHtml = `<div class="p-8"><h1 class="text-3xl font-bold text-gray-800 mb-8">Dashboard</h1><div class="bg-white p-6 rounded-lg shadow"><p>Bem-vindo ao seu sistema!</p><p class="mt-2 text-sm text-gray-600">Este é um ambiente de demonstração com persistência de dados via Supabase.</p></div></div>`;
            const vendasHtml = `<div class="p-8"><h1 class="text-3xl font-bold text-gray-800 mb-8">Gestão de Vendas</h1><div class="bg-white p-6 rounded-lg shadow"><p>Página de Vendas em construção.</p></div></div>`;
            const estoqueHtml = `<div class="p-8"><h1 class="text-3xl font-bold text-gray-800 mb-8">Controle de Inventário</h1><div class="bg-white p-6 rounded-lg shadow"><p>Página de Inventário em construção.</p></div></div>`;
            const financeiroHtml = `<div class="p-8"><h1 class="text-3xl font-bold text-gray-800 mb-8">Gestão Financeira</h1><div class="bg-white p-6 rounded-lg shadow"><p>Página Financeira em construção.</p></div></div>`;
            const productSystemHtml = `
            <div class="product-system-container grid grid-cols-[288px_1fr_200px] h-full overflow-hidden bg-gray-100 rounded-xl shadow-lg">
                <aside class="bg-gray-100 text-gray-800 p-4 space-y-4 overflow-y-auto flex-shrink-0 rounded-l-xl">
                    <div class="flex items-center justify-between">
                        <h2 class="text-xl font-bold">Filtrar</h2>
                        <button id="clear-filters-btn" class="text-sm text-gray-500 hover:text-gray-700 flex items-center gap-1 p-1 rounded-sm">
                            <i data-lucide="x" class="w-3.5 h-3.5"></i> Limpar
                        </button>
                    </div>
                    <div class="space-y-3 mt-4">
                        <div>
                            <label for="filter-situacao" class="block text-sm font-medium text-gray-700">Situação</label>
                            <select id="filter-situacao" class="w-full mt-1 bg-white border border-gray-300 rounded-md px-2 py-1.5 text-sm focus:ring-blue-500 focus:border-blue-500">
                                <option value="">Todos</option>
                                <option value="ultimos_incluidos">Últimos Incluídos</option>
                                <option value="ativo">Ativo</option>
                                <option value="inativo">Inativo</option>
                            </select>
                        </div>
                        <div>
                            <label for="filter-tags" class="block text-sm font-medium text-gray-700">Tags</label>
                            <select id="filter-tags" class="w-full mt-1 bg-white border border-gray-300 rounded-md px-2 py-1.5 text-sm focus:ring-blue-500 focus:border-blue-500">
                                <option value="">Todas</option>
                                <option value="tag1">Tag 1</option>
                                <option value="tag2">Tag 2</option>
                            </select>
                        </div>
                        <div>
                            <label for="filter-categoria" class="block text-sm font-medium text-gray-700">Categoria</label>
                            <select id="filter-categoria" class="w-full mt-1 bg-white border border-gray-300 rounded-md px-2 py-1.5 text-sm focus:ring-blue-500 focus:border-blue-500">
                                <option value="">Todas</option>
                                <option value="cat1">Categoria 1</option>
                                <option value="cat2">Categoria 2</option>
                            </select>
                        </div>
                        <div>
                            <label for="filter-ncm" class="block text-sm font-medium text-gray-700">NCM</label>
                            <input type="text" id="filter-ncm" class="w-full mt-1 bg-white border border-gray-300 rounded-md px-2 py-1.5 text-sm focus:ring-blue-500 focus:border-blue-500" placeholder="Código NCM">
                        </div>
                        <div>
                            <label for="filter-tipo" class="block text-sm font-medium text-gray-700">Tipo</label>
                            <select id="filter-tipo" class="w-full mt-1 bg-white border border-gray-300 rounded-md px-2 py-1.5 text-sm focus:ring-blue-500 focus:border-blue-500">
                                <option value="">Todos</option>
                                <option value="produto">Produto</option>
                                <option value="servico">Serviço</option>
                            </select>
                        </div>
                        <div>
                            <label for="filter-marca" class="block text-sm font-medium text-gray-700">Marca</label>
                            <input type="text" id="filter-marca" class="w-full mt-1 bg-white border border-gray-300 rounded-md px-2 py-1.5 text-sm focus:ring-blue-500 focus:border-blue-500" placeholder="Nome da marca">
                        </div>
                    </div>
                </aside>
                <main class="flex-1 flex flex-col overflow-hidden bg-white rounded-none shadow-md">
                    <header class="product-listing-header p-3 px-6 flex flex-col flex-shrink-0 rounded-t-xl">
                        <div class="flex justify-between items-center mb-2">
                            <h2 class="text-sm font-semibold text-gray-300">As Lojas</h2>
                            <div class="flex items-center gap-2">
                                <button id="lock-product-btn" class="p-1 rounded-sm bg-gray-700 hover:bg-gray-600 text-white transition-colors duration-200"><i data-lucide="lock" class="w-3.5 h-3.5"></i></button>
                                <button id="printer-product-btn" class="p-1 rounded-sm bg-gray-700 hover:bg-gray-600 text-white transition-colors duration-200"><i data-lucide="printer" class="w-3.5 h-3.5"></i></button>
                                <button id="trash-product-btn" class="p-1 rounded-sm bg-gray-700 hover:bg-gray-600 text-white transition-colors duration-200"><i data-lucide="trash-2" class="w-3.5 h-3.5"></i></button>
                            </div>
                        </div>
                        <div class="flex items-center space-x-2 w-full mb-2">
                            <div class="relative flex-1 max-w-sm"> <!-- Smaller search bar -->
                                <input type="text" id="product-search-input" class="w-full product-search-input-dark rounded-md pl-8 pr-2 py-1 text-sm placeholder-gray-400 focus:ring-blue-500 focus:border-blue-500" placeholder="Pesquisar por código, descrição ou GTIN">
                                <i data-lucide="search" class="w-3.5 h-3.5 text-gray-400 absolute left-2 top-1/2 -translate-y-1/2"></i>
                            </div>
                            <div id="date-range-display" class="relative bg-gray-700 border border-gray-600 rounded-md px-2 py-1 text-xs placeholder-gray-400 focus:ring-blue-500 focus:border-blue-500 w-40 text-center cursor-pointer flex items-center justify-between hover:bg-gray-600 transition-colors duration-200">
                                <span>Data do Pedido</span>
                                <i data-lucide="calendar" class="w-3.5 h-3.5 text-gray-400"></i>
                            </div>
                            <!-- Hidden inputs for actual date values -->
                            <input type="hidden" id="search-date-start" value="">
                            <input type="hidden" id="search-date-end" value="">

                            <button id="toggle-filter-sidebar-btn" class="bg-gray-700 hover:bg-gray-600 text-white font-semibold py-1 px-2.5 rounded-sm flex items-center gap-1 transition-colors duration-200 text-xs">
                                <i data-lucide="filter" class="w-3.5 h-3.5"></i>
                            </button>
                            <button id="refresh-product-btn" class="p-1 bg-gray-700 hover:bg-gray-600 text-white rounded-sm transition-colors duration-200"><i data-lucide="refresh-cw" class="w-3.5 h-3.5"></i></button>
                            <button id="view-options-product-btn" class="p-1 bg-gray-700 hover:bg-gray-600 text-white rounded-sm transition-colors duration-200"><i data-lucide="settings" class="w-3.5 h-3.5"></i></button>
                        </div>
                        <div id="filter-chips-container" class="flex flex-wrap items-center gap-2 text-sm mt-2">
                            <!-- Filter chips will be rendered here -->
                        </div>
                    </header>
                    <div class="flex-1 overflow-y-auto p-6"> <!-- Adjusted padding here -->
                        <div class="product-table-dark rounded-lg shadow overflow-hidden border border-gray-700">
                            <table class="w-full">
                                <thead class="border-b border-gray-700">
                                    <tr>
                                        <th class="p-3 text-left text-xs font-semibold uppercase w-10">
                                            <input type="checkbox" id="select-all-products" class="rounded-sm text-blue-500 focus:ring-blue-400 bg-gray-600 border-gray-500">
                                        </th>
                                        <th class="p-3 text-left text-xs font-semibold uppercase">Imagem</th>
                                        <th class="p-3 text-left text-xs font-semibold uppercase">Descrição</th>
                                        <th class="p-3 text-left text-xs font-semibold uppercase">Código</th>
                                        <th class="p-3 text-left text-xs font-semibold uppercase">Unidade</th>
                                        <th class="p-3 text-left text-xs font-semibold uppercase">Preço</th>
                                        <th class="p-3 text-center text-xs font-semibold uppercase">Estoque</th>
                                        <th class="p-3 text-center text-xs font-semibold uppercase">Ações</th>
                                    </tr>
                                </thead>
                                <tbody id="product-table-body" class="divide-y divide-gray-700">
                                    <!-- Conteúdo da tabela será carregado aqui -->
                                    <tr data-product-id="prod_001">
                                        <td class="p-3">
                                            <input type="checkbox" class="product-checkbox rounded-sm text-blue-500 focus:ring-blue-400 bg-gray-600 border-gray-500">
                                        </td>
                                        <td class="p-3">
                                            <img src="https://placehold.co/40x40/444444/ffffff?text=Prod" alt="Produto" class="w-10 h-10 rounded-sm object-cover">
                                        </td>
                                        <td class="p-3">FITA VEDA ROSCA 12MMX3M VEDALAR</td>
                                        <td class="p-3">9776</td>
                                        <td class="p-3">UN</td>
                                        <td class="p-3">1,9900</td>
                                        <td class="p-3">0,000000</td>
                                        <td class="text-center p-3">
                                            <button class="p-0.5 text-red-400 hover:text-red-600 rounded-sm" data-action="add-to-cart"><i data-lucide="shopping-cart" class="w-3.5 h-3.5"></i></button>
                                            <button class="p-0.5 text-gray-400 hover:text-red-600 rounded-sm" data-action="delete"><i data-lucide="trash-2" class="w-3.5 h-3.5"></i></button>
                                            <button class="p-0.5 text-gray-400 hover:text-blue-400 rounded-sm" data-action="more-options"><i data-lucide="more-horizontal" class="w-3.5 h-3.5"></i></button>
                                        </td>
                                    </tr>
                                    <tr data-product-id="prod_002">
                                        <td class="p-3">
                                            <input type="checkbox" class="product-checkbox rounded-sm text-blue-500 focus:ring-blue-400 bg-gray-600 border-gray-500">
                                        </td>
                                        <td class="p-3">
                                            <img src="https://placehold.co/40x40/444444/ffffff?text=Prod" alt="Produto" class="w-10 h-10 rounded-sm object-cover">
                                        </td>
                                        <td class="p-3">FITA VEDA ROSCA 12MMX3M VEDALAR</td>
                                        <td class="p-3">09370</td>
                                        <td class="p-3">UN</td>
                                        <td class="p-3">-3,000000</td>
                                        <td class="text-center p-3">
                                            <button class="p-0.5 text-red-400 hover:text-red-600 rounded-sm" data-action="add-to-cart"><i data-lucide="shopping-cart" class="w-3.5 h-3.5"></i></button>
                                            <button class="p-0.5 text-gray-400 hover:text-red-600 rounded-sm" data-action="delete"><i data-lucide="trash-2" class="w-3.5 h-3.5"></i></button>
                                            <button class="p-0.5 text-gray-400 hover:text-blue-400 rounded-sm" data-action="more-options"><i data-lucide="more-horizontal" class="w-3.5 h-3.5"></i></button>
                                        </td>
                                    </tr>
                                    <tr data-product-id="prod_003">
                                        <td class="p-3">
                                            <input type="checkbox" class="product-checkbox rounded-sm text-blue-500 focus:ring-blue-400 bg-gray-600 border-gray-500">
                                        </td>
                                        <td class="p-3">
                                            <img src="https://placehold.co/40x40/444444/ffffff?text=Prod" alt="Produto" class="w-10 h-10 rounded-sm object-cover">
                                        </td>
                                        <td class="p-3">CARRO INFANTIL PEQUENO S/PEGA</td>
                                        <td class="p-3">0301</td>
                                        <td class="p-3">UN</td>
                                        <td class="p-3">80,0000</td>
                                        <td class="p-3">2,000000</td>
                                        <td class="text-center p-3">
                                            <button class="p-0.5 text-red-400 hover:text-red-600 rounded-sm" data-action="add-to-cart"><i data-lucide="shopping-cart" class="w-3.5 h-3.5"></i></button>
                                            <button class="p-0.5 text-gray-400 hover:text-red-600 rounded-sm" data-action="delete"><i data-lucide="trash-2" class="w-3.5 h-3.5"></i></button>
                                            <button class="p-0.5 text-gray-400 hover:text-blue-400 rounded-sm" data-action="more-options"><i data-lucide="more-horizontal" class="w-3.5 h-3.5"></i></button>
                                        </td>
                                    </tr>
                                    <tr data-product-id="prod_004">
                                        <td class="p-3">
                                            <input type="checkbox" class="product-checkbox rounded-sm text-blue-500 focus:ring-blue-400 bg-gray-600 border-gray-500">
                                        </td>
                                        <td class="p-3">
                                            <img src="https://placehold.co/40x40/444444/ffffff?text=Prod" alt="Produto" class="w-10 h-10 rounded-sm object-cover">
                                        </td>
                                        <td class="p-3">CARRO INFANTIL PEQUENO S/PEGA</td>
                                        <td class="p-3">0300</td>
                                        <td class="p-3">UN</td>
                                        <td class="p-3">80,0000</td>
                                        <td class="p-3">2,000000</td>
                                        <td class="text-center p-3">
                                            <button class="p-0.5 text-red-400 hover:text-red-600 rounded-sm" data-action="add-to-cart"><i data-lucide="shopping-cart" class="w-3.5 h-3.5"></i></button>
                                            <button class="p-0.5 text-gray-400 hover:text-red-600 rounded-sm" data-action="delete"><i data-lucide="trash-2" class="w-3.5 h-3.5"></i></button>
                                            <button class="p-0.5 text-gray-400 hover:text-blue-400 rounded-sm" data-action="more-options"><i data-lucide="more-horizontal" class="w-3.5 h-3.5"></i></button>
                                        </td>
                                    </tr>
                                    <tr data-product-id="prod_005">
                                        <td class="p-3">
                                            <input type="checkbox" class="product-checkbox rounded-sm text-blue-500 focus:ring-blue-400 bg-gray-600 border-gray-500">
                                        </td>
                                        <td class="p-3">
                                            <img src="https://placehold.co/40x40/444444/ffffff?text=Prod" alt="Produto" class="w-10 h-10 rounded-sm object-cover">
                                        </td>
                                        <td class="p-3">CARRO INFANTIL TOTOCA C/LATERAL 6002</td>
                                        <td class="p-3">6002</td>
                                        <td class="p-3">UN</td>
                                        <td class="p-3">180,0000</td>
                                        <td class="p-3">2,000000</td>
                                        <td class="text-center p-3">
                                            <button class="p-0.5 text-red-400 hover:text-red-600 rounded-sm" data-action="add-to-cart"><i data-lucide="shopping-cart" class="w-3.5 h-3.5"></i></button>
                                            <button class="p-0.5 text-gray-400 hover:text-red-600 rounded-sm" data-action="delete"><i data-lucide="trash-2" class="w-3.5 h-3.5"></i></button>
                                            <button class="p-0.5 text-gray-400 hover:text-blue-400 rounded-sm" data-action="more-options"><i data-lucide="more-horizontal" class="w-3.5 h-3.5"></i></button>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </main>
                <aside class="bg-gray-100 text-gray-800 p-4 space-y-4 overflow-y-auto flex-shrink-0 rounded-r-xl">
                    <h2 class="text-xl font-bold mb-4">Ações</h2>
                    <div class="space-y-3">
                        <button id="add-product-btn" class="w-full bg-blue-500 hover:bg-blue-700 text-white font-semibold py-1.5 px-3 rounded-md flex items-center justify-center gap-2 transition-colors duration-200">
                            <i data-lucide="plus" class="w-4 h-4"></i> Adicionar Produto
                        </button>
                        <button id="import-products-btn" class="w-full bg-green-500 hover:bg-green-600 text-white font-semibold py-1.5 px-3 rounded-md flex items-center justify-center gap-2 transition-colors duration-200">
                            <i data-lucide="download" class="w-4 h-4"></i> Importar
                        </button>
                        <button id="export-products-btn" class="w-full bg-indigo-500 hover:bg-indigo-600 text-white font-semibold py-1.5 px-3 rounded-md flex items-center justify-center gap-2 transition-colors duration-200">
                            <i data-lucide="upload" class="w-4 h-4"></i> Exportar
                        </button>
                    </div>
                </aside>
            </div>`;
            const clientesFornecedoresHtml = `<main class="flex-1 flex flex-col overflow-hidden"><header class="bg-white p-4 px-8 flex items-center justify-between flex-shrink-0 border-b"><div><h1 class="text-2xl font-bold text-gray-800">Clientes e Fornecedores</h1></div><div class="flex items-center gap-4"><button id="add-cs-btn" class="bg-blue-500 hover:bg-blue-600 text-white font-semibold py-1.5 px-3 rounded-md flex items-center gap-2"><i data-lucide="plus" class="w-4 h-4"></i> Adicionar</button></div></header><div class="flex-1 overflow-y-auto p-8"><div class="bg-white rounded-lg shadow overflow-hidden"><table class="w-full"><thead class="bg-gray-50"><tr><th class="p-3 text-left text-xs font-semibold text-gray-600 uppercase">Nome</th><th class="p-3 text-left text-xs font-semibold text-gray-600 uppercase">Documento</th><th class="p-3 text-left text-xs font-semibold text-gray-600 uppercase">Tipo</th><th class="p-3 text-center text-xs font-semibold text-gray-600 uppercase">Ações</th></tr></thead><tbody id="cs-table-body" class="divide-y divide-gray-200"></tbody></table></div></div></main>`;
            const productModalHtml = `<div id="product-modal" class="modal hidden fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-60"><div class="modal-content bg-white text-gray-800 rounded-lg shadow-xl w-full max-w-5xl max-h-[95vh] flex flex-col"><div class="p-4 flex justify-between items-center border-b border-gray-200 relative"><h3 class="text-xl font-semibold">Detalhes do Produto</h3><div class="flex gap-4 items-center"><button id="product-modal-cancel" class="border border-gray-300 bg-gray-100 hover:bg-gray-200 text-gray-700 font-semibold py-1.5 px-3 rounded-md transition-colors duration-200">Cancelar</button><button type="submit" form="product-form" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-1.5 px-3 rounded-md transition-colors duration-200">Guardar produto</button><button id="product-modal-header-close" class="text-gray-500 hover:text-gray-700 transition-colors duration-200 ml-4 p-1.5 rounded-md"><i data-lucide="x" class="w-5 h-5"></i></button></div></div><form id="product-form" class="flex-1 overflow-y-auto p-6 space-y-6"><div class="grid grid-cols-12 gap-6 items-start"><div class="col-span-3 flex flex-col items-center justify-center bg-gray-50 rounded-lg border-2 border-dashed border-gray-200 p-4 h-48 relative overflow-hidden"><img id="product-image-preview" src="https://placehold.co/160x160/cbd5e1/475569?text=Sem%20Imagem" alt="Pré-visualização da Imagem" class="max-w-full max-h-full object-contain rounded-md mb-2"><input type="file" id="product-image-input" accept="image/*" class="absolute inset-0 opacity-0 cursor-pointer"><label for="product-image-input" class="absolute inset-0 flex items-center justify-center text-gray-500 hover:text-blue-500 cursor-pointer"><i data-lucide="camera" class="w-8 h-8"></i></label></div><div class="col-span-9 grid grid-cols-3 gap-4"><div><label class="block text-sm font-medium text-gray-700">Nome*</label><input type="text" name="product-name" required class="w-full bg-white border border-gray-300 rounded-md p-2 shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-400"></div><div><label class="block text-sm font-medium text-gray-700">Código (SKU)</label><div class="flex gap-2 mt-1"><input type="text" name="product-sku" class="w-full bg-white border border-gray-300 rounded-md p-2 shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-400"><button type="button" id="generate-barcode-btn" class="bg-blue-500 hover:bg-blue-600 text-white font-semibold py-1.5 px-3 rounded-md text-sm flex-shrink-0 transition-colors duration-200">Gerar Interno</button></div></div><div><label class="block text-sm font-medium text-gray-700">Preço Venda</label><input type="number" step="0.01" name="product-price" class="w-full bg-white border border-gray-300 rounded-md p-2 shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-400"></div><div><label class="block text-sm font-medium text-gray-700">Formato</label><select name="product-format" class="w-full bg-white border border-gray-300 rounded-md p-2 shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-400"><option>Simples</option><option>Variável</option></select></div><div><label class="block text-sm font-medium text-gray-700">Tipo</label><select name="product-type" class="w-full bg-white border border-gray-300 rounded-md p-2 shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-400"><option>Produto</option><option>Serviço</option></select></div><div><label class="block text-sm font-medium text-gray-700">Condição</label><select name="product-condition" class="w-full bg-white border border-gray-300 rounded-md p-2 shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-400"><option>Novo</option><option>Usado</option><option>Recondicionado</option></select></div></div></div><div class="border-b border-gray-200 mt-6"><nav class="-mb-px flex space-x-6" id="modal-tabs"><a href="#" class="tab-link active whitespace-nowrap py-3 px-1 border-b-2 font-medium text-sm border-green-500 text-green-500" data-tab="caracteristicas">Características</a><a href="#" class="tab-link whitespace-nowrap py-3 px-1 border-b-2 font-medium text-sm border-transparent text-gray-500 hover:border-gray-300 hover:text-gray-700" data-tab="imagens">Imagens</a><a href="#" class="tab-link whitespace-nowrap py-3 px-1 border-b-2 font-medium text-sm border-transparent text-gray-500 hover:border-gray-300 hover:text-gray-700" data-tab="fornecedores">Fornecedores</a><a href="#" class="tab-link whitespace-nowrap py-3 px-1 border-b-2 font-medium text-sm border-transparent text-gray-500 hover:border-gray-300 hover:text-gray-700" data-tab="tributacao">Tributação</a></nav></div><div id="tab-content-container" class="pt-6"><div id="caracteristicas" class="tab-content active grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-x-6 gap-y-4"><!-- Existing characteristic fields --><div class="space-y-1"><label class="block text-sm font-medium text-gray-700">Marca</label><input type="text" name="product-brand" class="w-full bg-white border border-gray-300 rounded-md p-2 shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-400"></div><div class="space-y-1"><label class="block text-sm font-medium text-gray-700">Produção</label><select name="product-production" class="w-full bg-white border border-gray-300 rounded-md p-2 shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-400"><option>Própria</option><option>Terceirizada</option></select></div><div class="space-y-1"><label class="block text-sm font-medium text-gray-700">Data de Validade</label><input type="date" name="product-expiration-date" class="w-full bg-white border border-gray-300 rounded-md p-2 shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-400"></div><div class="space-y-1"><label class="block text-sm font-medium text-gray-700">Frete Grátis</label><select name="product-free-shipping" class="w-full bg-white border border-gray-300 rounded-md p-2 shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-400"><option>Não</option><option>Sim</option></select></div><div class="space-y-1"><label class="block text-sm font-medium text-gray-700">Peso Líquido (kg)</label><input type="number" step="0.01" name="product-liquid-weight" class="w-full bg-white border border-gray-300 rounded-md p-2 shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-400"></div><div class="space-y-1"><label class="block text-sm font-medium text-gray-700">Peso Bruto (kg)</label><input type="number" step="0.01" name="product-gross-weight" class="w-full bg-white border border-gray-300 rounded-md p-2 shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-400"></div><div class="space-y-1"><label class="block text-sm font-medium text-gray-700">Largura (cm)</label><input type="number" step="0.01" name="product-width" class="w-full bg-white border border-gray-300 rounded-md p-2 shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-400"></div><div class="space-y-1"><label class="block text-sm font-medium text-gray-700">Altura (cm)</label><input type="number" step="0.01" name="product-height" class="w-full bg-white border border-gray-300 rounded-md p-2 shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-400"></div><div class="space-y-1"><label class="block text-sm font-medium text-gray-700">Profundidade (cm)</label><input type="number" step="0.01" name="product-depth" class="w-full bg-white border border-gray-300 rounded-md p-2 shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-400"></div><div class="space-y-1"><label class="block text-sm font-medium text-gray-700">Volumes</label><input type="number" name="product-volumes" class="w-full bg-white border border-gray-300 rounded-md p-2 shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-400"></div><div class="space-y-1"><label class="block text-sm font-medium text-gray-700">Itens p/ caixa</label><input type="number" name="product-items-per-box" class="w-full bg-white border border-gray-300 rounded-md p-2 shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-400"></div><div class="space-y-1"><label class="block text-sm font-medium text-gray-700">Unidade de medida</label><select name="product-measurement-unit" class="w-full bg-white border border-gray-300 rounded-md p-2 shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-400"><option>Centímetros</option><option>Metros</option><option>Polegadas</option></select></div><div class="space-y-1"><label class="block text-sm font-medium text-gray-700">GTIN/EAN</label><div class="flex gap-2 mt-1"><input type="text" name="product-gtinean" class="w-full bg-white border border-gray-300 rounded-md p-2 shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-400" placeholder="SEM GTIN"><button type="button" id="generate-gtinean-btn" class="bg-blue-500 hover:bg-blue-600 text-white font-semibold py-1.5 px-3 rounded-md text-sm flex-shrink-0 transition-colors duration-200">Gerar Interno</button></div></div><div class="space-y-1"><label class="block text-sm font-medium text-gray-700">GTIN/EAN Tributário</label><input type="text" name="product-gtinean-tax" class="w-full bg-white border border-gray-300 rounded-md p-2 shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-400" placeholder="SEM GTIN"></div></div><div id="imagens" class="tab-content flex flex-col items-center p-4 gap-4"><p class="text-gray-600">Arraste e solte imagens ou clique no ícone para carregar.</p><div class="w-full flex items-center gap-2 mb-4"><input type="url" id="image-url-input" class="flex-1 bg-white border border-gray-300 rounded-md p-2 shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-400" placeholder="Cole o link direto da imagem aqui (terminando em .jpg, .png, etc.)"><button type="button" id="add-image-url-btn" class="bg-blue-500 hover:bg-blue-600 text-white font-semibold py-1.5 px-3 rounded-md text-sm flex-shrink-0 transition-colors duration-200">Adicionar por Link</button></div><div id="image-drop-area" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4 w-full p-4 border-2 border-dashed border-gray-300 rounded-md bg-gray-50 min-h-[150px] items-center justify-center"></div></div><div id="fornecedores" class="tab-content space-y-4"><h4 class="text-lg font-semibold text-gray-800 mb-4">Gerir Fornecedores do Produto</h4><div class="grid grid-cols-1 md:grid-cols-2 gap-4"><div><label class="block text-sm font-medium text-gray-700">Nome do Fornecedor</label><input type="text" name="supplier-name" class="w-full bg-white border border-gray-300 rounded-md p-2 shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-400" placeholder="Nome do fornecedor"></div><div><label class="block text-sm font-medium text-gray-700">Código do Fornecedor</label><input type="text" name="supplier-code" class="w-full bg-white border border-gray-300 rounded-md p-2 shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-400" placeholder="Código de referência do fornecedor"></div><div class="md:col-span-2"><label class="block text-sm font-medium text-gray-700">Preço de Custo</label><input type="number" step="0.01" name="supplier-cost-price" class="w-full bg-white border border-gray-300 rounded-md p-2 shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-400" placeholder="0.00"></div></div><button type="button" class="mt-4 bg-blue-500 hover:bg-blue-600 text-white font-semibold py-1.5 px-3 rounded-md flex items-center gap-2 transition-colors duration-200"><i data-lucide="plus" class="w-5 h-5"></i> Adicionar Fornecedor</button></div><div id="tributacao" class="tab-content space-y-4"><h4 class="text-lg font-semibold text-gray-800 mb-4">Configurações de Tributação</h4><div class="grid grid-cols-1 md:grid-cols-2 gap-4"><div><label class="block text-sm font-medium text-gray-700">NCM (Nomenclatura Comum do Mercosul)</label><input type="text" name="tax-ncm" class="w-full bg-white border border-gray-300 rounded-md p-2 shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-400" placeholder="Ex: 8471.30.12"></div><div><label class="block text-sm font-medium text-gray-700">CEST (Código Especificador da Substituição Tributária)</label><input type="text" name="tax-cest" class="w-full bg-white border border-gray-300 rounded-md p-2 shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-400" placeholder="Ex: 28.064.00"></div><div><label class="block text-sm font-medium text-gray-700">Origem da Mercadoria</label><select name="tax-origin" class="w-full bg-white border border-gray-300 rounded-md p-2 shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-400"><option value="0">0 - Nacional, exceto as indicadas nos códigos 3, 4, 5 e 8</option><option value="1">1 - Estrangeira - Importação direta</option><option value="2">2 - Estrangeira - Adquirida no mercado interno</option></select></div><div><label class="block text-sm font-medium text-gray-700">Tipo de Tributação</label><select name="tax-type" class="w-full bg-white border border-gray-300 rounded-md p-2 shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-400"><option>Normal</option><option>Simples Nacional</option></select></div></div></div></div></form></div></div>
            <!-- Date Picker Modal -->
            <div id="date-picker-modal" class="modal hidden fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-60">
                <div class="date-picker-modal-content w-full max-w-4xl p-6 flex gap-6">
                    <div class="flex-1 flex flex-col space-y-4">
                        <div class="flex items-center justify-between">
                            <button id="prev-month-left" class="calendar-nav-btn"><i data-lucide="chevron-left" class="w-4 h-4"></i></button>
                            <h4 id="month-display-left" class="text-md font-semibold text-gray-300"></h4>
                            <button id="next-month-left" class="calendar-nav-btn"><i data-lucide="chevron-right" class="w-4 h-4"></i></button>
                        </div>
                        <div class="grid grid-cols-7 text-center text-xs text-gray-400 font-medium">
                            <span>Dom</span><span>Seg</span><span>Ter</span><span>Qua</span><span>Qui</span><span>Sex</span><span>Sáb</span>
                        </div>
                        <div id="calendar-grid-left" class="grid grid-cols-7 gap-1">
                            <!-- Days will be generated here -->
                        </div>
                    </div>
                    <div class="flex-1 flex flex-col space-y-4">
                        <div class="flex items-center justify-between">
                            <button id="prev-month-right" class="calendar-nav-btn"><i data-lucide="chevron-left" class="w-4 h-4"></i></button>
                            <h4 id="month-display-right" class="text-md font-semibold text-gray-300"></h4>
                            <button id="next-month-right" class="calendar-nav-btn"><i data-lucide="chevron-right" class="w-4 h-4"></i></button>
                        </div>
                        <div class="grid grid-cols-7 text-center text-xs text-gray-400 font-medium">
                            <span>Dom</span><span>Seg</span><span>Ter</span><span>Qua</span><span>Qui</span><span>Sex</span><span>Sáb</span>
                        </div>
                        <div id="calendar-grid-right" class="grid grid-cols-7 gap-1">
                            <!-- Days will be generated here -->
                        </div>
                    </div>
                    <div class="w-1/4 flex flex-col space-y-2 ml-6">
                        <h5 class="text-sm font-semibold mb-2">Períodos Rápidos</h5>
                        <button class="quick-select-btn" data-preset="today">Hoje</button>
                        <button class="quick-select-btn" data-preset="this_week">Esta semana</button>
                        <button class="quick-select-btn" data-preset="last_week">Semana passada</button>
                        <button class="quick-select-btn" data-preset="this_month">Este mês</button>
                        <button class="quick-select-btn" data-preset="last_month">Mês passado</button>
                        <button class="quick-select-btn mt-4 active-preset" data-preset="custom">Período customizado</button>
                        <div class="flex-grow"></div>
                        <div class="flex gap-2 mt-4">
                            <button id="date-picker-cancel-btn" class="flex-1 bg-gray-600 hover:bg-gray-700 text-white font-semibold py-1.5 px-3 rounded-md text-sm transition-colors duration-200">Cancelar</button>
                            <button id="date-picker-filter-btn" class="flex-1 bg-green-500 hover:bg-green-600 text-white font-semibold py-1.5 px-3 rounded-md text-sm transition-colors duration-200">Filtrar</button>
                        </div>
                    </div>
                    <button id="date-picker-close-btn" class="absolute top-3 right-3 text-gray-400 hover:text-gray-200 p-1.5 rounded-md"><i data-lucide="x" class="w-4 h-4"></i></button>
                </div>
            </div>
            `;
            
        document.getElementById('nav-dashboard').addEventListener('click', (e) => { e.preventDefault(); showPage(dashboardHtml, 'nav-dashboard'); });
        document.getElementById('nav-vendas').addEventListener('click', (e) => { e.preventDefault(); showPage(vendasHtml, 'nav-vendas'); });
        document.getElementById('nav-estoque').addEventListener('click', (e) => { e.preventDefault(); showPage(estoqueHtml, 'nav-estoque'); });
        document.getElementById('nav-financeiro').addEventListener('click', (e) => { e.preventDefault(); showPage(financeiroHtml, 'nav-financeiro'); });
        
        // When navigating to Products, inject the product modal HTML as well
        document.getElementById('link-produtos').addEventListener('click', (e) => { 
            e.preventDefault(); 
            showPage(productSystemHtml, 'nav-catalogo', runProductSystemScript, productModalHtml); 
        });
        document.getElementById('link-clientes-fornecedores').addEventListener('click', (e) => { e.preventDefault(); showPage(clientesFornecedoresHtml, 'nav-catalogo', runClientesFornecedoresScript); });

        // Initial page load for the dashboard
        showPage(dashboardHtml, 'nav-dashboard');
        window.lucide.createIcons();
    };

    document.addEventListener('DOMContentLoaded', async () => {
        console.log("DOMContentLoaded fired."); // Debugging line
        const loginPage = document.getElementById('login-page');
        const dashboardPage = document.getElementById('dashboard-page');
        const loginForm = document.getElementById('login-form');
        const signupLink = document.getElementById('signup-link');
        const registerModal = document.getElementById('register-modal');
        const registerForm = document.getElementById('register-form');
        const registerModalCloseBtn = document.getElementById('register-modal-close');

        console.log("Signup Link Element found (on DOMContentLoaded):", signupLink); // Debugging line
        console.log("Register Modal Element found (on DOMContentLoaded):", registerModal); // Debugging line

        window.dashboardInitialized = false;

        // Function to show the register modal
        const showRegisterModal = () => {
            console.log("showRegisterModal called."); // Debugging line
            if (registerModal) {
                registerForm.reset(); // Clear form
                registerModal.classList.remove('hidden');
                registerModal.querySelector('.modal-content').classList.remove('translate-y-[-20px]');
                window.lucide.createIcons(); // Re-render icons in modal
            } else {
                console.error("Erro: register-modal não encontrado ao tentar mostrar.");
            }
        };

        // Function to hide the register modal
        const hideRegisterModal = () => {
            console.log("hideRegisterModal called."); // Debugging line
            if (registerModal) {
                registerModal.querySelector('.modal-content').classList.add('translate-y-[-20px]');
                setTimeout(() => {
                    registerModal.classList.add('hidden');
                }, 300); // Match CSS transition
            } else {
                console.error("Erro: register-modal não encontrado ao tentar esconder.");
            }
        };

        // Event listener for "Crie a sua conta gratuitamente" link
        if (signupLink) { // Ensure the element exists before adding listener
            signupLink.addEventListener('click', (e) => {
                e.preventDefault();
                console.log("Signup link clicked!"); // Debugging line
                showRegisterModal();
            });
        } else {
            console.error("Erro: O elemento 'signup-link' não foi encontrado no DOM. O link 'Crie a sua conta gratuitamente' não funcionará.");
        }


        // Event listener for closing the register modal
        if (registerModalCloseBtn) {
            registerModalCloseBtn.addEventListener('click', hideRegisterModal);
        } else {
            console.warn("Aviso: O botão 'register-modal-close' não foi encontrado.");
        }


        // Handle login form submission
        loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = loginForm.querySelector('#email').value;
            const password = loginForm.querySelector('#password').value;

            if (!window.supabase) {
                window.showMessage("Erro: Supabase não inicializado. Verifique as suas credenciais.", "error");
                return;
            }

            // Supabase sign-in
            const { data, error } = await window.supabase.auth.signInWithPassword({
                email: email,
                password: password,
            });

            if (error) {
                console.error('Supabase Login Error:', error.message);
                window.showMessage(`Erro de Login: ${error.message}`, "error");
            } else if (data.user) {
                window.showMessage("Login bem-sucedido!", "success");
                // Hide any previous login error messages
                const loginErrorMessageDiv = document.getElementById('login-error-message');
                if (loginErrorMessageDiv) {
                    loginErrorMessageDiv.classList.add('hidden');
                }
                loginPage.classList.remove('active');
                dashboardPage.classList.add('active');
                if (!window.dashboardInitialized) {
                    window.initializeDashboard();
                    window.dashboardInitialized = true;
                }
            }
        });

        // Handle register form submission
        registerForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const name = registerForm.querySelector('#register-name').value;
            const email = registerForm.querySelector('#register-email').value;
            const phone = registerForm.querySelector('#register-phone').value; // Get phone number
            const password = registerForm.querySelector('#register-password').value;

            console.log("Attempting to register with:", { name, email, phone, password: '***' }); // Debugging line

            if (!window.supabase) {
                window.showMessage("Erro: Supabase não inicializado. Verifique as suas credenciais.", "error");
                return;
            }

            if (!name || !email || !password) {
                window.showMessage("Por favor, preencha todos os campos obrigatórios do registo.", "error");
                return;
            }

            // Supabase sign-up
            const { data, error } = await window.supabase.auth.signUp({
                email: email,
                password: password,
                options: {
                    data: {
                        full_name: name, // Store full name in user metadata
                        phone_number: phone // Store phone number in user metadata
                    }
                }
            });

            if (error) {
                console.error('Supabase Signup Error:', error.message);
                window.showMessage(`Erro de Registo: ${error.message}. Por favor, verifique se o email já está em uso ou se a senha é forte o suficiente.`, "error");
            } else if (data.user) {
                console.log("Supabase signup successful:", data.user); // Debugging line
                window.showMessage("Registo bem-sucedido! Por favor, verifique o seu email para confirmar a conta.", "success");
                hideRegisterModal();
                // Optionally, pre-fill login form with new user's email
                loginForm.querySelector('#email').value = email;
            }
        });

        window.lucide.createIcons(); 
    });
</script>
</body>
</html>
