<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema Círculos</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- Chart.js for dashboard graphs -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #e5e7eb; }
        ::-webkit-scrollbar-thumb { background: #9ca3af; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #6b7280; }
        
        .page, .content-section { display: none; }
        .page.active { display: block; }
        #dashboard-page.active { display: flex; flex-direction: column; }
        .content-section.active { display: block; }
        .content-section.flex-active { display: flex; }

        .login-bg {
            background-image: linear-gradient(rgba(0, 0, 0, 0.6), rgba(0, 0, 0, 0.6)), url('https://i.imgur.com/9x4CHMr.png');
            background-size: cover;
            background-position: center;
        }

        .nav-link.active {
             border-bottom-color: #3b82f6; /* Azul */
             color: #3b82f6;
        }
        .dropdown:hover .dropdown-menu { display: block; }
        .dropdown-menu {
            display: none;
            animation: fadeIn 0.2s ease-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .tab-link.active {
            border-color: #22c55e; /* green-500 */
            color: #22c55e;
        }
        /* Important: Ensure these base styles are not overridden by other CSS rules */
        .tab-content { display: none; }
        .tab-content.active { display: block; }

        /* Modal specific styles */
        .modal {
            transition: opacity 0.3s ease-in-out, visibility 0.3s ease-in-out;
        }
        .modal.hidden {
            opacity: 0;
            visibility: hidden;
        }
        .modal:not(.hidden) {
            opacity: 1;
            visibility: visible;
        }
        .modal-content {
            transform: translateY(-20px);
            transition: transform 0.3s ease-in-out;
        }
        .modal:not(.hidden) .modal-content {
            transform: translateY(0);
        }
        /* Custom message box for alerts */
        #message-box {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1050; /* Ensure it's above modals */
            display: none;
            padding: 1rem;
            border-radius: 0.5rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .message-box-success {
            background-color: #d1fae5;
            color: #065f46;
        }
        .message-box-error {
            background-color: #fee2e2;
            color: #991b1b;
        }
        /* Custom styles for product listing to match the image */
        .product-listing-header {
            background-color: #1a1a1a; /* Dark background from image */
            color: #e0e0e0;
        }
        .product-search-input-dark {
            background-color: #333;
            border-color: #555;
            color: #e0e0e0;
        }
        .filter-chip {
            background-color: #444;
            color: #eee;
            border-radius: 0.375rem; /* rounded-md */
            padding: 0.25rem 0.625rem; /* px-2.5 py-1 */
            font-size: 0.875rem; /* text-sm */
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
        }
        .filter-chip-clear {
            background-color: transparent;
            color: #aaa;
        }
        .product-table-dark {
            background-color: #222;
            color: #ccc;
        }
        .product-table-dark th {
            background-color: #333;
            color: #e0e0e0;
        }
        .product-table-dark tr:nth-child(even) {
            background-color: #2a2a2a;
        }
        .product-table-dark tr:hover {
            background-color: #3a3a3a;
        }
        .product-table-dark td {
            border-bottom: 1px solid #444;
        }
        .product-table-dark tr.selected-row {
            background-color: #3b82f630; /* Light blue tint for selected rows */
        }

        /* Calendar Picker Specific Styles */
        .date-picker-modal-content {
            background-color: #1a1a1a;
            color: #e0e0e0;
            border-radius: 0.5rem;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.5);
        }
        .calendar-nav-btn {
            background-color: #333;
            color: #e0e0e0;
            padding: 0.25rem 0.5rem;
            border-radius: 0.25rem;
            transition: background-color 0.2s;
        }
        .calendar-nav-btn:hover {
            background-color: #555;
        }
        .calendar-day {
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 0.25rem;
            cursor: pointer;
            transition: background-color 0.2s, color 0.2s;
            font-size: 0.875rem; /* text-sm */
        }
        .calendar-day.current-month {
            color: #e0e0e0;
        }
        .calendar-day.other-month {
            color: #666;
        }
        .calendar-day.selected {
            background-color: #22c55e; /* green-500 */
            color: white;
            font-weight: 600;
        }
        .calendar-day.range-selected {
            background-color: #1a563a; /* darker green for range */
            color: white;
        }
        .calendar-day.today {
            border: 1px solid #22c55e;
        }
        .quick-select-btn {
            background-color: #333;
            color: #e0e0e0;
            padding: 0.5rem 0.75rem;
            border-radius: 0.375rem;
            text-align: left;
            width: 100%;
            transition: background-color 0.2s;
            font-size: 0.875rem;
        }
        .quick-select-btn:hover {
            background-color: #444;
        }
        .quick-select-btn.active-preset {
            background-color: #22c55e;
            color: white;
            font-weight: 600;
        }

        /* Sales Page Search Results */
        .search-results {
            position: absolute;
            background-color: white;
            border: 1px solid #d1d5db;
            border-radius: 0.375rem;
            width: 100%;
            max-height: 200px;
            overflow-y: auto;
            z-index: 40; /* Needs to be above other content */
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
        }
        .search-results div {
            padding: 0.5rem 0.75rem;
            cursor: pointer;
        }
        .search-results div:hover {
            background-color: #f3f4f6;
        }
    </style>
    <!-- Supabase SDKs - ALL IMPORTS CONSOLIDATED AND MADE GLOBALLY AVAILABLE HERE -->
    <script type="module">
        import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

        // Global variables for Supabase instances
        window.supabase = null;
        window.userId = null;
        window.dashboardInitialized = false;
        window.appId = 'default-app-id'; // Global appId, initialized with default

        // Utility function for showing messages - now global
        window.showMessage = function(message, type = 'success') {
            const messageBox = document.getElementById('message-box');
            const messageText = document.getElementById('message-text');
            if (type === 'hide') {
                messageBox.style.display = 'none';
                return;
            }
            messageText.textContent = message;
            messageBox.classList.remove('message-box-success', 'message-box-error');
            messageBox.classList.add(`message-box-${type}`);
            messageBox.style.display = 'block';
            setTimeout(() => {
                messageBox.style.display = 'none';
            }, 5000);
        };

        // Function to initialize Supabase and attempt authentication
        window.initSupabaseAndAuth = async () => {
            console.log("initSupabaseAndAuth: Starting Supabase initialization and authentication.");

            // ==============================================================================================
            // === ATENÇÃO EXTREMA: CONFIGURAÇÃO DO SUPABASE É OBRIGATÓRIA!                                ===
            // ===                                                                                          ===
            // === Por favor, SUBSTITUA OS PLACEHOLDERS ABAIXO com o SEU URL e CHAVE ANON REAIS do Supabase. ===
            // === Encontrará estas credenciais no seu painel Supabase em 'Settings' -> 'API'.               ===
            // ===                                                                                          ===
            // === O URL deve começar com 'https://' (ex: https://abcde12345.supabase.co).                 ===
            // === A Chave Anon é uma string longa que começa com 'eyJ...'.                                  ===
            // ===                                                                                          ===
            // === NÃO DEIXE ESTES VALORES COMO PLACEHOLDERS!                                              ===
            // ==============================================================================================
            let localSupabaseUrl = "https://bmgkulpexiqibbgwwxcx.supabase.co"; // <--- COLOQUE O SEU URL REAL DO SUPABASE AQUI! EX: "https://abcdefghijk.supabase.co"
            let localSupabaseAnonKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJtZ2t1bHBleGlxaWJiZ3d3eGN4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ0MDU0ODUsImV4cCI6MjA2OTk4MTQ4NX0.JClBYIz7CbnHkn04LWYEtVzoz66FMSfR1Mjg-LRUqjI"; // <--- COLOQUE A SUA CHAVE ANON REAL DO SUPABASE AQUI! EX: "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFiY2RlZmdoamlrIiwicm9sZSI6ImFub24iLCJpYXQiOjE2NzgwODk2MDAsImV4cCI6MTk5MzY2NTYwMH0.1234567890abcdefghijklmnopqrstuvwxyz"
            // ==============================================================================================


            // Determine Supabase credentials and appId
            let finalSupabaseUrl = localSupabaseUrl;
            let finalSupabaseAnonKey = localSupabaseAnonKey;

            // Check if Canvas global variables are provided and valid
            if (typeof __supabase_url !== 'undefined' && typeof __supabase_url === 'string' && __supabase_url.trim() !== '') {
                finalSupabaseUrl = __supabase_url;
            }
            if (typeof __supabase_anon_key !== 'undefined' && typeof __supabase_anon_key === 'string' && __supabase_anon_key.trim() !== '') {
                finalSupabaseAnonKey = __supabase_anon_key;
            }
            if (typeof __app_id !== 'undefined' && typeof __app_id === 'string' && __app_id.trim() !== '') {
                window.appId = __app_id;
            }
            
            // Check if user has replaced placeholders for local development
            const defaultSupabaseUrlPlaceholder = "https://your-project-id.supabase.co"; // This is the placeholder URL
            const defaultSupabaseAnonKeyPlaceholder = "YOUR_SUPABASE_ANON_KEY_HERE_FROM_SUPABASE_DASHBOARD"; // This is the placeholder key

            if (finalSupabaseUrl === defaultSupabaseUrlPlaceholder || finalSupabaseAnonKey === defaultSupabaseAnonKeyPlaceholder) {
                console.error("initSupabaseAndAuth: ERRO CRÍTICO: Supabase URL ou Chave Anon não configurados.");
                window.showMessage("Erro: Credenciais do Supabase ausentes. Por favor, edite o código para inserir o seu URL e Chave Anon reais do Supabase.", "error");
                const loginErrorMessageDiv = document.getElementById('login-error-message');
                if (loginErrorMessageDiv) {
                    loginErrorMessageDiv.textContent = "ERRO: Credenciais do Supabase não configuradas.";
                    loginErrorMessageDiv.classList.remove('hidden');
                }
                return;
            }

            // Create Supabase client
            window.supabase = createClient(finalSupabaseUrl, finalSupabaseAnonKey);
            console.log("initSupabaseAndAuth: Supabase client created.");

            if (!window.supabase) {
                console.error("initSupabaseAndAuth: Supabase client failed to initialize.");
                window.showMessage("Erro: Falha ao inicializar o Supabase.", "error");
                return;
            }

            // Listen for auth changes - This is the single source of truth for auth UI
            window.supabase.auth.onAuthStateChange((event, session) => {
                console.log('Supabase auth state changed:', { event, session });

                const loginPage = document.getElementById('login-page');
                const dashboardPage = document.getElementById('dashboard-page');
                const userIdDisplay = document.getElementById('user-id-display');

                if (session) {
                    // User is logged in
                    window.userId = session.user.id;
                    if (userIdDisplay) {
                        userIdDisplay.textContent = `ID do Utilizador: ${window.userId}`;
                    }
                    
                    // Show dashboard and hide login
                    loginPage.classList.remove('active');
                    dashboardPage.classList.add('active');

                    // Initialize dashboard only once
                    if (!window.dashboardInitialized) {
                        console.log(`Initializing dashboard due to auth event: ${event}`);
                        window.initializeDashboard();
                        window.dashboardInitialized = true;
                    }
                } else {
                    // User is logged out
                    window.userId = null;
                    if (userIdDisplay) {
                        userIdDisplay.textContent = `ID do Utilizador: Não autenticado`;
                    }

                    // Show login and hide dashboard
                    loginPage.classList.add('active');
                    dashboardPage.classList.remove('active');
                    window.dashboardInitialized = false; // Reset dashboard state for next login
                }
            });
        };

        // Call the initialization function once the DOM is fully loaded
        document.addEventListener('DOMContentLoaded', window.initSupabaseAndAuth);
    </script>
</head>
<body>

    <!-- Message Box for alerts -->
    <div id="message-box" class="message-box-success">
        <span id="message-text"></span>
        <button class="float-right ml-4 text-sm font-semibold" onclick="window.showMessage('', 'hide')">&times;</button>
    </div>

    <!-- PÁGINA DE LOGIN -->
    <div id="login-page" class="page active">
        <div class="min-h-screen flex flex-col items-center justify-center px-4 login-bg">
            <div class="w-full max-w-md">
                <div class="text-center mb-8">
                    <img src="https://i.imgur.com/gM6495x.png" alt="Logo Círculos" class="mx-auto h-28 w-auto">
                    <p class="text-gray-200 mt-4 text-lg">Aceda à sua conta para gerir o seu negócio.</p>
                </div>
                <div class="bg-white rounded-xl shadow-lg p-8">
                    <div id="login-error-message" class="hidden text-red-500 text-center mb-4 font-bold"></div>
                    <form id="login-form">
                        <div class="space-y-6">
                            <div>
                                <label for="email" class="block text-sm font-medium text-gray-700">Email</label>
                                <div class="mt-1 relative">
                                    <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none"><i data-lucide="mail" class="w-5 h-5 text-gray-400"></i></div>
                                    <input type="email" id="email" name="email" required class="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-400" placeholder="voce@email.com">
                                </div>
                            </div>
                            <div>
                                <div class="flex justify-between items-center">
                                    <label for="password" class="block text-sm font-medium text-gray-700">Senha</label>
                                    <a href="#" class="text-sm text-blue-500 hover:underline">Esqueceu a senha?</a>
                                </div>
                                <div class="mt-1 relative">
                                    <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none"><i data-lucide="lock" class="w-5 h-5 text-gray-400"></i></div>
                                    <input type="password" id="password" name="password" required class="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-400" placeholder="Sua senha">
                                </div>
                            </div>
                            <div>
                                <button type="submit" class="w-full bg-blue-500 text-white font-semibold py-2.5 px-4 rounded-md hover:bg-blue-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition-colors">Entrar</button>
                            </div>
                        </div>
                    </form>
                    <div class="mt-6 text-center">
                        <a href="#" id="signup-link" class="font-medium text-blue-500 hover:text-blue-600">Crie a sua conta gratuitamente</a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- PAINEL PRINCIPAL DO SISTEMA -->
    <div id="dashboard-page" class="page h-screen">
        <header class="bg-white text-gray-800 shadow-md z-20 border-b">
            <div class="w-full px-6 flex justify-between items-center">
                <div class="h-16 flex items-center">
                    <img src="https://i.imgur.com/0ooTC9z.png" alt="Logo Círculos" class="h-10 w-auto">
                    <span id="user-id-display" class="ml-4 text-xs text-gray-500">ID do Utilizador: A carregar...</span>
                </div>
                <div class="flex items-center gap-6">
                    <nav class="flex items-center h-full text-sm font-medium text-gray-600">
                        <a href="#" id="nav-dashboard" class="nav-link h-16 flex items-center px-4 hover:bg-gray-100 transition-colors border-b-2 border-transparent">Dashboard</a>
                        <div class="dropdown relative h-16 flex items-center">
                            <button id="nav-catalogo" class="nav-link h-full flex items-center px-4 hover:bg-gray-100 transition-colors gap-2 border-b-2 border-transparent">
                                <span>Registos</span><i data-lucide="chevron-down" class="w-4 h-4"></i>
                            </button>
                            <div class="dropdown-menu absolute left-0 mt-16 w-56 bg-white rounded-b-md shadow-lg py-1 z-30 text-gray-800 border-t">
                                <a href="#" id="link-produtos" class="block px-4 py-2 text-sm hover:bg-gray-100">Produtos</a>
                                <a href="#" id="link-clientes-fornecedores" class="block px-4 py-2 text-sm hover:bg-gray-100">Clientes e Fornecedores</a>
                            </div>
                        </div>
                        <a href="#" id="nav-vendas" class="nav-link h-16 flex items-center px-4 hover:bg-gray-100 transition-colors border-b-2 border-transparent">Vendas</a>
                        <a href="#" id="nav-estoque" class="nav-link h-16 flex items-center px-4 hover:bg-gray-100 transition-colors border-b-2 border-transparent">Inventário</a>
                        <a href="#" id="nav-financeiro" class="nav-link h-16 flex items-center px-4 hover:bg-gray-100 transition-colors border-b-2 border-transparent">Financeiro</a>
                    </nav>
                    <div class="h-16 flex items-center border-l pl-6">
                         <button id="logout-btn" class="flex items-center gap-2 text-sm font-medium text-gray-500 hover:text-red-500 transition-colors duration-200 p-2 rounded-md hover:bg-red-50">
                            <i data-lucide="log-out" class="w-4 h-4"></i>
                            <span>Sair</span>
                        </button>
                    </div>
                </div>
            </div>
        </header>
        <main id="page-content" class="flex-1 overflow-y-auto bg-gray-50 p-6"></main> <!-- Added p-6 for spacing -->
        <div id="modal-container"></div>
    </div>

    <!-- MODAIS GLOBAIS (SEMPRE PRESENTES NO DOM, APENAS ESCONDIDOS) -->
    <div id="register-modal" class="modal hidden fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-60">
        <div class="modal-content bg-white rounded-lg shadow-xl w-full max-w-md p-6">
            <div class="flex justify-between items-center border-b pb-3 mb-4">
                <h3 class="text-xl font-semibold text-gray-800">Crie a sua conta</h3>
                <button id="register-modal-close" class="text-gray-400 hover:text-gray-600 p-1.5 rounded-md"><i data-lucide="x" class="w-5 h-5"></i></button>
            </div>
            <form id="register-form" class="space-y-4">
                <div>
                    <label for="register-name" class="block text-sm font-medium text-gray-700">Nome Completo</label>
                    <input type="text" id="register-name" name="name" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 focus:outline-none focus:ring-2 focus:ring-blue-400" placeholder="O seu nome">
                </div>
                <div>
                    <label for="register-email" class="block text-sm font-medium text-gray-700">Email</label>
                    <input type="email" id="register-email" name="email" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 focus:outline-none focus:ring-2 focus:ring-blue-400" placeholder="o-seu@email.com">
                </div>
                <div>
                    <label for="register-phone" class="block text-sm font-medium text-gray-700">Telefone</label>
                    <input type="tel" id="register-phone" name="phone" class="mt-1 block w-full border border-gray-300 rounded-md p-2 shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-400" placeholder="(XX) XXXXX-XXXX">
                </div>
                <div>
                    <label for="register-password" class="block text-sm font-medium text-gray-700">Senha</label>
                    <input type="password" id="register-password" name="password" required class="mt-1 block w-full border border-gray-300 rounded-md p-2 shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-400" placeholder="Crie uma senha segura">
                </div>
                <div>
                    <button type="submit" class="w-full bg-green-500 text-white font-semibold py-2.5 px-4 rounded-md hover:bg-green-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 transition-colors">Registar</button>
                </div>
            </form>
        </div>
    </div>
    
    <div id="product-modal" class="modal hidden fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-60"><div class="modal-content bg-white text-gray-800 rounded-lg shadow-xl w-full max-w-5xl max-h-[95vh] flex flex-col"><div class="p-4 flex justify-between items-center border-b border-gray-200 relative"><h3 class="text-xl font-semibold">Detalhes do Produto</h3><div class="flex gap-4 items-center"><button id="product-modal-cancel" class="border border-gray-300 bg-gray-100 hover:bg-gray-200 text-gray-700 font-semibold py-1.5 px-3 rounded-md transition-colors duration-200">Cancelar</button><button type="submit" form="product-form" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-1.5 px-3 rounded-md transition-colors duration-200">Guardar produto</button><button id="product-modal-header-close" class="text-gray-500 hover:text-gray-700 transition-colors duration-200 ml-4 p-1.5 rounded-md"><i data-lucide="x" class="w-5 h-5"></i></button></div></div><form id="product-form" class="flex-1 overflow-y-auto p-6 space-y-6"><div class="grid grid-cols-12 gap-6 items-start"><div class="col-span-3 flex flex-col items-center justify-center bg-gray-50 rounded-lg border-2 border-dashed border-gray-200 p-4 h-48 relative overflow-hidden"><img id="product-image-preview" src="https://placehold.co/160x160/cbd5e1/475569?text=Sem%20Imagem" alt="Pré-visualização da Imagem" class="max-w-full max-h-full object-contain rounded-md mb-2"><input type="file" id="product-image-input" accept="image/*" class="absolute inset-0 opacity-0 cursor-pointer"><label for="product-image-input" class="absolute inset-0 flex items-center justify-center text-gray-500 hover:text-blue-500 cursor-pointer"><i data-lucide="camera" class="w-8 h-8"></i></label></div><div class="col-span-9 grid grid-cols-3 gap-4"><div><label class="block text-sm font-medium text-gray-700">Nome*</label><input type="text" name="product-name" required class="w-full bg-white border border-gray-300 rounded-md p-2 shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-400"></div><div><label class="block text-sm font-medium text-gray-700">Código (SKU)</label><div class="flex gap-2 mt-1"><input type="text" name="product-sku" class="w-full bg-white border border-gray-300 rounded-md p-2 shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-400"><button type="button" id="generate-barcode-btn" class="bg-blue-500 hover:bg-blue-600 text-white font-semibold py-1.5 px-3 rounded-md text-sm flex-shrink-0 transition-colors duration-200">Gerar Interno</button></div></div><div><label class="block text-sm font-medium text-gray-700">Preço Venda</label><input type="number" step="0.01" name="product-price" class="w-full bg-white border border-gray-300 rounded-md p-2 shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-400"></div><div><label class="block text-sm font-medium text-gray-700">Estoque Atual</label><input type="number" name="stock_quantity" class="w-full bg-white border border-gray-300 rounded-md p-2 shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-400"></div><div><label class="block text-sm font-medium text-gray-700">Formato</label><select name="product-format" class="w-full bg-white border border-gray-300 rounded-md p-2 shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-400"><option>Simples</option><option>Variável</option></select></div><div><label class="block text-sm font-medium text-gray-700">Tipo</label><select name="product-type" class="w-full bg-white border border-gray-300 rounded-md p-2 shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-400"><option>Produto</option><option>Serviço</option></select></div><div><label class="block text-sm font-medium text-gray-700">Condição</label><select name="product-condition" class="w-full bg-white border border-gray-300 rounded-md p-2 shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-400"><option>Novo</option><option>Usado</option><option>Recondicionado</option></select></div></div></div><div class="border-b border-gray-200 mt-6"><nav class="-mb-px flex space-x-6" id="modal-tabs"><a href="#" class="tab-link active whitespace-nowrap py-3 px-1 border-b-2 font-medium text-sm border-green-500 text-green-500" data-tab="caracteristicas">Características</a><a href="#" class="tab-link whitespace-nowrap py-3 px-1 border-b-2 font-medium text-sm border-transparent text-gray-500 hover:border-gray-300 hover:text-gray-700" data-tab="imagens">Imagens</a><a href="#" class="tab-link whitespace-nowrap py-3 px-1 border-b-2 font-medium text-sm border-transparent text-gray-500 hover:border-gray-300 hover:text-gray-700" data-tab="fornecedores">Fornecedores</a><a href="#" class="tab-link whitespace-nowrap py-3 px-1 border-b-2 font-medium text-sm border-transparent text-gray-500 hover:border-gray-300 hover:text-gray-700" data-tab="tributacao">Tributação</a></nav></div><div id="tab-content-container" class="pt-6"><div id="caracteristicas" class="tab-content active grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-x-6 gap-y-4"><!-- Existing characteristic fields --><div class="space-y-1"><label class="block text-sm font-medium text-gray-700">Marca</label><input type="text" name="product-brand" class="w-full bg-white border border-gray-300 rounded-md p-2 shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-400"></div><div class="space-y-1"><label class="block text-sm font-medium text-gray-700">Produção</label><select name="product-production" class="w-full bg-white border border-gray-300 rounded-md p-2 shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-400"><option>Própria</option><option>Terceirizada</option></select></div><div class="space-y-1"><label class="block text-sm font-medium text-gray-700">Data de Validade</label><input type="date" name="product-expiration-date" class="w-full bg-white border border-gray-300 rounded-md p-2 shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-400"></div><div class="space-y-1"><label class="block text-sm font-medium text-gray-700">Frete Grátis</label><select name="product-free-shipping" class="w-full bg-white border border-gray-300 rounded-md p-2 shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-400"><option value="false">Não</option><option value="true">Sim</option></select></div><div class="space-y-1"><label class="block text-sm font-medium text-gray-700">Peso Líquido (kg)</label><input type="number" step="0.01" name="product-liquid-weight" class="w-full bg-white border border-gray-300 rounded-md p-2 shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-400"></div><div class="space-y-1"><label class="block text-sm font-medium text-gray-700">Peso Bruto (kg)</label><input type="number" step="0.01" name="product-gross-weight" class="w-full bg-white border border-gray-300 rounded-md p-2 shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-400"></div><div class="space-y-1"><label class="block text-sm font-medium text-gray-700">Largura (cm)</label><input type="number" step="0.01" name="product-width" class="w-full bg-white border border-gray-300 rounded-md p-2 shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-400"></div><div class="space-y-1"><label class="block text-sm font-medium text-gray-700">Altura (cm)</label><input type="number" step="0.01" name="product-height" class="w-full bg-white border border-gray-300 rounded-md p-2 shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-400"></div><div class="space-y-1"><label class="block text-sm font-medium text-gray-700">Profundidade (cm)</label><input type="number" step="0.01" name="product-depth" class="w-full bg-white border border-gray-300 rounded-md p-2 shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-400"></div><div class="space-y-1"><label class="block text-sm font-medium text-gray-700">Volumes</label><input type="number" name="product-volumes" class="w-full bg-white border border-gray-300 rounded-md p-2 shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-400"></div><div class="space-y-1"><label class="block text-sm font-medium text-gray-700">Itens p/ caixa</label><input type="number" name="product-items-per-box" class="w-full bg-white border border-gray-300 rounded-md p-2 shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-400"></div><div class="space-y-1"><label class="block text-sm font-medium text-gray-700">Unidade de medida</label><select name="product-measurement-unit" class="w-full bg-white border border-gray-300 rounded-md p-2 shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-400"><option>Centímetros</option><option>Metros</option><option>Polegadas</option></select></div><div class="space-y-1"><label class="block text-sm font-medium text-gray-700">GTIN/EAN</label><div class="flex gap-2 mt-1"><input type="text" name="product-gtinean" class="w-full bg-white border border-gray-300 rounded-md p-2 shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-400" placeholder="SEM GTIN"><button type="button" id="generate-gtinean-btn" class="bg-blue-500 hover:bg-blue-600 text-white font-semibold py-1.5 px-3 rounded-md text-sm flex-shrink-0 transition-colors duration-200">Gerar Interno</button></div></div><div class="space-y-1"><label class="block text-sm font-medium text-gray-700">GTIN/EAN Tributário</label><input type="text" name="product-gtinean-tax" class="w-full bg-white border border-gray-300 rounded-md p-2 shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-400" placeholder="SEM GTIN"></div></div><div id="imagens" class="tab-content flex flex-col items-center p-4 gap-4"><p class="text-gray-600">Arraste e solte imagens ou clique no ícone para carregar.</p><div class="w-full flex items-center gap-2 mb-4"><input type="url" id="image-url-input" class="flex-1 bg-white border border-gray-300 rounded-md p-2 shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-400" placeholder="Cole o link direto da imagem aqui (terminando em .jpg, .png, etc.)"><button type="button" id="add-image-url-btn" class="bg-blue-500 hover:bg-blue-600 text-white font-semibold py-1.5 px-3 rounded-md text-sm flex-shrink-0 transition-colors duration-200">Adicionar por Link</button></div><div id="image-drop-area" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4 w-full p-4 border-2 border-dashed border-gray-300 rounded-md bg-gray-50 min-h-[150px] items-center justify-center"></div></div><div id="fornecedores" class="tab-content space-y-4"><h4 class="text-lg font-semibold text-gray-800 mb-4">Gerir Fornecedores do Produto</h4><div class="grid grid-cols-1 md:grid-cols-2 gap-4"><div><label class="block text-sm font-medium text-gray-700">Nome do Fornecedor</label><input type="text" name="supplier-name" class="w-full bg-white border border-gray-300 rounded-md p-2 shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-400" placeholder="Nome do fornecedor"></div><div><label class="block text-sm font-medium text-gray-700">Código do Fornecedor</label><input type="text" name="supplier-code" class="w-full bg-white border border-gray-300 rounded-md p-2 shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-400" placeholder="Código de referência do fornecedor"></div><div class="md:col-span-2"><label class="block text-sm font-medium text-gray-700">Preço de Custo</label><input type="number" step="0.01" name="supplier-cost-price" class="w-full bg-white border border-gray-300 rounded-md p-2 shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-400" placeholder="0.00"></div></div><button type="button" class="mt-4 bg-blue-500 hover:bg-blue-600 text-white font-semibold py-1.5 px-3 rounded-md flex items-center gap-2 transition-colors duration-200"><i data-lucide="plus" class="w-5 h-5"></i> Adicionar Fornecedor</button></div><div id="tributacao" class="tab-content space-y-4"><h4 class="text-lg font-semibold text-gray-800 mb-4">Configurações de Tributação</h4><div class="grid grid-cols-1 md:grid-cols-2 gap-4"><div><label class="block text-sm font-medium text-gray-700">NCM (Nomenclatura Comum do Mercosul)</label><input type="text" name="tax-ncm" class="w-full bg-white border border-gray-300 rounded-md p-2 shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-400" placeholder="Ex: 8471.30.12"></div><div><label class="block text-sm font-medium text-gray-700">CEST (Código Especificador da Substituição Tributária)</label><input type="text" name="tax-cest" class="w-full bg-white border border-gray-300 rounded-md p-2 shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-400" placeholder="Ex: 28.064.00"></div><div><label class="block text-sm font-medium text-gray-700">Origem da Mercadoria</label><select name="tax-origin" class="w-full bg-white border border-gray-300 rounded-md p-2 shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-400"><option value="0">0 - Nacional, exceto as indicadas nos códigos 3, 4, 5 e 8</option><option value="1">1 - Estrangeira - Importação direta</option><option value="2">2 - Estrangeira - Adquirida no mercado interno</option></select></div><div><label class="block text-sm font-medium text-gray-700">Tipo de Tributação</label><select name="tax-type" class="w-full bg-white border border-gray-300 rounded-md p-2 shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-400"><option>Normal</option><option>Simples Nacional</option></select></div></div></div></div></form></div></div>
    <div id="import-modal" class="modal hidden fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-60"><div class="modal-content bg-white rounded-lg shadow-xl w-full max-w-2xl p-6"><div class="flex justify-between items-center border-b pb-3 mb-4"><h3 class="text-xl font-semibold text-gray-800">Importar Produtos em Massa</h3><button id="import-modal-close" class="text-gray-400 hover:text-gray-600 p-1.5 rounded-md"><i data-lucide="x" class="w-5 h-5"></i></button></div><div class="space-y-6 mt-4"><div><h4 class="font-semibold text-gray-700">Passo 1: Baixe o nosso modelo</h4><p class="text-sm text-gray-600 mt-1">Para garantir que os seus dados são importados corretamente, use o nosso ficheiro modelo. Preencha-o com os seus produtos antes de carregar.</p><button id="download-template-btn" class="mt-3 bg-gray-100 hover:bg-gray-200 text-gray-800 font-semibold py-2 px-4 rounded-md flex items-center gap-2 transition-colors duration-200 border border-gray-300"><i data-lucide="download-cloud" class="w-4 h-4"></i> Baixar Modelo (CSV)</button></div><div class="border-t border-gray-200"></div><div><h4 class="font-semibold text-gray-700">Passo 2: Carregue o seu ficheiro preenchido</h4><p class="text-sm text-gray-600 mt-1">Formatos suportados: CSV, XLS, XLSX.</p><div id="import-drop-area" class="mt-3 flex justify-center items-center w-full h-32 px-6 border-2 border-gray-300 border-dashed rounded-md cursor-pointer hover:border-blue-500 bg-gray-50"><div class="text-center"><i data-lucide="upload-cloud" class="mx-auto h-10 w-10 text-gray-400"></i><p id="import-file-text" class="mt-2 text-sm text-gray-600"><span class="font-semibold">Clique para carregar</span> ou arraste e solte</p><input id="import-file-input" type="file" class="hidden" accept=".csv, application/vnd.openxmlformats-officedocument.spreadsheetml.sheet, application/vnd.ms-excel"></div></div><p id="import-file-name" class="text-sm text-gray-500 mt-2"></p></div></div><div class="flex justify-end items-center border-t pt-4 mt-6 gap-4"><button id="import-modal-cancel" class="border border-gray-300 bg-white hover:bg-gray-100 text-gray-700 font-semibold py-1.5 px-3 rounded-md transition-colors duration-200">Cancelar</button><button id="process-import-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-1.5 px-3 rounded-md transition-colors duration-200 disabled:bg-gray-400" disabled>Importar Produtos</button></div></div></div>
    <div id="date-picker-modal" class="modal hidden fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-60">
        <div class="date-picker-modal-content w-full max-w-4xl p-6 flex gap-6">
            <div class="flex-1 flex flex-col space-y-4">
                <div class="flex items-center justify-between">
                    <button id="prev-month-left" class="calendar-nav-btn"><i data-lucide="chevron-left" class="w-4 h-4"></i></button>
                    <h4 id="month-display-left" class="text-md font-semibold text-gray-300"></h4>
                    <button id="next-month-left" class="calendar-nav-btn"><i data-lucide="chevron-right" class="w-4 h-4"></i></button>
                </div>
                <div class="grid grid-cols-7 text-center text-xs text-gray-400 font-medium">
                    <span>Dom</span><span>Seg</span><span>Ter</span><span>Qua</span><span>Qui</span><span>Sex</span><span>Sáb</span>
                </div>
                <div id="calendar-grid-left" class="grid grid-cols-7 gap-1">
                    <!-- Days will be generated here -->
                </div>
            </div>
            <div class="flex-1 flex flex-col space-y-4">
                <div class="flex items-center justify-between">
                    <button id="prev-month-right" class="calendar-nav-btn"><i data-lucide="chevron-left" class="w-4 h-4"></i></button>
                    <h4 id="month-display-right" class="text-md font-semibold text-gray-300"></h4>
                    <button id="next-month-right" class="calendar-nav-btn"><i data-lucide="chevron-right" class="w-4 h-4"></i></button>
                </div>
                <div class="grid grid-cols-7 text-center text-xs text-gray-400 font-medium">
                    <span>Dom</span><span>Seg</span><span>Ter</span><span>Qua</span><span>Qui</span><span>Sex</span><span>Sáb</span>
                </div>
                <div id="calendar-grid-right" class="grid grid-cols-7 gap-1">
                    <!-- Days will be generated here -->
                </div>
            </div>
            <div class="w-1/4 flex flex-col space-y-2 ml-6">
                <h5 class="text-sm font-semibold mb-2">Períodos Rápidos</h5>
                <button class="quick-select-btn" data-preset="today">Hoje</button>
                <button class="quick-select-btn" data-preset="this_week">Esta semana</button>
                <button class="quick-select-btn" data-preset="last_week">Semana passada</button>
                <button class="quick-select-btn" data-preset="this_month">Este mês</button>
                <button class="quick-select-btn" data-preset="last_month">Mês passado</button>
                <button class="quick-select-btn mt-4 active-preset" data-preset="custom">Período customizado</button>
                <div class="flex-grow"></div>
                <div class="flex gap-2 mt-4">
                    <button id="date-picker-cancel-btn" class="flex-1 bg-gray-600 hover:bg-gray-700 text-white font-semibold py-1.5 px-3 rounded-md text-sm transition-colors duration-200">Cancelar</button>
                    <button id="date-picker-filter-btn" class="flex-1 bg-green-500 hover:bg-green-600 text-white font-semibold py-1.5 px-3 rounded-md text-sm transition-colors duration-200">Filtrar</button>
                </div>
            </div>
            <button id="date-picker-close-btn" class="absolute top-3 right-3 text-gray-400 hover:text-gray-200 p-1.5 rounded-md"><i data-lucide="x" class="w-4 h-4"></i></button>
        </div>
    </div>
    <!-- Confirmation Modal -->
    <div id="confirmation-modal" class="modal hidden fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-60">
        <div class="modal-content bg-white rounded-lg shadow-xl w-full max-w-md p-6">
            <h3 id="confirmation-title" class="text-lg font-medium text-gray-900">Confirmar Ação</h3>
            <div class="mt-2">
                <p id="confirmation-message" class="text-sm text-gray-500">Tem a certeza de que deseja executar esta ação?</p>
            </div>
            <div class="mt-5 sm:mt-6 sm:grid sm:grid-flow-row-dense sm:grid-cols-2 sm:gap-3">
                <button id="confirm-action-btn" type="button" class="inline-flex w-full justify-center rounded-md bg-red-600 px-3 py-2 text-sm font-semibold text-white shadow-sm hover:bg-red-500 sm:col-start-2">Confirmar</button>
                <button id="cancel-action-btn" type="button" class="mt-3 inline-flex w-full justify-center rounded-md bg-white px-3 py-2 text-sm font-semibold text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 hover:bg-gray-50 sm:col-start-1 sm:mt-0">Cancelar</button>
            </div>
        </div>
    </div>
    <!-- Contact Modal -->
    <div id="contact-modal" class="modal hidden fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-60">
        <div class="modal-content bg-white rounded-lg shadow-xl w-full max-w-3xl max-h-[95vh] flex flex-col">
            <div class="flex justify-between items-center border-b p-4">
                <h3 id="contact-modal-title" class="text-xl font-semibold text-gray-800">Registo de Contacto</h3>
                <button id="contact-modal-close" class="text-gray-400 hover:text-gray-600 p-1.5 rounded-md"><i data-lucide="x" class="w-5 h-5"></i></button>
            </div>
            <form id="contact-form" class="flex-1 overflow-y-auto p-6 space-y-4">
                 <!-- Basic Info -->
                 <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Tipo de Contacto*</label>
                        <select name="contact_type" required class="w-full mt-1 bg-white border border-gray-300 rounded-md p-2 shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-400">
                            <option value="Cliente">Cliente</option>
                            <option value="Fornecedor">Fornecedor</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Tipo de Pessoa*</label>
                        <select name="person_type" required class="w-full mt-1 bg-white border border-gray-300 rounded-md p-2 shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-400">
                            <option value="Física">Física</option>
                            <option value="Jurídica">Jurídica</option>
                        </select>
                    </div>
                 </div>
                 <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Nome / Razão Social*</label>
                        <input type="text" name="name" required class="w-full mt-1 bg-white border border-gray-300 rounded-md p-2 shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-400">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">CPF / CNPJ</label>
                        <input type="text" name="cpf_cnpj" class="w-full mt-1 bg-white border border-gray-300 rounded-md p-2 shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-400">
                    </div>
                 </div>
                 <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Email</label>
                        <input type="email" name="email" class="w-full mt-1 bg-white border border-gray-300 rounded-md p-2 shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-400">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Telefone</label>
                        <input type="tel" name="phone" class="w-full mt-1 bg-white border border-gray-300 rounded-md p-2 shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-400">
                    </div>
                     <div id="credit-limit-field" class="hidden">
                        <label class="block text-sm font-medium text-gray-700">Limite de Crédito (R$)</label>
                        <input type="number" step="0.01" name="credit_limit" class="w-full mt-1 bg-white border border-gray-300 rounded-md p-2 shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-400" placeholder="0.00">
                    </div>
                 </div>
                 <!-- Address -->
                 <div class="pt-4 border-t">
                    <h4 class="text-md font-semibold text-gray-800 mb-2">Endereço</h4>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                         <div>
                            <label class="block text-sm font-medium text-gray-700">CEP</label>
                            <input type="text" name="address_zipcode" class="w-full mt-1 bg-white border border-gray-300 rounded-md p-2 shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-400">
                        </div>
                        <div class="md:col-span-2">
                            <label class="block text-sm font-medium text-gray-700">Rua</label>
                            <input type="text" name="address_street" class="w-full mt-1 bg-white border border-gray-300 rounded-md p-2 shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-400">
                        </div>
                    </div>
                     <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mt-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Número</label>
                            <input type="text" name="address_number" class="w-full mt-1 bg-white border border-gray-300 rounded-md p-2 shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-400">
                        </div>
                        <div class="md:col-span-2">
                            <label class="block text-sm font-medium text-gray-700">Complemento</label>
                            <input type="text" name="address_complement" class="w-full mt-1 bg-white border border-gray-300 rounded-md p-2 shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-400">
                        </div>
                    </div>
                     <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mt-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Bairro</label>
                            <input type="text" name="address_neighborhood" class="w-full mt-1 bg-white border border-gray-300 rounded-md p-2 shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-400">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Cidade</label>
                            <input type="text" name="address_city" class="w-full mt-1 bg-white border border-gray-300 rounded-md p-2 shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-400">
                        </div>
                         <div>
                            <label class="block text-sm font-medium text-gray-700">Estado</label>
                            <input type="text" name="address_state" class="w-full mt-1 bg-white border border-gray-300 rounded-md p-2 shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-400">
                        </div>
                    </div>
                 </div>
                 <!-- Notes -->
                 <div class="pt-4 border-t">
                    <label class="block text-sm font-medium text-gray-700">Observações</label>
                    <textarea name="notes" rows="3" class="w-full mt-1 bg-white border border-gray-300 rounded-md p-2 shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-400"></textarea>
                 </div>
            </form>
            <div class="flex justify-end items-center border-t p-4 gap-4">
                <button id="contact-modal-cancel" class="border border-gray-300 bg-white hover:bg-gray-100 text-gray-700 font-semibold py-1.5 px-3 rounded-md transition-colors duration-200">Cancelar</button>
                <button type="submit" form="contact-form" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-1.5 px-3 rounded-md transition-colors duration-200">Guardar Contacto</button>
            </div>
        </div>
    </div>


    <script type="module">
        // This function will be called after Supabase init and auth attempt
        window.initializeDashboard = () => {
            console.log('initializeDashboard started.');
            const pageContent = document.getElementById('page-content');
            const navLinks = document.querySelectorAll('.nav-link');
            const logoutBtn = document.getElementById('logout-btn');

            if (logoutBtn) {
                logoutBtn.addEventListener('click', async (e) => {
                    e.preventDefault();
                    console.log('Logout button clicked.');
                    window.showMessage('A terminar a sessão...', 'info');
                    const { error } = await window.supabase.auth.signOut();
                    if (error) {
                        console.error('Error signing out:', error);
                        window.showMessage(`Erro ao terminar a sessão: ${error.message}`, 'error');
                    } else {
                        window.showMessage('Sessão terminada com sucesso.', 'success');
                        // The onAuthStateChange listener will handle the UI redirection automatically.
                    }
                });
            }

            const setActiveLink = (id) => {
                navLinks.forEach(link => {
                    link.classList.remove('active', 'text-blue-500', 'border-blue-500');
                    link.classList.add('border-transparent');
                });
                const activeLink = document.getElementById(id);
                if (activeLink) {
                    activeLink.classList.add('active', 'text-blue-500', 'border-blue-500');
                    activeLink.classList.remove('border-transparent');
                }
            };

            const showPage = (pageHtml, navId, scriptRunner) => {
                console.log(`showPage called for navId: ${navId}`);
                pageContent.innerHTML = pageHtml;
                setActiveLink(navId);
                window.lucide.createIcons();
                if(scriptRunner) scriptRunner();
            };

            const runDashboardScript = () => {
                console.log('runDashboardScript started');
                const weeklySalesCtx = document.getElementById('weeklySalesChart')?.getContext('2d');
                const topProductsCtx = document.getElementById('topProductsChart')?.getContext('2d');

                if (weeklySalesCtx) {
                    new Chart(weeklySalesCtx, {
                        type: 'bar',
                        data: {
                            labels: ['Seg', 'Ter', 'Qua', 'Qui', 'Sex', 'Sáb', 'Dom'],
                            datasets: [{
                                label: 'Vendas da Semana',
                                data: [120, 190, 300, 500, 200, 350, 400], // Dados de exemplo
                                backgroundColor: 'rgba(59, 130, 246, 0.5)',
                                borderColor: 'rgba(59, 130, 246, 1)',
                                borderWidth: 1
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            scales: { y: { beginAtZero: true } }
                        }
                    });
                }

                if (topProductsCtx) {
                    new Chart(topProductsCtx, {
                        type: 'doughnut',
                        data: {
                            labels: ['Produto A', 'Produto B', 'Produto C', 'Produto D', 'Outros'],
                             datasets: [{
                                label: 'Produtos Mais Vendidos',
                                data: [300, 150, 100, 50, 120], // Dados de exemplo
                                backgroundColor: [
                                    'rgba(16, 185, 129, 0.7)',
                                    'rgba(59, 130, 246, 0.7)',
                                    'rgba(239, 68, 68, 0.7)',
                                    'rgba(245, 158, 11, 0.7)',
                                    'rgba(107, 114, 128, 0.7)'
                                ],
                                hoverOffset: 4
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                        }
                    });
                }
            };
            
            // Function to run the Product System specific script
            const runProductSystemScript = () => {
                console.log('runProductSystemScript started.');
                try { 
                    const tableBody = document.getElementById('product-table-body');
                    const addProductBtn = document.getElementById('add-product-btn');
                    const productModal = document.getElementById('product-modal');
                    const productForm = document.getElementById('product-form');
                    const modalCloseButton = productModal.querySelector('#product-modal-header-close'); 
                    const cancelBtn = document.getElementById('product-modal-cancel');
                    const generateBarcodeBtn = document.getElementById('generate-barcode-btn');
                    const generateGtinEanBtn = document.getElementById('generate-gtinean-btn'); 
                    const productImageInput = document.getElementById('product-image-input');
                    const productImagePreview = document.getElementById('product-image-preview');
                    const imageDropArea = productModal.querySelector('#image-drop-area'); 
                    const addImageUrlInput = productModal.querySelector('#image-url-input');
                    const addImageUrlBtn = document.getElementById('add-image-url-btn');
                    const filterSituacao = document.getElementById('filter-situacao');
                    const filterTags = document.getElementById('filter-tags');
                    const filterCategoria = document.getElementById('filter-categoria');
                    const filterNCM = document.getElementById('filter-ncm');
                    const filterTipo = document.getElementById('filter-tipo');
                    const filterMarca = document.getElementById('filter-marca');
                    const clearFiltersBtn = document.getElementById('clear-filters-btn');
                    const filterChipsContainer = document.getElementById('filter-chips-container');
                    const dateRangeDisplay = document.getElementById('date-range-display');
                    const datePickerModal = document.getElementById('date-picker-modal');
                    const datePickerCloseBtn = document.getElementById('date-picker-close-btn');
                    const datePickerCancelBtn = document.getElementById('date-picker-cancel-btn');
                    const datePickerFilterBtn = document.getElementById('date-picker-filter-btn');
                    const searchDateStartInput = document.getElementById('search-date-start');
                    const searchDateEndInput = document.getElementById('search-date-end');
                    const monthDisplayLeft = document.getElementById('month-display-left');
                    const calendarGridLeft = document.getElementById('calendar-grid-left');
                    const monthDisplayRight = document.getElementById('month-display-right');
                    const calendarGridRight = document.getElementById('calendar-grid-right');
                    const prevMonthBtnLeft = document.getElementById('prev-month-left');
                    const nextMonthBtnLeft = document.getElementById('next-month-left');
                    const prevMonthBtnRight = document.getElementById('prev-month-right');
                    const nextMonthBtnRight = document.getElementById('next-month-right');
                    const importProductsBtn = document.getElementById('import-products-btn');
                    const exportProductsBtn = document.getElementById('export-products-btn');
                    const productSearchInput = document.getElementById('product-search-input');
                    const toggleFilterSidebarBtn = document.getElementById('toggle-filter-sidebar-btn');
                    const lockBtn = document.getElementById('lock-product-btn');
                    const printerBtn = document.getElementById('printer-product-btn');
                    const trashBtn = document.getElementById('trash-product-btn');
                    const refreshBtn = document.getElementById('refresh-product-btn');
                    const viewOptionsBtn = document.getElementById('view-options-product-btn');
                    const selectAllCheckbox = document.getElementById('select-all-products');
                    const confirmationModal = document.getElementById('confirmation-modal');
                    const confirmationTitle = document.getElementById('confirmation-title');
                    const confirmationMessage = document.getElementById('confirmation-message');
                    const confirmActionBtn = document.getElementById('confirm-action-btn');
                    const cancelActionBtn = document.getElementById('cancel-action-btn');

                    const MAX_IMAGES = 4;
                    let productImages = [];
                    let editingProductId = null;
                    
                    // --- SUPABASE DATA FUNCTIONS ---

                    const loadProducts = async () => {
                        tableBody.innerHTML = '<tr><td colspan="8" class="p-3 text-center text-gray-400">A carregar produtos...</td></tr>';
                        
                        const { data: products, error } = await window.supabase
                            .from('products')
                            .select('*')
                            .order('created_at', { ascending: false });

                        if (error) {
                            console.error('Error fetching products:', error);
                            window.showMessage('Erro ao carregar produtos.', 'error');
                            tableBody.innerHTML = '<tr><td colspan="8" class="p-3 text-center text-red-400">Erro ao carregar. Tente novamente.</td></tr>';
                            return;
                        }

                        if (products.length === 0) {
                            tableBody.innerHTML = '<tr><td colspan="8" class="p-3 text-center text-gray-500">Nenhum produto encontrado. Adicione um novo!</td></tr>';
                            return;
                        }

                        tableBody.innerHTML = ''; // Clear table
                        products.forEach(product => {
                            const tr = document.createElement('tr');
                            tr.dataset.productId = product.id;
                            tr.innerHTML = `
                                <td class="p-3"><input type="checkbox" class="product-checkbox rounded-sm text-blue-500 bg-gray-600 border-gray-500"></td>
                                <td class="p-3">
                                    <img src="${product.images && product.images.length > 0 ? product.images[0] : 'https://placehold.co/40x40/444444/ffffff?text=Prod'}" alt="Produto" class="w-10 h-10 rounded-sm object-cover">
                                </td>
                                <td class="p-3">${product.name}</td>
                                <td class="p-3">${product.sku || '-'}</td>
                                <td class="p-3">${product.measurement_unit || 'UN'}</td>
                                <td class="p-3">${product.sale_price ? `R$ ${product.sale_price.toFixed(2)}` : '-'}</td>
                                <td class="p-3 text-center">${product.stock_quantity || 0}</td>
                                <td class="text-center p-3">
                                    <button class="p-0.5 text-gray-400 hover:text-blue-400 rounded-sm" data-action="edit"><i data-lucide="edit" class="w-3.5 h-3.5"></i></button>
                                    <button class="p-0.5 text-gray-400 hover:text-red-600 rounded-sm" data-action="delete"><i data-lucide="trash-2" class="w-3.5 h-3.5"></i></button>
                                </td>
                            `;
                            tableBody.appendChild(tr);
                        });
                        window.lucide.createIcons();
                    };

                    const populateProductForm = (product) => {
                        productForm.querySelector('[name="product-name"]').value = product.name ?? '';
                        productForm.querySelector('[name="product-sku"]').value = product.sku ?? '';
                        productForm.querySelector('[name="product-price"]').value = product.sale_price ?? '';
                        productForm.querySelector('[name="stock_quantity"]').value = product.stock_quantity ?? 0;
                        productForm.querySelector('[name="product-format"]').value = product.format ?? 'Simples';
                        productForm.querySelector('[name="product-type"]').value = product.type ?? 'Produto';
                        productForm.querySelector('[name="product-condition"]').value = product.condition ?? 'Novo';
                        productForm.querySelector('[name="product-brand"]').value = product.brand ?? '';
                        productForm.querySelector('[name="product-production"]').value = product.production_type ?? 'Própria';
                        productForm.querySelector('[name="product-expiration-date"]').value = product.expiration_date ?? '';
                        productForm.querySelector('[name="product-free-shipping"]').value = product.free_shipping ? 'true' : 'false';
                        productForm.querySelector('[name="product-liquid-weight"]').value = product.net_weight_kg ?? '';
                        productForm.querySelector('[name="product-gross-weight"]').value = product.gross_weight_kg ?? '';
                        productForm.querySelector('[name="product-width"]').value = product.width_cm ?? '';
                        productForm.querySelector('[name="product-height"]').value = product.height_cm ?? '';
                        productForm.querySelector('[name="product-depth"]').value = product.depth_cm ?? '';
                        productForm.querySelector('[name="product-volumes"]').value = product.volumes ?? '';
                        productForm.querySelector('[name="product-items-per-box"]').value = product.items_per_box ?? '';
                        productForm.querySelector('[name="product-measurement-unit"]').value = product.measurement_unit ?? 'Centímetros';
                        productForm.querySelector('[name="product-gtinean"]').value = product.gtin_ean ?? '';
                        productForm.querySelector('[name="product-gtinean-tax"]').value = product.gtin_ean_tax ?? '';
                        productForm.querySelector('[name="tax-ncm"]').value = product.ncm ?? '';
                        productForm.querySelector('[name="tax-cest"]').value = product.cest ?? '';
                        productForm.querySelector('[name="tax-origin"]').value = product.origin ?? '0';
                        
                        productImages = product.images || [];
                        renderImagePreviews();
                    };


                    productForm.addEventListener('submit', async (e) => {
                        e.preventDefault();
                        const formData = new FormData(productForm);
                        
                        const productData = {
                            name: formData.get('product-name'),
                            sku: formData.get('product-sku'),
                            sale_price: parseFloat(formData.get('product-price')) || null,
                            stock_quantity: parseInt(formData.get('stock_quantity')) || 0,
                            format: formData.get('product-format'),
                            type: formData.get('product-type'),
                            condition: formData.get('product-condition'),
                            brand: formData.get('product-brand'),
                            production_type: formData.get('product-production'),
                            expiration_date: formData.get('product-expiration-date') || null,
                            free_shipping: formData.get('product-free-shipping') === 'true',
                            net_weight_kg: parseFloat(formData.get('product-liquid-weight')) || null,
                            gross_weight_kg: parseFloat(formData.get('product-gross-weight')) || null,
                            width_cm: parseFloat(formData.get('product-width')) || null,
                            height_cm: parseFloat(formData.get('product-height')) || null,
                            depth_cm: parseFloat(formData.get('product-depth')) || null,
                            volumes: parseInt(formData.get('product-volumes')) || null,
                            items_per_box: parseInt(formData.get('product-items-per-box')) || null,
                            measurement_unit: formData.get('product-measurement-unit'),
                            gtin_ean: formData.get('product-gtinean'),
                            gtin_ean_tax: formData.get('product-gtinean-tax'),
                            images: productImages, // from the global array
                            ncm: formData.get('tax-ncm'),
                            cest: formData.get('tax-cest'),
                            origin: formData.get('tax-origin')
                        };
                        
                        let error;
                        if (editingProductId) {
                            console.log('Updating product:', editingProductId, productData);
                            const { error: updateError } = await window.supabase
                                .from('products')
                                .update(productData)
                                .eq('id', editingProductId);
                            error = updateError;
                        } else {
                            console.log('Inserting new product:', productData);
                            const { error: insertError } = await window.supabase
                                .from('products')
                                .insert([productData]);
                            error = insertError;
                        }

                        if (error) {
                            console.error('Error saving product:', error);
                            window.showMessage(`Erro ao guardar produto: ${error.message}`, 'error');
                        } else {
                            window.showMessage(`Produto ${editingProductId ? 'atualizado' : 'guardado'} com sucesso!`, 'success');
                            hideProductModal();
                            loadProducts(); // Refresh the list
                        }
                    });


                    // --- UI & EVENT LISTENERS ---
                     const showConfirmationModal = (title, message, onConfirm) => {
                        confirmationTitle.textContent = title;
                        confirmationMessage.textContent = message;

                        const newConfirmBtn = confirmActionBtn.cloneNode(true);
                        confirmActionBtn.parentNode.replaceChild(newConfirmBtn, confirmActionBtn);
                        
                        const confirmHandler = () => {
                            onConfirm();
                            confirmationModal.classList.add('hidden');
                        };
                        newConfirmBtn.addEventListener('click', confirmHandler, { once: true });
                        
                        const cancelHandler = () => {
                            confirmationModal.classList.add('hidden');
                            newConfirmBtn.removeEventListener('click', confirmHandler);
                        };
                        cancelActionBtn.addEventListener('click', cancelHandler, { once: true });

                        confirmationModal.classList.remove('hidden');
                    };


                    const months = ["Janeiro", "Fevereiro", "Março", "Abril", "Maio", "Junho", "Julho", "Agosto", "Setembro", "Outubro", "Novembro", "Dezembro"];
                    let currentMonthLeft = new Date();
                    let selectedStartDate = null;
                    let selectedEndDate = null;

                    const formatDate = (date) => {
                        if (!date) return '';
                        const d = new Date(date);
                        return d.toLocaleDateString('pt-BR', { day: '2-digit', month: '2-digit', year: 'numeric' });
                    };

                    const updateDateRangeDisplay = () => {
                        const start = searchDateStartInput.value;
                        const end = searchDateEndInput.value;
                        if(dateRangeDisplay) {
                            if (start && end) {
                                dateRangeDisplay.textContent = `${formatDate(start)} - ${formatDate(end)}`;
                            } else if (start) {
                                dateRangeDisplay.textContent = `${formatDate(start)} - Fim`;
                            } else if (end) {
                                dateRangeDisplay.textContent = `Início - ${formatDate(end)}`;
                            } else {
                                dateRangeDisplay.textContent = 'Data do Pedido';
                            }
                        }
                    };

                    const renderCalendar = (monthDate, calendarGrid, monthDisplay) => {
                        if (!calendarGrid || !monthDisplay) return;
                        calendarGrid.innerHTML = '';
                        monthDisplay.textContent = `${months[monthDate.getMonth()]} ${monthDate.getFullYear()}`;

                        const firstDayOfMonth = new Date(monthDate.getFullYear(), monthDate.getMonth(), 1);
                        const today = new Date();
                        today.setHours(0, 0, 0, 0);
                        const startDay = new Date(firstDayOfMonth);
                        startDay.setDate(firstDayOfMonth.getDate() - firstDayOfMonth.getDay());

                        for (let i = 0; i < 42; i++) {
                            const day = new Date(startDay);
                            day.setDate(startDay.getDate() + i);
                            const dayElement = document.createElement('div');
                            dayElement.classList.add('calendar-day');
                            dayElement.textContent = day.getDate();
                            dayElement.dataset.date = day.toISOString().split('T')[0];

                            if (day.getMonth() === monthDate.getMonth()) {
                                dayElement.classList.add('current-month');
                            } else {
                                dayElement.classList.add('other-month');
                            }
                            if (day.getTime() === today.getTime()) {
                                dayElement.classList.add('today');
                            }
                            if (selectedStartDate && selectedEndDate && day.getTime() >= new Date(selectedStartDate).getTime() && day.getTime() <= new Date(selectedEndDate).getTime()) {
                                dayElement.classList.add('range-selected');
                            }
                            if (selectedStartDate && day.getTime() === new Date(selectedStartDate).getTime()) {
                                dayElement.classList.add('selected');
                            }
                            if (selectedEndDate && day.getTime() === new Date(selectedEndDate).getTime()) {
                                dayElement.classList.add('selected');
                            }
                            
                            dayElement.addEventListener('click', () => {
                                const clickedDate = day.toISOString().split('T')[0];
                                if (!selectedStartDate || (selectedStartDate && selectedEndDate)) {
                                    selectedStartDate = clickedDate;
                                    selectedEndDate = null;
                                } else if (new Date(clickedDate).getTime() < new Date(selectedStartDate).getTime()) {
                                    selectedEndDate = selectedStartDate;
                                    selectedStartDate = clickedDate;
                                } else {
                                    selectedEndDate = clickedDate;
                                }
                                renderCalendars();
                            });
                            calendarGrid.appendChild(dayElement);
                        }
                    };

                    const renderCalendars = () => {
                        const monthDateRight = new Date(currentMonthLeft);
                        monthDateRight.setMonth(currentMonthLeft.getMonth() + 1);
                        renderCalendar(currentMonthLeft, calendarGridLeft, monthDisplayLeft);
                        renderCalendar(monthDateRight, calendarGridRight, monthDisplayRight);
                    };

                    const navigateMonth = (direction) => {
                        currentMonthLeft.setMonth(currentMonthLeft.getMonth() + direction);
                        renderCalendars();
                    };
                    
                    const setPresetDateRange = (preset) => {
                        const today = new Date();
                        today.setHours(0, 0, 0, 0);
                        let start = null;
                        let end = today;

                        if (preset === 'today') start = today;
                        else if (preset === 'this_week') {
                            start = new Date(today);
                            start.setDate(today.getDate() - today.getDay());
                        } else if (preset === 'last_week') {
                            end = new Date(today);
                            end.setDate(today.getDate() - today.getDay() - 1);
                            start = new Date(end);
                            start.setDate(end.getDate() - 6);
                        } else if (preset === 'this_month') {
                            start = new Date(today.getFullYear(), today.getMonth(), 1);
                        } else if (preset === 'last_month') {
                            end = new Date(today.getFullYear(), today.getMonth(), 0);
                            start = new Date(end.getFullYear(), end.getMonth(), 1);
                        }

                        selectedStartDate = start ? start.toISOString().split('T')[0] : null;
                        selectedEndDate = end ? end.toISOString().split('T')[0] : null;

                        if (selectedStartDate) {
                            currentMonthLeft = new Date(selectedStartDate);
                            currentMonthLeft.setDate(1);
                        }
                        renderCalendars();
                        document.querySelectorAll('.quick-select-btn').forEach(btn => btn.classList.remove('active-preset'));
                        const activeBtn = document.querySelector(`.quick-select-btn[data-preset="${preset}"]`);
                        if (activeBtn) activeBtn.classList.add('active-preset');
                    };

                    dateRangeDisplay?.addEventListener('click', () => {
                        if (datePickerModal) {
                            selectedStartDate = searchDateStartInput.value || null;
                            selectedEndDate = searchDateEndInput.value || null;
                            if(selectedStartDate) currentMonthLeft = new Date(selectedStartDate);
                            renderCalendars();
                            datePickerModal.classList.remove('hidden');
                        }
                    });

                    datePickerCloseBtn?.addEventListener('click', () => datePickerModal?.classList.add('hidden'));
                    datePickerCancelBtn?.addEventListener('click', () => datePickerModal?.classList.add('hidden'));
                    datePickerFilterBtn?.addEventListener('click', () => {
                        searchDateStartInput.value = selectedStartDate || '';
                        searchDateEndInput.value = selectedEndDate || '';
                        updateDateRangeDisplay();
                        datePickerModal?.classList.add('hidden');
                        applyFilters();
                    });
                    prevMonthBtnLeft?.addEventListener('click', () => navigateMonth(-1));
                    nextMonthBtnLeft?.addEventListener('click', () => navigateMonth(1));
                    prevMonthBtnRight?.addEventListener('click', () => navigateMonth(-1));
                    nextMonthBtnRight?.addEventListener('click', () => navigateMonth(1));
                    document.querySelectorAll('.quick-select-btn').forEach(btn => {
                        btn.addEventListener('click', () => setPresetDateRange(btn.dataset.preset));
                    });

                    updateDateRangeDisplay();
                    renderCalendars();

                    const renderFilterChips = (appliedFilters) => {
                        filterChipsContainer.innerHTML = '';
                        Object.entries(appliedFilters).forEach(([key, value]) => {
                            if (value) {
                                const chip = document.createElement('span');
                                chip.className = 'filter-chip';
                                chip.innerHTML = `${key}: ${value} <button class="ml-1 text-gray-300 hover:text-white" data-filter="${key}"><i data-lucide="x" class="w-3 h-3"></i></button>`;
                                filterChipsContainer.appendChild(chip);
                            }
                        });
                        if (Object.values(appliedFilters).some(v => v)) {
                            const clearChip = document.createElement('button');
                            clearChip.className = 'filter-chip-clear ml-2 text-sm font-semibold hover:text-white';
                            clearChip.innerHTML = `<i data-lucide="x" class="w-4 h-4 mr-1"></i> Limpar`;
                            clearChip.addEventListener('click', clearFilters);
                            filterChipsContainer.appendChild(clearChip);
                        }
                        window.lucide.createIcons();
                    };

                    const applyFilters = () => {
                        console.log('Aplicando filtros...');
                        const appliedFilters = {
                            situacao: filterSituacao?.value,
                            tags: filterTags?.value,
                            categoria: filterCategoria?.value,
                            ncm: filterNCM?.value,
                            tipo: filterTipo?.value,
                            marca: filterMarca?.value,
                            dataInicio: searchDateStartInput?.value,
                            dataFim: searchDateEndInput?.value,
                            termoPesquisa: productSearchInput?.value.trim()
                        };
                        renderFilterChips(appliedFilters);
                        window.showMessage("Funcionalidade de filtragem no Supabase pendente.", "info");
                    };

                    const clearFilters = () => {
                        console.log('A limpar filtros...');
                        [filterSituacao, filterTags, filterCategoria, filterNCM, filterTipo, filterMarca, searchDateStartInput, searchDateEndInput, productSearchInput].forEach(el => { if(el) el.value = ''; });
                        selectedStartDate = null;
                        selectedEndDate = null;
                        updateDateRangeDisplay();
                        renderCalendars();
                        applyFilters();
                        window.showMessage("Filtros limpos.", "info");
                    };

                    filterChipsContainer.addEventListener('click', (e) => {
                        const target = e.target.closest('button[data-filter]');
                        if (target) {
                            const filterToClear = target.dataset.filter;
                            const element = document.getElementById(`filter-${filterToClear}`) || document.getElementById(`product-search-input`);
                            if(element) element.value = '';
                            if(filterToClear === 'datas') {
                                searchDateStartInput.value = '';
                                searchDateEndInput.value = '';
                                updateDateRangeDisplay();
                            }
                            applyFilters();
                        }
                    });

                    clearFiltersBtn?.addEventListener('click', clearFilters);
                    productSearchInput?.addEventListener('keypress', (e) => e.key === 'Enter' && applyFilters());
                    toggleFilterSidebarBtn?.addEventListener('click', () => {
                        const filterSidebar = document.querySelector('aside:first-child');
                        const productSystemContainer = document.querySelector('.product-system-container');
                        filterSidebar?.classList.toggle('hidden');
                        productSystemContainer?.classList.toggle('grid-cols-[1fr_200px]', filterSidebar?.classList.contains('hidden'));
                        productSystemContainer?.classList.toggle('grid-cols-[288px_1fr_200px]', !filterSidebar?.classList.contains('hidden'));
                    });
                    
                    const handleBatchAction = (actionName, message) => {
                        const selectedProducts = Array.from(document.querySelectorAll('.product-checkbox:checked')).map(cb => cb.closest('tr').dataset.productId);
                        if (selectedProducts.length > 0) {
                            console.log(`${actionName} produtos: ${selectedProducts.join(', ')}`);
                            window.showMessage(`${message} ${selectedProducts.length} produtos. Funcionalidade pendente.`, "info");
                        } else {
                            window.showMessage(`Nenhum produto selecionado para ${actionName.toLowerCase()}.`, "warning");
                        }
                    };

                    lockBtn?.addEventListener('click', () => handleBatchAction('Bloquear', 'A bloquear'));
                    printerBtn?.addEventListener('click', () => handleBatchAction('Imprimir', 'A preparar impressão de'));
                    trashBtn?.addEventListener('click', () => handleBatchAction('Excluir', 'A mover'));
                    refreshBtn?.addEventListener('click', () => {
                        window.showMessage("A atualizar a lista de produtos...", "info");
                        loadProducts();
                    });
                    viewOptionsBtn?.addEventListener('click', () => window.showMessage("Opções de visualização pendentes.", "info"));

                    selectAllCheckbox?.addEventListener('change', (e) => {
                        document.querySelectorAll('.product-checkbox').forEach(checkbox => {
                            checkbox.checked = e.target.checked;
                            checkbox.closest('tr').classList.toggle('selected-row', e.target.checked);
                        });
                    });

                    tableBody.addEventListener('change', (e) => {
                        if (e.target.classList.contains('product-checkbox')) {
                            e.target.closest('tr').classList.toggle('selected-row', e.target.checked);
                            selectAllCheckbox.checked = Array.from(document.querySelectorAll('.product-checkbox')).every(cb => cb.checked);
                        }
                    });

                    const renderImagePreviews = () => {
                        if (!imageDropArea) return;
                        imageDropArea.innerHTML = '';
                        productImages.forEach((src, index) => {
                            const imageItem = document.createElement('div');
                            imageItem.className = 'relative group aspect-w-1 aspect-h-1 bg-gray-100 border rounded-md overflow-hidden flex items-center justify-center p-2';
                            imageItem.innerHTML = `<img src="${src}" alt="Pré-visualização ${index + 1}" class="object-cover w-full h-full" onerror="this.onerror=null;this.src='https://placehold.co/120x120/ef4444/ffffff?text=Falha';"><button type="button" class="absolute top-0.5 right-0.5 bg-red-500 text-white rounded-full p-0.5 opacity-0 group-hover:opacity-100 delete-image-btn" data-index="${index}"><i data-lucide="x" class="w-3 h-3"></i></button>`;
                            imageDropArea.appendChild(imageItem);
                        });
                        if (productImages.length < MAX_IMAGES) {
                            const plusIconDiv = document.createElement('div');
                            plusIconDiv.className = 'aspect-w-1 aspect-h-1 bg-gray-100 border-2 border-dashed rounded-md flex items-center justify-center text-gray-500 hover:border-blue-500 cursor-pointer add-image-slot';
                            plusIconDiv.innerHTML = '<i data-lucide="plus" class="w-8 h-8"></i>';
                            imageDropArea.appendChild(plusIconDiv);
                        }
                        productImagePreview.src = productImages.length > 0 ? productImages[0] : 'https://placehold.co/160x160/cbd5e1/475569?text=Sem%20Imagem';
                        window.lucide.createIcons();
                    };

                    addProductBtn.addEventListener('click', () => {
                        editingProductId = null; // Ensure we are in "add" mode
                        productForm.reset();
                        productImages = [];
                        renderImagePreviews();
                        productModal.classList.remove('hidden');
                    });
                    
                    const hideProductModal = () => productModal.classList.add('hidden');
                    modalCloseButton.addEventListener('click', hideProductModal);
                    cancelBtn.addEventListener('click', hideProductModal);

                    const addImageFile = (file) => {
                        if (productImages.length >= MAX_IMAGES) {
                            window.showMessage(`Limite de ${MAX_IMAGES} imagens atingido.`, "error");
                            return;
                        }
                        const reader = new FileReader();
                        reader.onload = (e) => {
                            productImages.push(e.target.result);
                            renderImagePreviews();
                        };
                        reader.readAsDataURL(file);
                    };

                    imageDropArea.addEventListener('click', (e) => {
                        if (e.target.closest('.add-image-slot')) productImageInput.click();
                        const deleteButton = e.target.closest('.delete-image-btn');
                        if (deleteButton) {
                            productImages.splice(parseInt(deleteButton.dataset.index, 10), 1);
                            renderImagePreviews();
                        }
                    });
                    productImageInput.addEventListener('change', (e) => e.target.files[0] && addImageFile(e.target.files[0]));
                    imageDropArea.addEventListener('dragover', (e) => e.preventDefault());
                    imageDropArea.addEventListener('drop', (e) => {
                        e.preventDefault();
                        if (e.dataTransfer.files[0]) addImageFile(e.dataTransfer.files[0]);
                    });

                    addImageUrlBtn.addEventListener('click', () => {
                        const imageUrl = addImageUrlInput.value.trim();
                        if (imageUrl) {
                            productImages.push(imageUrl);
                            renderImagePreviews();
                            addImageUrlInput.value = '';
                        }
                    });

                    generateBarcodeBtn.addEventListener('click', () => {
                        productForm.querySelector('[name="product-sku"]').value = `SKU-${Math.random().toString(36).substring(2, 8).toUpperCase()}`;
                    });
                    generateGtinEanBtn.addEventListener('click', () => {
                        productForm.querySelector('[name="product-gtinean"]').value = `GTIN-${Math.floor(100000000000 + Math.random() * 900000000000)}`;
                    });

                    tableBody.addEventListener('click', async (e) => {
                        const button = e.target.closest('button[data-action]');
                        if (!button) return;

                        const action = button.dataset.action;
                        const productId = button.closest('tr').dataset.productId;

                        if (action === 'delete') {
                            showConfirmationModal(
                                'Apagar Produto',
                                `Tem a certeza de that deseja apagar este produto? Esta ação não pode ser revertida.`,
                                async () => {
                                    console.log(`Deleting product with ID: ${productId}`);
                                    const { error } = await window.supabase.from('products').delete().eq('id', productId);
                                    if (error) {
                                        window.showMessage(`Erro ao apagar produto: ${error.message}`, 'error');
                                    } else {
                                        window.showMessage('Produto apagado com sucesso!', 'success');
                                        loadProducts();
                                    }
                                }
                            );
                        } else if (action === 'edit') {
                            const { data: product, error } = await window.supabase
                                .from('products')
                                .select('*')
                                .eq('id', productId)
                                .single(); // .single() gets one record as an object

                            if (error) {
                                window.showMessage(`Erro ao carregar dados do produto: ${error.message}`, 'error');
                            } else {
                                editingProductId = productId;
                                populateProductForm(product);
                                productModal.classList.remove('hidden');
                            }
                        }
                    });

                    document.getElementById('modal-tabs')?.addEventListener('click', (e) => {
                        e.preventDefault();
                        const tabLink = e.target.closest('.tab-link');
                        if (tabLink) {
                            document.querySelectorAll('#modal-tabs .tab-link, .tab-content').forEach(el => el.classList.remove('active', 'border-green-500', 'text-green-500'));
                            tabLink.classList.add('active', 'border-green-500', 'text-green-500');
                            document.getElementById(tabLink.dataset.tab)?.classList.add('active');
                        }
                    });
                    
                    const importModal = document.getElementById('import-modal');
                    const importModalCloseBtn = document.getElementById('import-modal-close');
                    const importModalCancelBtn = document.getElementById('import-modal-cancel');
                    const downloadTemplateBtn = document.getElementById('download-template-btn');
                    const importFileInput = document.getElementById('import-file-input');
                    const importDropArea = document.getElementById('import-drop-area');
                    const importFileText = document.getElementById('import-file-text');
                    const importFileName = document.getElementById('import-file-name');
                    const processImportBtn = document.getElementById('process-import-btn');

                    importProductsBtn?.addEventListener('click', () => importModal.classList.remove('hidden'));
                    const hideImportModal = () => importModal.classList.add('hidden');
                    importModalCloseBtn.addEventListener('click', hideImportModal);
                    importModalCancelBtn.addEventListener('click', hideImportModal);

                    downloadTemplateBtn.addEventListener('click', () => {
                        const headers = ["nome", "codigo_sku", "preco_venda", "formato", "tipo", "condicao", "marca", "producao", "data_validade", "frete_gratis", "peso_liquido_kg", "peso_bruto_kg", "largura_cm", "altura_cm", "profundidade_cm", "volumes", "itens_por_caixa", "unidade_medida", "gtin_ean", "gtin_ean_tributario", "ncm", "cest", "origem_mercadoria"];
                        const csvContent = "data:text/csv;charset=utf-8," + headers.join(",");
                        const link = document.createElement("a");
                        link.setAttribute("href", encodeURI(csvContent));
                        link.setAttribute("download", "modelo_importacao_produtos.csv");
                        link.click();
                    });

                    const handleFileSelect = (files) => {
                        if (files.length > 0) {
                            importFileName.textContent = `Ficheiro: ${files[0].name}`;
                            processImportBtn.disabled = false;
                        }
                    };

                    importDropArea.addEventListener('click', () => importFileInput.click());
                    importFileInput.addEventListener('change', (e) => handleFileSelect(e.target.files));
                    importDropArea.addEventListener('dragover', (e) => e.preventDefault());
                    importDropArea.addEventListener('drop', (e) => {
                        e.preventDefault();
                        handleFileSelect(e.dataTransfer.files);
                    });
                    processImportBtn.addEventListener('click', () => {
                        if (importFileInput.files.length > 0) {
                            window.showMessage(`A importar "${importFileInput.files[0].name}". Funcionalidade pendente.`, "info");
                            hideImportModal();
                        }
                    });

                    // --- Export Logic ---
                    exportProductsBtn.addEventListener('click', () => {
                        console.log('A exportar produtos...');
                        window.showMessage('A preparar a exportação...', 'info');

                        // Placeholder data - replace with actual data from Supabase
                        const productsToExport = [
                            { nome: "FITA VEDA ROSCA", codigo_sku: "9776", preco_venda: 1.99, unidade: "UN", estoque: 0 },
                            { nome: "CARRO INFANTIL PEQUENO", codigo_sku: "0301", preco_venda: 80.00, unidade: "UN", estoque: 2 },
                            { nome: "CARRO INFANTIL TOTOCA", codigo_sku: "6002", preco_venda: 180.00, unidade: "UN", estoque: 2 }
                        ];

                        if (productsToExport.length === 0) {
                            window.showMessage('Não há produtos para exportar.', 'error');
                            return;
                        }

                        const headers = ["Nome", "Codigo SKU", "Preco Venda", "Unidade", "Estoque"];
                        const csvRows = [headers.join(',')]; // Header row

                        productsToExport.forEach(product => {
                            const values = [
                                `"${product.nome}"`,
                                `"${product.codigo_sku}"`,
                                product.preco_venda,
                                `"${product.unidade}"`,
                                product.estoque
                            ];
                            csvRows.push(values.join(','));
                        });

                        const csvContent = csvRows.join('\n');
                        const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                        const url = URL.createObjectURL(blob);
                        const link = document.createElement("a");
                        link.setAttribute("href", url);
                        link.setAttribute("download", "produtos_exportados.csv");
                        link.style.visibility = 'hidden';
                        document.body.appendChild(link);
                        link.click();
                        document.body.removeChild(link);
                        window.showMessage('Exportação concluída!', 'success');
                    });


                    // Initial load
                    loadProducts();
                    applyFilters();
                } catch (error) {
                    console.error("An error occurred in runProductSystemScript:", error);
                    window.showMessage("Ocorreu um erro ao carregar o sistema de produtos.", "error");
                }
            };

            const runClientesFornecedoresScript = () => {
                console.log('runClientesFornecedoresScript started.');
                const tableBody = document.getElementById('cs-table-body');
                const addContactBtn = document.getElementById('add-cs-btn');
                const contactModal = document.getElementById('contact-modal');
                const contactForm = document.getElementById('contact-form');
                const contactModalCloseBtn = document.getElementById('contact-modal-close');
                const contactModalCancelBtn = document.getElementById('contact-modal-cancel');
                const contactModalTitle = document.getElementById('contact-modal-title');
                const contactTypeSelect = contactForm.querySelector('[name="contact_type"]');
                const creditLimitField = document.getElementById('credit-limit-field');
                const confirmationModal = document.getElementById('confirmation-modal');
                const confirmationTitle = document.getElementById('confirmation-title');
                const confirmationMessage = document.getElementById('confirmation-message');
                const confirmActionBtn = document.getElementById('confirm-action-btn');
                const cancelActionBtn = document.getElementById('cancel-action-btn');
                const searchInput = document.getElementById('contact-search-input');


                let editingContactId = null;

                const showConfirmationModal = (title, message, onConfirm) => {
                    confirmationTitle.textContent = title;
                    confirmationMessage.textContent = message;

                    const newConfirmBtn = confirmActionBtn.cloneNode(true);
                    confirmActionBtn.parentNode.replaceChild(newConfirmBtn, confirmActionBtn);
                    
                    const confirmHandler = () => {
                        onConfirm();
                        confirmationModal.classList.add('hidden');
                    };
                    newConfirmBtn.addEventListener('click', confirmHandler, { once: true });
                    
                    const cancelHandler = () => {
                        confirmationModal.classList.add('hidden');
                        newConfirmBtn.removeEventListener('click', confirmHandler);
                    };
                    cancelActionBtn.addEventListener('click', cancelHandler, { once: true });

                    confirmationModal.classList.remove('hidden');
                };

                const loadContacts = async (searchTerm = '') => {
                    tableBody.innerHTML = '<tr><td colspan="5" class="p-3 text-center text-gray-500">A carregar...</td></tr>';
                    
                    let query = window.supabase
                        .from('contacts')
                        .select('*')
                        .order('created_at', { ascending: false });
                    
                    if (searchTerm) {
                        query = query.or(`name.ilike.%${searchTerm}%,cpf_cnpj.ilike.%${searchTerm}%`);
                    }

                    const { data: contacts, error } = await query;

                    if (error) {
                        console.error('Error fetching contacts:', error);
                        tableBody.innerHTML = '<tr><td colspan="5" class="p-3 text-center text-red-400">Erro ao carregar contactos.</td></tr>';
                        return;
                    }

                    if (contacts.length === 0) {
                        tableBody.innerHTML = '<tr><td colspan="5" class="p-3 text-center text-gray-500">Nenhum contacto encontrado.</td></tr>';
                        return;
                    }

                    tableBody.innerHTML = '';
                    contacts.forEach(contact => {
                        const tr = document.createElement('tr');
                        tr.dataset.contactId = contact.id;
                        tr.innerHTML = `
                            <td class="p-3">${contact.name}</td>
                            <td class="p-3">${contact.cpf_cnpj || '-'}</td>
                             <td class="p-3">${contact.phone || '-'}</td>
                            <td class="p-3">${contact.contact_type}</td>
                            <td class="text-center p-3">
                                <button class="p-1.5 text-gray-500 hover:text-blue-600 rounded-md" data-action="edit"><i data-lucide="edit" class="w-4 h-4"></i></button>
                                <button class="p-1.5 text-gray-500 hover:text-red-600 rounded-md" data-action="delete"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                            </td>
                        `;
                        tableBody.appendChild(tr);
                    });
                    window.lucide.createIcons();
                };
                
                searchInput.addEventListener('keyup', (e) => {
                    const searchTerm = e.target.value.trim();
                    loadContacts(searchTerm);
                });

                const hideContactModal = () => contactModal.classList.add('hidden');

                const populateContactForm = (contact) => {
                    for (const key in contact) {
                        const field = contactForm.querySelector(`[name="${key}"]`);
                        if (field) {
                            field.value = contact[key] ?? '';
                        }
                    }
                    contactTypeSelect.dispatchEvent(new Event('change'));
                };

                contactTypeSelect.addEventListener('change', (e) => {
                    if (creditLimitField) {
                        if (e.target.value === 'Cliente') {
                            creditLimitField.classList.remove('hidden');
                        } else {
                            creditLimitField.classList.add('hidden');
                            creditLimitField.querySelector('input').value = '';
                        }
                    }
                });

                addContactBtn.addEventListener('click', () => {
                    editingContactId = null;
                    contactForm.reset();
                    contactModalTitle.textContent = 'Registo de Novo Contacto';
                    contactTypeSelect.value = 'Cliente';
                    contactTypeSelect.dispatchEvent(new Event('change'));
                    contactModal.classList.remove('hidden');
                });

                contactModalCloseBtn.addEventListener('click', hideContactModal);
                contactModalCancelBtn.addEventListener('click', hideContactModal);

                contactForm.addEventListener('submit', async(e) => {
                    e.preventDefault();
                    const formData = new FormData(contactForm);
                    const contactData = Object.fromEntries(formData.entries());
                    contactData.user_id = window.userId;

                    if (contactData.credit_limit) {
                        contactData.credit_limit = parseFloat(contactData.credit_limit);
                    } else {
                       contactData.credit_limit = null;
                    }
                    
                    if (!contactData.name) {
                        window.showMessage('O campo Nome é obrigatório.', 'error');
                        return;
                    }

                    let error;
                    if (editingContactId) {
                         const { error: updateError } = await window.supabase
                            .from('contacts')
                            .update(contactData)
                            .eq('id', editingContactId);
                        error = updateError;
                    } else {
                        const { error: insertError } = await window.supabase.from('contacts').insert([contactData]);
                        error = insertError;
                    }
                    
                    if (error) {
                         console.error('Error saving contact:', error);
                         window.showMessage(`Erro ao guardar contacto: ${error.message}`, 'error');
                    } else {
                        window.showMessage(`Contacto ${editingContactId ? 'atualizado' : 'guardado'} com sucesso!`, 'success');
                        hideContactModal();
                        loadContacts(searchInput.value.trim());
                    }
                });
                
                tableBody.addEventListener('click', async (e) => {
                    const button = e.target.closest('button[data-action]');
                    if (!button) return;

                    const action = button.dataset.action;
                    const contactId = button.closest('tr').dataset.contactId;

                    if (action === 'delete') {
                        showConfirmationModal(
                            'Apagar Contacto',
                            'Tem a certeza de that deseja apagar este contacto? Esta ação é irreversível.',
                            async () => {
                                const { error } = await window.supabase.from('contacts').delete().eq('id', contactId);
                                if (error) {
                                    window.showMessage(`Erro ao apagar: ${error.message}`, 'error');
                                } else {
                                    window.showMessage('Contacto apagado com sucesso.', 'success');
                                    loadContacts(searchInput.value.trim());
                                }
                            }
                        );
                    } else if (action === 'edit') {
                        const { data: contact, error } = await window.supabase
                            .from('contacts')
                            .select('*')
                            .eq('id', contactId)
                            .single();
                        
                        if (error) {
                            window.showMessage(`Erro ao carregar contacto: ${error.message}`, 'error');
                        } else {
                            editingContactId = contactId;
                            contactModalTitle.textContent = 'Editar Contacto';
                            populateContactForm(contact);
                            contactModal.classList.remove('hidden');
                        }
                    }
                });

                // Initial load
                loadContacts();
            };
            
            const runVendasScript = () => {
                console.log('runVendasScript started.');
                const customerSearchInput = document.getElementById('sale-customer-search');
                const productSearchInput = document.getElementById('sale-product-search');
                const customerSearchResults = document.getElementById('customer-search-results');
                const productSearchResults = document.getElementById('product-search-results');
                const saleItemsTableBody = document.getElementById('sale-items-table');
                const subtotalDisplay = document.getElementById('sale-subtotal');
                const totalDisplay = document.getElementById('sale-total');
                const discountInput = document.getElementById('sale-discount');
                const paymentMethodSelect = document.getElementById('sale-payment-method');
                const finishSaleBtn = document.getElementById('finish-sale-btn');
                const newSaleBtn = document.getElementById('new-sale-btn');


                let saleItems = [];
                let selectedCustomer = null;

                const debounce = (func, delay) => {
                    let timeout;
                    return (...args) => {
                        clearTimeout(timeout);
                        timeout = setTimeout(() => func.apply(this, args), delay);
                    };
                };

                const searchCustomers = async (searchTerm) => {
                    if (searchTerm.length < 2) {
                        customerSearchResults.innerHTML = '';
                        customerSearchResults.classList.add('hidden');
                        return;
                    }
                    const { data, error } = await supabase
                        .from('contacts')
                        .select('id, name, cpf_cnpj')
                        .or(`name.ilike.%${searchTerm}%,cpf_cnpj.ilike.%${searchTerm}%`)
                        .eq('contact_type', 'Cliente')
                        .limit(5);

                    customerSearchResults.innerHTML = '';
                    if (error || data.length === 0) {
                        customerSearchResults.classList.add('hidden');
                        return;
                    }
                    
                    data.forEach(customer => {
                        const div = document.createElement('div');
                        div.textContent = `${customer.name} (${customer.cpf_cnpj || 'N/D'})`;
                        div.dataset.customerId = customer.id;
                        div.addEventListener('click', () => {
                            selectedCustomer = customer;
                            customerSearchInput.value = customer.name;
                            customerSearchResults.classList.add('hidden');
                        });
                        customerSearchResults.appendChild(div);
                    });
                    customerSearchResults.classList.remove('hidden');
                };

                 const searchProducts = async (searchTerm) => {
                    if (searchTerm.length < 2) {
                        productSearchResults.innerHTML = '';
                        productSearchResults.classList.add('hidden');
                        return;
                    }
                     const { data, error } = await supabase
                        .from('products')
                        .select('id, name, sku, sale_price, stock_quantity')
                        .or(`name.ilike.%${searchTerm}%,sku.ilike.%${searchTerm}%`)
                        .limit(5);
                    
                    productSearchResults.innerHTML = '';
                    if (error || data.length === 0) {
                        productSearchResults.classList.add('hidden');
                        return;
                    }
                    
                    data.forEach(product => {
                        const div = document.createElement('div');
                        div.innerHTML = `<span class="font-semibold">${product.name}</span> <span class="text-xs text-gray-500">(Estoque: ${product.stock_quantity ?? 0})</span>`;
                        div.dataset.productId = product.id;
                        div.addEventListener('click', () => {
                           addItemToSale(product);
                           productSearchInput.value = '';
                           productSearchResults.classList.add('hidden');
                        });
                        productSearchResults.appendChild(div);
                    });
                    productSearchResults.classList.remove('hidden');
                };

                const updateTotals = () => {
                    const subtotal = saleItems.reduce((acc, item) => acc + (item.quantity * item.unit_price), 0);
                    const totalItemDiscount = saleItems.reduce((acc, item) => acc + item.discount, 0);
                    const globalDiscount = parseFloat(discountInput.value) || 0;
                    const totalDiscountValue = totalItemDiscount + globalDiscount;
                    const total = subtotal - totalDiscountValue;

                    subtotalDisplay.textContent = `R$ ${subtotal.toFixed(2)}`;
                    totalDisplay.textContent = `R$ ${total.toFixed(2)}`;
                };
                
                const renderSaleItems = () => {
                    saleItemsTableBody.innerHTML = '';
                    if (saleItems.length === 0) {
                         saleItemsTableBody.innerHTML = '<tr><td colspan="6" class="p-4 text-center text-gray-400">Nenhum produto adicionado.</td></tr>';
                    } else {
                        saleItems.forEach((item, index) => {
                            const tr = document.createElement('tr');
                            const subtotal = (item.quantity * item.unit_price) - item.discount;
                            tr.innerHTML = `
                                <td class="p-3 font-medium">${item.name}<br><span class="text-xs text-gray-500">Estoque: ${item.stock_available}</span></td>
                                <td class="p-3 text-center"><input type="number" value="${item.quantity}" min="1" max="${item.stock_available}" class="w-16 text-center border rounded-md py-1 quantity-input" data-index="${index}"></td>
                                <td class="p-3 text-right">R$ ${item.unit_price.toFixed(2)}</td>
                                <td class="p-3 text-right"><input type="number" value="${item.discount.toFixed(2)}" min="0" step="0.01" class="w-24 text-right border rounded-md py-1 px-2 discount-input" data-index="${index}"></td>
                                <td class="p-3 text-right font-semibold">R$ ${subtotal.toFixed(2)}</td>
                                <td class="p-3 text-center"><button class="text-red-500 hover:text-red-700 remove-item-btn" data-index="${index}"><i data-lucide="trash-2" class="w-4 h-4"></i></button></td>
                            `;
                            saleItemsTableBody.appendChild(tr);
                        });
                    }
                    window.lucide.createIcons();
                    updateTotals();
                };

                const addItemToSale = (product) => {
                    const existingItem = saleItems.find(item => item.product_id === product.id);
                    if (existingItem) {
                        if (existingItem.quantity < existingItem.stock_available) {
                           existingItem.quantity++;
                        } else {
                            window.showMessage('Quantidade máxima em estoque atingida.', 'error');
                        }
                    } else {
                        if ((product.stock_quantity ?? 0) > 0) {
                             saleItems.push({
                                product_id: product.id,
                                name: product.name,
                                quantity: 1,
                                unit_price: product.sale_price || 0,
                                stock_available: product.stock_quantity ?? 0,
                                discount: 0
                            });
                        } else {
                             window.showMessage('Produto sem estoque disponível.', 'error');
                        }
                    }
                    renderSaleItems();
                };
                
                const resetSale = () => {
                    saleItems = [];
                    selectedCustomer = null;
                    customerSearchInput.value = '';
                    productSearchInput.value = '';
                    discountInput.value = '';
                    renderSaleItems();
                };

                finishSaleBtn.addEventListener('click', async () => {
                    if (!selectedCustomer) {
                        window.showMessage('Por favor, selecione um cliente.', 'error');
                        return;
                    }
                    if (saleItems.length === 0) {
                        window.showMessage('Adicione pelo menos um produto à venda.', 'error');
                        return;
                    }

                    const subtotal = saleItems.reduce((acc, item) => acc + (item.quantity * item.unit_price), 0);
                    const totalItemDiscount = saleItems.reduce((acc, item) => acc + item.discount, 0);
                    const globalDiscount = parseFloat(discountInput.value) || 0;
                    const totalDiscountValue = totalItemDiscount + globalDiscount;
                    const final_amount = subtotal - totalDiscountValue;

                    // 1. Insert into sales table
                    const { data: saleData, error: saleError } = await supabase
                        .from('sales')
                        .insert({
                            user_id: window.userId,
                            contact_id: selectedCustomer.id,
                            total_amount: subtotal,
                            discount: totalDiscountValue,
                            final_amount: final_amount,
                            payment_method: paymentMethodSelect.value,
                            status: 'Concluída'
                        })
                        .select('id')
                        .single();

                    if (saleError) {
                        console.error('Error saving sale:', saleError);
                        window.showMessage(`Erro ao guardar a venda: ${saleError.message}`, 'error');
                        return;
                    }

                    // 2. Prepare and insert into sale_items table
                    const saleId = saleData.id;
                    const itemsToInsert = saleItems.map(item => ({
                        sale_id: saleId,
                        product_id: item.product_id,
                        quantity: item.quantity,
                        unit_price: item.unit_price,
                        discount: item.discount,
                        subtotal: (item.quantity * item.unit_price) - item.discount,
                        user_id: window.userId
                    }));

                    const { error: itemsError } = await supabase
                        .from('sale_items')
                        .insert(itemsToInsert);
                    
                    if (itemsError) {
                        console.error('Error saving sale items:', itemsError);
                        window.showMessage(`Erro ao guardar os itens da venda: ${itemsError.message}`, 'error');
                        await supabase.from('sales').delete().eq('id', saleId);
                        return;
                    }
                    
                    window.showMessage('Venda finalizada com sucesso!', 'success');
                    resetSale();
                });
                
                newSaleBtn.addEventListener('click', resetSale);

                saleItemsTableBody.addEventListener('input', (e) => {
                    const target = e.target;
                    if (target.matches('.quantity-input')) {
                        const index = parseInt(target.dataset.index, 10);
                        let newQuantity = parseInt(target.value, 10);
                        if (isNaN(newQuantity) || newQuantity < 1) {
                            newQuantity = 1;
                        }
                        if (newQuantity > saleItems[index].stock_available) {
                            newQuantity = saleItems[index].stock_available;
                            window.showMessage('Quantidade máxima em estoque atingida.', 'warning');
                        }
                        saleItems[index].quantity = newQuantity;
                        target.value = newQuantity; // Correct input value if it was invalid
                        renderSaleItems();
                    } else if (target.matches('.discount-input')) {
                         const index = parseInt(target.dataset.index, 10);
                         const newDiscount = parseFloat(target.value) || 0;
                         const maxDiscount = saleItems[index].quantity * saleItems[index].unit_price;
                         if (newDiscount > maxDiscount) {
                            saleItems[index].discount = maxDiscount;
                            target.value = maxDiscount.toFixed(2);
                            window.showMessage('Desconto não pode ser maior que o subtotal do item.', 'warning');
                         } else {
                            saleItems[index].discount = newDiscount;
                         }
                         renderSaleItems();
                    }
                });

                saleItemsTableBody.addEventListener('click', (e) => {
                    const removeBtn = e.target.closest('.remove-item-btn');
                    if (removeBtn) {
                        const index = parseInt(removeBtn.dataset.index, 10);
                        saleItems.splice(index, 1);
                        renderSaleItems();
                    }
                });

                discountInput.addEventListener('input', updateTotals);

                customerSearchInput.addEventListener('input', debounce((e) => searchCustomers(e.target.value), 300));
                productSearchInput.addEventListener('input', debounce((e) => searchProducts(e.target.value), 300));
                
                document.addEventListener('click', (e) => {
                    if (!e.target.closest('#customer-search-container')) {
                        customerSearchResults.classList.add('hidden');
                    }
                    if (!e.target.closest('#product-search-container')) {
                        productSearchResults.classList.add('hidden');
                    }
                });

                renderSaleItems();
            };

            const dashboardHtml = `
                <div>
                    <h1 class="text-3xl font-bold text-gray-800 mb-6">Painel de Controlo</h1>
                    <!-- KPI Cards -->
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                        <!-- Card 1: Receita do Mês -->
                        <div class="bg-white p-6 rounded-lg shadow-md flex items-center gap-6">
                            <div class="bg-blue-100 text-blue-600 p-4 rounded-full">
                                <i data-lucide="dollar-sign" class="w-8 h-8"></i>
                            </div>
                            <div>
                                <p class="text-sm font-medium text-gray-500">Receita do Mês</p>
                                <p class="text-2xl font-bold text-gray-800">R$ 12.345,67</p>
                            </div>
                        </div>
                        <!-- Card 2: Vendas Hoje -->
                        <div class="bg-white p-6 rounded-lg shadow-md flex items-center gap-6">
                            <div class="bg-green-100 text-green-600 p-4 rounded-full">
                                <i data-lucide="shopping-cart" class="w-8 h-8"></i>
                            </div>
                            <div>
                                <p class="text-sm font-medium text-gray-500">Vendas Hoje</p>
                                <p class="text-2xl font-bold text-gray-800">42</p>
                            </div>
                        </div>
                        <!-- Card 3: Ticket Médio -->
                        <div class="bg-white p-6 rounded-lg shadow-md flex items-center gap-6">
                            <div class="bg-yellow-100 text-yellow-600 p-4 rounded-full">
                                <i data-lucide="receipt" class="w-8 h-8"></i>
                            </div>
                            <div>
                                <p class="text-sm font-medium text-gray-500">Ticket Médio</p>
                                <p class="text-2xl font-bold text-gray-800">R$ 293,94</p>
                            </div>
                        </div>
                        <!-- Card 4: Novos Clientes -->
                        <div class="bg-white p-6 rounded-lg shadow-md flex items-center gap-6">
                            <div class="bg-indigo-100 text-indigo-600 p-4 rounded-full">
                                <i data-lucide="user-plus" class="w-8 h-8"></i>
                            </div>
                            <div>
                                <p class="text-sm font-medium text-gray-500">Novos Clientes (Mês)</p>
                                <p class="text-2xl font-bold text-gray-800">15</p>
                            </div>
                        </div>
                    </div>

                    <!-- Charts Section -->
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mt-8">
                        <!-- Weekly Sales Chart -->
                        <div class="lg:col-span-2 bg-white p-6 rounded-lg shadow-md">
                            <h3 class="font-semibold text-gray-800 mb-4">Vendas Semanais</h3>
                            <div class="h-80">
                                <canvas id="weeklySalesChart"></canvas>
                            </div>
                        </div>
                        <!-- Top Products Chart -->
                        <div class="bg-white p-6 rounded-lg shadow-md">
                             <h3 class="font-semibold text-gray-800 mb-4">Produtos Mais Vendidos</h3>
                            <div class="h-80">
                                <canvas id="topProductsChart"></canvas>
                            </div>
                        </div>
                    </div>
                     <!-- Quick Access & Alerts Section -->
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mt-8">
                        <!-- Recent Sales -->
                        <div class="lg:col-span-2 bg-white p-6 rounded-lg shadow-md">
                            <h3 class="font-semibold text-gray-800 mb-4">Últimas Vendas Realizadas</h3>
                            <div class="overflow-x-auto">
                                <table class="w-full text-sm text-left text-gray-500">
                                    <thead class="text-xs text-gray-700 uppercase bg-gray-50">
                                        <tr>
                                            <th scope="col" class="py-3 px-6">Cliente</th>
                                            <th scope="col" class="py-3 px-6">Status</th>
                                            <th scope="col" class="py-3 px-6">Valor</th>
                                            <th scope="col" class="py-3 px-6">Ação</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr class="bg-white border-b">
                                            <td class="py-4 px-6 font-medium text-gray-900">Ana Clara</td>
                                            <td class="py-4 px-6"><span class="bg-green-100 text-green-800 text-xs font-semibold mr-2 px-2.5 py-0.5 rounded-full">Pago</span></td>
                                            <td class="py-4 px-6">R$ 450,00</td>
                                            <td class="py-4 px-6"><a href="#" class="font-medium text-blue-600 hover:underline">Ver Detalhes</a></td>
                                        </tr>
                                        <tr class="bg-white border-b">
                                            <td class="py-4 px-6 font-medium text-gray-900">Bruno Costa</td>
                                            <td class="py-4 px-6"><span class="bg-yellow-100 text-yellow-800 text-xs font-semibold mr-2 px-2.5 py-0.5 rounded-full">Pendente</span></td>
                                            <td class="py-4 px-6">R$ 120,50</td>
                                            <td class="py-4 px-6"><a href="#" class="font-medium text-blue-600 hover:underline">Ver Detalhes</a></td>
                                        </tr>
                                        <tr class="bg-white border-b">
                                            <td class="py-4 px-6 font-medium text-gray-900">Carla Dias</td>
                                            <td class="py-4 px-6"><span class="bg-red-100 text-red-800 text-xs font-semibold mr-2 px-2.5 py-0.5 rounded-full">Cancelado</span></td>
                                            <td class="py-4 px-6">R$ 80,00</td>
                                            <td class="py-4 px-6"><a href="#" class="font-medium text-blue-600 hover:underline">Ver Detalhes</a></td>
                                        </tr>
                                         <tr class="bg-white">
                                            <td class="py-4 px-6 font-medium text-gray-900">Daniel Furtado</td>
                                            <td class="py-4 px-6"><span class="bg-green-100 text-green-800 text-xs font-semibold mr-2 px-2.5 py-0.5 rounded-full">Pago</span></td>
                                            <td class="py-4 px-6">R$ 1.200,00</td>
                                            <td class="py-4 px-6"><a href="#" class="font-medium text-blue-600 hover:underline">Ver Detalhes</a></td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        <!-- Low Stock Alert -->
                        <div class="bg-white p-6 rounded-lg shadow-md">
                             <h3 class="font-semibold text-gray-800 mb-4">Alerta de Baixo Estoque</h3>
                             <ul class="divide-y divide-gray-200">
                                <li class="py-3 flex justify-between items-center">
                                    <div>
                                        <p class="text-sm font-medium text-gray-900">Fita Veda Rosca 12mm</p>
                                        <p class="text-sm text-gray-500">SKU: 9776</p>
                                    </div>
                                    <div class="text-right">
                                        <p class="text-sm font-semibold text-red-600">Apenas 2 un.</p>
                                        <a href="#" class="text-xs text-blue-600 hover:underline">Ver Produto</a>
                                    </div>
                                </li>
                                <li class="py-3 flex justify-between items-center">
                                     <div>
                                        <p class="text-sm font-medium text-gray-900">Carro Infantil Totoca</p>
                                        <p class="text-sm text-gray-500">SKU: 6002</p>
                                    </div>
                                    <div class="text-right">
                                        <p class="text-sm font-semibold text-red-600">Apenas 1 un.</p>
                                        <a href="#" class="text-xs text-blue-600 hover:underline">Ver Produto</a>
                                    </div>
                                </li>
                                <li class="py-3 flex justify-between items-center">
                                     <div>
                                        <p class="text-sm font-medium text-gray-900">Lâmpada LED 9W</p>
                                        <p class="text-sm text-gray-500">SKU: 4152</p>
                                    </div>
                                    <div class="text-right">
                                        <p class="text-sm font-semibold text-yellow-600">Apenas 5 un.</p>
                                        <a href="#" class="text-xs text-blue-600 hover:underline">Ver Produto</a>
                                    </div>
                                </li>
                             </ul>
                        </div>
                    </div>
                </div>
            `;
            const vendasHtml = `
                <div class="h-full flex flex-col">
                    <header class="bg-white p-4 px-8 flex items-center justify-between flex-shrink-0 border-b">
                        <div>
                            <h1 class="text-2xl font-bold text-gray-800">Ponto de Venda</h1>
                        </div>
                        <div class="flex items-center gap-4">
                             <button class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-semibold py-1.5 px-3 rounded-md flex items-center gap-2">
                                <i data-lucide="list" class="w-4 h-4"></i> Listar Vendas
                            </button>
                            <button id="new-sale-btn" class="bg-blue-500 hover:bg-blue-600 text-white font-semibold py-1.5 px-3 rounded-md flex items-center gap-2">
                                <i data-lucide="plus" class="w-4 h-4"></i> Nova Venda
                            </button>
                        </div>
                    </header>
                    <div class="flex-1 grid grid-cols-1 lg:grid-cols-3 gap-6 p-6 overflow-hidden">
                        <!-- Coluna Principal (Esquerda) -->
                        <div class="lg:col-span-2 flex flex-col gap-4">
                            <!-- Seleção de Cliente e Produto -->
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div id="customer-search-container" class="relative">
                                    <label class="block text-sm font-medium text-gray-700">Cliente</label>
                                    <input type="text" id="sale-customer-search" class="w-full mt-1 pl-10 pr-4 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-400" placeholder="Pesquisar cliente...">
                                    <div class="absolute inset-y-0 left-0 top-6 pl-3 flex items-center pointer-events-none"><i data-lucide="user-search" class="w-5 h-5 text-gray-400"></i></div>
                                    <div id="customer-search-results" class="search-results hidden"></div>
                                </div>
                                 <div id="product-search-container" class="relative">
                                    <label class="block text-sm font-medium text-gray-700">Adicionar Produto</label>
                                    <input type="text" id="sale-product-search" class="w-full mt-1 pl-10 pr-4 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-400" placeholder="Pesquisar por código ou nome...">
                                    <div class="absolute inset-y-0 left-0 top-6 pl-3 flex items-center pointer-events-none"><i data-lucide="search" class="w-5 h-5 text-gray-400"></i></div>
                                    <div id="product-search-results" class="search-results hidden"></div>
                                </div>
                            </div>
                             <!-- Tabela de Itens da Venda -->
                            <div class="bg-white rounded-lg shadow overflow-hidden flex-1 flex flex-col">
                                <div class="overflow-y-auto">
                                     <table class="w-full text-sm">
                                        <thead class="bg-gray-100">
                                            <tr>
                                                <th class="p-3 text-left font-semibold text-gray-600">Produto</th>
                                                <th class="p-3 text-center font-semibold text-gray-600 w-24">Qtd.</th>
                                                <th class="p-3 text-right font-semibold text-gray-600">Preço Unit.</th>
                                                <th class="p-3 text-right font-semibold text-gray-600 w-28">Desconto (R$)</th>
                                                <th class="p-3 text-right font-semibold text-gray-600">Subtotal</th>
                                                <th class="p-3 text-center font-semibold text-gray-600">Ação</th>
                                            </tr>
                                        </thead>
                                        <tbody id="sale-items-table" class="divide-y divide-gray-200">
                                            <!-- Sale items will be rendered here -->
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                        <!-- Coluna de Resumo (Direita) -->
                        <div class="bg-white rounded-lg shadow p-6 flex flex-col">
                            <h3 class="text-lg font-bold text-gray-800 border-b pb-3">Resumo da Venda</h3>
                            <div class="space-y-3 mt-4 flex-1">
                                <div class="flex justify-between items-center">
                                    <span class="text-gray-600">Subtotal</span>
                                    <span id="sale-subtotal" class="font-semibold text-gray-800">R$ 0,00</span>
                                </div>
                                <div class="flex justify-between items-center">
                                    <span class="text-gray-600">Desconto Geral</span>
                                     <input type="number" step="0.01" id="sale-discount" class="w-24 text-right border rounded-md py-1 px-2" placeholder="0,00">
                                </div>
                            </div>
                            <div class="border-t pt-4 space-y-4">
                                <div class="flex justify-between items-center text-xl">
                                    <span class="font-bold text-gray-800">TOTAL</span>
                                    <span id="sale-total" class="font-bold text-blue-600">R$ 0,00</span>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Forma de Pagamento</label>
                                    <select id="sale-payment-method" class="w-full bg-white border border-gray-300 rounded-md p-2 shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-400">
                                        <option>Dinheiro</option>
                                        <option>Cartão de Crédito</option>
                                        <option>Cartão de Débito</option>
                                        <option>PIX</option>
                                    </select>
                                </div>
                                <button id="finish-sale-btn" class="w-full bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-4 rounded-md flex items-center justify-center gap-2 text-lg">
                                    <i data-lucide="check-circle" class="w-6 h-6"></i>
                                    Finalizar Venda
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            const estoqueHtml = `<div class="p-8"><h1 class="text-3xl font-bold text-gray-800 mb-8">Controle de Inventário</h1><div class="bg-white p-6 rounded-lg shadow"><p>Página em construção.</p></div></div>`;
            const financeiroHtml = `<div class="p-8"><h1 class="text-3xl font-bold text-gray-800 mb-8">Gestão Financeira</h1><div class="bg-white p-6 rounded-lg shadow"><p>Página em construção.</p></div></div>`;
            const productSystemHtml = `
            <div class="product-system-container grid grid-cols-[288px_1fr_200px] h-full overflow-hidden bg-gray-100 rounded-xl shadow-lg">
                <aside class="bg-gray-100 text-gray-800 p-4 space-y-4 overflow-y-auto flex-shrink-0 rounded-l-xl">
                    <div class="flex items-center justify-between">
                        <h2 class="text-xl font-bold">Filtrar</h2>
                        <button id="clear-filters-btn" class="text-sm text-gray-500 hover:text-gray-700 flex items-center gap-1 p-1 rounded-sm"><i data-lucide="x" class="w-3.5 h-3.5"></i> Limpar</button>
                    </div>
                    <div class="space-y-3 mt-4">
                        <div><label for="filter-situacao" class="block text-sm font-medium text-gray-700">Situação</label><select id="filter-situacao" class="w-full mt-1 bg-white border border-gray-300 rounded-md px-2 py-1.5 text-sm"><option value="">Todos</option><option value="ativo">Ativo</option><option value="inativo">Inativo</option></select></div>
                        <div><label for="filter-tags" class="block text-sm font-medium text-gray-700">Tags</label><select id="filter-tags" class="w-full mt-1 bg-white border border-gray-300 rounded-md px-2 py-1.5 text-sm"><option value="">Todas</option></select></div>
                        <div><label for="filter-categoria" class="block text-sm font-medium text-gray-700">Categoria</label><select id="filter-categoria" class="w-full mt-1 bg-white border border-gray-300 rounded-md px-2 py-1.5 text-sm"><option value="">Todas</option></select></div>
                        <div><label for="filter-ncm" class="block text-sm font-medium text-gray-700">NCM</label><input type="text" id="filter-ncm" class="w-full mt-1 bg-white border border-gray-300 rounded-md px-2 py-1.5 text-sm" placeholder="Código NCM"></div>
                        <div><label for="filter-tipo" class="block text-sm font-medium text-gray-700">Tipo</label><select id="filter-tipo" class="w-full mt-1 bg-white border border-gray-300 rounded-md px-2 py-1.5 text-sm"><option value="">Todos</option><option value="produto">Produto</option><option value="servico">Serviço</option></select></div>
                        <div><label for="filter-marca" class="block text-sm font-medium text-gray-700">Marca</label><input type="text" id="filter-marca" class="w-full mt-1 bg-white border border-gray-300 rounded-md px-2 py-1.5 text-sm" placeholder="Nome da marca"></div>
                    </div>
                </aside>
                <main class="flex-1 flex flex-col overflow-hidden bg-white rounded-none shadow-md">
                    <header class="product-listing-header p-3 px-6 flex flex-col flex-shrink-0 rounded-t-xl">
                        <div class="flex justify-between items-center mb-2">
                            <h2 class="text-sm font-semibold text-gray-300">As Lojas</h2>
                            <div class="flex items-center gap-2">
                                <button id="lock-product-btn" class="p-1 rounded-sm bg-gray-700 hover:bg-gray-600 text-white"><i data-lucide="lock" class="w-3.5 h-3.5"></i></button>
                                <button id="printer-product-btn" class="p-1 rounded-sm bg-gray-700 hover:bg-gray-600 text-white"><i data-lucide="printer" class="w-3.5 h-3.5"></i></button>
                                <button id="trash-product-btn" class="p-1 rounded-sm bg-gray-700 hover:bg-gray-600 text-white"><i data-lucide="trash-2" class="w-3.5 h-3.5"></i></button>
                            </div>
                        </div>
                        <div class="flex items-center space-x-2 w-full mb-2">
                            <div class="relative flex-1 max-w-sm"><input type="text" id="product-search-input" class="w-full product-search-input-dark rounded-md pl-8 pr-2 py-1 text-sm" placeholder="Pesquisar..."><i data-lucide="search" class="w-3.5 h-3.5 text-gray-400 absolute left-2 top-1/2 -translate-y-1/2"></i></div>
                            <div id="date-range-display" class="relative bg-gray-700 border border-gray-600 rounded-md px-2 py-1 text-xs w-40 text-center cursor-pointer flex items-center justify-between hover:bg-gray-600"><span>Data do Pedido</span><i data-lucide="calendar" class="w-3.5 h-3.5 text-gray-400"></i></div>
                            <input type="hidden" id="search-date-start" value=""><input type="hidden" id="search-date-end" value="">
                            <button id="toggle-filter-sidebar-btn" class="bg-gray-700 hover:bg-gray-600 text-white font-semibold py-1 px-2.5 rounded-sm flex items-center gap-1 text-xs"><i data-lucide="filter" class="w-3.5 h-3.5"></i></button>
                            <button id="refresh-product-btn" class="p-1 bg-gray-700 hover:bg-gray-600 text-white rounded-sm"><i data-lucide="refresh-cw" class="w-3.5 h-3.5"></i></button>
                            <button id="view-options-product-btn" class="p-1 bg-gray-700 hover:bg-gray-600 text-white rounded-sm"><i data-lucide="settings" class="w-3.5 h-3.5"></i></button>
                        </div>
                        <div id="filter-chips-container" class="flex flex-wrap items-center gap-2 text-sm mt-2"></div>
                    </header>
                    <div class="flex-1 overflow-y-auto p-6">
                        <div class="product-table-dark rounded-lg shadow overflow-hidden border border-gray-700">
                            <table class="w-full">
                                <thead class="border-b border-gray-700">
                                    <tr>
                                        <th class="p-3 text-left text-xs font-semibold uppercase w-10"><input type="checkbox" id="select-all-products" class="rounded-sm text-blue-500 bg-gray-600 border-gray-500"></th>
                                        <th class="p-3 text-left text-xs font-semibold uppercase">Imagem</th>
                                        <th class="p-3 text-left text-xs font-semibold uppercase">Descrição</th>
                                        <th class="p-3 text-left text-xs font-semibold uppercase">Código</th>
                                        <th class="p-3 text-left text-xs font-semibold uppercase">Unidade</th>
                                        <th class="p-3 text-left text-xs font-semibold uppercase">Preço</th>
                                        <th class="p-3 text-center text-xs font-semibold uppercase">Estoque</th>
                                        <th class="p-3 text-center text-xs font-semibold uppercase">Ações</th>
                                    </tr>
                                </thead>
                                <tbody id="product-table-body" class="divide-y divide-gray-700"></tbody>
                            </table>
                        </div>
                    </div>
                </main>
                <aside class="bg-gray-100 text-gray-800 p-4 space-y-4 overflow-y-auto flex-shrink-0 rounded-r-xl">
                    <h2 class="text-xl font-bold mb-4">Ações</h2>
                    <div class="space-y-3">
                        <button id="add-product-btn" class="w-full bg-blue-500 hover:bg-blue-700 text-white font-semibold py-1.5 px-3 rounded-md flex items-center justify-center gap-2"><i data-lucide="plus" class="w-4 h-4"></i> Adicionar Produto</button>
                        <button id="import-products-btn" class="w-full bg-green-500 hover:bg-green-600 text-white font-semibold py-1.5 px-3 rounded-md flex items-center justify-center gap-2"><i data-lucide="upload-cloud" class="w-4 h-4"></i> Importar</button>
                        <button id="export-products-btn" class="w-full bg-indigo-500 hover:bg-indigo-600 text-white font-semibold py-1.5 px-3 rounded-md flex items-center justify-center gap-2"><i data-lucide="download-cloud" class="w-4 h-4"></i> Exportar</button>
                    </div>
                </aside>
            </div>`;
            const clientesFornecedoresHtml = `<main class="flex-1 flex flex-col overflow-hidden"><header class="bg-white p-4 px-8 flex items-center justify-between flex-shrink-0 border-b"><div><h1 class="text-2xl font-bold text-gray-800">Clientes e Fornecedores</h1></div><div class="flex items-center gap-4"><div class="relative"><input type="text" id="contact-search-input" class="w-64 pl-10 pr-4 py-1.5 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-400" placeholder="Pesquisar por nome ou documento..."><div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none"><i data-lucide="search" class="w-5 h-5 text-gray-400"></i></div></div><button id="add-cs-btn" class="bg-blue-500 hover:bg-blue-600 text-white font-semibold py-1.5 px-3 rounded-md flex items-center gap-2"><i data-lucide="plus" class="w-4 h-4"></i> Adicionar</button></div></header><div class="flex-1 overflow-y-auto p-8"><div class="bg-white rounded-lg shadow overflow-hidden"><table class="w-full"><thead class="bg-gray-50"><tr><th class="p-3 text-left text-xs font-semibold text-gray-600 uppercase">Nome</th><th class="p-3 text-left text-xs font-semibold text-gray-600 uppercase">Documento</th><th class="p-3 text-left text-xs font-semibold text-gray-600 uppercase">Telefone</th><th class="p-3 text-left text-xs font-semibold text-gray-600 uppercase">Tipo</th><th class="p-3 text-center text-xs font-semibold text-gray-600 uppercase">Ações</th></tr></thead><tbody id="cs-table-body" class="divide-y divide-gray-200"></tbody></table></div></div></main>`;
            
        document.getElementById('nav-dashboard').addEventListener('click', (e) => { e.preventDefault(); showPage(dashboardHtml, 'nav-dashboard', runDashboardScript); });
        document.getElementById('nav-vendas').addEventListener('click', (e) => { e.preventDefault(); showPage(vendasHtml, 'nav-vendas', runVendasScript); });
        document.getElementById('nav-estoque').addEventListener('click', (e) => { e.preventDefault(); showPage(estoqueHtml, 'nav-estoque'); });
        document.getElementById('nav-financeiro').addEventListener('click', (e) => { e.preventDefault(); showPage(financeiroHtml, 'nav-financeiro'); });
        document.getElementById('link-produtos').addEventListener('click', (e) => { e.preventDefault(); showPage(productSystemHtml, 'nav-catalogo', runProductSystemScript); });
        document.getElementById('link-clientes-fornecedores').addEventListener('click', (e) => { e.preventDefault(); showPage(clientesFornecedoresHtml, 'nav-catalogo', runClientesFornecedoresScript); });

        // Initial page load
        showPage(dashboardHtml, 'nav-dashboard', runDashboardScript);
        window.lucide.createIcons();
    };

    document.addEventListener('DOMContentLoaded', async () => {
        const loginForm = document.getElementById('login-form');
        const signupLink = document.getElementById('signup-link');
        const registerModal = document.getElementById('register-modal');
        const registerForm = document.getElementById('register-form');
        const registerModalCloseBtn = document.getElementById('register-modal-close');

        const showRegisterModal = () => {
            if (registerModal) {
                registerForm.reset();
                registerModal.classList.remove('hidden');
                registerModal.querySelector('.modal-content').classList.remove('translate-y-[-20px]');
                window.lucide.createIcons();
            }
        };

        const hideRegisterModal = () => {
            if (registerModal) {
                registerModal.querySelector('.modal-content').classList.add('translate-y-[-20px]');
                setTimeout(() => registerModal.classList.add('hidden'), 300);
            }
        };

        signupLink.addEventListener('click', (e) => {
            e.preventDefault();
            showRegisterModal();
        });

        registerModalCloseBtn.addEventListener('click', hideRegisterModal);

        loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = loginForm.querySelector('#email').value;
            const password = loginForm.querySelector('#password').value;
            if (!window.supabase) return window.showMessage("Erro: Supabase não inicializado.", "error");
            
            const { error } = await window.supabase.auth.signInWithPassword({ email, password });
            if (error) {
                window.showMessage(`Erro de Login: ${error.message}`, "error");
            } else {
                window.showMessage("Login bem-sucedido! A redirecionar...", "success");
            }
        });

        registerForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const name = registerForm.querySelector('#register-name').value;
            const email = registerForm.querySelector('#register-email').value;
            const phone = registerForm.querySelector('#register-phone').value;
            const password = registerForm.querySelector('#register-password').value;

            if (!window.supabase) return window.showMessage("Erro: Supabase não inicializado.", "error");
            if (!name || !email || !password) return window.showMessage("Por favor, preencha todos os campos obrigatórios.", "error");

            const { data, error } = await window.supabase.auth.signUp({
                email,
                password,
                options: { data: { full_name: name, phone_number: phone } }
            });

            if (error) {
                window.showMessage(`Erro de Registo: ${error.message}.`, "error");
            } else if (data.user) {
                window.showMessage("Registo bem-sucedido! Verifique o seu email para confirmar a conta.", "success");
                hideRegisterModal();
                loginForm.querySelector('#email').value = email;
            }
        });

        window.lucide.createIcons(); 
    });
</script>
</body>
</html>

