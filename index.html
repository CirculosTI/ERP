<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema Círculos</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- Chart.js for dashboard graphs -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #e5e7eb; }
        ::-webkit-scrollbar-thumb { background: #9ca3af; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #6b7280; }
        
        .page, .content-section { display: none; }
        .page.active { display: block; }
        #dashboard-page.active { display: flex; flex-direction: column; }
        .content-section.active { display: block; }
        .content-section.flex-active { display: flex; }

        .login-bg {
            background-image: linear-gradient(rgba(0, 0, 0, 0.6), rgba(0, 0, 0, 0.6)), url('https://i.imgur.com/9x4CHMr.png');
            background-size: cover;
            background-position: center;
        }

        .nav-link.active {
             border-bottom-color: #3b82f6; /* Azul */
             color: #3b82f6;
        }
        .dropdown .dropdown-menu { display: none; }
        .dropdown.open .dropdown-menu { 
            display: block; 
            animation: fadeIn 0.2s ease-out;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .tab-link.active {
            border-color: #22c55e; /* green-500 */
            color: #22c55e;
        }
        /* Important: Ensure these base styles are not overridden by other CSS rules */
        .tab-content { display: none; }
        .tab-content.active { display: block; }

        /* Modal specific styles */
        .modal {
            transition: opacity 0.3s ease-in-out, visibility 0.3s ease-in-out;
        }
        .modal.hidden {
            opacity: 0;
            visibility: hidden;
        }
        .modal:not(.hidden) {
            opacity: 1;
            visibility: visible;
        }
        .modal-content {
            transform: translateY(-20px);
            transition: transform 0.3s ease-in-out;
        }
        .modal:not(.hidden) .modal-content {
            transform: translateY(0);
        }
        /* Custom message box for alerts */
        #message-box {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1050; /* Ensure it's above modals */
            display: none;
            padding: 1rem;
            border-radius: 0.5rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            max-width: 400px;
        }
        .message-box-success {
            background-color: #d1fae5;
            color: #065f46;
        }
        .message-box-error {
            background-color: #fee2e2;
            color: #991b1b;
        }
         .message-box-info {
            background-color: #dbeafe;
            color: #1e40af;
        }
        /* Custom styles for product listing to match the image */
        .product-listing-header {
            background-color: #1a1a1a; /* Dark background from image */
            color: #e0e0e0;
        }
        .product-search-input-dark {
            background-color: #333;
            border-color: #555;
            color: #e0e0e0;
        }
        .filter-chip {
            background-color: #444;
            color: #eee;
            border-radius: 0.375rem; /* rounded-md */
            padding: 0.25rem 0.625rem; /* px-2.5 py-1 */
            font-size: 0.875rem; /* text-sm */
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
        }
        .filter-chip-clear {
            background-color: transparent;
            color: #aaa;
        }
        .product-table-dark {
            background-color: #222;
            color: #ccc;
        }
        .product-table-dark th {
            background-color: #333;
            color: #e0e0e0;
        }
        .product-table-dark tr:nth-child(even) {
            background-color: #2a2a2a;
        }
        .product-table-dark tr:hover {
            background-color: #3a3a3a;
        }
        .product-table-dark td {
            border-bottom: 1px solid #444;
        }
        .product-table-dark tr.selected-row {
            background-color: #3b82f630; /* Light blue tint for selected rows */
        }

        /* Calendar Picker Specific Styles */
        .date-picker-modal-content {
            background-color: #1a1a1a;
            color: #e0e0e0;
            border-radius: 0.5rem;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.5);
        }
        .calendar-nav-btn {
            background-color: #333;
            color: #e0e0e0;
            padding: 0.25rem 0.5rem;
            border-radius: 0.25rem;
            transition: background-color 0.2s;
        }
        .calendar-nav-btn:hover {
            background-color: #555;
        }
        .calendar-day {
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 0.25rem;
            cursor: pointer;
            transition: background-color 0.2s, color 0.2s;
            font-size: 0.875rem; /* text-sm */
        }
        .calendar-day.current-month {
            color: #e0e0e0;
        }
        .calendar-day.other-month {
            color: #666;
        }
        .calendar-day.selected {
            background-color: #22c55e; /* green-500 */
            color: white;
            font-weight: 600;
        }
        .calendar-day.range-selected {
            background-color: #1a563a; /* darker green for range */
            color: white;
        }
        .calendar-day.today {
            border: 1px solid #22c55e;
        }
        .quick-select-btn {
            background-color: #333;
            color: #e0e0e0;
            padding: 0.5rem 0.75rem;
            border-radius: 0.375rem;
            text-align: left;
            width: 100%;
            transition: background-color 0.2s;
            font-size: 0.875rem;
        }
        .quick-select-btn:hover {
            background-color: #444;
        }
        .quick-select-btn.active-preset {
            background-color: #22c55e;
            color: white;
            font-weight: 600;
        }

        /* Search Results for Sales/Purchases */
        .search-results {
            position: absolute;
            background-color: white;
            border: 1px solid #d1d5db;
            border-radius: 0.375rem;
            width: 100%;
            max-height: 200px;
            overflow-y: auto;
            z-index: 40; /* Needs to be above other content */
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
        }
        .search-results div {
            padding: 0.5rem 0.75rem;
            cursor: pointer;
        }
        .search-results div:hover {
            background-color: #f3f4f6;
        }
        /* Financial page specific styles */
        .finance-tab-link.active {
            border-color: #3b82f6; /* blue-500 */
            color: #3b82f6;
        }
    </style>
    <!-- Supabase SDKs -->
    <script type="module">
        import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

        // Global variables for Supabase instances
        window.supabase = null;
        window.userId = null;
        window.dashboardInitialized = false;
        window.appId = 'default-app-id'; // Global appId, initialized with default

        // --- GLOBAL UTILITY FUNCTIONS ---
        window.showMessage = function(message, type = 'success') {
            const messageBox = document.getElementById('message-box');
            const messageText = document.getElementById('message-text');
            if (!messageBox || !messageText) return;
            if (type === 'hide') {
                messageBox.style.display = 'none';
                return;
            }
            messageText.textContent = message;
            messageBox.classList.remove('message-box-success', 'message-box-error', 'message-box-info');
            messageBox.classList.add(`message-box-${type}`);
            messageBox.style.display = 'block';
            setTimeout(() => {
                messageBox.style.display = 'none';
            }, 5000);
        };
        
        window.formatCurrency = function(value) {
            if (typeof value !== 'number') value = 0;
            return value.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
        };

        window.formatDate = function(dateString) {
            if (!dateString) return 'N/A';
            const date = new Date(dateString);
            return date.toLocaleDateString('pt-BR', { timeZone: 'UTC' });
        };


        // Function to initialize Supabase and attempt authentication
        window.initSupabaseAndAuth = async () => {
            console.log("initSupabaseAndAuth: Starting Supabase initialization and authentication.");
            
            // --- INÍCIO: CREDENCIAIS DO SUPABASE ---
            // Substitua com as suas credenciais reais do Supabase.
            const SUPABASE_URL = "https://bmgkulpexiqibbgwwxcx.supabase.co"; 
            const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJtZ2t1bHBleGlxaWJiZ3d3eGN4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ0MDU0ODUsImV4cCI6MjA2OTk4MTQ4NX0.JClBYIz7CbnHkn04LWYEtVzoz66FMSfR1Mjg-LRUqjI";
            // --- FIM: CREDENCIAIS DO SUPABASE ---

            let finalSupabaseUrl = SUPABASE_URL;
            let finalSupabaseAnonKey = SUPABASE_ANON_KEY;
            
            // This allows overriding with environment variables if they exist
            if (typeof __supabase_url !== 'undefined' && __supabase_url.trim() !== '') finalSupabaseUrl = __supabase_url;
            if (typeof __supabase_anon_key !== 'undefined' && __supabase_anon_key.trim() !== '') finalSupabaseAnonKey = __supabase_anon_key;
            if (typeof __app_id !== 'undefined' && __app_id.trim() !== '') window.appId = __app_id;

            if (!finalSupabaseUrl || !finalSupabaseAnonKey) {
                console.error("ERRO CRÍTICO: Supabase URL ou Chave Anon não configurados.");
                const loginErrorMessageDiv = document.getElementById('login-error-message');
                if (loginErrorMessageDiv) {
                    loginErrorMessageDiv.textContent = "ERRO: Credenciais do Supabase não configuradas.";
                    loginErrorMessageDiv.classList.remove('hidden');
                }
                return;
            }

            window.supabase = createClient(finalSupabaseUrl, finalSupabaseAnonKey);
            console.log("initSupabaseAndAuth: Supabase client created.");

            if (!window.supabase) {
                console.error("initSupabaseAndAuth: Supabase client failed to initialize.");
                window.showMessage("Erro: Falha ao inicializar o Supabase.", "error");
                return;
            }

            window.supabase.auth.onAuthStateChange((event, session) => {
                console.log('Supabase auth state changed:', { event, session });
                const loginPage = document.getElementById('login-page');
                const dashboardPage = document.getElementById('dashboard-page');
                const userIdDisplay = document.getElementById('user-id-display');
                if (session) {
                    window.userId = session.user.id;
                    if (userIdDisplay) userIdDisplay.textContent = `ID do Utilizador: ${window.userId.substring(0, 8)}...`;
                    loginPage.classList.remove('active');
                    dashboardPage.classList.add('active');
                    if (!window.dashboardInitialized) {
                        console.log(`Initializing dashboard due to auth event: ${event}`);
                        window.initializeDashboard();
                        window.dashboardInitialized = true;
                    }
                } else {
                    window.userId = null;
                    if (userIdDisplay) userIdDisplay.textContent = `ID do Utilizador: Não autenticado`;
                    loginPage.classList.add('active');
                    dashboardPage.classList.remove('active');
                    window.dashboardInitialized = false;
                }
            });
        };

        document.addEventListener('DOMContentLoaded', window.initSupabaseAndAuth);
    </script>
</head>
<body>
    <!-- Message Box for alerts -->
    <div id="message-box" class="hidden">
        <span id="message-text"></span>
        <button class="float-right ml-4 text-sm font-semibold" onclick="window.showMessage('', 'hide')">&times;</button>
    </div>

    <!-- Login Page -->
    <div id="login-page" class="page active">
        <div class="min-h-screen flex flex-col items-center justify-center px-4 login-bg">
            <div class="w-full max-w-md">
                <div class="text-center mb-8">
                    <img src="https://i.imgur.com/gM6495x.png" alt="Logo Círculos" class="mx-auto h-28 w-auto">
                    <p class="text-gray-200 mt-4 text-lg">Aceda à sua conta para gerir o seu negócio.</p>
                </div>
                <div class="bg-white rounded-xl shadow-lg p-8">
                    <div id="login-error-message" class="hidden text-red-500 text-center mb-4 font-bold"></div>
                    <form id="login-form">
                        <div class="space-y-6">
                            <div>
                                <label for="email" class="block text-sm font-medium text-gray-700">Email</label>
                                <div class="mt-1 relative">
                                    <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none"><i data-lucide="mail" class="w-5 h-5 text-gray-400"></i></div>
                                    <input type="email" id="email" name="email" required class="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-400" placeholder="voce@email.com">
                                </div>
                            </div>
                            <div>
                                <div class="flex justify-between items-center">
                                    <label for="password" class="block text-sm font-medium text-gray-700">Senha</label>
                                    <a href="#" id="esqueci-senha-link" class="text-sm text-blue-500 hover:underline">Esqueceu a senha?</a>
                                </div>
                                <div class="mt-1 relative">
                                    <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none"><i data-lucide="lock" class="w-5 h-5 text-gray-400"></i></div>
                                    <input type="password" id="password" name="password" required class="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-400" placeholder="Sua senha">
                                </div>
                            </div>
                            <div>
                                <button type="submit" class="w-full bg-blue-500 text-white font-semibold py-2.5 px-4 rounded-md hover:bg-blue-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition-colors flex items-center justify-center">Entrar</button>
                            </div>
                        </div>
                    </form>
                    <div class="mt-6 text-center">
                        <a href="#" id="signup-link" class="font-medium text-blue-500 hover:text-blue-600">Crie a sua conta gratuitamente</a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Dashboard -->
    <div id="dashboard-page" class="page h-screen">
        <header class="bg-white text-gray-800 shadow-md z-20 border-b">
            <div class="w-full px-6 flex justify-between items-center">
                <div class="h-16 flex items-center">
                    <img src="https://i.imgur.com/0ooTC9z.png" alt="Logo Círculos" class="h-10 w-auto">
                    <span id="user-id-display" class="ml-4 text-xs text-gray-500">ID do Utilizador: A carregar...</span>
                </div>
                <div class="flex items-center gap-6">
                    <nav class="flex items-center h-full text-sm font-medium text-gray-600">
                        <a href="#" id="nav-dashboard" class="nav-link h-16 flex items-center px-4 hover:bg-gray-100 transition-colors border-b-2 border-transparent">Dashboard</a>
                        <div class="dropdown relative h-16 flex items-center">
                            <button class="nav-link h-full flex items-center px-4 hover:bg-gray-100 transition-colors gap-2 border-b-2 border-transparent" data-dropdown-toggle="nav-catalogo-dropdown">
                                <span>Registos</span><i data-lucide="chevron-down" class="w-4 h-4"></i>
                            </button>
                            <div id="nav-catalogo-dropdown" class="dropdown-menu absolute left-0 mt-16 w-56 bg-white rounded-b-md shadow-lg py-1 z-30 text-gray-800 border-t">
                                <a href="#" id="link-produtos" class="block px-4 py-2 text-sm hover:bg-gray-100">Produtos</a>
                                <a href="#" id="link-clientes-fornecedores" class="block px-4 py-2 text-sm hover:bg-gray-100">Clientes e Fornecedores</a>
                            </div>
                        </div>
                        <a href="#" id="nav-compras" class="nav-link h-16 flex items-center px-4 hover:bg-gray-100 transition-colors border-b-2 border-transparent">Compras</a>
                        <a href="#" id="nav-vendas" class="nav-link h-16 flex items-center px-4 hover:bg-gray-100 transition-colors border-b-2 border-transparent">Vendas</a>
                        <a href="#" id="nav-estoque" class="nav-link h-16 flex items-center px-4 hover:bg-gray-100 transition-colors border-b-2 border-transparent">Inventário</a>
                        <a href="#" id="nav-financeiro" class="nav-link h-16 flex items-center px-4 hover:bg-gray-100 transition-colors border-b-2 border-transparent">Financeiro</a>
                        <a href="#" id="nav-relatorios" class="nav-link h-16 flex items-center px-4 hover:bg-gray-100 transition-colors border-b-2 border-transparent">Relatórios</a>
                    </nav>
                    <div class="h-16 flex items-center border-l pl-6">
                         <button id="logout-btn" class="flex items-center gap-2 text-sm font-medium text-gray-500 hover:text-red-500 transition-colors duration-200 p-2 rounded-md hover:bg-red-50">
                            <i data-lucide="log-out" class="w-4 h-4"></i>
                            <span>Sair</span>
                        </button>
                    </div>
                </div>
            </div>
        </header>
        <main id="page-content" class="flex-1 overflow-y-auto bg-gray-50 p-6"></main>
    </div>

    <!-- Global Modals -->
    <div id="register-modal" class="modal hidden fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-60">
        <div class="modal-content bg-white rounded-lg shadow-xl w-full max-w-md p-6">
            <div class="flex justify-between items-center border-b pb-3 mb-4">
                <h3 class="text-xl font-semibold text-gray-800">Crie a sua conta</h3>
                <button id="register-modal-close" class="text-gray-400 hover:text-gray-600 p-1.5 rounded-md"><i data-lucide="x" class="w-5 h-5"></i></button>
            </div>
            <form id="register-form" class="space-y-4">
                <div>
                    <label for="register-name" class="block text-sm font-medium text-gray-700">Nome Completo</label>
                    <input type="text" id="register-name" name="name" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 focus:outline-none focus:ring-2 focus:ring-blue-400" placeholder="O seu nome">
                </div>
                <div>
                    <label for="register-email" class="block text-sm font-medium text-gray-700">Email</label>
                    <input type="email" id="register-email" name="email" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 focus:outline-none focus:ring-2 focus:ring-blue-400" placeholder="o-seu@email.com">
                </div>
                <div>
                    <label for="register-phone" class="block text-sm font-medium text-gray-700">Telefone</label>
                    <input type="tel" id="register-phone" name="phone" class="mt-1 block w-full border border-gray-300 rounded-md p-2 shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-400" placeholder="(XX) XXXXX-XXXX">
                </div>
                <div>
                    <label for="register-password" class="block text-sm font-medium text-gray-700">Senha</label>
                    <input type="password" id="register-password" name="password" required class="mt-1 block w-full border border-gray-300 rounded-md p-2 shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-400" placeholder="Crie uma senha segura">
                </div>
                <div>
                    <button type="submit" class="w-full bg-green-500 text-white font-semibold py-2.5 px-4 rounded-md hover:bg-green-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 transition-colors">Registar</button>
                </div>
            </form>
        </div>
    </div>
    
    <div id="esqueci-senha-modal" class="modal hidden fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-60">
        <div class="modal-content bg-white rounded-lg shadow-xl w-full max-w-md p-6">
            <div class="flex justify-between items-center border-b pb-3 mb-4">
                <h3 class="text-xl font-semibold text-gray-800">Recuperar Senha</h3>
                <button id="esqueci-senha-modal-close" class="text-gray-400 hover:text-gray-600 p-1.5 rounded-md"><i data-lucide="x" class="w-5 h-5"></i></button>
            </div>
            <form id="esqueci-senha-form" class="space-y-4">
                <p class="text-sm text-gray-600">Insira o seu email de registo. Enviaremos um link para que possa definir uma nova senha.</p>
                <div>
                    <label for="reset-email" class="block text-sm font-medium text-gray-700">Email</label>
                    <input type="email" id="reset-email" name="email" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 focus:outline-none focus:ring-2 focus:ring-blue-400" placeholder="O seu email de registo">
                </div>
                <div>
                    <button type="submit" class="w-full bg-blue-500 text-white font-semibold py-2.5 px-4 rounded-md hover:bg-blue-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition-colors">Enviar Link de Recuperação</button>
                </div>
            </form>
        </div>
    </div>
    
    <div id="product-modal" class="modal hidden fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-60"><div class="modal-content bg-white text-gray-800 rounded-lg shadow-xl w-full max-w-5xl max-h-[95vh] flex flex-col"><div class="p-4 flex justify-between items-center border-b border-gray-200 relative"><h3 id="product-modal-title" class="text-xl font-semibold">Novo Produto</h3><div class="flex gap-4 items-center"><button id="product-modal-cancel" class="border border-gray-300 bg-gray-100 hover:bg-gray-200 text-gray-700 font-semibold py-1.5 px-3 rounded-md transition-colors duration-200">Cancelar</button><button type="submit" form="product-form" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-1.5 px-3 rounded-md transition-colors duration-200">Guardar produto</button><button id="product-modal-header-close" class="text-gray-500 hover:text-gray-700 transition-colors duration-200 ml-4 p-1.5 rounded-md"><i data-lucide="x" class="w-5 h-5"></i></button></div></div><form id="product-form" class="flex-1 overflow-y-auto p-6 space-y-6"><input type="hidden" name="product-id"><div class="grid grid-cols-12 gap-6 items-start"><div class="col-span-3 flex flex-col items-center justify-center bg-gray-50 rounded-lg border-2 border-dashed border-gray-200 p-4 h-48 relative overflow-hidden"><img id="product-image-preview" src="https://placehold.co/160x160/cbd5e1/475569?text=Sem%20Imagem" alt="Pré-visualização da Imagem" class="max-w-full max-h-full object-contain rounded-md mb-2"><input type="file" id="product-image-input" accept="image/*" class="absolute inset-0 opacity-0 cursor-pointer"><label for="product-image-input" class="absolute inset-0 flex items-center justify-center text-gray-500 hover:text-blue-500 cursor-pointer"><i data-lucide="camera" class="w-8 h-8"></i></label></div><div class="col-span-9 grid grid-cols-3 gap-4"><div><label class="block text-sm font-medium text-gray-700">Nome*</label><input type="text" name="name" required class="w-full bg-white border border-gray-300 rounded-md p-2 shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-400"></div><div><label class="block text-sm font-medium text-gray-700">Código (SKU)</label><div class="flex gap-2 mt-1"><input type="text" name="sku" class="w-full bg-white border border-gray-300 rounded-md p-2 shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-400"><button type="button" id="generate-barcode-btn" class="bg-blue-500 hover:bg-blue-600 text-white font-semibold py-1.5 px-3 rounded-md text-sm flex-shrink-0 transition-colors duration-200">Gerar Interno</button></div></div><div><label class="block text-sm font-medium text-gray-700">Preço Venda</label><input type="number" step="0.01" name="price" class="w-full bg-white border border-gray-300 rounded-md p-2 shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-400"></div><div><label class="block text-sm font-medium text-gray-700">Estoque Atual</label><input type="number" name="stock_quantity" class="w-full bg-white border border-gray-300 rounded-md p-2 shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-400"></div><div><label class="block text-sm font-medium text-gray-700">Formato</label><select name="format" class="w-full bg-white border border-gray-300 rounded-md p-2 shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-400"><option>Simples</option><option>Variável</option></select></div><div><label class="block text-sm font-medium text-gray-700">Tipo</label><select name="type" class="w-full bg-white border border-gray-300 rounded-md p-2 shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-400"><option>Produto</option><option>Serviço</option></select></div><div><label class="block text-sm font-medium text-gray-700">Condição</label><select name="condition" class="w-full bg-white border border-gray-300 rounded-md p-2 shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-400"><option>Novo</option><option>Usado</option><option>Recondicionado</option></select></div></div></div><div class="border-b border-gray-200 mt-6"><nav class="-mb-px flex space-x-6" id="modal-tabs"><a href="#" class="tab-link active whitespace-nowrap py-3 px-1 border-b-2 font-medium text-sm border-green-500 text-green-500" data-tab="caracteristicas">Características</a><a href="#" class="tab-link whitespace-nowrap py-3 px-1 border-b-2 font-medium text-sm border-transparent text-gray-500 hover:border-gray-300 hover:text-gray-700" data-tab="fornecedores">Fornecedores</a><a href="#" class="tab-link whitespace-nowrap py-3 px-1 border-b-2 font-medium text-sm border-transparent text-gray-500 hover:border-gray-300 hover:text-gray-700" data-tab="tributacao">Tributação</a></nav></div><div id="tab-content-container" class="pt-6"><div id="caracteristicas" class="tab-content active grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-x-6 gap-y-4"><div class="space-y-1"><label class="block text-sm font-medium text-gray-700">Marca</label><input type="text" name="brand" class="w-full bg-white border border-gray-300 rounded-md p-2 shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-400"></div><div class="space-y-1"><label class="block text-sm font-medium text-gray-700">Produção</label><select name="production_type" class="w-full bg-white border border-gray-300 rounded-md p-2 shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-400"><option>Própria</option><option>Terceirizada</option></select></div><div class="space-y-1"><label class="block text-sm font-medium text-gray-700">Data de Validade</label><input type="date" name="expiration_date" class="w-full bg-white border border-gray-300 rounded-md p-2 shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-400"></div><div class="space-y-1"><label class="block text-sm font-medium text-gray-700">Frete Grátis</label><select name="free_shipping" class="w-full bg-white border border-gray-300 rounded-md p-2 shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-400"><option value="false">Não</option><option value="true">Sim</option></select></div><div class="space-y-1"><label class="block text-sm font-medium text-gray-700">Peso Líquido (kg)</label><input type="number" step="0.01" name="net_weight" class="w-full bg-white border border-gray-300 rounded-md p-2 shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-400"></div><div class="space-y-1"><label class="block text-sm font-medium text-gray-700">Peso Bruto (kg)</label><input type="number" step="0.01" name="gross_weight" class="w-full bg-white border border-gray-300 rounded-md p-2 shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-400"></div><div class="space-y-1"><label class="block text-sm font-medium text-gray-700">Largura (cm)</label><input type="number" step="0.01" name="width" class="w-full bg-white border border-gray-300 rounded-md p-2 shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-400"></div><div class="space-y-1"><label class="block text-sm font-medium text-gray-700">Altura (cm)</label><input type="number" step="0.01" name="height" class="w-full bg-white border border-gray-300 rounded-md p-2 shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-400"></div><div class="space-y-1"><label class="block text-sm font-medium text-gray-700">Profundidade (cm)</label><input type="number" step="0.01" name="depth" class="w-full bg-white border border-gray-300 rounded-md p-2 shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-400"></div><div class="space-y-1"><label class="block text-sm font-medium text-gray-700">Volumes</label><input type="number" name="volumes" class="w-full bg-white border border-gray-300 rounded-md p-2 shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-400"></div><div class="space-y-1"><label class="block text-sm font-medium text-gray-700">Itens p/ caixa</label><input type="number" name="items_per_box" class="w-full bg-white border border-gray-300 rounded-md p-2 shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-400"></div><div class="space-y-1"><label class="block text-sm font-medium text-gray-700">Unidade de medida</label><select name="measurement_unit" class="w-full bg-white border border-gray-300 rounded-md p-2 shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-400"><option>Centímetros</option><option>Metros</option><option>Polegadas</option></select></div><div class="space-y-1"><label class="block text-sm font-medium text-gray-700">GTIN/EAN</label><div class="flex gap-2 mt-1"><input type="text" name="gtin_ean" class="w-full bg-white border border-gray-300 rounded-md p-2 shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-400" placeholder="SEM GTIN"><button type="button" id="generate-gtinean-btn" class="bg-blue-500 hover:bg-blue-600 text-white font-semibold py-1.5 px-3 rounded-md text-sm flex-shrink-0 transition-colors duration-200">Gerar Interno</button></div></div><div class="space-y-1"><label class="block text-sm font-medium text-gray-700">GTIN/EAN Tributário</label><input type="text" name="gtin_ean_tax" class="w-full bg-white border border-gray-300 rounded-md p-2 shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-400" placeholder="SEM GTIN"></div></div><div id="fornecedores" class="tab-content space-y-4"><h4 class="text-lg font-semibold text-gray-800 mb-4">Gerir Fornecedores do Produto</h4><div class="grid grid-cols-1 md:grid-cols-2 gap-4"><div><label class="block text-sm font-medium text-gray-700">Nome do Fornecedor</label><input type="text" name="supplier-name" class="w-full bg-white border border-gray-300 rounded-md p-2 shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-400" placeholder="Nome do fornecedor"></div><div><label class="block text-sm font-medium text-gray-700">Código do Fornecedor</label><input type="text" name="supplier-code" class="w-full bg-white border border-gray-300 rounded-md p-2 shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-400" placeholder="Código de referência do fornecedor"></div><div class="md:col-span-2"><label class="block text-sm font-medium text-gray-700">Preço de Custo</label><input type="number" step="0.01" name="supplier-cost-price" class="w-full bg-white border border-gray-300 rounded-md p-2 shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-400" placeholder="0.00"></div></div><button type="button" class="mt-4 bg-blue-500 hover:bg-blue-600 text-white font-semibold py-1.5 px-3 rounded-md flex items-center gap-2 transition-colors duration-200"><i data-lucide="plus" class="w-5 h-5"></i> Adicionar Fornecedor</button></div><div id="tributacao" class="tab-content space-y-4"><h4 class="text-lg font-semibold text-gray-800 mb-4">Configurações de Tributação</h4><div class="grid grid-cols-1 md:grid-cols-2 gap-4"><div><label class="block text-sm font-medium text-gray-700">NCM (Nomenclatura Comum do Mercosul)</label><input type="text" name="tax_ncm" class="w-full bg-white border border-gray-300 rounded-md p-2 shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-400" placeholder="Ex: 8471.30.12"></div><div><label class="block text-sm font-medium text-gray-700">CEST (Código Especificador da Substituição Tributária)</label><input type="text" name="tax_cest" class="w-full bg-white border border-gray-300 rounded-md p-2 shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-400" placeholder="Ex: 28.064.00"></div><div><label class="block text-sm font-medium text-gray-700">Origem da Mercadoria</label><select name="tax_origin" class="w-full bg-white border border-gray-300 rounded-md p-2 shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-400"><option value="0">0 - Nacional, exceto as indicadas nos códigos 3, 4, 5 e 8</option><option value="1">1 - Estrangeira - Importação direta</option><option value="2">2 - Estrangeira - Adquirida no mercado interno</option></select></div><div><label class="block text-sm font-medium text-gray-700">Tipo de Tributação</label><select name="tax_type" class="w-full bg-white border border-gray-300 rounded-md p-2 shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-400"><option>Normal</option><option>Simples Nacional</option></select></div></div></div></div></form></div></div>
    <div id="import-modal" class="modal hidden fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-60"><div class="modal-content bg-white rounded-lg shadow-xl w-full max-w-2xl p-6"><div class="flex justify-between items-center border-b pb-3 mb-4"><h3 class="text-xl font-semibold text-gray-800">Importar Produtos em Massa</h3><button id="import-modal-close" class="text-gray-400 hover:text-gray-600 p-1.5 rounded-md"><i data-lucide="x" class="w-5 h-5"></i></button></div><div class="space-y-6 mt-4"><div><h4 class="font-semibold text-gray-700">Passo 1: Baixe o nosso modelo</h4><p class="text-sm text-gray-600 mt-1">Para garantir que os seus dados são importados corretamente, use o nosso ficheiro modelo. Preencha-o com os seus produtos antes de carregar.</p><button id="download-template-btn" class="mt-3 bg-gray-100 hover:bg-gray-200 text-gray-800 font-semibold py-2 px-4 rounded-md flex items-center gap-2 transition-colors duration-200 border border-gray-300"><i data-lucide="download-cloud" class="w-4 h-4"></i> Baixar Modelo (CSV)</button></div><div class="border-t border-gray-200"></div><div><h4 class="font-semibold text-gray-700">Passo 2: Carregue o seu ficheiro preenchido</h4><p class="text-sm text-gray-600 mt-1">Formatos suportados: CSV, XLS, XLSX.</p><div id="import-drop-area" class="mt-3 flex justify-center items-center w-full h-32 px-6 border-2 border-gray-300 border-dashed rounded-md cursor-pointer hover:border-blue-500 bg-gray-50"><div class="text-center"><i data-lucide="upload-cloud" class="mx-auto h-10 w-10 text-gray-400"></i><p id="import-file-text" class="mt-2 text-sm text-gray-600"><span class="font-semibold">Clique para carregar</span> ou arraste e solte</p><input id="import-file-input" type="file" class="hidden" accept=".csv, application/vnd.openxmlformats-officedocument.spreadsheetml.sheet, application/vnd.ms-excel"></div></div><p id="import-file-name" class="text-sm text-gray-500 mt-2"></p></div></div><div class="flex justify-end items-center border-t pt-4 mt-6 gap-4"><button id="import-modal-cancel" class="border border-gray-300 bg-white hover:bg-gray-100 text-gray-700 font-semibold py-1.5 px-3 rounded-md transition-colors duration-200">Cancelar</button><button id="process-import-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-1.5 px-3 rounded-md transition-colors duration-200 disabled:bg-gray-400" disabled>Importar Produtos</button></div></div></div>
    <div id="date-picker-modal" class="modal hidden fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-60">
        <div class="date-picker-modal-content w-full max-w-4xl p-6 flex gap-6">
            <div class="flex-1 flex flex-col space-y-4">
                <div class="flex items-center justify-between">
                    <button id="prev-month-left" class="calendar-nav-btn"><i data-lucide="chevron-left" class="w-4 h-4"></i></button>
                    <h4 id="month-display-left" class="text-md font-semibold text-gray-300"></h4>
                    <button id="next-month-left" class="calendar-nav-btn"><i data-lucide="chevron-right" class="w-4 h-4"></i></button>
                </div>
                <div class="grid grid-cols-7 text-center text-xs text-gray-400 font-medium">
                    <span>Dom</span><span>Seg</span><span>Ter</span><span>Qua</span><span>Qui</span><span>Sex</span><span>Sáb</span>
                </div>
                <div id="calendar-grid-left" class="grid grid-cols-7 gap-1"></div>
            </div>
            <div class="flex-1 flex flex-col space-y-4">
                <div class="flex items-center justify-between">
                    <button id="prev-month-right" class="calendar-nav-btn"><i data-lucide="chevron-left" class="w-4 h-4"></i></button>
                    <h4 id="month-display-right" class="text-md font-semibold text-gray-300"></h4>
                    <button id="next-month-right" class="calendar-nav-btn"><i data-lucide="chevron-right" class="w-4 h-4"></i></button>
                </div>
                <div class="grid grid-cols-7 text-center text-xs text-gray-400 font-medium">
                    <span>Dom</span><span>Seg</span><span>Ter</span><span>Qua</span><span>Qui</span><span>Sex</span><span>Sáb</span>
                </div>
                <div id="calendar-grid-right" class="grid grid-cols-7 gap-1"></div>
            </div>
            <div class="w-1/4 flex flex-col space-y-2 ml-6">
                <h5 class="text-sm font-semibold mb-2">Períodos Rápidos</h5>
                <button class="quick-select-btn" data-preset="today">Hoje</button>
                <button class="quick-select-btn" data-preset="this_week">Esta semana</button>
                <button class="quick-select-btn" data-preset="last_week">Semana passada</button>
                <button class="quick-select-btn" data-preset="this_month">Este mês</button>
                <button class="quick-select-btn" data-preset="last_month">Mês passado</button>
                <button class="quick-select-btn mt-4 active-preset" data-preset="custom">Período customizado</button>
                <div class="flex-grow"></div>
                <div class="flex gap-2 mt-4">
                    <button id="date-picker-cancel-btn" class="flex-1 bg-gray-600 hover:bg-gray-700 text-white font-semibold py-1.5 px-3 rounded-md text-sm transition-colors duration-200">Cancelar</button>
                    <button id="date-picker-filter-btn" class="flex-1 bg-green-500 hover:bg-green-600 text-white font-semibold py-1.5 px-3 rounded-md text-sm transition-colors duration-200">Filtrar</button>
                </div>
            </div>
            <button id="date-picker-close-btn" class="absolute top-3 right-3 text-gray-400 hover:text-gray-200 p-1.5 rounded-md"><i data-lucide="x" class="w-4 h-4"></i></button>
        </div>
    </div>
    <!-- Confirmation Modal -->
    <div id="confirmation-modal" class="modal hidden fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-60">
        <div class="modal-content bg-white rounded-lg shadow-xl w-full max-w-md p-6">
            <h3 id="confirmation-title" class="text-lg font-medium text-gray-900">Confirmar Ação</h3>
            <div class="mt-2">
                <p id="confirmation-message" class="text-sm text-gray-500">Tem a certeza de que deseja executar esta ação?</p>
            </div>
            <div class="mt-5 sm:mt-6 sm:grid sm:grid-flow-row-dense sm:grid-cols-2 sm:gap-3">
                <button id="confirm-action-btn" type="button" class="inline-flex w-full justify-center rounded-md bg-red-600 px-3 py-2 text-sm font-semibold text-white shadow-sm hover:bg-red-500 sm:col-start-2">Confirmar</button>
                <button id="cancel-action-btn" type="button" class="mt-3 inline-flex w-full justify-center rounded-md bg-white px-3 py-2 text-sm font-semibold text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 hover:bg-gray-50 sm:col-start-1 sm:mt-0">Cancelar</button>
            </div>
        </div>
    </div>
    <!-- Contact Modal -->
    <div id="contact-modal" class="modal hidden fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-60">
        <div class="modal-content bg-white rounded-lg shadow-xl w-full max-w-3xl max-h-[95vh] flex flex-col">
            <div class="flex justify-between items-center border-b p-4">
                <h3 id="contact-modal-title" class="text-xl font-semibold text-gray-800">Registo de Contacto</h3>
                <button id="contact-modal-close" class="text-gray-400 hover:text-gray-600 p-1.5 rounded-md"><i data-lucide="x" class="w-5 h-5"></i></button>
            </div>
            <form id="contact-form" class="flex-1 overflow-y-auto p-6 space-y-4">
                 <input type="hidden" name="contact_id">
                 <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Tipo de Contacto*</label>
                        <select name="contact_type" required class="w-full mt-1 bg-white border border-gray-300 rounded-md p-2 shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-400">
                            <option value="Cliente">Cliente</option>
                            <option value="Fornecedor">Fornecedor</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Tipo de Pessoa*</label>
                        <select name="person_type" required class="w-full mt-1 bg-white border border-gray-300 rounded-md p-2 shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-400">
                            <option value="Física">Física</option>
                            <option value="Jurídica">Jurídica</option>
                        </select>
                    </div>
                 </div>
                 <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Nome / Razão Social*</label>
                        <input type="text" name="name" required class="w-full mt-1 bg-white border border-gray-300 rounded-md p-2 shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-400">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">CPF / CNPJ</label>
                        <input type="text" name="cpf_cnpj" class="w-full mt-1 bg-white border border-gray-300 rounded-md p-2 shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-400">
                    </div>
                 </div>
                 <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Email</label>
                        <input type="email" name="email" class="w-full mt-1 bg-white border border-gray-300 rounded-md p-2 shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-400">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Telefone</label>
                        <input type="tel" name="phone" class="w-full mt-1 bg-white border border-gray-300 rounded-md p-2 shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-400">
                    </div>
                     <div id="credit-limit-field" class="hidden">
                        <label class="block text-sm font-medium text-gray-700">Limite de Crédito (R$)</label>
                        <input type="number" step="0.01" name="credit_limit" class="w-full mt-1 bg-white border border-gray-300 rounded-md p-2 shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-400" placeholder="0.00">
                    </div>
                 </div>
                 <div class="pt-4 border-t">
                    <h4 class="text-md font-semibold text-gray-800 mb-2">Endereço</h4>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                         <div>
                            <label class="block text-sm font-medium text-gray-700">CEP</label>
                            <input type="text" name="address_zipcode" class="w-full mt-1 bg-white border border-gray-300 rounded-md p-2 shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-400">
                        </div>
                        <div class="md:col-span-2">
                            <label class="block text-sm font-medium text-gray-700">Rua</label>
                            <input type="text" name="address_street" class="w-full mt-1 bg-white border border-gray-300 rounded-md p-2 shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-400">
                        </div>
                    </div>
                     <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mt-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Número</label>
                            <input type="text" name="address_number" class="w-full mt-1 bg-white border border-gray-300 rounded-md p-2 shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-400">
                        </div>
                        <div class="md:col-span-2">
                            <label class="block text-sm font-medium text-gray-700">Complemento</label>
                            <input type="text" name="address_complement" class="w-full mt-1 bg-white border border-gray-300 rounded-md p-2 shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-400">
                        </div>
                    </div>
                     <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mt-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Bairro</label>
                            <input type="text" name="address_neighborhood" class="w-full mt-1 bg-white border border-gray-300 rounded-md p-2 shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-400">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Cidade</label>
                            <input type="text" name="address_city" class="w-full mt-1 bg-white border border-gray-300 rounded-md p-2 shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-400">
                        </div>
                         <div>
                            <label class="block text-sm font-medium text-gray-700">Estado</label>
                            <input type="text" name="address_state" class="w-full mt-1 bg-white border border-gray-300 rounded-md p-2 shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-400">
                        </div>
                    </div>
                 </div>
                 <div class="pt-4 border-t">
                    <label class="block text-sm font-medium text-gray-700">Observações</label>
                    <textarea name="notes" rows="3" class="w-full mt-1 bg-white border border-gray-300 rounded-md p-2 shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-400"></textarea>
                 </div>
            </form>
            <div class="flex justify-end items-center border-t p-4 gap-4">
                <button id="contact-modal-cancel" class="border border-gray-300 bg-white hover:bg-gray-100 text-gray-700 font-semibold py-1.5 px-3 rounded-md transition-colors duration-200">Cancelar</button>
                <button type="submit" form="contact-form" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-1.5 px-3 rounded-md transition-colors duration-200">Guardar Contacto</button>
            </div>
        </div>
    </div>
    <!-- Financial Transaction Modal -->
    <div id="financial-transaction-modal" class="modal hidden fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-60">
        <div class="modal-content bg-white rounded-lg shadow-xl w-full max-w-lg p-6">
            <div class="flex justify-between items-center border-b pb-3 mb-4">
                <h3 id="financial-modal-title" class="text-xl font-semibold text-gray-800">Nova Despesa</h3>
                <button id="financial-modal-close" class="text-gray-400 hover:text-gray-600 p-1.5 rounded-md"><i data-lucide="x" class="w-5 h-5"></i></button>
            </div>
            <form id="financial-transaction-form" class="space-y-4">
                <input type="hidden" name="transaction_id">
                <div>
                    <label class="block text-sm font-medium text-gray-700">Descrição*</label>
                    <input type="text" name="description" required class="w-full mt-1 border border-gray-300 rounded-md p-2 shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-400">
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Valor (R$)*</label>
                        <input type="number" step="0.01" name="amount" required class="w-full mt-1 border border-gray-300 rounded-md p-2 shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-400">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Data de Vencimento*</label>
                        <input type="date" name="due_date" required class="w-full mt-1 border border-gray-300 rounded-md p-2 shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-400">
                    </div>
                </div>
                <div>
                     <label class="block text-sm font-medium text-gray-700">Fornecedor (Opcional)</label>
                     <select name="contact_id" class="w-full mt-1 border border-gray-300 rounded-md p-2 shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-400">
                     </select>
                </div>
                 <div>
                    <label class="block text-sm font-medium text-gray-700">Observações</label>
                    <textarea name="notes" rows="2" class="w-full mt-1 bg-white border border-gray-300 rounded-md p-2 shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-400"></textarea>
                 </div>
                <div class="flex justify-end items-center pt-4 gap-4">
                    <button id="financial-modal-cancel" type="button" class="border border-gray-300 bg-white hover:bg-gray-100 text-gray-700 font-semibold py-1.5 px-3 rounded-md transition-colors duration-200">Cancelar</button>
                    <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-1.5 px-3 rounded-md transition-colors duration-200">Guardar</button>
                </div>
            </form>
        </div>
    </div>
    <!-- Inventory Modals -->
    <div id="inventory-history-modal" class="modal hidden fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-60">
        <div class="modal-content bg-white rounded-lg shadow-xl w-full max-w-4xl max-h-[90vh] flex flex-col p-6">
            <div class="flex justify-between items-center border-b pb-3 mb-4">
                <h3 id="inventory-history-title" class="text-xl font-semibold text-gray-800">Histórico de Movimentações</h3>
                <button id="inventory-history-close" class="text-gray-400 hover:text-gray-600 p-1.5 rounded-md"><i data-lucide="x" class="w-5 h-5"></i></button>
            </div>
            <div class="flex-1 overflow-y-auto">
                <table class="w-full text-sm">
                    <thead class="bg-gray-50 sticky top-0">
                        <tr>
                            <th class="p-3 text-left text-xs font-semibold text-gray-600 uppercase">Data</th>
                            <th class="p-3 text-left text-xs font-semibold text-gray-600 uppercase">Tipo</th>
                            <th class="p-3 text-center text-xs font-semibold text-gray-600 uppercase">Alteração</th>
                            <th class="p-3 text-left text-xs font-semibold text-gray-600 uppercase">Observações</th>
                        </tr>
                    </thead>
                    <tbody id="inventory-history-body" class="divide-y divide-gray-200"></tbody>
                </table>
            </div>
        </div>
    </div>
     <div id="inventory-adjust-modal" class="modal hidden fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-60">
        <div class="modal-content bg-white rounded-lg shadow-xl w-full max-w-lg p-6">
            <div class="flex justify-between items-center border-b pb-3 mb-4">
                <h3 id="inventory-adjust-title" class="text-xl font-semibold text-gray-800">Ajustar Estoque</h3>
                <button id="inventory-adjust-close" class="text-gray-400 hover:text-gray-600 p-1.5 rounded-md"><i data-lucide="x" class="w-5 h-5"></i></button>
            </div>
            <form id="inventory-adjust-form" class="space-y-4">
                 <input type="hidden" name="product_id">
                 <div>
                    <span class="block text-sm font-medium text-gray-700">Produto</span>
                    <p id="adjust-product-name" class="mt-1 text-lg font-semibold text-gray-900"></p>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <span class="block text-sm font-medium text-gray-700">Estoque Atual</span>
                        <p id="adjust-current-stock" class="mt-1 text-lg font-semibold text-gray-900"></p>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Nova Quantidade*</label>
                        <input type="number" name="new_quantity" required class="w-full mt-1 border border-gray-300 rounded-md p-2 shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-400">
                    </div>
                </div>
                 <div>
                    <label class="block text-sm font-medium text-gray-700">Motivo do Ajuste*</label>
                    <input type="text" name="notes" required class="w-full mt-1 border border-gray-300 rounded-md p-2 shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-400" placeholder="Ex: Contagem de inventário, perda, etc.">
                </div>
                <div class="flex justify-end items-center pt-4 gap-4">
                    <button id="inventory-adjust-cancel" type="button" class="border border-gray-300 bg-white hover:bg-gray-100 text-gray-700 font-semibold py-1.5 px-3 rounded-md transition-colors duration-200">Cancelar</button>
                    <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-1.5 px-3 rounded-md transition-colors duration-200">Confirmar Ajuste</button>
                </div>
            </form>
        </div>
    </div>


    <script type="module">
        // This function will be called after Supabase init and auth attempt
        window.initializeDashboard = () => {
            console.log('initializeDashboard started.');
            const pageContent = document.getElementById('page-content');
            const navLinks = document.querySelectorAll('.nav-link');
            const logoutBtn = document.getElementById('logout-btn');

            if (logoutBtn) {
                logoutBtn.addEventListener('click', async (e) => {
                    e.preventDefault();
                    console.log('Logout button clicked.');
                    window.showMessage('A terminar a sessão...', 'info');
                    const { error } = await window.supabase.auth.signOut();
                    if (error) {
                        console.error('Error signing out:', error);
                        window.showMessage(`Erro ao terminar a sessão: ${error.message}`, 'error');
                    } else {
                        window.showMessage('Sessão terminada com sucesso.', 'success');
                    }
                });
            }

            // Simple dropdown handler
            document.addEventListener('click', (e) => {
                const isDropdownButton = e.target.matches("[data-dropdown-toggle]");
                // Hide all dropdowns if click is outside
                if (!isDropdownButton && e.target.closest('.dropdown') === null) {
                    document.querySelectorAll('.dropdown.open').forEach(dropdown => {
                        dropdown.classList.remove('open');
                    });
                }
                // Toggle the clicked dropdown
                if (isDropdownButton) {
                    const dropdown = e.target.closest('.dropdown');
                    dropdown.classList.toggle('open');
                }
            });

            const setActiveLink = (navId) => {
                navLinks.forEach(link => {
                    link.classList.remove('active', 'text-blue-500', 'border-blue-500');
                    link.classList.add('border-transparent');
                });
                const activeLink = document.querySelector(`[data-dropdown-toggle="${navId}"], #${navId}`);
                 if (activeLink) {
                    const parent = activeLink.closest('.dropdown');
                    if(parent) {
                        const parentLink = parent.querySelector('.nav-link');
                        parentLink.classList.add('active', 'text-blue-500', 'border-blue-500');
                        parentLink.classList.remove('border-transparent');
                    } else {
                        activeLink.classList.add('active', 'text-blue-500', 'border-blue-500');
                        activeLink.classList.remove('border-transparent');
                    }
                }
            };

            const showPage = (pageHtml, navId, scriptRunner, ...args) => {
                console.log(`showPage called for navId: ${navId}`);
                pageContent.innerHTML = pageHtml;
                setActiveLink(navId);
                window.lucide.createIcons();
                if(scriptRunner) scriptRunner(...args);
            };
            
            // --- PAGE HTML TEMPLATES ---
            const dashboardHtml = `<div><h1 class="text-3xl font-bold text-gray-800 mb-6">Painel de Controlo</h1><div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6"><div class="bg-white p-6 rounded-lg shadow-md flex items-center gap-6"><div class="bg-blue-100 text-blue-600 p-4 rounded-full"><i data-lucide="dollar-sign" class="w-8 h-8"></i></div><div><p class="text-sm font-medium text-gray-500">Receita do Mês</p><p id="receita-mes-valor" class="text-2xl font-bold text-gray-800">A carregar...</p></div></div><div class="bg-white p-6 rounded-lg shadow-md flex items-center gap-6"><div class="bg-green-100 text-green-600 p-4 rounded-full"><i data-lucide="shopping-cart" class="w-8 h-8"></i></div><div><p class="text-sm font-medium text-gray-500">Vendas Hoje</p><p id="vendas-hoje-valor" class="text-2xl font-bold text-gray-800">A carregar...</p></div></div><div class="bg-white p-6 rounded-lg shadow-md flex items-center gap-6"><div class="bg-yellow-100 text-yellow-600 p-4 rounded-full"><i data-lucide="receipt" class="w-8 h-8"></i></div><div><p class="text-sm font-medium text-gray-500">Ticket Médio</p><p id="ticket-medio-valor" class="text-2xl font-bold text-gray-800">A carregar...</p></div></div><div class="bg-white p-6 rounded-lg shadow-md flex items-center gap-6"><div class="bg-indigo-100 text-indigo-600 p-4 rounded-full"><i data-lucide="user-plus" class="w-8 h-8"></i></div><div><p class="text-sm font-medium text-gray-500">Novos Clientes (Mês)</p><p id="novos-clientes-valor" class="text-2xl font-bold text-gray-800">A carregar...</p></div></div></div><div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mt-8"><div class="lg:col-span-2 bg-white p-6 rounded-lg shadow-md"><h3 class="font-semibold text-gray-800 mb-4">Vendas Semanais</h3><div class="h-80"><canvas id="weeklySalesChart"></canvas></div></div><div class="bg-white p-6 rounded-lg shadow-md"><h3 class="font-semibold text-gray-800 mb-4">Produtos Mais Vendidos</h3><div class="h-80"><canvas id="topProductsChart"></canvas></div></div></div><div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mt-8"><div class="lg:col-span-2 bg-white p-6 rounded-lg shadow-md"><h3 class="font-semibold text-gray-800 mb-4">Últimas Vendas Realizadas</h3><div class="overflow-x-auto"><table class="w-full text-sm text-left text-gray-500"><thead class="text-xs text-gray-700 uppercase bg-gray-50"><tr><th scope="col" class="py-3 px-6">Cliente</th><th scope="col" class="py-3 px-6">Status</th><th scope="col" class="py-3 px-6">Valor</th><th scope="col" class="py-3 px-6">Ação</th></tr></thead><tbody id="recent-sales-body"></tbody></table></div></div><div class="bg-white p-6 rounded-lg shadow-md"><h3 class="font-semibold text-gray-800 mb-4">Alerta de Baixo Estoque</h3><ul id="low-stock-list" class="divide-y divide-gray-200"></ul></div></div></div>`;
            const productSystemHtml = `<div class="product-system-container grid grid-cols-[288px_1fr_200px] h-full overflow-hidden bg-gray-100 rounded-xl shadow-lg"><aside class="bg-gray-100 text-gray-800 p-4 space-y-4 overflow-y-auto flex-shrink-0 rounded-l-xl"><div class="flex items-center justify-between"><h2 class="text-xl font-bold">Filtrar</h2><button id="clear-filters-btn" class="text-sm text-gray-500 hover:text-gray-700 flex items-center gap-1 p-1 rounded-sm"><i data-lucide="x" class="w-3.5 h-3.5"></i> Limpar</button></div><div class="space-y-3 mt-4"><div><label for="filter-situacao" class="block text-sm font-medium text-gray-700">Situação</label><select id="filter-situacao" class="w-full mt-1 bg-white border border-gray-300 rounded-md px-2 py-1.5 text-sm"><option value="">Todos</option><option value="ativo">Ativo</option><option value="inativo">Inativo</option></select></div><div><label for="filter-tags" class="block text-sm font-medium text-gray-700">Tags</label><select id="filter-tags" class="w-full mt-1 bg-white border border-gray-300 rounded-md px-2 py-1.5 text-sm"><option value="">Todas</option></select></div><div><label for="filter-categoria" class="block text-sm font-medium text-gray-700">Categoria</label><select id="filter-categoria" class="w-full mt-1 bg-white border border-gray-300 rounded-md px-2 py-1.5 text-sm"><option value="">Todas</option></select></div><div><label for="filter-ncm" class="block text-sm font-medium text-gray-700">NCM</label><input type="text" id="filter-ncm" class="w-full mt-1 bg-white border border-gray-300 rounded-md px-2 py-1.5 text-sm" placeholder="Código NCM"></div><div><label for="filter-tipo" class="block text-sm font-medium text-gray-700">Tipo</label><select id="filter-tipo" class="w-full mt-1 bg-white border border-gray-300 rounded-md px-2 py-1.5 text-sm"><option value="">Todos</option><option value="produto">Produto</option><option value="servico">Serviço</option></select></div><div><label for="filter-marca" class="block text-sm font-medium text-gray-700">Marca</label><input type="text" id="filter-marca" class="w-full mt-1 bg-white border border-gray-300 rounded-md px-2 py-1.5 text-sm" placeholder="Nome da marca"></div></div></aside><main class="flex-1 flex flex-col overflow-hidden bg-white rounded-none shadow-md"><header class="product-listing-header p-3 px-6 flex flex-col flex-shrink-0 rounded-t-xl"><div class="flex justify-between items-center mb-2"><h2 class="text-sm font-semibold text-gray-300">As Lojas</h2><div class="flex items-center gap-2"><button id="lock-product-btn" class="p-1 rounded-sm bg-gray-700 hover:bg-gray-600 text-white"><i data-lucide="lock" class="w-3.5 h-3.5"></i></button><button id="printer-product-btn" class="p-1 rounded-sm bg-gray-700 hover:bg-gray-600 text-white"><i data-lucide="printer" class="w-3.5 h-3.5"></i></button><button id="trash-product-btn" class="p-1 rounded-sm bg-gray-700 hover:bg-gray-600 text-white"><i data-lucide="trash-2" class="w-3.5 h-3.5"></i></button></div></div><div class="flex items-center space-x-2 w-full mb-2"><div class="relative flex-1 max-w-sm"><input type="text" id="product-search-input" class="w-full product-search-input-dark rounded-md pl-8 pr-2 py-1 text-sm" placeholder="Pesquisar..."><i data-lucide="search" class="w-3.5 h-3.5 text-gray-400 absolute left-2 top-1/2 -translate-y-1/2"></i></div><div id="date-range-display" class="relative bg-gray-700 border border-gray-600 rounded-md px-2 py-1 text-xs w-40 text-center cursor-pointer flex items-center justify-between hover:bg-gray-600"><span>Data do Pedido</span><i data-lucide="calendar" class="w-3.5 h-3.5 text-gray-400"></i></div><input type="hidden" id="search-date-start" value=""><input type="hidden" id="search-date-end" value=""><button id="toggle-filter-sidebar-btn" class="bg-gray-700 hover:bg-gray-600 text-white font-semibold py-1 px-2.5 rounded-sm flex items-center gap-1 text-xs"><i data-lucide="filter" class="w-3.5 h-3.5"></i></button><button id="refresh-product-btn" class="p-1 bg-gray-700 hover:bg-gray-600 text-white rounded-sm"><i data-lucide="refresh-cw" class="w-3.5 h-3.5"></i></button><button id="view-options-product-btn" class="p-1 bg-gray-700 hover:bg-gray-600 text-white rounded-sm"><i data-lucide="settings" class="w-3.5 h-3.5"></i></button></div><div id="filter-chips-container" class="flex flex-wrap items-center gap-2 text-sm mt-2"></div></header><div class="flex-1 overflow-y-auto p-6"><div class="product-table-dark rounded-lg shadow overflow-hidden border border-gray-700"><table class="w-full"><thead class="border-b border-gray-700"><tr><th class="p-3 text-left text-xs font-semibold uppercase w-10"><input type="checkbox" id="select-all-products" class="rounded-sm text-blue-500 bg-gray-600 border-gray-500"></th><th class="p-3 text-left text-xs font-semibold uppercase">Imagem</th><th class="p-3 text-left text-xs font-semibold uppercase">Descrição</th><th class="p-3 text-left text-xs font-semibold uppercase">Código</th><th class="p-3 text-left text-xs font-semibold uppercase">Unidade</th><th class="p-3 text-left text-xs font-semibold uppercase">Preço</th><th class="p-3 text-center text-xs font-semibold uppercase">Estoque</th><th class="p-3 text-center text-xs font-semibold uppercase">Ações</th></tr></thead><tbody id="product-table-body" class="divide-y divide-gray-700"></tbody></table></div></div></main><aside class="bg-gray-100 text-gray-800 p-4 space-y-4 overflow-y-auto flex-shrink-0 rounded-r-xl"><h2 class="text-xl font-bold mb-4">Ações</h2><div class="space-y-3"><button id="add-product-btn" class="w-full bg-blue-500 hover:bg-blue-700 text-white font-semibold py-1.5 px-3 rounded-md flex items-center justify-center gap-2"><i data-lucide="plus" class="w-4 h-4"></i> Adicionar Produto</button><button id="import-products-btn" class="w-full bg-green-500 hover:bg-green-600 text-white font-semibold py-1.5 px-3 rounded-md flex items-center justify-center gap-2"><i data-lucide="upload-cloud" class="w-4 h-4"></i> Importar</button><button id="export-products-btn" class="w-full bg-indigo-500 hover:bg-indigo-600 text-white font-semibold py-1.5 px-3 rounded-md flex items-center justify-center gap-2"><i data-lucide="download-cloud" class="w-4 h-4"></i> Exportar</button></div></aside></div>`;
            const clientesFornecedoresHtml = `<main class="flex-1 flex flex-col overflow-hidden"><header class="bg-white p-4 px-8 flex items-center justify-between flex-shrink-0 border-b"><div><h1 class="text-2xl font-bold text-gray-800">Clientes e Fornecedores</h1></div><div class="flex items-center gap-4"><div class="relative"><input type="text" id="contact-search-input" class="w-64 pl-10 pr-4 py-1.5 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-400" placeholder="Pesquisar por nome ou documento..."><div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none"><i data-lucide="search" class="w-5 h-5 text-gray-400"></i></div></div><button id="add-cs-btn" class="bg-blue-500 hover:bg-blue-600 text-white font-semibold py-1.5 px-3 rounded-md flex items-center gap-2"><i data-lucide="plus" class="w-4 h-4"></i> Adicionar</button></div></header><div class="flex-1 overflow-y-auto p-8"><div class="bg-white rounded-lg shadow overflow-hidden"><table class="w-full"><thead class="bg-gray-50"><tr><th class="p-3 text-left text-xs font-semibold text-gray-600 uppercase">Nome</th><th class="p-3 text-left text-xs font-semibold text-gray-600 uppercase">Documento</th><th class="p-3 text-left text-xs font-semibold text-gray-600 uppercase">Telefone</th><th class="p-3 text-left text-xs font-semibold text-gray-600 uppercase">Tipo</th><th class="p-3 text-center text-xs font-semibold text-gray-600 uppercase">Ações</th></tr></thead><tbody id="cs-table-body" class="divide-y divide-gray-200"></tbody></table></div></div></main>`;
            const vendasHtml = `<div class="h-full flex flex-col"><header class="bg-white p-4 px-8 flex items-center justify-between flex-shrink-0 border-b"><div><h1 class="text-2xl font-bold text-gray-800">Ponto de Venda</h1></div><div class="flex items-center gap-4"><button id="list-sales-btn" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-semibold py-1.5 px-3 rounded-md flex items-center gap-2"><i data-lucide="list" class="w-4 h-4"></i> Listar Vendas</button><button id="new-sale-btn" class="bg-blue-500 hover:bg-blue-600 text-white font-semibold py-1.5 px-3 rounded-md flex items-center gap-2"><i data-lucide="plus" class="w-4 h-4"></i> Nova Venda</button></div></header><div class="flex-1 grid grid-cols-1 lg:grid-cols-3 gap-6 p-6 overflow-hidden"><div class="lg:col-span-2 flex flex-col gap-4"><div class="grid grid-cols-1 md:grid-cols-2 gap-4"><div id="customer-search-container" class="relative"><label class="block text-sm font-medium text-gray-700">Cliente</label><input type="text" id="sale-customer-search" class="w-full mt-1 pl-10 pr-4 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-400" placeholder="Pesquisar cliente..."><div class="absolute inset-y-0 left-0 top-6 pl-3 flex items-center pointer-events-none"><i data-lucide="user-search" class="w-5 h-5 text-gray-400"></i></div><div id="customer-search-results" class="search-results hidden"></div></div><div id="product-search-container" class="relative"><label class="block text-sm font-medium text-gray-700">Adicionar Produto</label><input type="text" id="sale-product-search" class="w-full mt-1 pl-10 pr-4 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-400" placeholder="Pesquisar por código ou nome..."><div class="absolute inset-y-0 left-0 top-6 pl-3 flex items-center pointer-events-none"><i data-lucide="search" class="w-5 h-5 text-gray-400"></i></div><div id="product-search-results" class="search-results hidden"></div></div></div><div class="bg-white rounded-lg shadow overflow-hidden flex-1 flex flex-col"><div class="overflow-y-auto"><table class="w-full text-sm"><thead class="bg-gray-100"><tr><th class="p-3 text-left font-semibold text-gray-600">Produto</th><th class="p-3 text-center font-semibold text-gray-600 w-24">Qtd.</th><th class="p-3 text-right font-semibold text-gray-600">Preço Unit.</th><th class="p-3 text-right font-semibold text-gray-600 w-28">Desconto (R$)</th><th class="p-3 text-right font-semibold text-gray-600">Subtotal</th><th class="p-3 text-center font-semibold text-gray-600">Ação</th></tr></thead><tbody id="sale-items-table" class="divide-y divide-gray-200"></tbody></table></div></div></div><div class="bg-white rounded-lg shadow p-6 flex flex-col"><h3 class="text-lg font-bold text-gray-800 border-b pb-3">Resumo da Venda</h3><div class="space-y-3 mt-4 flex-1"><div class="flex justify-between items-center"><span class="text-gray-600">Subtotal</span><span id="sale-subtotal" class="font-semibold text-gray-800">R$ 0,00</span></div><div class="flex justify-between items-center"><span class="text-gray-600">Desconto Geral</span><input type="number" step="0.01" id="sale-discount" class="w-24 text-right border rounded-md py-1 px-2" placeholder="0,00"></div></div><div class="border-t pt-4 space-y-4"><div class="flex justify-between items-center text-xl"><span class="font-bold text-gray-800">TOTAL</span><span id="sale-total" class="font-bold text-blue-600">R$ 0,00</span></div><div><label class="block text-sm font-medium text-gray-700 mb-1">Forma de Pagamento</label><select id="sale-payment-method" class="w-full bg-white border border-gray-300 rounded-md p-2 shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-400"><option>Dinheiro</option><option>Cartão de Crédito</option><option>Cartão de Débito</option><option>PIX</option></select></div><button id="finish-sale-btn" class="w-full bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-4 rounded-md flex items-center justify-center gap-2 text-lg"><i data-lucide="check-circle" class="w-6 h-6"></i>Finalizar Venda</button></div></div></div></div>`;
            const salesHubHtml = `<div class="p-8"><h1 class="text-3xl font-bold text-gray-800 mb-8">Módulo de Vendas</h1><div class="grid grid-cols-1 md:grid-cols-2 gap-8"><div id="go-to-pos" class="bg-white p-6 rounded-lg shadow-md hover:shadow-xl transition-shadow cursor-pointer flex flex-col items-center text-center"><i data-lucide="shopping-cart" class="w-16 h-16 text-blue-500 mb-4"></i><h2 class="text-xl font-bold text-gray-800">Ponto de Venda</h2><p class="text-gray-600 mt-2">Crie e finalize vendas diretas de forma rápida e eficiente.</p></div><div id="go-to-proposals" class="bg-white p-6 rounded-lg shadow-md hover:shadow-xl transition-shadow cursor-pointer flex flex-col items-center text-center"><i data-lucide="file-text" class="w-16 h-16 text-green-500 mb-4"></i><h2 class="text-xl font-bold text-gray-800">Propostas / Orçamentos</h2><p class="text-gray-600 mt-2">Crie, gira e converta orçamentos em vendas.</p></div></div></div>`;
            const salesListHtml = `<main class="flex-1 flex flex-col overflow-hidden"><header class="bg-white p-4 px-8 flex items-center justify-between flex-shrink-0 border-b"><div><h1 class="text-2xl font-bold text-gray-800">Histórico de Vendas</h1></div><div class="flex items-center gap-4"><div class="relative"><input type="text" id="sales-search-input" class="w-64 pl-10 pr-4 py-1.5 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-400" placeholder="Pesquisar por cliente..."><div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none"><i data-lucide="search" class="w-5 h-5 text-gray-400"></i></div></div><button id="back-to-pos-btn" class="bg-gray-600 hover:bg-gray-700 text-white font-semibold py-1.5 px-3 rounded-md flex items-center gap-2"><i data-lucide="arrow-left" class="w-4 h-4"></i> Voltar ao PDV</button></div></header><div class="flex-1 overflow-y-auto p-8"><div class="bg-white rounded-lg shadow overflow-hidden"><table class="w-full"><thead class="bg-gray-50"><tr><th class="p-3 text-left text-xs font-semibold text-gray-600 uppercase">Data</th><th class="p-3 text-left text-xs font-semibold text-gray-600 uppercase">Cliente</th><th class="p-3 text-right text-xs font-semibold text-gray-600 uppercase">Valor Total</th><th class="p-3 text-left text-xs font-semibold text-gray-600 uppercase">Status</th><th class="p-3 text-center text-xs font-semibold text-gray-600 uppercase">Ações</th></tr></thead><tbody id="sales-list-table-body" class="divide-y divide-gray-200"></tbody></table></div></div></main>`;
            const proposalsListHtml = `<main class="flex-1 flex flex-col overflow-hidden"><header class="bg-white p-4 px-8 flex items-center justify-between flex-shrink-0 border-b"><div><h1 class="text-2xl font-bold text-gray-800">Propostas e Orçamentos</h1></div><div class="flex items-center gap-4"><button id="back-to-sales-hub-btn" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-semibold py-1.5 px-3 rounded-md flex items-center gap-2"><i data-lucide="arrow-left" class="w-4 h-4"></i> Voltar</button><button id="new-proposal-btn" class="bg-blue-500 hover:bg-blue-600 text-white font-semibold py-1.5 px-3 rounded-md flex items-center gap-2"><i data-lucide="plus" class="w-4 h-4"></i> Nova Proposta</button></div></header><div class="flex-1 overflow-y-auto p-8"><div class="bg-white rounded-lg shadow overflow-hidden"><table class="w-full"><thead class="bg-gray-50"><tr><th class="p-3 text-left text-xs font-semibold text-gray-600 uppercase">Data</th><th class="p-3 text-left text-xs font-semibold text-gray-600 uppercase">Cliente</th><th class="p-3 text-left text-xs font-semibold text-gray-600 uppercase">Validade</th><th class="p-3 text-right text-xs font-semibold text-gray-600 uppercase">Valor Total</th><th class="p-3 text-left text-xs font-semibold text-gray-600 uppercase">Status</th><th class="p-3 text-center text-xs font-semibold text-gray-600 uppercase">Ações</th></tr></thead><tbody id="proposals-list-table-body" class="divide-y divide-gray-200"></tbody></table></div></div></main>`;
            const newProposalHtml = `<div class="h-full flex flex-col"><header class="bg-white p-4 px-8 flex items-center justify-between flex-shrink-0 border-b"><div><h1 class="text-2xl font-bold text-gray-800">Nova Proposta</h1></div><div class="flex items-center gap-4"><button id="save-proposal-btn" class="bg-green-500 hover:bg-green-600 text-white font-semibold py-1.5 px-3 rounded-md flex items-center gap-2"><i data-lucide="save" class="w-4 h-4"></i> Guardar Proposta</button></div></header><div class="flex-1 grid grid-cols-1 lg:grid-cols-3 gap-6 p-6 overflow-hidden"><div class="lg:col-span-2 flex flex-col gap-4"><div class="grid grid-cols-1 md:grid-cols-2 gap-4"><div id="customer-search-container" class="relative"><label class="block text-sm font-medium text-gray-700">Cliente</label><input type="text" id="proposal-customer-search" class="w-full mt-1 pl-10 pr-4 py-2 border rounded-md" placeholder="Pesquisar cliente..."><div class="absolute inset-y-0 left-0 top-6 pl-3 flex items-center pointer-events-none"><i data-lucide="user-search" class="w-5 h-5 text-gray-400"></i></div><div id="customer-search-results" class="search-results hidden"></div></div><div id="product-search-container-proposal" class="relative"><label class="block text-sm font-medium text-gray-700">Adicionar Produto</label><input type="text" id="proposal-product-search" class="w-full mt-1 pl-10 pr-4 py-2 border rounded-md" placeholder="Pesquisar produto..."><div class="absolute inset-y-0 left-0 top-6 pl-3 flex items-center pointer-events-none"><i data-lucide="search" class="w-5 h-5 text-gray-400"></i></div><div id="product-search-results" class="search-results hidden"></div></div></div><div class="bg-white rounded-lg shadow overflow-hidden flex-1 flex flex-col"><div class="overflow-y-auto"><table class="w-full text-sm"><thead class="bg-gray-100"><tr><th class="p-3 text-left font-semibold text-gray-600">Produto</th><th class="p-3 text-center font-semibold text-gray-600 w-24">Qtd.</th><th class="p-3 text-right font-semibold text-gray-600">Preço Unit.</th><th class="p-3 text-right font-semibold text-gray-600">Subtotal</th><th class="p-3 text-center font-semibold text-gray-600">Ação</th></tr></thead><tbody id="proposal-items-table"></tbody></table></div></div></div><div class="bg-white rounded-lg shadow p-6 flex flex-col"><h3 class="text-lg font-bold text-gray-800 border-b pb-3">Resumo da Proposta</h3><div class="flex-1 mt-4"><div><label class="block text-sm font-medium text-gray-700 mb-1">Válido até</label><input type="date" id="proposal-valid-until" class="w-full bg-white border border-gray-300 rounded-md p-2 shadow-sm"></div></div><div class="border-t pt-4 space-y-4"><div class="flex justify-between items-center text-xl"><span class="font-bold text-gray-800">TOTAL</span><span id="proposal-total" class="font-bold text-blue-600">R$ 0,00</span></div></div></div></div></div>`;
            const estoqueHtml = `<main class="flex-1 flex flex-col overflow-hidden"><header class="bg-white p-4 px-8 flex items-center justify-between flex-shrink-0 border-b"><div><h1 class="text-2xl font-bold text-gray-800">Controlo de Inventário</h1></div></header><div class="flex-1 overflow-y-auto p-8"><div class="bg-white rounded-lg shadow overflow-hidden"><table class="w-full"><thead class="bg-gray-50"><tr><th class="p-3 text-left text-xs font-semibold text-gray-600 uppercase">Produto</th><th class="p-3 text-left text-xs font-semibold text-gray-600 uppercase">SKU</th><th class="p-3 text-center text-xs font-semibold text-gray-600 uppercase">Estoque Atual</th><th class="p-3 text-center text-xs font-semibold text-gray-600 uppercase">Ações</th></tr></thead><tbody id="inventory-table-body" class="divide-y divide-gray-200"></tbody></table></div></div></main>`;
            const financeiroHtml = `<main class="flex-1 flex flex-col overflow-hidden"><header class="bg-white p-4 px-8 flex items-center justify-between flex-shrink-0 border-b"><div><h1 class="text-2xl font-bold text-gray-800">Financeiro</h1></div><div class="flex items-center gap-4"><button id="add-expense-btn" class="bg-blue-500 hover:bg-blue-600 text-white font-semibold py-1.5 px-3 rounded-md flex items-center gap-2"><i data-lucide="plus" class="w-4 h-4"></i> Nova Despesa</button></div></header><div class="flex-1 flex flex-col p-8 gap-6"><div class="border-b border-gray-200"><nav class="-mb-px flex space-x-6" id="finance-tabs"><a href="#" class="finance-tab-link active whitespace-nowrap py-3 px-1 border-b-2 font-medium text-sm" data-tab="contas-a-pagar">Contas a Pagar</a><a href="#" class="finance-tab-link whitespace-nowrap py-3 px-1 border-b-2 font-medium text-sm border-transparent text-gray-500 hover:border-gray-300 hover:text-gray-700" data-tab="contas-a-receber">Contas a Receber</a></nav></div><div id="finance-tab-content-container" class="flex-1 overflow-hidden"><div id="contas-a-pagar" class="finance-tab-content active h-full overflow-y-auto"><div class="bg-white rounded-lg shadow overflow-hidden"><table class="w-full"><thead class="bg-gray-50"><tr><th class="p-3 text-left text-xs font-semibold text-gray-600 uppercase">Descrição</th><th class="p-3 text-left text-xs font-semibold text-gray-600 uppercase">Fornecedor</th><th class="p-3 text-left text-xs font-semibold text-gray-600 uppercase">Vencimento</th><th class="p-3 text-right text-xs font-semibold text-gray-600 uppercase">Valor</th><th class="p-3 text-left text-xs font-semibold text-gray-600 uppercase">Status</th><th class="p-3 text-center text-xs font-semibold text-gray-600 uppercase">Ações</th></tr></thead><tbody id="accounts-payable-body" class="divide-y divide-gray-200"></tbody></table></div></div><div id="contas-a-receber" class="finance-tab-content h-full overflow-y-auto"><div class="bg-white rounded-lg shadow overflow-hidden"><table class="w-full"><thead class="bg-gray-50"><tr><th class="p-3 text-left text-xs font-semibold text-gray-600 uppercase">Cliente</th><th class="p-3 text-left text-xs font-semibold text-gray-600 uppercase">Vencimento</th><th class="p-3 text-right text-xs font-semibold text-gray-600 uppercase">Valor</th><th class="p-3 text-left text-xs font-semibold text-gray-600 uppercase">Status</th><th class="p-3 text-center text-xs font-semibold text-gray-600 uppercase">Ações</th></tr></thead><tbody id="accounts-receivable-body" class="divide-y divide-gray-200"></tbody></table></div></div></div></div></main>`;
            const purchasesHubHtml = `<div class="p-8"><h1 class="text-3xl font-bold text-gray-800 mb-8">Módulo de Compras</h1><div class="grid grid-cols-1 md:grid-cols-2 gap-8"><div id="go-to-new-purchase" class="bg-white p-6 rounded-lg shadow-md hover:shadow-xl transition-shadow cursor-pointer flex flex-col items-center text-center"><i data-lucide="shopping-basket" class="w-16 h-16 text-blue-500 mb-4"></i><h2 class="text-xl font-bold text-gray-800">Nova Compra</h2><p class="text-gray-600 mt-2">Registe a entrada de novos produtos no seu estoque.</p></div><div id="go-to-purchases-list" class="bg-white p-6 rounded-lg shadow-md hover:shadow-xl transition-shadow cursor-pointer flex flex-col items-center text-center"><i data-lucide="archive" class="w-16 h-16 text-green-500 mb-4"></i><h2 class="text-xl font-bold text-gray-800">Listar Compras</h2><p class="text-gray-600 mt-2">Veja o histórico de todas as compras realizadas.</p></div></div></div>`;
            const newPurchaseHtml = `<div class="h-full flex flex-col"><header class="bg-white p-4 px-8 flex items-center justify-between flex-shrink-0 border-b"><div><h1 class="text-2xl font-bold text-gray-800">Nova Compra</h1></div></header><div class="flex-1 grid grid-cols-1 lg:grid-cols-3 gap-6 p-6 overflow-hidden"><div class="lg:col-span-2 flex flex-col gap-4"><div class="grid grid-cols-1 md:grid-cols-2 gap-4"><div id="supplier-search-container" class="relative"><label class="block text-sm font-medium text-gray-700">Fornecedor</label><input type="text" id="purchase-supplier-search" class="w-full mt-1 pl-10 pr-4 py-2 border rounded-md" placeholder="Pesquisar fornecedor..."><div class="absolute inset-y-0 left-0 top-6 pl-3 flex items-center pointer-events-none"><i data-lucide="user-search" class="w-5 h-5 text-gray-400"></i></div><div id="supplier-search-results" class="search-results hidden"></div></div><div id="product-search-container-purchase" class="relative"><label class="block text-sm font-medium text-gray-700">Adicionar Produto</label><input type="text" id="purchase-product-search" class="w-full mt-1 pl-10 pr-4 py-2 border rounded-md" placeholder="Pesquisar por código ou nome..."><div class="absolute inset-y-0 left-0 top-6 pl-3 flex items-center pointer-events-none"><i data-lucide="search" class="w-5 h-5 text-gray-400"></i></div><div id="product-search-results" class="search-results hidden"></div></div></div><div class="bg-white rounded-lg shadow overflow-hidden flex-1 flex flex-col"><div class="overflow-y-auto"><table class="w-full text-sm"><thead class="bg-gray-100"><tr><th class="p-3 text-left font-semibold text-gray-600">Produto</th><th class="p-3 text-center font-semibold text-gray-600 w-24">Qtd.</th><th class="p-3 text-right font-semibold text-gray-600">Preço Custo</th><th class="p-3 text-right font-semibold text-gray-600">Subtotal</th><th class="p-3 text-center font-semibold text-gray-600">Ação</th></tr></thead><tbody id="purchase-items-table" class="divide-y divide-gray-200"></tbody></table></div></div></div><div class="bg-white rounded-lg shadow p-6 flex flex-col"><h3 class="text-lg font-bold text-gray-800 border-b pb-3">Resumo da Compra</h3><div class="flex-1"></div><div class="border-t pt-4 space-y-4"><div class="flex justify-between items-center text-xl"><span class="font-bold text-gray-800">TOTAL</span><span id="purchase-total" class="font-bold text-blue-600">R$ 0,00</span></div><button id="finish-purchase-btn" class="w-full bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-4 rounded-md flex items-center justify-center gap-2 text-lg"><i data-lucide="check-circle" class="w-6 h-6"></i>Finalizar Compra</button></div></div></div></div>`;
            const purchasesListHtml = `<main class="flex-1 flex flex-col overflow-hidden"><header class="bg-white p-4 px-8 flex items-center justify-between flex-shrink-0 border-b"><div><h1 class="text-2xl font-bold text-gray-800">Histórico de Compras</h1></div></header><div class="flex-1 overflow-y-auto p-8"><div class="bg-white rounded-lg shadow overflow-hidden"><table class="w-full"><thead class="bg-gray-50"><tr><th class="p-3 text-left text-xs font-semibold text-gray-600 uppercase">Data</th><th class="p-3 text-left text-xs font-semibold text-gray-600 uppercase">Fornecedor</th><th class="p-3 text-right text-xs font-semibold text-gray-600 uppercase">Valor Total</th><th class="p-3 text-left text-xs font-semibold text-gray-600 uppercase">Status</th><th class="p-3 text-center text-xs font-semibold text-gray-600 uppercase">Ações</th></tr></thead><tbody id="purchases-list-table-body" class="divide-y divide-gray-200"></tbody></table></div></div></main>`;
            const relatoriosHtml = `<main class="flex-1 flex flex-col overflow-hidden"><header class="bg-white p-4 px-8 flex items-center justify-between flex-shrink-0 border-b"><div><h1 class="text-2xl font-bold text-gray-800">Relatório de Vendas</h1></div><div class="flex items-center gap-4"><div class="flex items-center gap-2"><label for="report-start-date" class="text-sm font-medium">De:</label><input type="date" id="report-start-date" class="border-gray-300 rounded-md shadow-sm p-1.5 text-sm"><label for="report-end-date" class="text-sm font-medium">Até:</label><input type="date" id="report-end-date" class="border-gray-300 rounded-md shadow-sm p-1.5 text-sm"></div><button id="generate-report-btn" class="bg-blue-500 hover:bg-blue-600 text-white font-semibold py-1.5 px-3 rounded-md flex items-center gap-2"><i data-lucide="search" class="w-4 h-4"></i> Gerar</button></div></header><div class="flex-1 overflow-y-auto p-8"><div id="report-summary" class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8"></div><div id="report-results" class="bg-white rounded-lg shadow overflow-hidden"></div></div></main>`;
            
            // --- PAGE SCRIPT RUNNERS ---

            const runDashboardScript = async () => {
                console.log("Running Dashboard Script");
                const receitaMesValor = document.getElementById('receita-mes-valor');
                const vendasHojeValor = document.getElementById('vendas-hoje-valor');
                const ticketMedioValor = document.getElementById('ticket-medio-valor');
                const novosClientesValor = document.getElementById('novos-clientes-valor');
                const lowStockList = document.getElementById('low-stock-list');

                const getMonthBounds = () => {
                    const now = new Date();
                    const firstDay = new Date(now.getFullYear(), now.getMonth(), 1);
                    const lastDay = new Date(now.getFullYear(), now.getMonth() + 1, 0);
                    return { start: firstDay.toISOString(), end: lastDay.toISOString() };
                };
                 const getTodayBounds = () => {
                    const now = new Date();
                    const start = new Date(now.getFullYear(), now.getMonth(), now.getDate());
                    const end = new Date(now.getFullYear(), now.getMonth(), now.getDate() + 1);
                    return { start: start.toISOString(), end: end.toISOString() };
                };

                const { start: monthStart, end: monthEnd } = getMonthBounds();
                const { data: monthSales, error: salesError } = await window.supabase
                    .from('sales').select('total_amount').eq('user_id', window.userId)
                    .gte('created_at', monthStart).lte('created_at', monthEnd);

                if (salesError) console.error("Error fetching month sales:", salesError);
                
                const totalRevenue = monthSales?.reduce((sum, sale) => sum + sale.total_amount, 0) || 0;
                receitaMesValor.textContent = window.formatCurrency(totalRevenue);

                const avgTicket = monthSales && monthSales.length > 0 ? totalRevenue / monthSales.length : 0;
                ticketMedioValor.textContent = window.formatCurrency(avgTicket);

                const { start: todayStart, end: todayEnd } = getTodayBounds();
                 const { error: todayError, count: todayCount } = await window.supabase
                    .from('sales').select('*', { count: 'exact' }).eq('user_id', window.userId)
                    .gte('created_at', todayStart).lt('created_at', todayEnd);
                if(todayError) console.error("Error fetching today's sales:", todayError);
                vendasHojeValor.textContent = todayCount || 0;
                
                const { count: newClientsCount, error: clientError } = await window.supabase
                    .from('contacts').select('*', { count: 'exact', head: true }).eq('user_id', window.userId)
                    .eq('contact_type', 'Cliente').gte('created_at', monthStart).lte('created_at', monthEnd);
                if(clientError) console.error("Error fetching new clients:", clientError);
                novosClientesValor.textContent = newClientsCount || 0;
                
                const { data: lowStockProducts, error: stockError } = await window.supabase
                    .from('products').select('name, stock_quantity').eq('user_id', window.userId)
                    .lte('stock_quantity', 5).order('stock_quantity', { ascending: true });
                
                if (stockError) console.error("Error fetching low stock products:", stockError);
                
                if (lowStockProducts && lowStockProducts.length > 0) {
                     lowStockList.innerHTML = lowStockProducts.map(p => `
                        <li class="py-2 flex justify-between items-center text-sm">
                            <span>${p.name}</span>
                            <span class="font-bold text-red-500">${p.stock_quantity} em estoque</span>
                        </li>
                     `).join('');
                } else {
                    lowStockList.innerHTML = '<li class="py-2 text-sm text-gray-500">Nenhum produto com baixo estoque.</li>';
                }
            };
            const runProductSystemScript = () => {
                 console.log("Running Product System Script");
                 const addProductBtn = document.getElementById('add-product-btn');
                 const productModal = document.getElementById('product-modal');
                 const productForm = document.getElementById('product-form');
                 const cancelBtn = document.getElementById('product-modal-cancel');
                 const closeHeaderBtn = document.getElementById('product-modal-header-close');
                 const imageInput = document.getElementById('product-image-input');
                 const imagePreview = document.getElementById('product-image-preview');
                 const productTableBody = document.getElementById('product-table-body');
                 const searchInput = document.getElementById('product-search-input');
                 const deleteBtn = document.getElementById('trash-product-btn');
                 const selectAllCheckbox = document.getElementById('select-all-products');
                 
                 let currentEditingId = null;
                 let uploadedFile = null;

                const openModal = () => {
                    productForm.reset();
                    currentEditingId = null;
                    uploadedFile = null;
                    document.getElementById('product-modal-title').textContent = 'Novo Produto';
                    imagePreview.src = 'https://placehold.co/160x160/cbd5e1/475569?text=Sem%20Imagem';
                    productModal.classList.remove('hidden');
                }
                const closeModal = () => productModal.classList.add('hidden');
                
                const fetchProducts = async (searchTerm = '') => {
                    let query = window.supabase.from('products').select('*').eq('user_id', window.userId);
                    if(searchTerm) {
                        query = query.or(`name.ilike.%${searchTerm}%,sku.ilike.%${searchTerm}%`);
                    }
                    const { data, error } = await query.order('name', { ascending: true });

                    if(error) {
                        console.error('Error fetching products:', error);
                        window.showMessage("Erro ao carregar produtos.", "error");
                        return;
                    }
                    
                    productTableBody.innerHTML = data.map(p => `
                        <tr data-id="${p.id}" class="hover:bg-gray-700">
                           <td class="p-3"><input type="checkbox" class="product-checkbox rounded-sm text-blue-500 bg-gray-600 border-gray-500" data-id="${p.id}"></td>
                           <td class="p-3"><img src="${p.image_url || 'https://placehold.co/40x40/cbd5e1/475569?text=N/A'}" class="w-10 h-10 rounded-md object-cover"></td>
                           <td class="p-3 font-medium">${p.name}</td>
                           <td class="p-3 text-gray-400">${p.sku || 'N/A'}</td>
                           <td class="p-3 text-gray-400">UN</td>
                           <td class="p-3 font-semibold">${window.formatCurrency(p.price)}</td>
                           <td class="p-3 text-center font-bold ${p.stock_quantity <= 5 ? 'text-red-400' : 'text-green-400'}">${p.stock_quantity || 0}</td>
                           <td class="p-3 text-center">
                                <button class="edit-product-btn p-1 text-gray-400 hover:text-white" data-id="${p.id}"><i data-lucide="edit-2" class="w-4 h-4"></i></button>
                           </td>
                        </tr>
                    `).join('');
                    window.lucide.createIcons();
                };
                
                const saveProduct = async (e) => {
                    e.preventDefault();
                    if (!window.userId) return window.showMessage("Utilizador não autenticado.", "error");

                    let imageUrl = productForm.querySelector('img').src;
                    if (uploadedFile) {
                        const filePath = `public/${window.userId}/${Date.now()}-${uploadedFile.name}`;
                        const { data: uploadData, error: uploadError } = await window.supabase.storage
                            .from('product_images')
                            .upload(filePath, uploadedFile);
                        
                        if (uploadError) { return window.showMessage("Erro ao carregar a imagem.", "error"); }

                        const { data: urlData } = window.supabase.storage.from('product_images').getPublicUrl(uploadData.path);
                        imageUrl = urlData.publicUrl;
                    }
                    
                    const formData = new FormData(productForm);
                    const productData = { name: formData.get('name'), sku: formData.get('sku'), price: parseFloat(formData.get('price')) || 0, stock_quantity: parseInt(formData.get('stock_quantity')) || 0, type: formData.get('type'), user_id: window.userId };
                    if (imageUrl && !imageUrl.startsWith('https://placehold.co')) productData.image_url = imageUrl;


                    const { error } = currentEditingId
                        ? await window.supabase.from('products').update(productData).eq('id', currentEditingId)
                        : await window.supabase.from('products').insert([productData]);

                    if(error) { window.showMessage(`Erro ao guardar o produto: ${error.message}`, "error"); } 
                    else {
                        window.showMessage("Produto guardado com sucesso!", "success");
                        closeModal();
                        fetchProducts();
                    }
                };
                
                const editProduct = async (id) => {
                    const { data, error } = await window.supabase.from('products').select('*').eq('id', id).single();
                    if (error) return window.showMessage("Erro ao carregar dados do produto.", "error");
                    
                    currentEditingId = id;
                    document.getElementById('product-modal-title').textContent = 'Editar Produto';
                    for (const key in data) { if (productForm.elements[key]) { productForm.elements[key].value = data[key]; } }
                    imagePreview.src = data.image_url || 'https://placehold.co/160x160/cbd5e1/475569?text=Sem%20Imagem';
                    productModal.classList.remove('hidden');
                };

                const deleteSelectedProducts = async () => {
                    const selectedIds = Array.from(document.querySelectorAll('.product-checkbox:checked')).map(cb => cb.dataset.id);
                    if (selectedIds.length === 0) return window.showMessage("Nenhum produto selecionado.", "info");

                    const confirmationModal = document.getElementById('confirmation-modal');
                    const confirmBtn = document.getElementById('confirm-action-btn');
                    const cancelBtn = document.getElementById('cancel-action-btn');
                    document.getElementById('confirmation-title').textContent = 'Apagar Produtos';
                    document.getElementById('confirmation-message').textContent = `Tem a certeza de que deseja apagar ${selectedIds.length} produto(s)? Esta ação não pode ser desfeita.`;
                    confirmationModal.classList.remove('hidden');

                    const handleConfirm = async () => {
                        const { error } = await window.supabase.from('products').delete().in('id', selectedIds);
                        if (error) window.showMessage(`Erro ao apagar produtos: ${error.message}`, "error");
                        else {
                            window.showMessage("Produtos apagados com sucesso.", "success");
                            fetchProducts();
                        }
                        confirmationModal.classList.add('hidden');
                    };
                    
                    const handleCancel = () => confirmationModal.classList.add('hidden');
                    confirmBtn.addEventListener('click', handleConfirm, { once: true });
                    cancelBtn.addEventListener('click', handleCancel, { once: true });
                };
                
                addProductBtn.addEventListener('click', openModal);
                cancelBtn.addEventListener('click', closeModal);
                closeHeaderBtn.addEventListener('click', closeModal);
                productForm.addEventListener('submit', saveProduct);
                imageInput.addEventListener('change', (e) => {
                    if (e.target.files && e.target.files[0]) {
                        uploadedFile = e.target.files[0];
                        imagePreview.src = URL.createObjectURL(uploadedFile);
                    }
                });
                
                searchInput.addEventListener('input', (e) => fetchProducts(e.target.value));
                deleteBtn.addEventListener('click', deleteSelectedProducts);
                
                selectAllCheckbox.addEventListener('change', (e) => {
                    document.querySelectorAll('.product-checkbox').forEach(cb => cb.checked = e.target.checked);
                });

                productTableBody.addEventListener('click', (e) => {
                    const editBtn = e.target.closest('.edit-product-btn');
                    if (editBtn) editProduct(editBtn.dataset.id);
                });

                fetchProducts();
            };
            const runClientesFornecedoresScript = () => {
                console.log("Running Clientes/Fornecedores Script");
                const addBtn = document.getElementById('add-cs-btn');
                const modal = document.getElementById('contact-modal');
                const form = document.getElementById('contact-form');
                const cancelBtn = document.getElementById('contact-modal-cancel');
                const closeBtn = document.getElementById('contact-modal-close');
                const tableBody = document.getElementById('cs-table-body');
                const searchInput = document.getElementById('contact-search-input');
                
                let currentEditingId = null;

                const openModal = () => {
                    form.reset();
                    currentEditingId = null;
                    document.getElementById('contact-modal-title').textContent = 'Novo Contacto';
                    modal.classList.remove('hidden');
                };
                const closeModal = () => modal.classList.add('hidden');

                const fetchContacts = async (searchTerm = '') => {
                    let query = window.supabase.from('contacts').select('*').eq('user_id', window.userId);
                    if (searchTerm) {
                        query = query.or(`name.ilike.%${searchTerm}%,cpf_cnpj.ilike.%${searchTerm}%`);
                    }
                    const { data, error } = await query.order('name');
                    if (error) return window.showMessage("Erro ao carregar contactos.", "error");

                    tableBody.innerHTML = data.map(c => `
                        <tr>
                            <td class="p-3 font-medium">${c.name}</td>
                            <td class="p-3">${c.cpf_cnpj || 'N/A'}</td>
                            <td class="p-3">${c.phone || 'N/A'}</td>
                            <td class="p-3"><span class="px-2 py-1 text-xs font-semibold rounded-full ${c.contact_type === 'Cliente' ? 'bg-blue-100 text-blue-800' : 'bg-green-100 text-green-800'}">${c.contact_type}</span></td>
                            <td class="p-3 text-center">
                               <button class="edit-contact-btn p-1 text-gray-500 hover:text-blue-600" data-id="${c.id}"><i data-lucide="edit" class="w-4 h-4"></i></button>
                               <button class="delete-contact-btn p-1 text-gray-500 hover:text-red-600" data-id="${c.id}"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                            </td>
                        </tr>
                    `).join('');
                    window.lucide.createIcons();
                };

                const saveContact = async (e) => {
                    e.preventDefault();
                    const formData = new FormData(form);
                    const contactData = Object.fromEntries(formData.entries());
                    contactData.user_id = window.userId;
                    if(contactData.credit_limit) contactData.credit_limit = parseFloat(contactData.credit_limit);
                    
                    const { error } = currentEditingId
                        ? await window.supabase.from('contacts').update(contactData).eq('id', currentEditingId)
                        : await window.supabase.from('contacts').insert([contactData]);
                    
                    if (error) window.showMessage(`Erro: ${error.message}`, 'error');
                    else {
                        window.showMessage('Contacto guardado!', 'success');
                        closeModal();
                        fetchContacts();
                    }
                };
                
                const editContact = async (id) => {
                    const { data, error } = await window.supabase.from('contacts').select('*').eq('id', id).single();
                    if(error) return window.showMessage("Erro ao carregar contacto.", "error");

                    currentEditingId = id;
                    document.getElementById('contact-modal-title').textContent = 'Editar Contacto';
                    for (const key in data) { if (form.elements[key]) { form.elements[key].value = data[key] || ''; } }
                    modal.classList.remove('hidden');
                };

                const deleteContact = async (id) => {
                    const confirmationModal = document.getElementById('confirmation-modal');
                    const confirmBtn = document.getElementById('confirm-action-btn');
                    const cancelBtn = document.getElementById('cancel-action-btn');
                    document.getElementById('confirmation-title').textContent = 'Apagar Contacto';
                    document.getElementById('confirmation-message').textContent = 'Tem a certeza de que deseja apagar este contacto? Esta ação não pode ser desfeita.';
                    confirmationModal.classList.remove('hidden');

                    const handleConfirm = async () => {
                        const { error } = await window.supabase.from('contacts').delete().eq('id', id);
                        if(error) window.showMessage(`Erro: ${error.message}`, 'error');
                        else {
                            window.showMessage('Contacto apagado.', 'success');
                            fetchContacts();
                        }
                        confirmationModal.classList.add('hidden');
                    };
                    
                    const handleCancel = () => confirmationModal.classList.add('hidden');
                    confirmBtn.addEventListener('click', handleConfirm, { once: true });
                    cancelBtn.addEventListener('click', handleCancel, { once: true });
                };

                addBtn.addEventListener('click', openModal);
                cancelBtn.addEventListener('click', closeModal);
                closeBtn.addEventListener('click', closeModal);
                form.addEventListener('submit', saveContact);
                searchInput.addEventListener('input', (e) => fetchContacts(e.target.value));

                tableBody.addEventListener('click', (e) => {
                    const editBtn = e.target.closest('.edit-contact-btn');
                    const deleteBtn = e.target.closest('.delete-contact-btn');
                    if (editBtn) editContact(editBtn.dataset.id);
                    if (deleteBtn) deleteContact(deleteBtn.dataset.id);
                });
                
                fetchContacts();
            };
            const runVendasScript = (prefillData = null) => {
                console.log("Running Vendas Script");
                const customerSearchInput = document.getElementById('sale-customer-search');
                const productSearchInput = document.getElementById('sale-product-search');
                const customerSearchResults = document.getElementById('customer-search-results');
                const productSearchResults = document.getElementById('product-search-results');
                const saleItemsTable = document.getElementById('sale-items-table');
                const saleSubtotalEl = document.getElementById('sale-subtotal');
                const saleDiscountEl = document.getElementById('sale-discount');
                const saleTotalEl = document.getElementById('sale-total');
                const finishSaleBtn = document.getElementById('finish-sale-btn');
                const listSalesBtn = document.getElementById('list-sales-btn');

                let selectedCustomer = null;
                let saleItems = []; // Array of { product_id, name, quantity, unit_price, stock }

                customerSearchInput.addEventListener('input', async (e) => {
                    const searchTerm = e.target.value;
                    if (searchTerm.length < 2) { customerSearchResults.classList.add('hidden'); return; }
                    const { data, error } = await window.supabase.from('contacts').select('id, name').eq('contact_type', 'Cliente').ilike('name', `%${searchTerm}%`).limit(5);
                    
                    customerSearchResults.innerHTML = '';
                    if (data && data.length > 0) {
                        data.forEach(customer => {
                            const div = document.createElement('div');
                            div.textContent = customer.name;
                            div.addEventListener('click', () => {
                                selectedCustomer = customer;
                                customerSearchInput.value = customer.name;
                                customerSearchResults.classList.add('hidden');
                            });
                            customerSearchResults.appendChild(div);
                        });
                        customerSearchResults.classList.remove('hidden');
                    } else { customerSearchResults.classList.add('hidden'); }
                });
                
                productSearchInput.addEventListener('input', async (e) => {
                    const searchTerm = e.target.value;
                    if (searchTerm.length < 2) { productSearchResults.classList.add('hidden'); return; }
                    const { data, error } = await window.supabase.from('products').select('id, name, price, stock_quantity').or(`name.ilike.%${searchTerm}%,sku.ilike.%${searchTerm}%`).limit(5);

                    productSearchResults.innerHTML = '';
                    if (data && data.length > 0) {
                        data.forEach(product => {
                            const div = document.createElement('div');
                            div.textContent = `${product.name} - ${window.formatCurrency(product.price)}`;
                            div.addEventListener('click', () => {
                                addProductToSale(product);
                                productSearchInput.value = '';
                                productSearchResults.classList.add('hidden');
                            });
                            productSearchResults.appendChild(div);
                        });
                        productSearchResults.classList.remove('hidden');
                    } else { productSearchResults.classList.add('hidden'); }
                });

                const addProductToSale = (product) => {
                    if (product.stock_quantity <= 0) { return window.showMessage("Produto sem estoque.", "error"); }
                    const existingItem = saleItems.find(item => item.product_id === product.id);
                    if (existingItem) {
                        if (existingItem.quantity < product.stock_quantity) existingItem.quantity++;
                        else window.showMessage("Quantidade máxima em estoque atingida.", "info");
                    } else {
                        saleItems.push({ product_id: product.id, name: product.name, quantity: 1, unit_price: product.price, stock: product.stock_quantity });
                    }
                    renderSaleItems();
                };

                const renderSaleItems = () => {
                    saleItemsTable.innerHTML = saleItems.map((item, index) => `
                        <tr>
                            <td class="p-3">${item.name}</td>
                            <td class="p-3 text-center"><input type="number" value="${item.quantity}" min="1" max="${item.stock}" data-index="${index}" class="quantity-input w-16 text-center border rounded"></td>
                            <td class="p-3 text-right">${window.formatCurrency(item.unit_price)}</td>
                            <td class="p-3 text-right">${window.formatCurrency(item.quantity * item.unit_price)}</td>
                            <td class="p-3 text-center"><button class="remove-item-btn text-red-500 hover:text-red-700" data-index="${index}"><i data-lucide="trash-2" class="w-4 h-4"></i></button></td>
                        </tr>
                    `).join('').replace(/<td[^>]*><\/td>/g, '');
                    window.lucide.createIcons();
                    updateTotals();
                };
                
                const updateTotals = () => {
                    const subtotal = saleItems.reduce((acc, item) => acc + (item.quantity * item.unit_price), 0);
                    saleSubtotalEl.textContent = window.formatCurrency(subtotal);
                    const generalDiscount = parseFloat(saleDiscountEl.value) || 0;
                    const total = subtotal - generalDiscount;
                    saleTotalEl.textContent = window.formatCurrency(total);
                };

                saleItemsTable.addEventListener('input', (e) => {
                    if(e.target.classList.contains('quantity-input')) {
                        const index = e.target.dataset.index;
                        const newQuantity = parseInt(e.target.value);
                        if(newQuantity > saleItems[index].stock) {
                           e.target.value = saleItems[index].stock;
                           window.showMessage("Quantidade máxima em estoque atingida.", "info");
                        }
                        saleItems[index].quantity = parseInt(e.target.value);
                        renderSaleItems();
                    }
                });
                
                saleItemsTable.addEventListener('click', (e) => {
                    const removeBtn = e.target.closest('.remove-item-btn');
                    if(removeBtn) {
                        saleItems.splice(removeBtn.dataset.index, 1);
                        renderSaleItems();
                    }
                });

                saleDiscountEl.addEventListener('input', updateTotals);

                finishSaleBtn.addEventListener('click', async () => {
                    if (saleItems.length === 0) return window.showMessage("Adicione produtos à venda.", "info");
                    if (!selectedCustomer) return window.showMessage("Selecione um cliente.", "info");

                    const total = parseFloat(saleTotalEl.textContent.replace(/[^0-9,-]+/g,"").replace(",", "."));

                    const { data: saleData, error: saleError } = await window.supabase.from('sales').insert({ user_id: window.userId, contact_id: selectedCustomer.id, total_amount: total, status: 'Concluída' }).select().single();
                    if(saleError) return window.showMessage(`Erro ao criar venda: ${saleError.message}`, 'error');

                    const saleItemsToInsert = saleItems.map(item => ({ sale_id: saleData.id, product_id: item.product_id, quantity: item.quantity, unit_price: item.unit_price, subtotal: item.quantity * item.unit_price }));
                    const { error: itemsError } = await window.supabase.from('sale_items').insert(saleItemsToInsert);
                    if(itemsError) return window.showMessage(`Erro ao guardar itens da venda: ${itemsError.message}`, 'error');
                    
                    for(const item of saleItems) {
                        const { error } = await window.supabase.rpc('decrease_stock', { p_product_id: item.product_id, p_quantity: item.quantity });
                        if(error) console.error(`Failed to update stock for ${item.name}:`, error);
                    }

                    window.showMessage("Venda finalizada com sucesso!", "success");
                    saleItems = [];
                    selectedCustomer = null;
                    customerSearchInput.value = '';
                    renderSaleItems();
                });

                listSalesBtn.addEventListener('click', () => showPage(salesListHtml, 'nav-vendas', runSalesListScript));
            };
            const runSalesListScript = async () => {
                const tableBody = document.getElementById('sales-list-table-body');
                const backBtn = document.getElementById('back-to-pos-btn');
                
                const { data, error } = await window.supabase.from('sales').select(`id, created_at, total_amount, status, contacts ( name )`).eq('user_id', window.userId).order('created_at', { ascending: false });

                if(error) return window.showMessage("Erro ao carregar vendas.", "error");

                tableBody.innerHTML = data.map(sale => `
                    <tr>
                        <td class="p-3">${window.formatDate(sale.created_at)}</td>
                        <td class="p-3 font-medium">${sale.contacts.name}</td>
                        <td class="p-3 text-right font-semibold">${window.formatCurrency(sale.total_amount)}</td>
                        <td class="p-3">${sale.status}</td>
                        <td class="p-3 text-center">
                            <button class="p-1 text-gray-500 hover:text-blue-600"><i data-lucide="eye" class="w-4 h-4"></i></button>
                        </td>
                    </tr>
                `).join('');
                 window.lucide.createIcons();
                
                backBtn.addEventListener('click', () => showPage(salesHubHtml, 'nav-vendas', runSalesHubScript));
            };
            const runSalesHubScript = () => {
                document.getElementById('go-to-pos').addEventListener('click', () => showPage(vendasHtml, 'nav-vendas', runVendasScript));
                document.getElementById('go-to-proposals').addEventListener('click', () => window.showMessage('Módulo de Propostas em desenvolvimento.', 'info'));
            };
            const runProposalsListScript = () => { window.showMessage('Módulo de Propostas em desenvolvimento.', 'info'); };
            const runNewProposalScript = (proposalToEdit = null) => { window.showMessage('Módulo de Propostas em desenvolvimento.', 'info'); };
            const runFinanceiroScript = async () => {
                const tabs = document.querySelectorAll('.finance-tab-link');
                const contents = document.querySelectorAll('.finance-tab-content');
                const payableBody = document.getElementById('accounts-payable-body');
                
                tabs.forEach(tab => {
                    tab.addEventListener('click', (e) => {
                        e.preventDefault();
                        tabs.forEach(t => t.classList.remove('active'));
                        contents.forEach(c => c.classList.remove('active'));
                        tab.classList.add('active');
                        document.getElementById(tab.dataset.tab).classList.add('active');
                    });
                });
                
                const { data, error } = await window.supabase.from('financial_transactions').select(`*, contacts(name)`).eq('user_id', window.userId).eq('type', 'despesa');
                if(error) return window.showMessage("Erro ao carregar contas a pagar.", 'error');

                payableBody.innerHTML = data.map(t => `
                    <tr>
                        <td class="p-3">${t.description}</td>
                        <td class="p-3">${t.contacts?.name || 'N/A'}</td>
                        <td class="p-3">${window.formatDate(t.due_date)}</td>
                        <td class="p-3 text-right">${window.formatCurrency(t.amount)}</td>
                        <td class="p-3">${t.status}</td>
                        <td class="p-3 text-center"><button class="p-1 text-gray-500 hover:text-blue-600"><i data-lucide="edit" class="w-4 h-4"></i></button></td>
                    </tr>
                `).join('');
                window.lucide.createIcons();
            };
            const runEstoqueScript = async () => {
                const tableBody = document.getElementById('inventory-table-body');
                const adjustModal = document.getElementById('inventory-adjust-modal');
                const adjustForm = document.getElementById('inventory-adjust-form');
                const adjustCancelBtn = document.getElementById('inventory-adjust-cancel');
                const adjustCloseBtn = document.getElementById('inventory-adjust-close');

                const fetchInventory = async () => {
                    const { data, error } = await window.supabase.from('products').select('id, name, sku, stock_quantity').eq('user_id', window.userId).order('name');
                    if (error) return window.showMessage("Erro ao carregar inventário.", "error");
                    tableBody.innerHTML = data.map(p => `
                        <tr>
                            <td class="p-3 font-medium">${p.name}</td>
                            <td class="p-3">${p.sku || 'N/A'}</td>
                            <td class="p-3 text-center font-bold ${p.stock_quantity <= 5 ? 'text-red-500' : 'text-green-600'}">${p.stock_quantity || 0}</td>
                            <td class="p-3 text-center">
                                <button class="adjust-stock-btn bg-blue-100 text-blue-700 px-2 py-1 text-xs rounded hover:bg-blue-200" data-id="${p.id}" data-name="${p.name}" data-stock="${p.stock_quantity || 0}">Ajustar</button>
                            </td>
                        </tr>`).join('');
                };

                const openAdjustModal = (product) => {
                    adjustForm.reset();
                    adjustForm.querySelector('[name="product_id"]').value = product.id;
                    document.getElementById('adjust-product-name').textContent = product.name;
                    document.getElementById('adjust-current-stock').textContent = product.stock;
                    adjustModal.classList.remove('hidden');
                };
                
                const closeAdjustModal = () => adjustModal.classList.add('hidden');

                tableBody.addEventListener('click', e => {
                    const adjustBtn = e.target.closest('.adjust-stock-btn');
                    if (adjustBtn) openAdjustModal(adjustBtn.dataset);
                });

                adjustForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const formData = new FormData(adjustForm);
                    const productId = formData.get('product_id');
                    const newQuantity = parseInt(formData.get('new_quantity'));
                    const notes = formData.get('notes');
                    const currentStock = parseInt(document.getElementById('adjust-current-stock').textContent);
                    const change = newQuantity - currentStock;

                    const { error: updateError } = await window.supabase.from('products').update({ stock_quantity: newQuantity }).eq('id', productId);
                    if (updateError) return window.showMessage("Erro ao ajustar estoque.", "error");

                    await window.supabase.from('stock_history').insert({ product_id: productId, user_id: window.userId, quantity_change: change, reason: `Ajuste manual: ${notes}` });
                    
                    window.showMessage("Estoque ajustado com sucesso.", "success");
                    closeAdjustModal();
                    fetchInventory();
                });
                
                adjustCancelBtn.addEventListener('click', closeAdjustModal);
                adjustCloseBtn.addEventListener('click', closeAdjustModal);
                fetchInventory();
            };
            const runPurchasesHubScript = () => { window.showMessage('Módulo de Compras em desenvolvimento.', 'info'); };
            const runNewPurchaseScript = () => { window.showMessage('Módulo de Compras em desenvolvimento.', 'info'); };
            const runPurchasesListScript = () => { window.showMessage('Módulo de Compras em desenvolvimento.', 'info'); };
            const runRelatoriosScript = () => { window.showMessage('Módulo de Relatórios em desenvolvimento.', 'info'); };

            // --- NAVIGATION SETUP ---
            document.getElementById('nav-dashboard').addEventListener('click', (e) => { e.preventDefault(); showPage(dashboardHtml, 'nav-dashboard', runDashboardScript); });
            document.getElementById('nav-compras').addEventListener('click', (e) => { e.preventDefault(); showPage(purchasesHubHtml, 'nav-compras', runPurchasesHubScript); });
            document.getElementById('nav-vendas').addEventListener('click', (e) => { e.preventDefault(); showPage(salesHubHtml, 'nav-vendas', runSalesHubScript); });
            document.getElementById('nav-estoque').addEventListener('click', (e) => { e.preventDefault(); showPage(estoqueHtml, 'nav-estoque', runEstoqueScript); });
            document.getElementById('nav-financeiro').addEventListener('click', (e) => { e.preventDefault(); showPage(financeiroHtml, 'nav-financeiro', runFinanceiroScript); });
            document.getElementById('nav-relatorios').addEventListener('click', (e) => { e.preventDefault(); showPage(relatoriosHtml, 'nav-relatorios', runRelatoriosScript); });
            document.getElementById('link-produtos').addEventListener('click', (e) => { e.preventDefault(); showPage(productSystemHtml, 'nav-catalogo-dropdown', runProductSystemScript); });
            document.getElementById('link-clientes-fornecedores').addEventListener('click', (e) => { e.preventDefault(); showPage(clientesFornecedoresHtml, 'nav-catalogo-dropdown', runClientesFornecedoresScript); });

            // Initial page load
            showPage(dashboardHtml, 'nav-dashboard', runDashboardScript);
            window.lucide.createIcons();
        };

        // --- AUTHENTICATION AND MODAL SCRIPT ---
        document.addEventListener('DOMContentLoaded', async () => {
            const loginForm = document.getElementById('login-form');
            const signupLink = document.getElementById('signup-link');
            const registerModal = document.getElementById('register-modal');
            const registerForm = document.getElementById('register-form');
            const registerModalCloseBtn = document.getElementById('register-modal-close');
            const esqueciSenhaLink = document.getElementById('esqueci-senha-link');
            const esqueciSenhaModal = document.getElementById('esqueci-senha-modal');
            const esqueciSenhaForm = document.getElementById('esqueci-senha-form');
            const esqueciSenhaModalCloseBtn = document.getElementById('esqueci-senha-modal-close');

            const showRegisterModal = () => { if (registerModal) { registerForm.reset(); registerModal.classList.remove('hidden'); } };
            const hideRegisterModal = () => { if (registerModal) registerModal.classList.add('hidden'); };
            const showEsqueciSenhaModal = () => { if(esqueciSenhaModal) { esqueciSenhaForm.reset(); esqueciSenhaModal.classList.remove('hidden'); } };
            const hideEsqueciSenhaModal = () => { if(esqueciSenhaModal) esqueciSenhaModal.classList.add('hidden'); };

            esqueciSenhaLink.addEventListener('click', (e) => { e.preventDefault(); showEsqueciSenhaModal(); });
            esqueciSenhaModalCloseBtn.addEventListener('click', hideEsqueciSenhaModal);
            esqueciSenhaForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const email = esqueciSenhaForm.querySelector('#reset-email').value;
                if(!window.supabase) return window.showMessage("Erro: Supabase não inicializado.", "error");
                const { error } = await window.supabase.auth.resetPasswordForEmail(email, { redirectTo: window.location.href.split('?')[0] });
                if (error) { window.showMessage(`Erro: ${error.message}`, 'error'); }
                else { window.showMessage('Link de recuperação enviado! Verifique o seu email.', 'success'); hideEsqueciSenhaModal(); }
            });

            signupLink.addEventListener('click', (e) => { e.preventDefault(); showRegisterModal(); });
            registerModalCloseBtn.addEventListener('click', hideRegisterModal);

            loginForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const email = loginForm.querySelector('#email').value;
                const password = loginForm.querySelector('#password').value;
                const submitButton = loginForm.querySelector('button[type="submit"]');
                const errorMessageDiv = document.getElementById('login-error-message');

                if (!window.supabase) {
                    errorMessageDiv.textContent = "Erro: Supabase não inicializado.";
                    errorMessageDiv.classList.remove('hidden');
                    return;
                }
                
                submitButton.disabled = true;
                submitButton.innerHTML = `<svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg> A processar...`;
                errorMessageDiv.classList.add('hidden');
                
                const { data, error } = await window.supabase.auth.signInWithPassword({ email, password });

                submitButton.disabled = false;
                submitButton.innerHTML = 'Entrar';

                if (error) {
                    errorMessageDiv.textContent = `Erro de Login: ${error.message}`;
                    errorMessageDiv.classList.remove('hidden');
                } else {
                    window.showMessage("Login bem-sucedido! A redirecionar...", "success");
                }
            });

            registerForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const name = registerForm.querySelector('#register-name').value;
                const email = registerForm.querySelector('#register-email').value;
                const phone = registerForm.querySelector('#register-phone').value;
                const password = registerForm.querySelector('#register-password').value;

                if (!window.supabase) return window.showMessage("Erro: Supabase não inicializado.", "error");
                if (!name || !email || !password) return window.showMessage("Por favor, preencha todos os campos obrigatórios.", "error");

                const { data, error } = await window.supabase.auth.signUp({
                    email,
                    password,
                    options: { data: { full_name: name, phone_number: phone } }
                });

                if (error) {
                    window.showMessage(`Erro de Registo: ${error.message}.`, "error");
                } else if (data.user) {
                    window.showMessage("Registo bem-sucedido! Verifique o seu email para confirmar a conta.", "success");
                    hideRegisterModal();
                    loginForm.querySelector('#email').value = email;
                }
            });

            window.lucide.createIcons(); 
        });
    </script>
</body>
</html>

