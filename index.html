<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema Círculos</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #e5e7eb; }
        ::-webkit-scrollbar-thumb { background: #9ca3af; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #6b7280; }
        
        .page, .content-section { display: none; }
        .page.active { display: block; }
        #dashboard-page.active { display: flex; flex-direction: column; }
        .content-section.active { display: block; }
        .content-section.flex-active { display: flex; }

        .login-bg {
            background-image: linear-gradient(rgba(0, 0, 0, 0.6), rgba(0, 0, 0, 0.6)), url('https://i.imgur.com/9x4CHMr.png');
            background-size: cover;
            background-position: center;
        }

        .nav-link.active {
             border-bottom-color: #3b82f6; /* Azul */
             color: #3b82f6;
        }
        .dropdown:hover .dropdown-menu { display: block; }
        .dropdown-menu {
            display: none;
            animation: fadeIn 0.2s ease-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .tab-link.active {
            border-color: #22c55e; /* green-500 */
            color: #22c55e;
        }
        /* Important: Ensure these base styles are not overridden by other CSS rules */
        .tab-content { display: none; }
        .tab-content.active { display: block; }

        /* Modal specific styles */
        .modal {
            transition: opacity 0.3s ease-in-out, visibility 0.3s ease-in-out;
        }
        .modal.hidden {
            opacity: 0;
            visibility: hidden;
        }
        .modal:not(.hidden) {
            opacity: 1;
            visibility: visible;
        }
        .modal-content {
            transform: translateY(-20px);
            transition: transform 0.3s ease-in-out;
        }
        .modal:not(.hidden) .modal-content {
            transform: translateY(0);
        }
        /* Custom message box for alerts */
        #message-box {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1050; /* Ensure it's above modals */
            display: none;
            padding: 1rem;
            border-radius: 0.5rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .message-box-success {
            background-color: #d1fae5;
            color: #065f46;
        }
        .message-box-error {
            background-color: #fee2e2;
            color: #991b1b;
        }
        /* Custom styles for product listing to match the image */
        .product-listing-header {
            background-color: #1a1a1a; /* Dark background from image */
            color: #e0e0e0;
        }
        .product-search-input-dark {
            background-color: #333;
            border-color: #555;
            color: #e0e0e0;
        }
        .filter-chip {
            background-color: #444;
            color: #eee;
            border-radius: 0.375rem; /* rounded-md */
            padding: 0.25rem 0.625rem; /* px-2.5 py-1 */
            font-size: 0.875rem; /* text-sm */
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
        }
        .filter-chip-clear {
            background-color: transparent;
            color: #aaa;
        }
        .product-table-dark {
            background-color: #222;
            color: #ccc;
        }
        .product-table-dark th {
            background-color: #333;
            color: #e0e0e0;
        }
        .product-table-dark tr:nth-child(even) {
            background-color: #2a2a2a;
        }
        .product-table-dark tr:hover {
            background-color: #3a3a3a;
        }
        .product-table-dark td {
            border-bottom: 1px solid #444;
        }
        .product-table-dark tr.selected-row {
            background-color: #3b82f630; /* Light blue tint for selected rows */
        }

        /* Calendar Picker Specific Styles */
        .date-picker-modal-content {
            background-color: #1a1a1a;
            color: #e0e0e0;
            border-radius: 0.5rem;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.5);
        }
        .calendar-nav-btn {
            background-color: #333;
            color: #e0e0e0;
            padding: 0.25rem 0.5rem;
            border-radius: 0.25rem;
            transition: background-color 0.2s;
        }
        .calendar-nav-btn:hover {
            background-color: #555;
        }
        .calendar-day {
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 0.25rem;
            cursor: pointer;
            transition: background-color 0.2s, color 0.2s;
            font-size: 0.875rem; /* text-sm */
        }
        .calendar-day.current-month {
            color: #e0e0e0;
        }
        .calendar-day.other-month {
            color: #666;
        }
        .calendar-day.selected {
            background-color: #22c55e; /* green-500 */
            color: white;
            font-weight: 600;
        }
        .calendar-day.range-selected {
            background-color: #1a563a; /* darker green for range */
            color: white;
        }
        .calendar-day.today {
            border: 1px solid #22c55e;
        }
        .quick-select-btn {
            background-color: #333;
            color: #e0e0e0;
            padding: 0.5rem 0.75rem;
            border-radius: 0.375rem;
            text-align: left;
            width: 100%;
            transition: background-color 0.2s;
            font-size: 0.875rem;
        }
        .quick-select-btn:hover {
            background-color: #444;
        }
        .quick-select-btn.active-preset {
            background-color: #22c55e;
            color: white;
            font-weight: 600;
        }
    </style>
    <!-- Supabase SDKs - ALL IMPORTS CONSOLIDATED AND MADE GLOBALLY AVAILABLE HERE -->
    <script type="module">
        import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

        // Global variables for Supabase instances
        window.supabase = null;
        window.userId = null;
        window.dashboardInitialized = false;
        window.appId = 'default-app-id'; // Global appId, initialized with default

        // Utility function for showing messages - now global
        window.showMessage = function(message, type = 'success') {
            const messageBox = document.getElementById('message-box');
            const messageText = document.getElementById('message-text');
            if (type === 'hide') {
                messageBox.style.display = 'none';
                return;
            }
            messageText.textContent = message;
            messageBox.classList.remove('message-box-success', 'message-box-error');
            messageBox.classList.add(`message-box-${type}`);
            messageBox.style.display = 'block';
            setTimeout(() => {
                messageBox.style.display = 'none';
            }, 5000);
        };

        // Function to initialize Supabase and attempt authentication
        window.initSupabaseAndAuth = async () => {
            console.log("initSupabaseAndAuth: Starting Supabase initialization and authentication.");

            // ==============================================================================================
            // === ATENÇÃO EXTREMA: CONFIGURAÇÃO DO SUPABASE É OBRIGATÓRIA!                                ===
            // ===                                                                                          ===
            // === Por favor, SUBSTITUA OS PLACEHOLDERS ABAIXO com o SEU URL e CHAVE ANON REAIS do Supabase. ===
            // === Encontrará estas credenciais no seu painel Supabase em 'Settings' -> 'API'.               ===
            // ===                                                                                          ===
            // === O URL deve começar com 'https://' (ex: https://abcde12345.supabase.co).                 ===
            // === A Chave Anon é uma string longa que começa com 'eyJ...'.                                  ===
            // ===                                                                                          ===
            // === NÃO DEIXE ESTES VALORES COMO PLACEHOLDERS!                                              ===
            // ==============================================================================================
            let localSupabaseUrl = "https://bmgkulpexiqibbgwwxcx.supabase.co"; // <--- COLOQUE O SEU URL REAL DO SUPABASE AQUI! EX: "https://abcdefghijk.supabase.co"
            let localSupabaseAnonKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJtZ2t1bHBleGlxaWJiZ3d3eGN4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ0MDU0ODUsImV4cCI6MjA2OTk4MTQ4NX0.JClBYIz7CbnHkn04LWYEtVzoz66FMSfR1Mjg-LRUqjI"; // <--- COLOQUE A SUA CHAVE ANON REAL DO SUPABASE AQUI! EX: "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFiY2RlZmdoamlrIiwicm9sZSI6ImFub24iLCJpYXQiOjE2NzgwODk2MDAsImV4cCI6MTk5MzY2NTYwMH0.1234567890abcdefghijklmnopqrstuvwxyz"
            // ==============================================================================================


            // Determine Supabase credentials and appId
            let finalSupabaseUrl = localSupabaseUrl;
            let finalSupabaseAnonKey = localSupabaseAnonKey;

            // Check if Canvas global variables are provided and valid
            if (typeof __supabase_url !== 'undefined' && typeof __supabase_url === 'string' && __supabase_url.trim() !== '') {
                finalSupabaseUrl = __supabase_url;
            }
            if (typeof __supabase_anon_key !== 'undefined' && typeof __supabase_anon_key === 'string' && __supabase_anon_key.trim() !== '') {
                finalSupabaseAnonKey = __supabase_anon_key;
            }
            if (typeof __app_id !== 'undefined' && typeof __app_id === 'string' && __app_id.trim() !== '') {
                window.appId = __app_id;
            }
            
            // Check if user has replaced placeholders for local development
            const defaultSupabaseUrlPlaceholder = "https://your-project-id.supabase.co"; // This is the placeholder URL
            const defaultSupabaseAnonKeyPlaceholder = "YOUR_SUPABASE_ANON_KEY_HERE_FROM_SUPABASE_DASHBOARD"; // This is the placeholder key

            if (finalSupabaseUrl === defaultSupabaseUrlPlaceholder || finalSupabaseAnonKey === defaultSupabaseAnonKeyPlaceholder) {
                console.error("initSupabaseAndAuth: ERRO CRÍTICO: Supabase URL ou Chave Anon não configurados.");
                window.showMessage("Erro: Credenciais do Supabase ausentes. Por favor, edite o código para inserir o seu URL e Chave Anon reais do Supabase.", "error");
                const loginErrorMessageDiv = document.getElementById('login-error-message');
                if (loginErrorMessageDiv) {
                    loginErrorMessageDiv.textContent = "ERRO: Credenciais do Supabase não configuradas.";
                    loginErrorMessageDiv.classList.remove('hidden');
                }
                return;
            }

            // Create Supabase client
            window.supabase = createClient(finalSupabaseUrl, finalSupabaseAnonKey);
            console.log("initSupabaseAndAuth: Supabase client created.");

            if (!window.supabase) {
                console.error("initSupabaseAndAuth: Supabase client failed to initialize.");
                window.showMessage("Erro: Falha ao inicializar o Supabase.", "error");
                return;
            }

            // Listen for auth changes - This is the single source of truth for auth UI
            window.supabase.auth.onAuthStateChange((event, session) => {
                console.log('Supabase auth state changed:', { event, session });

                const loginPage = document.getElementById('login-page');
                const dashboardPage = document.getElementById('dashboard-page');
                const userIdDisplay = document.getElementById('user-id-display');

                if (session) {
                    // User is logged in
                    window.userId = session.user.id;
                    if (userIdDisplay) {
                        userIdDisplay.textContent = `ID do Utilizador: ${window.userId}`;
                    }
                    
                    // Show dashboard and hide login
                    loginPage.classList.remove('active');
                    dashboardPage.classList.add('active');

                    // Initialize dashboard only once
                    if (!window.dashboardInitialized) {
                        console.log(`Initializing dashboard due to auth event: ${event}`);
                        window.initializeDashboard();
                        window.dashboardInitialized = true;
                    }
                } else {
                    // User is logged out
                    window.userId = null;
                    if (userIdDisplay) {
                        userIdDisplay.textContent = `ID do Utilizador: Não autenticado`;
                    }

                    // Show login and hide dashboard
                    loginPage.classList.add('active');
                    dashboardPage.classList.remove('active');
                    window.dashboardInitialized = false; // Reset dashboard state for next login
                }
            });
        };

        // Call the initialization function once the DOM is fully loaded
        document.addEventListener('DOMContentLoaded', window.initSupabaseAndAuth);
    </script>
</head>
<body>

    <!-- Message Box for alerts -->
    <div id="message-box" class="message-box-success">
        <span id="message-text"></span>
        <button class="float-right ml-4 text-sm font-semibold" onclick="window.showMessage('', 'hide')">&times;</button>
    </div>

    <!-- PÁGINA DE LOGIN -->
    <div id="login-page" class="page active">
        <div class="min-h-screen flex flex-col items-center justify-center px-4 login-bg">
            <div class="w-full max-w-md">
                <div class="text-center mb-8">
                    <img src="https://i.imgur.com/gM6495x.png" alt="Logo Círculos" class="mx-auto h-28 w-auto">
                    <p class="text-gray-200 mt-4 text-lg">Aceda à sua conta para gerir o seu negócio.</p>
                </div>
                <div class="bg-white rounded-xl shadow-lg p-8">
                    <div id="login-error-message" class="hidden text-red-500 text-center mb-4 font-bold"></div>
                    <form id="login-form">
                        <div class="space-y-6">
                            <div>
                                <label for="email" class="block text-sm font-medium text-gray-700">Email</label>
                                <div class="mt-1 relative">
                                    <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none"><i data-lucide="mail" class="w-5 h-5 text-gray-400"></i></div>
                                    <input type="email" id="email" name="email" required class="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-400" placeholder="voce@email.com">
                                </div>
                            </div>
                            <div>
                                <div class="flex justify-between items-center">
                                    <label for="password" class="block text-sm font-medium text-gray-700">Senha</label>
                                    <a href="#" class="text-sm text-blue-500 hover:underline">Esqueceu a senha?</a>
                                </div>
                                <div class="mt-1 relative">
                                    <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none"><i data-lucide="lock" class="w-5 h-5 text-gray-400"></i></div>
                                    <input type="password" id="password" name="password" required class="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-400" placeholder="Sua senha">
                                </div>
                            </div>
                            <div>
                                <button type="submit" class="w-full bg-blue-500 text-white font-semibold py-2.5 px-4 rounded-md hover:bg-blue-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition-colors">Entrar</button>
                            </div>
                        </div>
                    </form>
                    <div class="mt-6 text-center">
                        <a href="#" id="signup-link" class="font-medium text-blue-500 hover:text-blue-600">Crie a sua conta gratuitamente</a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- PAINEL PRINCIPAL DO SISTEMA -->
    <div id="dashboard-page" class="page h-screen">
        <header class="bg-white text-gray-800 shadow-md z-20 border-b">
            <div class="w-full px-6 flex justify-between items-center">
                <div class="h-16 flex items-center">
                    <img src="https://i.imgur.com/0ooTC9z.png" alt="Logo Círculos" class="h-10 w-auto">
                    <span id="user-id-display" class="ml-4 text-xs text-gray-500">ID do Utilizador: A carregar...</span>
                </div>
                <div class="flex items-center gap-6">
                    <nav class="flex items-center h-full text-sm font-medium text-gray-600">
                        <a href="#" id="nav-dashboard" class="nav-link h-16 flex items-center px-4 hover:bg-gray-100 transition-colors border-b-2 border-transparent">Dashboard</a>
                        <div class="dropdown relative h-16 flex items-center">
                            <button id="nav-catalogo" class="nav-link h-full flex items-center px-4 hover:bg-gray-100 transition-colors gap-2 border-b-2 border-transparent">
                                <span>Registos</span><i data-lucide="chevron-down" class="w-4 h-4"></i>
                            </button>
                            <div class="dropdown-menu absolute left-0 mt-16 w-56 bg-white rounded-b-md shadow-lg py-1 z-30 text-gray-800 border-t">
                                <a href="#" id="link-produtos" class="block px-4 py-2 text-sm hover:bg-gray-100">Produtos</a>
                                <a href="#" id="link-clientes-fornecedores" class="block px-4 py-2 text-sm hover:bg-gray-100">Clientes e Fornecedores</a>
                            </div>
                        </div>
                        <a href="#" id="nav-vendas" class="nav-link h-16 flex items-center px-4 hover:bg-gray-100 transition-colors border-b-2 border-transparent">Vendas</a>
                        <a href="#" id="nav-estoque" class="nav-link h-16 flex items-center px-4 hover:bg-gray-100 transition-colors border-b-2 border-transparent">Inventário</a>
                        <a href="#" id="nav-financeiro" class="nav-link h-16 flex items-center px-4 hover:bg-gray-100 transition-colors border-b-2 border-transparent">Financeiro</a>
                    </nav>
                    <div class="h-16 flex items-center border-l pl-6">
                         <button id="logout-btn" class="flex items-center gap-2 text-sm font-medium text-gray-500 hover:text-red-500 transition-colors duration-200 p-2 rounded-md hover:bg-red-50">
                            <i data-lucide="log-out" class="w-4 h-4"></i>
                            <span>Sair</span>
                        </button>
                    </div>
                </div>
            </div>
        </header>
        <main id="page-content" class="flex-1 overflow-y-auto bg-gray-50 p-6"></main> <!-- Added p-6 for spacing -->
        <div id="modal-container"></div>
    </div>

    <!-- MODAIS GLOBAIS (SEMPRE PRESENTES NO DOM, APENAS ESCONDIDOS) -->
    <div id="register-modal" class="modal hidden fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-60">
        <div class="modal-content bg-white rounded-lg shadow-xl w-full max-w-md p-6">
            <div class="flex justify-between items-center border-b pb-3 mb-4">
                <h3 class="text-xl font-semibold text-gray-800">Crie a sua conta</h3>
                <button id="register-modal-close" class="text-gray-400 hover:text-gray-600 p-1.5 rounded-md"><i data-lucide="x" class="w-5 h-5"></i></button>
            </div>
            <form id="register-form" class="space-y-4">
                <div>
                    <label for="register-name" class="block text-sm font-medium text-gray-700">Nome Completo</label>
                    <input type="text" id="register-name" name="name" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 focus:outline-none focus:ring-2 focus:ring-blue-400" placeholder="O seu nome">
                </div>
                <div>
                    <label for="register-email" class="block text-sm font-medium text-gray-700">Email</label>
                    <input type="email" id="register-email" name="email" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 focus:outline-none focus:ring-2 focus:ring-blue-400" placeholder="o-seu@email.com">
                </div>
                <div>
                    <label for="register-phone" class="block text-sm font-medium text-gray-700">Telefone</label>
                    <input type="tel" id="register-phone" name="phone" class="mt-1 block w-full border border-gray-300 rounded-md p-2 shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-400" placeholder="(XX) XXXXX-XXXX">
                </div>
                <div>
                    <label for="register-password" class="block text-sm font-medium text-gray-700">Senha</label>
                    <input type="password" id="register-password" name="password" required class="mt-1 block w-full border border-gray-300 rounded-md p-2 shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-400" placeholder="Crie uma senha segura">
                </div>
                <div>
                    <button type="submit" class="w-full bg-green-500 text-white font-semibold py-2.5 px-4 rounded-md hover:bg-green-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 transition-colors">Registar</button>
                </div>
            </form>
        </div>
    </div>
    
    <div id="product-modal" class="modal hidden fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-60"><div class="modal-content bg-white text-gray-800 rounded-lg shadow-xl w-full max-w-5xl max-h-[95vh] flex flex-col"><div class="p-4 flex justify-between items-center border-b border-gray-200 relative"><h3 class="text-xl font-semibold">Detalhes do Produto</h3><div class="flex gap-4 items-center"><button id="product-modal-cancel" class="border border-gray-300 bg-gray-100 hover:bg-gray-200 text-gray-700 font-semibold py-1.5 px-3 rounded-md transition-colors duration-200">Cancelar</button><button type="submit" form="product-form" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-1.5 px-3 rounded-md transition-colors duration-200">Guardar produto</button><button id="product-modal-header-close" class="text-gray-500 hover:text-gray-700 transition-colors duration-200 ml-4 p-1.5 rounded-md"><i data-lucide="x" class="w-5 h-5"></i></button></div></div><form id="product-form" class="flex-1 overflow-y-auto p-6 space-y-6"><div class="grid grid-cols-12 gap-6 items-start"><div class="col-span-3 flex flex-col items-center justify-center bg-gray-50 rounded-lg border-2 border-dashed border-gray-200 p-4 h-48 relative overflow-hidden"><img id="product-image-preview" src="https://placehold.co/160x160/cbd5e1/475569?text=Sem%20Imagem" alt="Pré-visualização da Imagem" class="max-w-full max-h-full object-contain rounded-md mb-2"><input type="file" id="product-image-input" accept="image/*" class="absolute inset-0 opacity-0 cursor-pointer"><label for="product-image-input" class="absolute inset-0 flex items-center justify-center text-gray-500 hover:text-blue-500 cursor-pointer"><i data-lucide="camera" class="w-8 h-8"></i></label></div><div class="col-span-9 grid grid-cols-3 gap-4"><div><label class="block text-sm font-medium text-gray-700">Nome*</label><input type="text" name="product-name" required class="w-full bg-white border border-gray-300 rounded-md p-2 shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-400"></div><div><label class="block text-sm font-medium text-gray-700">Código (SKU)</label><div class="flex gap-2 mt-1"><input type="text" name="product-sku" class="w-full bg-white border border-gray-300 rounded-md p-2 shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-400"><button type="button" id="generate-barcode-btn" class="bg-blue-500 hover:bg-blue-600 text-white font-semibold py-1.5 px-3 rounded-md text-sm flex-shrink-0 transition-colors duration-200">Gerar Interno</button></div></div><div><label class="block text-sm font-medium text-gray-700">Preço Venda</label><input type="number" step="0.01" name="product-price" class="w-full bg-white border border-gray-300 rounded-md p-2 shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-400"></div><div><label class="block text-sm font-medium text-gray-700">Formato</label><select name="product-format" class="w-full bg-white border border-gray-300 rounded-md p-2 shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-400"><option>Simples</option><option>Variável</option></select></div><div><label class="block text-sm font-medium text-gray-700">Tipo</label><select name="product-type" class="w-full bg-white border border-gray-300 rounded-md p-2 shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-400"><option>Produto</option><option>Serviço</option></select></div><div><label class="block text-sm font-medium text-gray-700">Condição</label><select name="product-condition" class="w-full bg-white border border-gray-300 rounded-md p-2 shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-400"><option>Novo</option><option>Usado</option><option>Recondicionado</option></select></div></div></div><div class="border-b border-gray-200 mt-6"><nav class="-mb-px flex space-x-6" id="modal-tabs"><a href="#" class="tab-link active whitespace-nowrap py-3 px-1 border-b-2 font-medium text-sm border-green-500 text-green-500" data-tab="caracteristicas">Características</a><a href="#" class="tab-link whitespace-nowrap py-3 px-1 border-b-2 font-medium text-sm border-transparent text-gray-500 hover:border-gray-300 hover:text-gray-700" data-tab="imagens">Imagens</a><a href="#" class="tab-link whitespace-nowrap py-3 px-1 border-b-2 font-medium text-sm border-transparent text-gray-500 hover:border-gray-300 hover:text-gray-700" data-tab="fornecedores">Fornecedores</a><a href="#" class="tab-link whitespace-nowrap py-3 px-1 border-b-2 font-medium text-sm border-transparent text-gray-500 hover:border-gray-300 hover:text-gray-700" data-tab="tributacao">Tributação</a></nav></div><div id="tab-content-container" class="pt-6"><div id="caracteristicas" class="tab-content active grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-x-6 gap-y-4"><!-- Existing characteristic fields --><div class="space-y-1"><label class="block text-sm font-medium text-gray-700">Marca</label><input type="text" name="product-brand" class="w-full bg-white border border-gray-300 rounded-md p-2 shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-400"></div><div class="space-y-1"><label class="block text-sm font-medium text-gray-700">Produção</label><select name="product-production" class="w-full bg-white border border-gray-300 rounded-md p-2 shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-400"><option>Própria</option><option>Terceirizada</option></select></div><div class="space-y-1"><label class="block text-sm font-medium text-gray-700">Data de Validade</label><input type="date" name="product-expiration-date" class="w-full bg-white border border-gray-300 rounded-md p-2 shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-400"></div><div class="space-y-1"><label class="block text-sm font-medium text-gray-700">Frete Grátis</label><select name="product-free-shipping" class="w-full bg-white border border-gray-300 rounded-md p-2 shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-400"><option>Não</option><option>Sim</option></select></div><div class="space-y-1"><label class="block text-sm font-medium text-gray-700">Peso Líquido (kg)</label><input type="number" step="0.01" name="product-liquid-weight" class="w-full bg-white border border-gray-300 rounded-md p-2 shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-400"></div><div class="space-y-1"><label class="block text-sm font-medium text-gray-700">Peso Bruto (kg)</label><input type="number" step="0.01" name="product-gross-weight" class="w-full bg-white border border-gray-300 rounded-md p-2 shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-400"></div><div class="space-y-1"><label class="block text-sm font-medium text-gray-700">Largura (cm)</label><input type="number" step="0.01" name="product-width" class="w-full bg-white border border-gray-300 rounded-md p-2 shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-400"></div><div class="space-y-1"><label class="block text-sm font-medium text-gray-700">Altura (cm)</label><input type="number" step="0.01" name="product-height" class="w-full bg-white border border-gray-300 rounded-md p-2 shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-400"></div><div class="space-y-1"><label class="block text-sm font-medium text-gray-700">Profundidade (cm)</label><input type="number" step="0.01" name="product-depth" class="w-full bg-white border border-gray-300 rounded-md p-2 shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-400"></div><div class="space-y-1"><label class="block text-sm font-medium text-gray-700">Volumes</label><input type="number" name="product-volumes" class="w-full bg-white border border-gray-300 rounded-md p-2 shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-400"></div><div class="space-y-1"><label class="block text-sm font-medium text-gray-700">Itens p/ caixa</label><input type="number" name="product-items-per-box" class="w-full bg-white border border-gray-300 rounded-md p-2 shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-400"></div><div class="space-y-1"><label class="block text-sm font-medium text-gray-700">Unidade de medida</label><select name="product-measurement-unit" class="w-full bg-white border border-gray-300 rounded-md p-2 shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-400"><option>Centímetros</option><option>Metros</option><option>Polegadas</option></select></div><div class="space-y-1"><label class="block text-sm font-medium text-gray-700">GTIN/EAN</label><div class="flex gap-2 mt-1"><input type="text" name="product-gtinean" class="w-full bg-white border border-gray-300 rounded-md p-2 shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-400" placeholder="SEM GTIN"><button type="button" id="generate-gtinean-btn" class="bg-blue-500 hover:bg-blue-600 text-white font-semibold py-1.5 px-3 rounded-md text-sm flex-shrink-0 transition-colors duration-200">Gerar Interno</button></div></div><div class="space-y-1"><label class="block text-sm font-medium text-gray-700">GTIN/EAN Tributário</label><input type="text" name="product-gtinean-tax" class="w-full bg-white border border-gray-300 rounded-md p-2 shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-400" placeholder="SEM GTIN"></div></div><div id="imagens" class="tab-content flex flex-col items-center p-4 gap-4"><p class="text-gray-600">Arraste e solte imagens ou clique no ícone para carregar.</p><div class="w-full flex items-center gap-2 mb-4"><input type="url" id="image-url-input" class="flex-1 bg-white border border-gray-300 rounded-md p-2 shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-400" placeholder="Cole o link direto da imagem aqui (terminando em .jpg, .png, etc.)"><button type="button" id="add-image-url-btn" class="bg-blue-500 hover:bg-blue-600 text-white font-semibold py-1.5 px-3 rounded-md text-sm flex-shrink-0 transition-colors duration-200">Adicionar por Link</button></div><div id="image-drop-area" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4 w-full p-4 border-2 border-dashed border-gray-300 rounded-md bg-gray-50 min-h-[150px] items-center justify-center"></div></div><div id="fornecedores" class="tab-content space-y-4"><h4 class="text-lg font-semibold text-gray-800 mb-4">Gerir Fornecedores do Produto</h4><div class="grid grid-cols-1 md:grid-cols-2 gap-4"><div><label class="block text-sm font-medium text-gray-700">Nome do Fornecedor</label><input type="text" name="supplier-name" class="w-full bg-white border border-gray-300 rounded-md p-2 shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-400" placeholder="Nome do fornecedor"></div><div><label class="block text-sm font-medium text-gray-700">Código do Fornecedor</label><input type="text" name="supplier-code" class="w-full bg-white border border-gray-300 rounded-md p-2 shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-400" placeholder="Código de referência do fornecedor"></div><div class="md:col-span-2"><label class="block text-sm font-medium text-gray-700">Preço de Custo</label><input type="number" step="0.01" name="supplier-cost-price" class="w-full bg-white border border-gray-300 rounded-md p-2 shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-400" placeholder="0.00"></div></div><button type="button" class="mt-4 bg-blue-500 hover:bg-blue-600 text-white font-semibold py-1.5 px-3 rounded-md flex items-center gap-2 transition-colors duration-200"><i data-lucide="plus" class="w-5 h-5"></i> Adicionar Fornecedor</button></div><div id="tributacao" class="tab-content space-y-4"><h4 class="text-lg font-semibold text-gray-800 mb-4">Configurações de Tributação</h4><div class="grid grid-cols-1 md:grid-cols-2 gap-4"><div><label class="block text-sm font-medium text-gray-700">NCM (Nomenclatura Comum do Mercosul)</label><input type="text" name="tax-ncm" class="w-full bg-white border border-gray-300 rounded-md p-2 shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-400" placeholder="Ex: 8471.30.12"></div><div><label class="block text-sm font-medium text-gray-700">CEST (Código Especificador da Substituição Tributária)</label><input type="text" name="tax-cest" class="w-full bg-white border border-gray-300 rounded-md p-2 shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-400" placeholder="Ex: 28.064.00"></div><div><label class="block text-sm font-medium text-gray-700">Origem da Mercadoria</label><select name="tax-origin" class="w-full bg-white border border-gray-300 rounded-md p-2 shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-400"><option value="0">0 - Nacional, exceto as indicadas nos códigos 3, 4, 5 e 8</option><option value="1">1 - Estrangeira - Importação direta</option><option value="2">2 - Estrangeira - Adquirida no mercado interno</option></select></div><div><label class="block text-sm font-medium text-gray-700">Tipo de Tributação</label><select name="tax-type" class="w-full bg-white border border-gray-300 rounded-md p-2 shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-400"><option>Normal</option><option>Simples Nacional</option></select></div></div></div></div></form></div></div>
    <div id="import-modal" class="modal hidden fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-60"><div class="modal-content bg-white rounded-lg shadow-xl w-full max-w-2xl p-6"><div class="flex justify-between items-center border-b pb-3 mb-4"><h3 class="text-xl font-semibold text-gray-800">Importar Produtos em Massa</h3><button id="import-modal-close" class="text-gray-400 hover:text-gray-600 p-1.5 rounded-md"><i data-lucide="x" class="w-5 h-5"></i></button></div><div class="space-y-6 mt-4"><div><h4 class="font-semibold text-gray-700">Passo 1: Baixe o nosso modelo</h4><p class="text-sm text-gray-600 mt-1">Para garantir que os seus dados são importados corretamente, use o nosso ficheiro modelo. Preencha-o com os seus produtos antes de carregar.</p><button id="download-template-btn" class="mt-3 bg-gray-100 hover:bg-gray-200 text-gray-800 font-semibold py-2 px-4 rounded-md flex items-center gap-2 transition-colors duration-200 border border-gray-300"><i data-lucide="download-cloud" class="w-4 h-4"></i> Baixar Modelo (CSV)</button></div><div class="border-t border-gray-200"></div><div><h4 class="font-semibold text-gray-700">Passo 2: Carregue o seu ficheiro preenchido</h4><p class="text-sm text-gray-600 mt-1">Formatos suportados: CSV, XLS, XLSX.</p><div id="import-drop-area" class="mt-3 flex justify-center items-center w-full h-32 px-6 border-2 border-gray-300 border-dashed rounded-md cursor-pointer hover:border-blue-500 bg-gray-50"><div class="text-center"><i data-lucide="upload-cloud" class="mx-auto h-10 w-10 text-gray-400"></i><p id="import-file-text" class="mt-2 text-sm text-gray-600"><span class="font-semibold">Clique para carregar</span> ou arraste e solte</p><input id="import-file-input" type="file" class="hidden" accept=".csv, application/vnd.openxmlformats-officedocument.spreadsheetml.sheet, application/vnd.ms-excel"></div></div><p id="import-file-name" class="text-sm text-gray-500 mt-2"></p></div></div><div class="flex justify-end items-center border-t pt-4 mt-6 gap-4"><button id="import-modal-cancel" class="border border-gray-300 bg-white hover:bg-gray-100 text-gray-700 font-semibold py-1.5 px-3 rounded-md transition-colors duration-200">Cancelar</button><button id="process-import-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-1.5 px-3 rounded-md transition-colors duration-200 disabled:bg-gray-400" disabled>Importar Produtos</button></div></div></div>
    <div id="date-picker-modal" class="modal hidden fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-60">
        <div class="date-picker-modal-content w-full max-w-4xl p-6 flex gap-6">
            <div class="flex-1 flex flex-col space-y-4">
                <div class="flex items-center justify-between">
                    <button id="prev-month-left" class="calendar-nav-btn"><i data-lucide="chevron-left" class="w-4 h-4"></i></button>
                    <h4 id="month-display-left" class="text-md font-semibold text-gray-300"></h4>
                    <button id="next-month-left" class="calendar-nav-btn"><i data-lucide="chevron-right" class="w-4 h-4"></i></button>
                </div>
                <div class="grid grid-cols-7 text-center text-xs text-gray-400 font-medium">
                    <span>Dom</span><span>Seg</span><span>Ter</span><span>Qua</span><span>Qui</span><span>Sex</span><span>Sáb</span>
                </div>
                <div id="calendar-grid-left" class="grid grid-cols-7 gap-1">
                    <!-- Days will be generated here -->
                </div>
            </div>
            <div class="flex-1 flex flex-col space-y-4">
                <div class="flex items-center justify-between">
                    <button id="prev-month-right" class="calendar-nav-btn"><i data-lucide="chevron-left" class="w-4 h-4"></i></button>
                    <h4 id="month-display-right" class="text-md font-semibold text-gray-300"></h4>
                    <button id="next-month-right" class="calendar-nav-btn"><i data-lucide="chevron-right" class="w-4 h-4"></i></button>
                </div>
                <div class="grid grid-cols-7 text-center text-xs text-gray-400 font-medium">
                    <span>Dom</span><span>Seg</span><span>Ter</span><span>Qua</span><span>Qui</span><span>Sex</span><span>Sáb</span>
                </div>
                <div id="calendar-grid-right" class="grid grid-cols-7 gap-1">
                    <!-- Days will be generated here -->
                </div>
            </div>
            <div class="w-1/4 flex flex-col space-y-2 ml-6">
                <h5 class="text-sm font-semibold mb-2">Períodos Rápidos</h5>
                <button class="quick-select-btn" data-preset="today">Hoje</button>
                <button class="quick-select-btn" data-preset="this_week">Esta semana</button>
                <button class="quick-select-btn" data-preset="last_week">Semana passada</button>
                <button class="quick-select-btn" data-preset="this_month">Este mês</button>
                <button class="quick-select-btn" data-preset="last_month">Mês passado</button>
                <button class="quick-select-btn mt-4 active-preset" data-preset="custom">Período customizado</button>
                <div class="flex-grow"></div>
                <div class="flex gap-2 mt-4">
                    <button id="date-picker-cancel-btn" class="flex-1 bg-gray-600 hover:bg-gray-700 text-white font-semibold py-1.5 px-3 rounded-md text-sm transition-colors duration-200">Cancelar</button>
                    <button id="date-picker-filter-btn" class="flex-1 bg-green-500 hover:bg-green-600 text-white font-semibold py-1.5 px-3 rounded-md text-sm transition-colors duration-200">Filtrar</button>
                </div>
            </div>
            <button id="date-picker-close-btn" class="absolute top-3 right-3 text-gray-400 hover:text-gray-200 p-1.5 rounded-md"><i data-lucide="x" class="w-4 h-4"></i></button>
        </div>
    </div>


    <script type="module">
        // This function will be called after Supabase init and auth attempt
        window.initializeDashboard = () => {
            console.log('initializeDashboard started.');
            const pageContent = document.getElementById('page-content');
            const navLinks = document.querySelectorAll('.nav-link');
            const logoutBtn = document.getElementById('logout-btn');

            if (logoutBtn) {
                logoutBtn.addEventListener('click', async (e) => {
                    e.preventDefault();
                    console.log('Logout button clicked.');
                    window.showMessage('A terminar a sessão...', 'info');
                    const { error } = await window.supabase.auth.signOut();
                    if (error) {
                        console.error('Error signing out:', error);
                        window.showMessage(`Erro ao terminar a sessão: ${error.message}`, 'error');
                    } else {
                        window.showMessage('Sessão terminada com sucesso.', 'success');
                        // The onAuthStateChange listener will handle the UI redirection automatically.
                    }
                });
            }


            // Initial dummy data for clients and suppliers (will be replaced by Supabase later)
            let clientsAndSuppliers = [
                { id: 1, tipo: 'Cliente', pessoa: 'Física', nome: 'João da Silva', cpf: '123.456.789-00', email: 'joao.silva@email.com', telefone: '(11) 98765-4321' },
            ];

            const setActiveLink = (id) => {
                navLinks.forEach(link => {
                    link.classList.remove('active', 'text-blue-500', 'border-blue-500');
                    link.classList.add('border-transparent');
                });
                const activeLink = document.getElementById(id);
                if (activeLink) {
                    activeLink.classList.add('active', 'text-blue-500', 'border-blue-500');
                    activeLink.classList.remove('border-transparent');
                }
            };

            const showPage = (pageHtml, navId, scriptRunner) => {
                console.log(`showPage called for navId: ${navId}`);
                pageContent.innerHTML = pageHtml;
                setActiveLink(navId);
                window.lucide.createIcons();
                if(scriptRunner) scriptRunner();
            };
            
            // Function to run the Product System specific script
            const runProductSystemScript = () => {
                console.log('runProductSystemScript started.');
                try { 
                    const tableBody = document.getElementById('product-table-body');
                    const addProductBtn = document.getElementById('add-product-btn');
                    const productModal = document.getElementById('product-modal');
                    const productForm = document.getElementById('product-form');
                    const modalCloseButton = productModal.querySelector('#product-modal-header-close'); 
                    const cancelBtn = document.getElementById('product-modal-cancel');
                    const generateBarcodeBtn = document.getElementById('generate-barcode-btn');
                    const generateGtinEanBtn = document.getElementById('generate-gtinean-btn'); 
                    const productImageInput = document.getElementById('product-image-input');
                    const productImagePreview = document.getElementById('product-image-preview');
                    const imageDropArea = productModal.querySelector('#image-drop-area'); 
                    const addImageUrlInput = productModal.querySelector('#image-url-input');
                    const addImageUrlBtn = document.getElementById('add-image-url-btn');
                    const filterSituacao = document.getElementById('filter-situacao');
                    const filterTags = document.getElementById('filter-tags');
                    const filterCategoria = document.getElementById('filter-categoria');
                    const filterNCM = document.getElementById('filter-ncm');
                    const filterTipo = document.getElementById('filter-tipo');
                    const filterMarca = document.getElementById('filter-marca');
                    const clearFiltersBtn = document.getElementById('clear-filters-btn');
                    const filterChipsContainer = document.getElementById('filter-chips-container');
                    const dateRangeDisplay = document.getElementById('date-range-display');
                    const datePickerModal = document.getElementById('date-picker-modal');
                    const datePickerCloseBtn = document.getElementById('date-picker-close-btn');
                    const datePickerCancelBtn = document.getElementById('date-picker-cancel-btn');
                    const datePickerFilterBtn = document.getElementById('date-picker-filter-btn');
                    const searchDateStartInput = document.getElementById('search-date-start');
                    const searchDateEndInput = document.getElementById('search-date-end');
                    const monthDisplayLeft = document.getElementById('month-display-left');
                    const calendarGridLeft = document.getElementById('calendar-grid-left');
                    const monthDisplayRight = document.getElementById('month-display-right');
                    const calendarGridRight = document.getElementById('calendar-grid-right');
                    const prevMonthBtnLeft = document.getElementById('prev-month-left');
                    const nextMonthBtnLeft = document.getElementById('next-month-left');
                    const prevMonthBtnRight = document.getElementById('prev-month-right');
                    const nextMonthBtnRight = document.getElementById('next-month-right');
                    const importProductsBtn = document.getElementById('import-products-btn');
                    const exportProductsBtn = document.getElementById('export-products-btn');
                    const productSearchInput = document.getElementById('product-search-input');
                    const toggleFilterSidebarBtn = document.getElementById('toggle-filter-sidebar-btn');
                    const lockBtn = document.getElementById('lock-product-btn');
                    const printerBtn = document.getElementById('printer-product-btn');
                    const trashBtn = document.getElementById('trash-product-btn');
                    const refreshBtn = document.getElementById('refresh-product-btn');
                    const viewOptionsBtn = document.getElementById('view-options-product-btn');
                    const selectAllCheckbox = document.getElementById('select-all-products');

                    const MAX_IMAGES = 4;
                    let productImages = [];

                    tableBody.innerHTML = '<tr><td colspan="8" class="p-3 text-center text-gray-400">A carregar produtos...</td></tr>';

                    const months = ["Janeiro", "Fevereiro", "Março", "Abril", "Maio", "Junho", "Julho", "Agosto", "Setembro", "Outubro", "Novembro", "Dezembro"];
                    let currentMonthLeft = new Date();
                    let selectedStartDate = null;
                    let selectedEndDate = null;

                    const formatDate = (date) => {
                        if (!date) return '';
                        const d = new Date(date);
                        return d.toLocaleDateString('pt-BR', { day: '2-digit', month: '2-digit', year: 'numeric' });
                    };

                    const updateDateRangeDisplay = () => {
                        const start = searchDateStartInput.value;
                        const end = searchDateEndInput.value;
                        if(dateRangeDisplay) {
                            if (start && end) {
                                dateRangeDisplay.textContent = `${formatDate(start)} - ${formatDate(end)}`;
                            } else if (start) {
                                dateRangeDisplay.textContent = `${formatDate(start)} - Fim`;
                            } else if (end) {
                                dateRangeDisplay.textContent = `Início - ${formatDate(end)}`;
                            } else {
                                dateRangeDisplay.textContent = 'Data do Pedido';
                            }
                        }
                    };

                    const renderCalendar = (monthDate, calendarGrid, monthDisplay) => {
                        if (!calendarGrid || !monthDisplay) return;
                        calendarGrid.innerHTML = '';
                        monthDisplay.textContent = `${months[monthDate.getMonth()]} ${monthDate.getFullYear()}`;

                        const firstDayOfMonth = new Date(monthDate.getFullYear(), monthDate.getMonth(), 1);
                        const today = new Date();
                        today.setHours(0, 0, 0, 0);
                        const startDay = new Date(firstDayOfMonth);
                        startDay.setDate(firstDayOfMonth.getDate() - firstDayOfMonth.getDay());

                        for (let i = 0; i < 42; i++) {
                            const day = new Date(startDay);
                            day.setDate(startDay.getDate() + i);
                            const dayElement = document.createElement('div');
                            dayElement.classList.add('calendar-day');
                            dayElement.textContent = day.getDate();
                            dayElement.dataset.date = day.toISOString().split('T')[0];

                            if (day.getMonth() === monthDate.getMonth()) {
                                dayElement.classList.add('current-month');
                            } else {
                                dayElement.classList.add('other-month');
                            }
                            if (day.getTime() === today.getTime()) {
                                dayElement.classList.add('today');
                            }
                            if (selectedStartDate && selectedEndDate && day.getTime() >= new Date(selectedStartDate).getTime() && day.getTime() <= new Date(selectedEndDate).getTime()) {
                                dayElement.classList.add('range-selected');
                            }
                            if (selectedStartDate && day.getTime() === new Date(selectedStartDate).getTime()) {
                                dayElement.classList.add('selected');
                            }
                            if (selectedEndDate && day.getTime() === new Date(selectedEndDate).getTime()) {
                                dayElement.classList.add('selected');
                            }
                            
                            dayElement.addEventListener('click', () => {
                                const clickedDate = day.toISOString().split('T')[0];
                                if (!selectedStartDate || (selectedStartDate && selectedEndDate)) {
                                    selectedStartDate = clickedDate;
                                    selectedEndDate = null;
                                } else if (new Date(clickedDate).getTime() < new Date(selectedStartDate).getTime()) {
                                    selectedEndDate = selectedStartDate;
                                    selectedStartDate = clickedDate;
                                } else {
                                    selectedEndDate = clickedDate;
                                }
                                renderCalendars();
                            });
                            calendarGrid.appendChild(dayElement);
                        }
                    };

                    const renderCalendars = () => {
                        const monthDateRight = new Date(currentMonthLeft);
                        monthDateRight.setMonth(currentMonthLeft.getMonth() + 1);
                        renderCalendar(currentMonthLeft, calendarGridLeft, monthDisplayLeft);
                        renderCalendar(monthDateRight, calendarGridRight, monthDisplayRight);
                    };

                    const navigateMonth = (direction) => {
                        currentMonthLeft.setMonth(currentMonthLeft.getMonth() + direction);
                        renderCalendars();
                    };
                    
                    const setPresetDateRange = (preset) => {
                        const today = new Date();
                        today.setHours(0, 0, 0, 0);
                        let start = null;
                        let end = today;

                        if (preset === 'today') start = today;
                        else if (preset === 'this_week') {
                            start = new Date(today);
                            start.setDate(today.getDate() - today.getDay());
                        } else if (preset === 'last_week') {
                            end = new Date(today);
                            end.setDate(today.getDate() - today.getDay() - 1);
                            start = new Date(end);
                            start.setDate(end.getDate() - 6);
                        } else if (preset === 'this_month') {
                            start = new Date(today.getFullYear(), today.getMonth(), 1);
                        } else if (preset === 'last_month') {
                            end = new Date(today.getFullYear(), today.getMonth(), 0);
                            start = new Date(end.getFullYear(), end.getMonth(), 1);
                        }

                        selectedStartDate = start ? start.toISOString().split('T')[0] : null;
                        selectedEndDate = end ? end.toISOString().split('T')[0] : null;

                        if (selectedStartDate) {
                            currentMonthLeft = new Date(selectedStartDate);
                            currentMonthLeft.setDate(1);
                        }
                        renderCalendars();
                        document.querySelectorAll('.quick-select-btn').forEach(btn => btn.classList.remove('active-preset'));
                        const activeBtn = document.querySelector(`.quick-select-btn[data-preset="${preset}"]`);
                        if (activeBtn) activeBtn.classList.add('active-preset');
                    };

                    dateRangeDisplay?.addEventListener('click', () => {
                        if (datePickerModal) {
                            selectedStartDate = searchDateStartInput.value || null;
                            selectedEndDate = searchDateEndInput.value || null;
                            if(selectedStartDate) currentMonthLeft = new Date(selectedStartDate);
                            renderCalendars();
                            datePickerModal.classList.remove('hidden');
                        }
                    });

                    datePickerCloseBtn?.addEventListener('click', () => datePickerModal?.classList.add('hidden'));
                    datePickerCancelBtn?.addEventListener('click', () => datePickerModal?.classList.add('hidden'));
                    datePickerFilterBtn?.addEventListener('click', () => {
                        searchDateStartInput.value = selectedStartDate || '';
                        searchDateEndInput.value = selectedEndDate || '';
                        updateDateRangeDisplay();
                        datePickerModal?.classList.add('hidden');
                        applyFilters();
                    });
                    prevMonthBtnLeft?.addEventListener('click', () => navigateMonth(-1));
                    nextMonthBtnLeft?.addEventListener('click', () => navigateMonth(1));
                    prevMonthBtnRight?.addEventListener('click', () => navigateMonth(-1));
                    nextMonthBtnRight?.addEventListener('click', () => navigateMonth(1));
                    document.querySelectorAll('.quick-select-btn').forEach(btn => {
                        btn.addEventListener('click', () => setPresetDateRange(btn.dataset.preset));
                    });

                    updateDateRangeDisplay();
                    renderCalendars();

                    const renderFilterChips = (appliedFilters) => {
                        filterChipsContainer.innerHTML = '';
                        Object.entries(appliedFilters).forEach(([key, value]) => {
                            if (value) {
                                const chip = document.createElement('span');
                                chip.className = 'filter-chip';
                                chip.innerHTML = `${key}: ${value} <button class="ml-1 text-gray-300 hover:text-white" data-filter="${key}"><i data-lucide="x" class="w-3 h-3"></i></button>`;
                                filterChipsContainer.appendChild(chip);
                            }
                        });
                        if (Object.values(appliedFilters).some(v => v)) {
                            const clearChip = document.createElement('button');
                            clearChip.className = 'filter-chip-clear ml-2 text-sm font-semibold hover:text-white';
                            clearChip.innerHTML = `<i data-lucide="x" class="w-4 h-4 mr-1"></i> Limpar`;
                            clearChip.addEventListener('click', clearFilters);
                            filterChipsContainer.appendChild(clearChip);
                        }
                        window.lucide.createIcons();
                    };

                    const applyFilters = () => {
                        console.log('Aplicando filtros...');
                        const appliedFilters = {
                            situacao: filterSituacao?.value,
                            tags: filterTags?.value,
                            categoria: filterCategoria?.value,
                            ncm: filterNCM?.value,
                            tipo: filterTipo?.value,
                            marca: filterMarca?.value,
                            dataInicio: searchDateStartInput?.value,
                            dataFim: searchDateEndInput?.value,
                            termoPesquisa: productSearchInput?.value.trim()
                        };
                        renderFilterChips(appliedFilters);
                        window.showMessage("Funcionalidade de filtragem no Supabase pendente.", "info");
                    };

                    const clearFilters = () => {
                        console.log('A limpar filtros...');
                        [filterSituacao, filterTags, filterCategoria, filterNCM, filterTipo, filterMarca, searchDateStartInput, searchDateEndInput, productSearchInput].forEach(el => { if(el) el.value = ''; });
                        selectedStartDate = null;
                        selectedEndDate = null;
                        updateDateRangeDisplay();
                        renderCalendars();
                        applyFilters();
                        window.showMessage("Filtros limpos.", "info");
                    };

                    filterChipsContainer.addEventListener('click', (e) => {
                        const target = e.target.closest('button[data-filter]');
                        if (target) {
                            const filterToClear = target.dataset.filter;
                            const element = document.getElementById(`filter-${filterToClear}`) || document.getElementById(`product-search-input`);
                            if(element) element.value = '';
                            if(filterToClear === 'datas') {
                                searchDateStartInput.value = '';
                                searchDateEndInput.value = '';
                                updateDateRangeDisplay();
                            }
                            applyFilters();
                        }
                    });

                    clearFiltersBtn?.addEventListener('click', clearFilters);
                    productSearchInput?.addEventListener('keypress', (e) => e.key === 'Enter' && applyFilters());
                    toggleFilterSidebarBtn?.addEventListener('click', () => {
                        const filterSidebar = document.querySelector('aside:first-child');
                        const productSystemContainer = document.querySelector('.product-system-container');
                        filterSidebar?.classList.toggle('hidden');
                        productSystemContainer?.classList.toggle('grid-cols-[1fr_200px]', filterSidebar?.classList.contains('hidden'));
                        productSystemContainer?.classList.toggle('grid-cols-[288px_1fr_200px]', !filterSidebar?.classList.contains('hidden'));
                    });
                    
                    const handleBatchAction = (actionName, message) => {
                        const selectedProducts = Array.from(document.querySelectorAll('.product-checkbox:checked')).map(cb => cb.closest('tr').dataset.productId);
                        if (selectedProducts.length > 0) {
                            console.log(`${actionName} produtos: ${selectedProducts.join(', ')}`);
                            window.showMessage(`${message} ${selectedProducts.length} produtos. Funcionalidade pendente.`, "info");
                        } else {
                            window.showMessage(`Nenhum produto selecionado para ${actionName.toLowerCase()}.`, "warning");
                        }
                    };

                    lockBtn?.addEventListener('click', () => handleBatchAction('Bloquear', 'A bloquear'));
                    printerBtn?.addEventListener('click', () => handleBatchAction('Imprimir', 'A preparar impressão de'));
                    trashBtn?.addEventListener('click', () => handleBatchAction('Excluir', 'A mover'));
                    refreshBtn?.addEventListener('click', () => {
                        window.showMessage("A atualizar a lista de produtos...", "info");
                        applyFilters();
                    });
                    viewOptionsBtn?.addEventListener('click', () => window.showMessage("Opções de visualização pendentes.", "info"));

                    selectAllCheckbox?.addEventListener('change', (e) => {
                        document.querySelectorAll('.product-checkbox').forEach(checkbox => {
                            checkbox.checked = e.target.checked;
                            checkbox.closest('tr').classList.toggle('selected-row', e.target.checked);
                        });
                    });

                    tableBody.addEventListener('change', (e) => {
                        if (e.target.classList.contains('product-checkbox')) {
                            e.target.closest('tr').classList.toggle('selected-row', e.target.checked);
                            selectAllCheckbox.checked = Array.from(document.querySelectorAll('.product-checkbox')).every(cb => cb.checked);
                        }
                    });

                    const renderImagePreviews = () => {
                        if (!imageDropArea) return;
                        imageDropArea.innerHTML = '';
                        productImages.forEach((src, index) => {
                            const imageItem = document.createElement('div');
                            imageItem.className = 'relative group aspect-w-1 aspect-h-1 bg-gray-100 border rounded-md overflow-hidden flex items-center justify-center p-2';
                            imageItem.innerHTML = `<img src="${src}" alt="Pré-visualização ${index + 1}" class="object-cover w-full h-full" onerror="this.onerror=null;this.src='https://placehold.co/120x120/ef4444/ffffff?text=Falha';"><button class="absolute top-0.5 right-0.5 bg-red-500 text-white rounded-full p-0.5 opacity-0 group-hover:opacity-100" data-index="${index}"><i data-lucide="x" class="w-3 h-3"></i></button>`;
                            imageDropArea.appendChild(imageItem);
                        });
                        if (productImages.length < MAX_IMAGES) {
                            const plusIconDiv = document.createElement('div');
                            plusIconDiv.className = 'aspect-w-1 aspect-h-1 bg-gray-100 border-2 border-dashed rounded-md flex items-center justify-center text-gray-500 hover:border-blue-500 cursor-pointer add-image-slot';
                            plusIconDiv.innerHTML = '<i data-lucide="plus" class="w-8 h-8"></i>';
                            imageDropArea.appendChild(plusIconDiv);
                        }
                        productImagePreview.src = productImages.length > 0 ? productImages[0] : 'https://placehold.co/160x160/cbd5e1/475569?text=Sem%20Imagem';
                        window.lucide.createIcons();
                    };

                    addProductBtn.addEventListener('click', () => {
                        productForm.reset();
                        productImages = [];
                        renderImagePreviews();
                        productModal.classList.remove('hidden');
                    });
                    
                    const hideProductModal = () => productModal.classList.add('hidden');
                    modalCloseButton.addEventListener('click', hideProductModal);
                    cancelBtn.addEventListener('click', hideProductModal);

                    const addImageFile = (file) => {
                        if (productImages.length >= MAX_IMAGES) {
                            window.showMessage(`Limite de ${MAX_IMAGES} imagens atingido.`, "error");
                            return;
                        }
                        const reader = new FileReader();
                        reader.onload = (e) => {
                            productImages.push(e.target.result);
                            renderImagePreviews();
                        };
                        reader.readAsDataURL(file);
                    };

                    imageDropArea.addEventListener('click', (e) => {
                        if (e.target.closest('.add-image-slot')) productImageInput.click();
                        const deleteButton = e.target.closest('.delete-image-btn');
                        if (deleteButton) {
                            productImages.splice(parseInt(deleteButton.dataset.index, 10), 1);
                            renderImagePreviews();
                        }
                    });
                    productImageInput.addEventListener('change', (e) => e.target.files[0] && addImageFile(e.target.files[0]));
                    imageDropArea.addEventListener('dragover', (e) => e.preventDefault());
                    imageDropArea.addEventListener('drop', (e) => {
                        e.preventDefault();
                        if (e.dataTransfer.files[0]) addImageFile(e.dataTransfer.files[0]);
                    });

                    addImageUrlBtn.addEventListener('click', () => {
                        const imageUrl = addImageUrlInput.value.trim();
                        if (imageUrl) {
                            productImages.push(imageUrl);
                            renderImagePreviews();
                            addImageUrlInput.value = '';
                        }
                    });

                    generateBarcodeBtn.addEventListener('click', () => {
                        productForm.querySelector('[name="product-sku"]').value = `SKU-${Math.random().toString(36).substring(2, 8).toUpperCase()}`;
                    });
                    generateGtinEanBtn.addEventListener('click', () => {
                        productForm.querySelector('[name="product-gtinean"]').value = `GTIN-${Math.floor(100000000000 + Math.random() * 900000000000)}`;
                    });

                    productForm.addEventListener('submit', (e) => {
                        e.preventDefault();
                        window.showMessage("Guarda de produto no Supabase pendente.", "info");
                        hideProductModal();
                    });

                    tableBody.addEventListener('click', (e) => {
                        const button = e.target.closest('button[data-action]');
                        if (button) {
                            const action = button.dataset.action;
                            const productId = button.closest('tr').dataset.productId;
                            window.showMessage(`Ação '${action}' para produto ${productId} pendente.`, "info");
                        }
                    });

                    document.getElementById('modal-tabs')?.addEventListener('click', (e) => {
                        e.preventDefault();
                        const tabLink = e.target.closest('.tab-link');
                        if (tabLink) {
                            document.querySelectorAll('#modal-tabs .tab-link, .tab-content').forEach(el => el.classList.remove('active', 'border-green-500', 'text-green-500'));
                            tabLink.classList.add('active', 'border-green-500', 'text-green-500');
                            document.getElementById(tabLink.dataset.tab)?.classList.add('active');
                        }
                    });
                    
                    const importModal = document.getElementById('import-modal');
                    const importModalCloseBtn = document.getElementById('import-modal-close');
                    const importModalCancelBtn = document.getElementById('import-modal-cancel');
                    const downloadTemplateBtn = document.getElementById('download-template-btn');
                    const importFileInput = document.getElementById('import-file-input');
                    const importDropArea = document.getElementById('import-drop-area');
                    const importFileText = document.getElementById('import-file-text');
                    const importFileName = document.getElementById('import-file-name');
                    const processImportBtn = document.getElementById('process-import-btn');

                    importProductsBtn?.addEventListener('click', () => importModal.classList.remove('hidden'));
                    const hideImportModal = () => importModal.classList.add('hidden');
                    importModalCloseBtn.addEventListener('click', hideImportModal);
                    importModalCancelBtn.addEventListener('click', hideImportModal);

                    downloadTemplateBtn.addEventListener('click', () => {
                        const headers = ["nome", "codigo_sku", "preco_venda", "formato", "tipo", "condicao", "marca", "producao", "data_validade", "frete_gratis", "peso_liquido_kg", "peso_bruto_kg", "largura_cm", "altura_cm", "profundidade_cm", "volumes", "itens_por_caixa", "unidade_medida", "gtin_ean", "gtin_ean_tributario", "ncm", "cest", "origem_mercadoria"];
                        const csvContent = "data:text/csv;charset=utf-8," + headers.join(",");
                        const link = document.createElement("a");
                        link.setAttribute("href", encodeURI(csvContent));
                        link.setAttribute("download", "modelo_importacao_produtos.csv");
                        link.click();
                    });

                    const handleFileSelect = (files) => {
                        if (files.length > 0) {
                            importFileName.textContent = `Ficheiro: ${files[0].name}`;
                            processImportBtn.disabled = false;
                        }
                    };

                    importDropArea.addEventListener('click', () => importFileInput.click());
                    importFileInput.addEventListener('change', (e) => handleFileSelect(e.target.files));
                    importDropArea.addEventListener('dragover', (e) => e.preventDefault());
                    importDropArea.addEventListener('drop', (e) => {
                        e.preventDefault();
                        handleFileSelect(e.dataTransfer.files);
                    });
                    processImportBtn.addEventListener('click', () => {
                        if (importFileInput.files.length > 0) {
                            window.showMessage(`A importar "${importFileInput.files[0].name}". Funcionalidade pendente.`, "info");
                            hideImportModal();
                        }
                    });

                    // --- Export Logic ---
                    exportProductsBtn.addEventListener('click', () => {
                        console.log('A exportar produtos...');
                        window.showMessage('A preparar a exportação...', 'info');

                        // Placeholder data - replace with actual data from Supabase
                        const productsToExport = [
                            { nome: "FITA VEDA ROSCA", codigo_sku: "9776", preco_venda: 1.99, unidade: "UN", estoque: 0 },
                            { nome: "CARRO INFANTIL PEQUENO", codigo_sku: "0301", preco_venda: 80.00, unidade: "UN", estoque: 2 },
                            { nome: "CARRO INFANTIL TOTOCA", codigo_sku: "6002", preco_venda: 180.00, unidade: "UN", estoque: 2 }
                        ];

                        if (productsToExport.length === 0) {
                            window.showMessage('Não há produtos para exportar.', 'error');
                            return;
                        }

                        const headers = ["Nome", "Codigo SKU", "Preco Venda", "Unidade", "Estoque"];
                        const csvRows = [headers.join(',')]; // Header row

                        productsToExport.forEach(product => {
                            const values = [
                                `"${product.nome}"`,
                                `"${product.codigo_sku}"`,
                                product.preco_venda,
                                `"${product.unidade}"`,
                                product.estoque
                            ];
                            csvRows.push(values.join(','));
                        });

                        const csvContent = csvRows.join('\n');
                        const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                        const url = URL.createObjectURL(blob);
                        const link = document.createElement("a");
                        link.setAttribute("href", url);
                        link.setAttribute("download", "produtos_exportados.csv");
                        link.style.visibility = 'hidden';
                        document.body.appendChild(link);
                        link.click();
                        document.body.removeChild(link);
                        window.showMessage('Exportação concluída!', 'success');
                    });


                    applyFilters();
                } catch (error) {
                    console.error("An error occurred in runProductSystemScript:", error);
                    window.showMessage("Ocorreu um erro ao carregar o sistema de produtos.", "error");
                }
            };

            const runClientesFornecedoresScript = () => {
                console.log('runClientesFornecedoresScript started.');
                const tableBody = document.getElementById('cs-table-body');
                if (!tableBody) return;
                tableBody.innerHTML = '<tr><td colspan="4" class="p-3 text-center text-gray-500">A carregar...</td></tr>';
            };

            const dashboardHtml = `<div class="p-8"><h1 class="text-3xl font-bold text-gray-800 mb-8">Dashboard</h1><div class="bg-white p-6 rounded-lg shadow"><p>Bem-vindo ao seu sistema!</p></div></div>`;
            const vendasHtml = `<div class="p-8"><h1 class="text-3xl font-bold text-gray-800 mb-8">Gestão de Vendas</h1><div class="bg-white p-6 rounded-lg shadow"><p>Página em construção.</p></div></div>`;
            const estoqueHtml = `<div class="p-8"><h1 class="text-3xl font-bold text-gray-800 mb-8">Controle de Inventário</h1><div class="bg-white p-6 rounded-lg shadow"><p>Página em construção.</p></div></div>`;
            const financeiroHtml = `<div class="p-8"><h1 class="text-3xl font-bold text-gray-800 mb-8">Gestão Financeira</h1><div class="bg-white p-6 rounded-lg shadow"><p>Página em construção.</p></div></div>`;
            const productSystemHtml = `
            <div class="product-system-container grid grid-cols-[288px_1fr_200px] h-full overflow-hidden bg-gray-100 rounded-xl shadow-lg">
                <aside class="bg-gray-100 text-gray-800 p-4 space-y-4 overflow-y-auto flex-shrink-0 rounded-l-xl">
                    <div class="flex items-center justify-between">
                        <h2 class="text-xl font-bold">Filtrar</h2>
                        <button id="clear-filters-btn" class="text-sm text-gray-500 hover:text-gray-700 flex items-center gap-1 p-1 rounded-sm"><i data-lucide="x" class="w-3.5 h-3.5"></i> Limpar</button>
                    </div>
                    <div class="space-y-3 mt-4">
                        <div><label for="filter-situacao" class="block text-sm font-medium text-gray-700">Situação</label><select id="filter-situacao" class="w-full mt-1 bg-white border border-gray-300 rounded-md px-2 py-1.5 text-sm"><option value="">Todos</option><option value="ativo">Ativo</option><option value="inativo">Inativo</option></select></div>
                        <div><label for="filter-tags" class="block text-sm font-medium text-gray-700">Tags</label><select id="filter-tags" class="w-full mt-1 bg-white border border-gray-300 rounded-md px-2 py-1.5 text-sm"><option value="">Todas</option></select></div>
                        <div><label for="filter-categoria" class="block text-sm font-medium text-gray-700">Categoria</label><select id="filter-categoria" class="w-full mt-1 bg-white border border-gray-300 rounded-md px-2 py-1.5 text-sm"><option value="">Todas</option></select></div>
                        <div><label for="filter-ncm" class="block text-sm font-medium text-gray-700">NCM</label><input type="text" id="filter-ncm" class="w-full mt-1 bg-white border border-gray-300 rounded-md px-2 py-1.5 text-sm" placeholder="Código NCM"></div>
                        <div><label for="filter-tipo" class="block text-sm font-medium text-gray-700">Tipo</label><select id="filter-tipo" class="w-full mt-1 bg-white border border-gray-300 rounded-md px-2 py-1.5 text-sm"><option value="">Todos</option><option value="produto">Produto</option><option value="servico">Serviço</option></select></div>
                        <div><label for="filter-marca" class="block text-sm font-medium text-gray-700">Marca</label><input type="text" id="filter-marca" class="w-full mt-1 bg-white border border-gray-300 rounded-md px-2 py-1.5 text-sm" placeholder="Nome da marca"></div>
                    </div>
                </aside>
                <main class="flex-1 flex flex-col overflow-hidden bg-white rounded-none shadow-md">
                    <header class="product-listing-header p-3 px-6 flex flex-col flex-shrink-0 rounded-t-xl">
                        <div class="flex justify-between items-center mb-2">
                            <h2 class="text-sm font-semibold text-gray-300">As Lojas</h2>
                            <div class="flex items-center gap-2">
                                <button id="lock-product-btn" class="p-1 rounded-sm bg-gray-700 hover:bg-gray-600 text-white"><i data-lucide="lock" class="w-3.5 h-3.5"></i></button>
                                <button id="printer-product-btn" class="p-1 rounded-sm bg-gray-700 hover:bg-gray-600 text-white"><i data-lucide="printer" class="w-3.5 h-3.5"></i></button>
                                <button id="trash-product-btn" class="p-1 rounded-sm bg-gray-700 hover:bg-gray-600 text-white"><i data-lucide="trash-2" class="w-3.5 h-3.5"></i></button>
                            </div>
                        </div>
                        <div class="flex items-center space-x-2 w-full mb-2">
                            <div class="relative flex-1 max-w-sm"><input type="text" id="product-search-input" class="w-full product-search-input-dark rounded-md pl-8 pr-2 py-1 text-sm" placeholder="Pesquisar..."><i data-lucide="search" class="w-3.5 h-3.5 text-gray-400 absolute left-2 top-1/2 -translate-y-1/2"></i></div>
                            <div id="date-range-display" class="relative bg-gray-700 border border-gray-600 rounded-md px-2 py-1 text-xs w-40 text-center cursor-pointer flex items-center justify-between hover:bg-gray-600"><span>Data do Pedido</span><i data-lucide="calendar" class="w-3.5 h-3.5 text-gray-400"></i></div>
                            <input type="hidden" id="search-date-start" value=""><input type="hidden" id="search-date-end" value="">
                            <button id="toggle-filter-sidebar-btn" class="bg-gray-700 hover:bg-gray-600 text-white font-semibold py-1 px-2.5 rounded-sm flex items-center gap-1 text-xs"><i data-lucide="filter" class="w-3.5 h-3.5"></i></button>
                            <button id="refresh-product-btn" class="p-1 bg-gray-700 hover:bg-gray-600 text-white rounded-sm"><i data-lucide="refresh-cw" class="w-3.5 h-3.5"></i></button>
                            <button id="view-options-product-btn" class="p-1 bg-gray-700 hover:bg-gray-600 text-white rounded-sm"><i data-lucide="settings" class="w-3.5 h-3.5"></i></button>
                        </div>
                        <div id="filter-chips-container" class="flex flex-wrap items-center gap-2 text-sm mt-2"></div>
                    </header>
                    <div class="flex-1 overflow-y-auto p-6">
                        <div class="product-table-dark rounded-lg shadow overflow-hidden border border-gray-700">
                            <table class="w-full">
                                <thead class="border-b border-gray-700">
                                    <tr>
                                        <th class="p-3 text-left text-xs font-semibold uppercase w-10"><input type="checkbox" id="select-all-products" class="rounded-sm text-blue-500 bg-gray-600 border-gray-500"></th>
                                        <th class="p-3 text-left text-xs font-semibold uppercase">Imagem</th>
                                        <th class="p-3 text-left text-xs font-semibold uppercase">Descrição</th>
                                        <th class="p-3 text-left text-xs font-semibold uppercase">Código</th>
                                        <th class="p-3 text-left text-xs font-semibold uppercase">Unidade</th>
                                        <th class="p-3 text-left text-xs font-semibold uppercase">Preço</th>
                                        <th class="p-3 text-center text-xs font-semibold uppercase">Estoque</th>
                                        <th class="p-3 text-center text-xs font-semibold uppercase">Ações</th>
                                    </tr>
                                </thead>
                                <tbody id="product-table-body" class="divide-y divide-gray-700"></tbody>
                            </table>
                        </div>
                    </div>
                </main>
                <aside class="bg-gray-100 text-gray-800 p-4 space-y-4 overflow-y-auto flex-shrink-0 rounded-r-xl">
                    <h2 class="text-xl font-bold mb-4">Ações</h2>
                    <div class="space-y-3">
                        <button id="add-product-btn" class="w-full bg-blue-500 hover:bg-blue-700 text-white font-semibold py-1.5 px-3 rounded-md flex items-center justify-center gap-2"><i data-lucide="plus" class="w-4 h-4"></i> Adicionar Produto</button>
                        <button id="import-products-btn" class="w-full bg-green-500 hover:bg-green-600 text-white font-semibold py-1.5 px-3 rounded-md flex items-center justify-center gap-2"><i data-lucide="upload-cloud" class="w-4 h-4"></i> Importar</button>
                        <button id="export-products-btn" class="w-full bg-indigo-500 hover:bg-indigo-600 text-white font-semibold py-1.5 px-3 rounded-md flex items-center justify-center gap-2"><i data-lucide="download-cloud" class="w-4 h-4"></i> Exportar</button>
                    </div>
                </aside>
            </div>`;
            const clientesFornecedoresHtml = `<main class="flex-1 flex flex-col overflow-hidden"><header class="bg-white p-4 px-8 flex items-center justify-between flex-shrink-0 border-b"><div><h1 class="text-2xl font-bold text-gray-800">Clientes e Fornecedores</h1></div><div class="flex items-center gap-4"><button id="add-cs-btn" class="bg-blue-500 hover:bg-blue-600 text-white font-semibold py-1.5 px-3 rounded-md flex items-center gap-2"><i data-lucide="plus" class="w-4 h-4"></i> Adicionar</button></div></header><div class="flex-1 overflow-y-auto p-8"><div class="bg-white rounded-lg shadow overflow-hidden"><table class="w-full"><thead class="bg-gray-50"><tr><th class="p-3 text-left text-xs font-semibold text-gray-600 uppercase">Nome</th><th class="p-3 text-left text-xs font-semibold text-gray-600 uppercase">Documento</th><th class="p-3 text-left text-xs font-semibold text-gray-600 uppercase">Tipo</th><th class="p-3 text-center text-xs font-semibold text-gray-600 uppercase">Ações</th></tr></thead><tbody id="cs-table-body" class="divide-y divide-gray-200"></tbody></table></div></div></main>`;
            
        document.getElementById('nav-dashboard').addEventListener('click', (e) => { e.preventDefault(); showPage(dashboardHtml, 'nav-dashboard'); });
        document.getElementById('nav-vendas').addEventListener('click', (e) => { e.preventDefault(); showPage(vendasHtml, 'nav-vendas'); });
        document.getElementById('nav-estoque').addEventListener('click', (e) => { e.preventDefault(); showPage(estoqueHtml, 'nav-estoque'); });
        document.getElementById('nav-financeiro').addEventListener('click', (e) => { e.preventDefault(); showPage(financeiroHtml, 'nav-financeiro'); });
        document.getElementById('link-produtos').addEventListener('click', (e) => { e.preventDefault(); showPage(productSystemHtml, 'nav-catalogo', runProductSystemScript); });
        document.getElementById('link-clientes-fornecedores').addEventListener('click', (e) => { e.preventDefault(); showPage(clientesFornecedoresHtml, 'nav-catalogo', runClientesFornecedoresScript); });

        // Initial page load
        showPage(dashboardHtml, 'nav-dashboard');
        window.lucide.createIcons();
    };

    document.addEventListener('DOMContentLoaded', async () => {
        const loginForm = document.getElementById('login-form');
        const signupLink = document.getElementById('signup-link');
        const registerModal = document.getElementById('register-modal');
        const registerForm = document.getElementById('register-form');
        const registerModalCloseBtn = document.getElementById('register-modal-close');

        const showRegisterModal = () => {
            if (registerModal) {
                registerForm.reset();
                registerModal.classList.remove('hidden');
                registerModal.querySelector('.modal-content').classList.remove('translate-y-[-20px]');
                window.lucide.createIcons();
            }
        };

        const hideRegisterModal = () => {
            if (registerModal) {
                registerModal.querySelector('.modal-content').classList.add('translate-y-[-20px]');
                setTimeout(() => registerModal.classList.add('hidden'), 300);
            }
        };

        signupLink.addEventListener('click', (e) => {
            e.preventDefault();
            showRegisterModal();
        });

        registerModalCloseBtn.addEventListener('click', hideRegisterModal);

        loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = loginForm.querySelector('#email').value;
            const password = loginForm.querySelector('#password').value;
            if (!window.supabase) return window.showMessage("Erro: Supabase não inicializado.", "error");
            
            const { error } = await window.supabase.auth.signInWithPassword({ email, password });
            if (error) {
                window.showMessage(`Erro de Login: ${error.message}`, "error");
            } else {
                window.showMessage("Login bem-sucedido! A redirecionar...", "success");
            }
        });

        registerForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const name = registerForm.querySelector('#register-name').value;
            const email = registerForm.querySelector('#register-email').value;
            const phone = registerForm.querySelector('#register-phone').value;
            const password = registerForm.querySelector('#register-password').value;

            if (!window.supabase) return window.showMessage("Erro: Supabase não inicializado.", "error");
            if (!name || !email || !password) return window.showMessage("Por favor, preencha todos os campos obrigatórios.", "error");

            const { data, error } = await window.supabase.auth.signUp({
                email,
                password,
                options: { data: { full_name: name, phone_number: phone } }
            });

            if (error) {
                window.showMessage(`Erro de Registo: ${error.message}.`, "error");
            } else if (data.user) {
                window.showMessage("Registo bem-sucedido! Verifique o seu email para confirmar a conta.", "success");
                hideRegisterModal();
                loginForm.querySelector('#email').value = email;
            }
        });

        window.lucide.createIcons(); 
    });
</script>
</body>
</html>

